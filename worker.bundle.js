/*! For license information please see worker.bundle.js.LICENSE.txt */
(()=>{var t={206:t=>{t.exports=function t(e,i,n){function s(o,a){if(!i[o]){if(!e[o]){if(r)return r(o,!0);throw new Error("Cannot find module '"+o+"'")}var h=i[o]={exports:{}};e[o][0].call(h.exports,(function(t){return s(e[o][1][t]||t)}),h,h.exports,t,e,i,n)}return i[o].exports}for(var r=void 0,o=0;o<n.length;o++)s(n[o]);return s}({1:[function(t,e,i){e.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(t,e,i){e.exports={version:t("../package.json").version,AABB:t("./collision/AABB"),ArrayCollisionMatrix:t("./collision/ArrayCollisionMatrix"),Body:t("./objects/Body"),Box:t("./shapes/Box"),Broadphase:t("./collision/Broadphase"),Constraint:t("./constraints/Constraint"),ContactEquation:t("./equations/ContactEquation"),Narrowphase:t("./world/Narrowphase"),ConeTwistConstraint:t("./constraints/ConeTwistConstraint"),ContactMaterial:t("./material/ContactMaterial"),ConvexPolyhedron:t("./shapes/ConvexPolyhedron"),Cylinder:t("./shapes/Cylinder"),DistanceConstraint:t("./constraints/DistanceConstraint"),Equation:t("./equations/Equation"),EventTarget:t("./utils/EventTarget"),FrictionEquation:t("./equations/FrictionEquation"),GSSolver:t("./solver/GSSolver"),GridBroadphase:t("./collision/GridBroadphase"),Heightfield:t("./shapes/Heightfield"),HingeConstraint:t("./constraints/HingeConstraint"),LockConstraint:t("./constraints/LockConstraint"),Mat3:t("./math/Mat3"),Material:t("./material/Material"),NaiveBroadphase:t("./collision/NaiveBroadphase"),ObjectCollisionMatrix:t("./collision/ObjectCollisionMatrix"),Pool:t("./utils/Pool"),Particle:t("./shapes/Particle"),Plane:t("./shapes/Plane"),PointToPointConstraint:t("./constraints/PointToPointConstraint"),Quaternion:t("./math/Quaternion"),Ray:t("./collision/Ray"),RaycastVehicle:t("./objects/RaycastVehicle"),RaycastResult:t("./collision/RaycastResult"),RigidVehicle:t("./objects/RigidVehicle"),RotationalEquation:t("./equations/RotationalEquation"),RotationalMotorEquation:t("./equations/RotationalMotorEquation"),SAPBroadphase:t("./collision/SAPBroadphase"),SPHSystem:t("./objects/SPHSystem"),Shape:t("./shapes/Shape"),Solver:t("./solver/Solver"),Sphere:t("./shapes/Sphere"),SplitSolver:t("./solver/SplitSolver"),Spring:t("./objects/Spring"),Trimesh:t("./shapes/Trimesh"),Vec3:t("./math/Vec3"),Vec3Pool:t("./utils/Vec3Pool"),World:t("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(t,e,i){var n=t("../math/Vec3");function s(t){t=t||{},this.lowerBound=new n,t.lowerBound&&this.lowerBound.copy(t.lowerBound),this.upperBound=new n,t.upperBound&&this.upperBound.copy(t.upperBound)}t("../utils/Utils"),e.exports=s;var r=new n;s.prototype.setFromPoints=function(t,e,i,n){var s=this.lowerBound,o=this.upperBound,a=i;s.copy(t[0]),a&&a.vmult(s,s),o.copy(s);for(var h=1;h<t.length;h++){var l=t[h];a&&(a.vmult(l,r),l=r),l.x>o.x&&(o.x=l.x),l.x<s.x&&(s.x=l.x),l.y>o.y&&(o.y=l.y),l.y<s.y&&(s.y=l.y),l.z>o.z&&(o.z=l.z),l.z<s.z&&(s.z=l.z)}return e&&(e.vadd(s,s),e.vadd(o,o)),n&&(s.x-=n,s.y-=n,s.z-=n,o.x+=n,o.y+=n,o.z+=n),this},s.prototype.copy=function(t){return this.lowerBound.copy(t.lowerBound),this.upperBound.copy(t.upperBound),this},s.prototype.clone=function(){return(new s).copy(this)},s.prototype.extend=function(t){var e=t.lowerBound.x;this.lowerBound.x>e&&(this.lowerBound.x=e);var i=t.upperBound.x;this.upperBound.x<i&&(this.upperBound.x=i),e=t.lowerBound.y,this.lowerBound.y>e&&(this.lowerBound.y=e),i=t.upperBound.y,this.upperBound.y<i&&(this.upperBound.y=i),e=t.lowerBound.z,this.lowerBound.z>e&&(this.lowerBound.z=e),i=t.upperBound.z,this.upperBound.z<i&&(this.upperBound.z=i)},s.prototype.overlaps=function(t){var e=this.lowerBound,i=this.upperBound,n=t.lowerBound,s=t.upperBound;return(n.x<=i.x&&i.x<=s.x||e.x<=s.x&&s.x<=i.x)&&(n.y<=i.y&&i.y<=s.y||e.y<=s.y&&s.y<=i.y)&&(n.z<=i.z&&i.z<=s.z||e.z<=s.z&&s.z<=i.z)},s.prototype.contains=function(t){var e=this.lowerBound,i=this.upperBound,n=t.lowerBound,s=t.upperBound;return e.x<=n.x&&i.x>=s.x&&e.y<=n.y&&i.y>=s.y&&e.z<=n.z&&i.z>=s.z},s.prototype.getCorners=function(t,e,i,n,s,r,o,a){var h=this.lowerBound,l=this.upperBound;t.copy(h),e.set(l.x,h.y,h.z),i.set(l.x,l.y,h.z),n.set(h.x,l.y,l.z),s.set(l.x,h.y,h.z),r.set(h.x,l.y,h.z),o.set(h.x,h.y,l.z),a.copy(l)};var o=[new n,new n,new n,new n,new n,new n,new n,new n];s.prototype.toLocalFrame=function(t,e){var i=o,n=i[0],s=i[1],r=i[2],a=i[3],h=i[4],l=i[5],c=i[6],u=i[7];this.getCorners(n,s,r,a,h,l,c,u);for(var p=0;8!==p;p++){var d=i[p];t.pointToLocal(d,d)}return e.setFromPoints(i)},s.prototype.toWorldFrame=function(t,e){var i=o,n=i[0],s=i[1],r=i[2],a=i[3],h=i[4],l=i[5],c=i[6],u=i[7];this.getCorners(n,s,r,a,h,l,c,u);for(var p=0;8!==p;p++){var d=i[p];t.pointToWorld(d,d)}return e.setFromPoints(i)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(t,e,i){function n(){this.matrix=[]}e.exports=n,n.prototype.get=function(t,e){if(t=t.index,(e=e.index)>t){var i=e;e=t,t=i}return this.matrix[(t*(t+1)>>1)+e-1]},n.prototype.set=function(t,e,i){if(t=t.index,(e=e.index)>t){var n=e;e=t,t=n}this.matrix[(t*(t+1)>>1)+e-1]=i?1:0},n.prototype.reset=function(){for(var t=0,e=this.matrix.length;t!==e;t++)this.matrix[t]=0},n.prototype.setNumObjects=function(t){this.matrix.length=t*(t-1)>>1}},{}],5:[function(t,e,i){var n=t("../objects/Body"),s=t("../math/Vec3"),r=t("../math/Quaternion");function o(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}t("../shapes/Shape"),t("../shapes/Plane"),e.exports=o,o.prototype.collisionPairs=function(t,e,i){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var a=n.STATIC|n.KINEMATIC;o.prototype.needBroadphaseCollision=function(t,e){return!(!(t.collisionFilterGroup&e.collisionFilterMask&&e.collisionFilterGroup&t.collisionFilterMask)||(t.type&a||t.sleepState===n.SLEEPING)&&(e.type&a||e.sleepState===n.SLEEPING))},o.prototype.intersectionTest=function(t,e,i,n){this.useBoundingBoxes?this.doBoundingBoxBroadphase(t,e,i,n):this.doBoundingSphereBroadphase(t,e,i,n)};var h=new s;new s,new r,new s,o.prototype.doBoundingSphereBroadphase=function(t,e,i,n){var s=h;e.position.vsub(t.position,s);var r=Math.pow(t.boundingRadius+e.boundingRadius,2);s.norm2()<r&&(i.push(t),n.push(e))},o.prototype.doBoundingBoxBroadphase=function(t,e,i,n){t.aabbNeedsUpdate&&t.computeAABB(),e.aabbNeedsUpdate&&e.computeAABB(),t.aabb.overlaps(e.aabb)&&(i.push(t),n.push(e))};var l={keys:[]},c=[],u=[];o.prototype.makePairsUnique=function(t,e){for(var i=l,n=c,s=u,r=t.length,o=0;o!==r;o++)n[o]=t[o],s[o]=e[o];for(t.length=0,e.length=0,o=0;o!==r;o++){var a=n[o].id,h=s[o].id;i[p=a<h?a+","+h:h+","+a]=o,i.keys.push(p)}for(o=0;o!==i.keys.length;o++){var p=i.keys.pop(),d=i[p];t.push(n[d]),e.push(s[d]),delete i[p]}},o.prototype.setWorld=function(t){};var p=new s;o.boundingSphereCheck=function(t,e){var i=p;return t.position.vsub(e.position,i),Math.pow(t.shape.boundingSphereRadius+e.shape.boundingSphereRadius,2)>i.norm2()},o.prototype.aabbQuery=function(t,e,i){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(t,e,i){e.exports=o;var n=t("./Broadphase"),s=t("../math/Vec3"),r=t("../shapes/Shape");function o(t,e,i,r,o){n.apply(this),this.nx=i||10,this.ny=r||10,this.nz=o||10,this.aabbMin=t||new s(100,100,100),this.aabbMax=e||new s(-100,-100,-100);var a=this.nx*this.ny*this.nz;if(a<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=a,this.binLengths.length=a;for(var h=0;h<a;h++)this.bins[h]=[],this.binLengths[h]=0}o.prototype=new n,o.prototype.constructor=o;var a=new s;new s,o.prototype.collisionPairs=function(t,e,i){for(var n=t.numObjects(),s=t.bodies,o=this.aabbMax,h=this.aabbMin,l=this.nx,c=this.ny,u=this.nz,p=c*u,d=u,m=o.x,f=o.y,y=o.z,v=h.x,g=h.y,x=h.z,b=l/(m-v),w=c/(f-g),_=u/(y-x),M=(m-v)/l,S=(f-g)/c,A=(y-x)/u,z=.5*Math.sqrt(M*M+S*S+A*A),T=r.types,P=T.SPHERE,k=T.PLANE,E=(T.BOX,T.COMPOUND,T.CONVEXPOLYHEDRON,this.bins),B=this.binLengths,C=this.bins.length,I=0;I!==C;I++)B[I]=0;var R=Math.ceil;function V(t,e,i,n,s,r,o){var a=(t-v)*b|0,h=(e-g)*w|0,m=(i-x)*_|0,f=R((n-v)*b),y=R((s-g)*w),M=R((r-x)*_);a<0?a=0:a>=l&&(a=l-1),h<0?h=0:h>=c&&(h=c-1),m<0?m=0:m>=u&&(m=u-1),f<0?f=0:f>=l&&(f=l-1),y<0?y=0:y>=c&&(y=c-1),M<0?M=0:M>=u&&(M=u-1),h*=d,m*=1,f*=p,y*=d,M*=1;for(var S=a*=p;S<=f;S+=p)for(var A=h;A<=y;A+=d)for(var z=m;z<=M;z+=1){var T=S+A+z;E[T][B[T]++]=o}}for(h=Math.min,o=Math.max,I=0;I!==n;I++){var F=(et=s[I]).shape;switch(F.type){case P:var O=et.position.x,j=et.position.y,N=et.position.z,q=F.radius;V(O-q,j-q,N-q,O+q,j+q,N+q,et);break;case k:F.worldNormalNeedsUpdate&&F.computeWorldNormal(et.quaternion);var L=F.worldNormal,D=v+.5*M-et.position.x,W=g+.5*S-et.position.y,U=x+.5*A-et.position.z,H=a;H.set(D,W,U);for(var G=0,X=0;G!==l;G++,X+=p,H.y=W,H.x+=M)for(var Y=0,Z=0;Y!==c;Y++,Z+=d,H.z=U,H.y+=S)for(var Q=0,J=0;Q!==u;Q++,J+=1,H.z+=A)if(H.dot(L)<z){var $=X+Z+J;E[$][B[$]++]=et}break;default:et.aabbNeedsUpdate&&et.computeAABB(),V(et.aabb.lowerBound.x,et.aabb.lowerBound.y,et.aabb.lowerBound.z,et.aabb.upperBound.x,et.aabb.upperBound.y,et.aabb.upperBound.z,et)}}for(I=0;I!==C;I++){var K=B[I];if(K>1){var tt=E[I];for(G=0;G!==K;G++){var et=tt[G];for(Y=0;Y!==G;Y++){var it=tt[Y];this.needBroadphaseCollision(et,it)&&this.intersectionTest(et,it,e,i)}}}}this.makePairsUnique(e,i)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(t,e,i){e.exports=r;var n=t("./Broadphase"),s=t("./AABB");function r(){n.apply(this)}r.prototype=new n,r.prototype.constructor=r,r.prototype.collisionPairs=function(t,e,i){var n,s,r,o,a=t.bodies,h=a.length;for(n=0;n!==h;n++)for(s=0;s!==n;s++)r=a[n],o=a[s],this.needBroadphaseCollision(r,o)&&this.intersectionTest(r,o,e,i)},new s,r.prototype.aabbQuery=function(t,e,i){i=i||[];for(var n=0;n<t.bodies.length;n++){var s=t.bodies[n];s.aabbNeedsUpdate&&s.computeAABB(),s.aabb.overlaps(e)&&i.push(s)}return i}},{"./AABB":3,"./Broadphase":5}],8:[function(t,e,i){function n(){this.matrix={}}e.exports=n,n.prototype.get=function(t,e){if(t=t.id,(e=e.id)>t){var i=e;e=t,t=i}return t+"-"+e in this.matrix},n.prototype.set=function(t,e,i){if(t=t.id,(e=e.id)>t){var n=e;e=t,t=n}i?this.matrix[t+"-"+e]=!0:delete this.matrix[t+"-"+e]},n.prototype.reset=function(){this.matrix={}},n.prototype.setNumObjects=function(t){}},{}],9:[function(t,e,i){e.exports=l;var n=t("../math/Vec3"),s=t("../math/Quaternion"),r=t("../math/Transform"),o=(t("../shapes/ConvexPolyhedron"),t("../shapes/Box"),t("../collision/RaycastResult")),a=t("../shapes/Shape"),h=t("../collision/AABB");function l(t,e){this.from=t?t.clone():new n,this.to=e?e.clone():new n,this._direction=new n,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=l.ANY,this.result=new o,this.hasHit=!1,this.callback=function(t){}}l.prototype.constructor=l,l.CLOSEST=1,l.ANY=2,l.ALL=4;var c=new h,u=[];l.prototype.intersectWorld=function(t,e){return this.mode=e.mode||l.ANY,this.result=e.result||new o,this.skipBackfaces=!!e.skipBackfaces,this.collisionFilterMask=void 0!==e.collisionFilterMask?e.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==e.collisionFilterGroup?e.collisionFilterGroup:-1,e.from&&this.from.copy(e.from),e.to&&this.to.copy(e.to),this.callback=e.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(c),u.length=0,t.broadphase.aabbQuery(t,c,u),this.intersectBodies(u),this.hasHit};var p=new n,d=new n;function m(t,e,i,n){n.vsub(e,R),i.vsub(e,p),t.vsub(e,d);var s,r,o=R.dot(R),a=R.dot(p),h=R.dot(d),l=p.dot(p),c=p.dot(d);return(s=l*h-a*c)>=0&&(r=o*c-a*h)>=0&&s+r<o*l-a*a}l.pointInTriangle=m;var f=new n,y=new s;l.prototype.intersectBody=function(t,e){e&&(this.result=e,this._updateDirection());var i=this.checkCollisionResponse;if((!i||t.collisionResponse)&&this.collisionFilterGroup&t.collisionFilterMask&&t.collisionFilterGroup&this.collisionFilterMask)for(var n=f,s=y,r=0,o=t.shapes.length;r<o;r++){var a=t.shapes[r];if((!i||a.collisionResponse)&&(t.quaternion.mult(t.shapeOrientations[r],s),t.quaternion.vmult(t.shapeOffsets[r],n),n.vadd(t.position,n),this.intersectShape(a,s,n,t),this.result._shouldStop))break}},l.prototype.intersectBodies=function(t,e){e&&(this.result=e,this._updateDirection());for(var i=0,n=t.length;!this.result._shouldStop&&i<n;i++)this.intersectBody(t[i])},l.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},l.prototype.intersectShape=function(t,e,i,n){if(!(function(t,e,i){i.vsub(t,R);var n=R.dot(e);return e.mult(n,V),V.vadd(t,V),i.distanceTo(V)}(this.from,this._direction,i)>t.boundingSphereRadius)){var s=this[t.type];s&&s.call(this,t,e,i,n)}},new n,new n;var v=new n,g=new n,x=new n,b=new n;new n,new o,l.prototype.intersectBox=function(t,e,i,n){return this.intersectConvex(t.convexPolyhedronRepresentation,e,i,n)},l.prototype[a.types.BOX]=l.prototype.intersectBox,l.prototype.intersectPlane=function(t,e,i,s){var r=this.from,o=this.to,a=this._direction,h=new n(0,0,1);e.vmult(h,h);var l=new n;r.vsub(i,l);var c=l.dot(h);if(o.vsub(i,l),!(c*l.dot(h)>0||r.distanceTo(o)<c)){var u=h.dot(a);if(!(Math.abs(u)<this.precision)){var p=new n,d=new n,m=new n;r.vsub(i,p);var f=-h.dot(p)/u;a.scale(f,d),r.vadd(d,m),this.reportIntersection(h,m,t,s,-1)}}},l.prototype[a.types.PLANE]=l.prototype.intersectPlane,l.prototype.getAABB=function(t){var e=this.to,i=this.from;t.lowerBound.x=Math.min(e.x,i.x),t.lowerBound.y=Math.min(e.y,i.y),t.lowerBound.z=Math.min(e.z,i.z),t.upperBound.x=Math.max(e.x,i.x),t.upperBound.y=Math.max(e.y,i.y),t.upperBound.z=Math.max(e.z,i.z)};var w={faceList:[0]};l.prototype.intersectHeightfield=function(t,e,i,s){t.data,t.elementSize;var o=new n,a=new l(this.from,this.to);r.pointToLocalFrame(i,e,a.from,a.from),r.pointToLocalFrame(i,e,a.to,a.to);var h=[],c=null,u=null,p=null,d=null,m=t.getIndexOfPosition(a.from.x,a.from.y,h,!1);if(m&&(c=h[0],u=h[1],p=h[0],d=h[1]),(m=t.getIndexOfPosition(a.to.x,a.to.y,h,!1))&&((null===c||h[0]<c)&&(c=h[0]),(null===p||h[0]>p)&&(p=h[0]),(null===u||h[1]<u)&&(u=h[1]),(null===d||h[1]>d)&&(d=h[1])),null!==c){var f=[];t.getRectMinMax(c,u,p,d,f);for(var y=c;y<=p;y++)for(var v=u;v<=d;v++){if(this.result._shouldStop)return;if(t.getConvexTrianglePillar(y,v,!1),r.pointToWorldFrame(i,e,t.pillarOffset,o),this.intersectConvex(t.pillarConvex,e,o,s,w),this.result._shouldStop)return;t.getConvexTrianglePillar(y,v,!0),r.pointToWorldFrame(i,e,t.pillarOffset,o),this.intersectConvex(t.pillarConvex,e,o,s,w)}}},l.prototype[a.types.HEIGHTFIELD]=l.prototype.intersectHeightfield;var _=new n,M=new n;l.prototype.intersectSphere=function(t,e,i,n){var s=this.from,r=this.to,o=t.radius,a=Math.pow(r.x-s.x,2)+Math.pow(r.y-s.y,2)+Math.pow(r.z-s.z,2),h=2*((r.x-s.x)*(s.x-i.x)+(r.y-s.y)*(s.y-i.y)+(r.z-s.z)*(s.z-i.z)),l=Math.pow(s.x-i.x,2)+Math.pow(s.y-i.y,2)+Math.pow(s.z-i.z,2)-Math.pow(o,2),c=Math.pow(h,2)-4*a*l,u=_,p=M;if(!(c<0))if(0===c)s.lerp(r,c,u),u.vsub(i,p),p.normalize(),this.reportIntersection(p,u,t,n,-1);else{var d=(-h-Math.sqrt(c))/(2*a),m=(-h+Math.sqrt(c))/(2*a);if(d>=0&&d<=1&&(s.lerp(r,d,u),u.vsub(i,p),p.normalize(),this.reportIntersection(p,u,t,n,-1)),this.result._shouldStop)return;m>=0&&m<=1&&(s.lerp(r,m,u),u.vsub(i,p),p.normalize(),this.reportIntersection(p,u,t,n,-1))}},l.prototype[a.types.SPHERE]=l.prototype.intersectSphere;var S=new n,A=(new n,new n,new n);l.prototype.intersectConvex=function(t,e,i,n,s){for(var r=S,o=A,a=s&&s.faceList||null,h=t.faces,l=t.vertices,c=t.faceNormals,u=this._direction,p=this.from,d=this.to,f=p.distanceTo(d),y=a?a.length:h.length,w=this.result,_=0;!w._shouldStop&&_<y;_++){var M=a?a[_]:_,z=h[M],T=c[M],P=e,k=i;o.copy(l[z[0]]),P.vmult(o,o),o.vadd(k,o),o.vsub(p,o),P.vmult(T,r);var E=u.dot(r);if(!(Math.abs(E)<this.precision)){var B=r.dot(o)/E;if(!(B<0)){u.mult(B,v),v.vadd(p,v),g.copy(l[z[0]]),P.vmult(g,g),k.vadd(g,g);for(var C=1;!w._shouldStop&&C<z.length-1;C++){x.copy(l[z[C]]),b.copy(l[z[C+1]]),P.vmult(x,x),P.vmult(b,b),k.vadd(x,x),k.vadd(b,b);var I=v.distanceTo(p);!m(v,g,x,b)&&!m(v,x,g,b)||I>f||this.reportIntersection(r,v,t,n,M)}}}}},l.prototype[a.types.CONVEXPOLYHEDRON]=l.prototype.intersectConvex;var z=new n,T=new n,P=new n,k=new n,E=new n,B=new n,C=(new h,[]),I=new r;l.prototype.intersectTrimesh=function(t,e,i,n,s){var o=z,a=C,h=I,l=A,c=T,u=P,p=k,d=B,f=E,y=(s&&s.faceList,t.indices),w=(t.vertices,t.faceNormals,this.from),_=this.to,M=this._direction;h.position.copy(i),h.quaternion.copy(e),r.vectorToLocalFrame(i,e,M,c),r.pointToLocalFrame(i,e,w,u),r.pointToLocalFrame(i,e,_,p);var S=u.distanceSquared(p);t.tree.rayQuery(this,h,a);for(var R=0,V=a.length;!this.result._shouldStop&&R!==V;R++){var F=a[R];t.getNormal(F,o),t.getVertex(y[3*F],g),g.vsub(u,l);var O=c.dot(o),j=o.dot(l)/O;if(!(j<0)){c.scale(j,v),v.vadd(u,v),t.getVertex(y[3*F+1],x),t.getVertex(y[3*F+2],b);var N=v.distanceSquared(u);!m(v,x,g,b)&&!m(v,g,x,b)||N>S||(r.vectorToWorldFrame(e,o,f),r.pointToWorldFrame(i,e,v,d),this.reportIntersection(f,d,t,n,F))}}a.length=0},l.prototype[a.types.TRIMESH]=l.prototype.intersectTrimesh,l.prototype.reportIntersection=function(t,e,i,n,s){var r=this.from,o=this.to,a=r.distanceTo(e),h=this.result;if(!(this.skipBackfaces&&t.dot(this._direction)>0))switch(h.hitFaceIndex=void 0!==s?s:-1,this.mode){case l.ALL:this.hasHit=!0,h.set(r,o,t,e,i,n,a),h.hasHit=!0,this.callback(h);break;case l.CLOSEST:(a<h.distance||!h.hasHit)&&(this.hasHit=!0,h.hasHit=!0,h.set(r,o,t,e,i,n,a));break;case l.ANY:this.hasHit=!0,h.hasHit=!0,h.set(r,o,t,e,i,n,a),h._shouldStop=!0}};var R=new n,V=new n},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(t,e,i){var n=t("../math/Vec3");function s(){this.rayFromWorld=new n,this.rayToWorld=new n,this.hitNormalWorld=new n,this.hitPointWorld=new n,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}e.exports=s,s.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},s.prototype.abort=function(){this._shouldStop=!0},s.prototype.set=function(t,e,i,n,s,r,o){this.rayFromWorld.copy(t),this.rayToWorld.copy(e),this.hitNormalWorld.copy(i),this.hitPointWorld.copy(n),this.shape=s,this.body=r,this.distance=o}},{"../math/Vec3":30}],11:[function(t,e,i){t("../shapes/Shape");var n=t("../collision/Broadphase");function s(t){n.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var e=this.axisList;this._addBodyHandler=function(t){e.push(t.body)},this._removeBodyHandler=function(t){var i=e.indexOf(t.body);-1!==i&&e.splice(i,1)},t&&this.setWorld(t)}e.exports=s,s.prototype=new n,s.prototype.setWorld=function(t){this.axisList.length=0;for(var e=0;e<t.bodies.length;e++)this.axisList.push(t.bodies[e]);t.removeEventListener("addBody",this._addBodyHandler),t.removeEventListener("removeBody",this._removeBodyHandler),t.addEventListener("addBody",this._addBodyHandler),t.addEventListener("removeBody",this._removeBodyHandler),this.world=t,this.dirty=!0},s.insertionSortX=function(t){for(var e=1,i=t.length;e<i;e++){for(var n=t[e],s=e-1;s>=0&&!(t[s].aabb.lowerBound.x<=n.aabb.lowerBound.x);s--)t[s+1]=t[s];t[s+1]=n}return t},s.insertionSortY=function(t){for(var e=1,i=t.length;e<i;e++){for(var n=t[e],s=e-1;s>=0&&!(t[s].aabb.lowerBound.y<=n.aabb.lowerBound.y);s--)t[s+1]=t[s];t[s+1]=n}return t},s.insertionSortZ=function(t){for(var e=1,i=t.length;e<i;e++){for(var n=t[e],s=e-1;s>=0&&!(t[s].aabb.lowerBound.z<=n.aabb.lowerBound.z);s--)t[s+1]=t[s];t[s+1]=n}return t},s.prototype.collisionPairs=function(t,e,i){var n,r,o=this.axisList,a=o.length,h=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),n=0;n!==a;n++){var l=o[n];for(r=n+1;r<a;r++){var c=o[r];if(this.needBroadphaseCollision(l,c)){if(!s.checkBounds(l,c,h))break;this.intersectionTest(l,c,e,i)}}}},s.prototype.sortList=function(){for(var t=this.axisList,e=this.axisIndex,i=t.length,n=0;n!==i;n++){var r=t[n];r.aabbNeedsUpdate&&r.computeAABB()}0===e?s.insertionSortX(t):1===e?s.insertionSortY(t):2===e&&s.insertionSortZ(t)},s.checkBounds=function(t,e,i){var n,s;0===i?(n=t.position.x,s=e.position.x):1===i?(n=t.position.y,s=e.position.y):2===i&&(n=t.position.z,s=e.position.z);var r=t.boundingRadius;return s-e.boundingRadius<n+r},s.prototype.autoDetectAxis=function(){for(var t=0,e=0,i=0,n=0,s=0,r=0,o=this.axisList,a=o.length,h=1/a,l=0;l!==a;l++){var c=o[l],u=c.position.x;t+=u,e+=u*u;var p=c.position.y;i+=p,n+=p*p;var d=c.position.z;s+=d,r+=d*d}var m=e-t*t*h,f=n-i*i*h,y=r-s*s*h;this.axisIndex=m>f?m>y?0:2:f>y?1:2},s.prototype.aabbQuery=function(t,e,i){i=i||[],this.dirty&&(this.sortList(),this.dirty=!1);var n=this.axisIndex,s="x";1===n&&(s="y"),2===n&&(s="z");for(var r=this.axisList,o=(e.lowerBound[s],e.upperBound[s],0);o<r.length;o++){var a=r[o];a.aabbNeedsUpdate&&a.computeAABB(),a.aabb.overlaps(e)&&i.push(a)}return i}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(t,e,i){e.exports=a,t("./Constraint");var n=t("./PointToPointConstraint"),s=t("../equations/ConeEquation"),r=t("../equations/RotationalEquation"),o=(t("../equations/ContactEquation"),t("../math/Vec3"));function a(t,e,i){var a=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,h=i.pivotA?i.pivotA.clone():new o,l=i.pivotB?i.pivotB.clone():new o;this.axisA=i.axisA?i.axisA.clone():new o,this.axisB=i.axisB?i.axisB.clone():new o,n.call(this,t,h,e,l,a),this.collideConnected=!!i.collideConnected,this.angle=void 0!==i.angle?i.angle:0;var c=this.coneEquation=new s(t,e,i),u=this.twistEquation=new r(t,e,i);this.twistAngle=void 0!==i.twistAngle?i.twistAngle:0,c.maxForce=0,c.minForce=-a,u.maxForce=0,u.minForce=-a,this.equations.push(c,u)}a.prototype=new n,a.constructor=a,new o,new o,a.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=this.coneEquation,s=this.twistEquation;n.prototype.update.call(this),t.vectorToWorldFrame(this.axisA,i.axisA),e.vectorToWorldFrame(this.axisB,i.axisB),this.axisA.tangents(s.axisA,s.axisA),t.vectorToWorldFrame(s.axisA,s.axisA),this.axisB.tangents(s.axisB,s.axisB),e.vectorToWorldFrame(s.axisB,s.axisB),i.angle=this.angle,s.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(t,e,i){e.exports=s;var n=t("../utils/Utils");function s(t,e,i){i=n.defaults(i,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=t,this.bodyB=e,this.id=s.idCounter++,this.collideConnected=i.collideConnected,i.wakeUpBodies&&(t&&t.wakeUp(),e&&e.wakeUp())}s.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},s.prototype.enable=function(){for(var t=this.equations,e=0;e<t.length;e++)t[e].enabled=!0},s.prototype.disable=function(){for(var t=this.equations,e=0;e<t.length;e++)t[e].enabled=!1},s.idCounter=0},{"../utils/Utils":53}],14:[function(t,e,i){e.exports=r;var n=t("./Constraint"),s=t("../equations/ContactEquation");function r(t,e,i,r){n.call(this,t,e),void 0===i&&(i=t.position.distanceTo(e.position)),void 0===r&&(r=1e6),this.distance=i;var o=this.distanceEquation=new s(t,e);this.equations.push(o),o.minForce=-r,o.maxForce=r}r.prototype=new n,r.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=this.distanceEquation,n=.5*this.distance,s=i.ni;e.position.vsub(t.position,s),s.normalize(),s.mult(n,i.ri),s.mult(-n,i.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(t,e,i){e.exports=a,t("./Constraint");var n=t("./PointToPointConstraint"),s=t("../equations/RotationalEquation"),r=t("../equations/RotationalMotorEquation"),o=(t("../equations/ContactEquation"),t("../math/Vec3"));function a(t,e,i){var a=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,h=i.pivotA?i.pivotA.clone():new o,l=i.pivotB?i.pivotB.clone():new o;n.call(this,t,h,e,l,a),(this.axisA=i.axisA?i.axisA.clone():new o(1,0,0)).normalize(),(this.axisB=i.axisB?i.axisB.clone():new o(1,0,0)).normalize();var c=this.rotationalEquation1=new s(t,e,i),u=this.rotationalEquation2=new s(t,e,i),p=this.motorEquation=new r(t,e,a);p.enabled=!1,this.equations.push(c,u,p)}a.prototype=new n,a.constructor=a,a.prototype.enableMotor=function(){this.motorEquation.enabled=!0},a.prototype.disableMotor=function(){this.motorEquation.enabled=!1},a.prototype.setMotorSpeed=function(t){this.motorEquation.targetVelocity=t},a.prototype.setMotorMaxForce=function(t){this.motorEquation.maxForce=t,this.motorEquation.minForce=-t};var h=new o,l=new o;a.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=this.motorEquation,s=this.rotationalEquation1,r=this.rotationalEquation2,o=h,a=l,c=this.axisA,u=this.axisB;n.prototype.update.call(this),t.quaternion.vmult(c,o),e.quaternion.vmult(u,a),o.tangents(s.axisA,r.axisA),s.axisB.copy(a),r.axisB.copy(a),this.motorEquation.enabled&&(t.quaternion.vmult(this.axisA,i.axisA),e.quaternion.vmult(this.axisB,i.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(t,e,i){e.exports=o,t("./Constraint");var n=t("./PointToPointConstraint"),s=t("../equations/RotationalEquation"),r=(t("../equations/RotationalMotorEquation"),t("../equations/ContactEquation"),t("../math/Vec3"));function o(t,e,i){var o=void 0!==(i=i||{}).maxForce?i.maxForce:1e6,a=new r,h=new r,l=new r;t.position.vadd(e.position,l),l.scale(.5,l),e.pointToLocalFrame(l,h),t.pointToLocalFrame(l,a),n.call(this,t,a,e,h,o);var c=this.rotationalEquation1=new s(t,e,i),u=this.rotationalEquation2=new s(t,e,i),p=this.rotationalEquation3=new s(t,e,i);this.equations.push(c,u,p)}o.prototype=new n,o.constructor=o,new r,new r,o.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=(this.motorEquation,this.rotationalEquation1),s=this.rotationalEquation2,o=this.rotationalEquation3;n.prototype.update.call(this),t.vectorToWorldFrame(r.UNIT_X,i.axisA),e.vectorToWorldFrame(r.UNIT_Y,i.axisB),t.vectorToWorldFrame(r.UNIT_Y,s.axisA),e.vectorToWorldFrame(r.UNIT_Z,s.axisB),t.vectorToWorldFrame(r.UNIT_Z,o.axisA),e.vectorToWorldFrame(r.UNIT_X,o.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(t,e,i){e.exports=o;var n=t("./Constraint"),s=t("../equations/ContactEquation"),r=t("../math/Vec3");function o(t,e,i,o,a){n.call(this,t,i),a=void 0!==a?a:1e6,this.pivotA=e?e.clone():new r,this.pivotB=o?o.clone():new r;var h=this.equationX=new s(t,i),l=this.equationY=new s(t,i),c=this.equationZ=new s(t,i);this.equations.push(h,l,c),h.minForce=l.minForce=c.minForce=-a,h.maxForce=l.maxForce=c.maxForce=a,h.ni.set(1,0,0),l.ni.set(0,1,0),c.ni.set(0,0,1)}o.prototype=new n,o.prototype.update=function(){var t=this.bodyA,e=this.bodyB,i=this.equationX,n=this.equationY,s=this.equationZ;t.quaternion.vmult(this.pivotA,i.ri),e.quaternion.vmult(this.pivotB,i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj),s.ri.copy(i.ri),s.rj.copy(i.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(t,e,i){e.exports=r;var n=t("../math/Vec3"),s=(t("../math/Mat3"),t("./Equation"));function r(t,e,i){var r=void 0!==(i=i||{}).maxForce?i.maxForce:1e6;s.call(this,t,e,-r,r),this.axisA=i.axisA?i.axisA.clone():new n(1,0,0),this.axisB=i.axisB?i.axisB.clone():new n(0,1,0),this.angle=void 0!==i.angle?i.angle:0}r.prototype=new s,r.prototype.constructor=r;var o=new n,a=new n;r.prototype.computeB=function(t){var e=this.a,i=this.b,n=this.axisA,s=this.axisB,r=o,h=a,l=this.jacobianElementA,c=this.jacobianElementB;return n.cross(s,r),s.cross(n,h),l.rotational.copy(h),c.rotational.copy(r),-(Math.cos(this.angle)-n.dot(s))*e-this.computeGW()*i-t*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(t,e,i){e.exports=r;var n=t("./Equation"),s=t("../math/Vec3");function r(t,e,i){i=void 0!==i?i:1e6,n.call(this,t,e,0,i),this.restitution=0,this.ri=new s,this.rj=new s,this.ni=new s}t("../math/Mat3"),r.prototype=new n,r.prototype.constructor=r;var o=new s,a=new s,h=new s;r.prototype.computeB=function(t){var e=this.a,i=this.b,n=this.bi,s=this.bj,r=this.ri,l=this.rj,c=o,u=a,p=n.velocity,d=n.angularVelocity,m=(n.force,n.torque,s.velocity),f=s.angularVelocity,y=(s.force,s.torque,h),v=this.jacobianElementA,g=this.jacobianElementB,x=this.ni;r.cross(x,c),l.cross(x,u),x.negate(v.spatial),c.negate(v.rotational),g.spatial.copy(x),g.rotational.copy(u),y.copy(s.position),y.vadd(l,y),y.vsub(n.position,y),y.vsub(r,y);var b=x.dot(y),w=this.restitution+1;return-b*e-(w*m.dot(x)-w*p.dot(x)+f.dot(u)-d.dot(c))*i-t*this.computeGiMf()};var l=new s,c=new s,u=new s,p=new s,d=new s;r.prototype.getImpactVelocityAlongNormal=function(){var t=l,e=c,i=u,n=p,s=d;return this.bi.position.vadd(this.ri,i),this.bj.position.vadd(this.rj,n),this.bi.getVelocityAtWorldPoint(i,t),this.bj.getVelocityAtWorldPoint(n,e),t.vsub(e,s),this.ni.dot(s)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(t,e,i){e.exports=r;var n=t("../math/JacobianElement"),s=t("../math/Vec3");function r(t,e,i,s){this.id=r.id++,this.minForce=void 0===i?-1e6:i,this.maxForce=void 0===s?1e6:s,this.bi=t,this.bj=e,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new n,this.jacobianElementB=new n,this.enabled=!0,this.setSpookParams(1e7,4,1/60)}r.prototype.constructor=r,r.id=0,r.prototype.setSpookParams=function(t,e,i){var n=e,s=t,r=i;this.a=4/(r*(1+4*n)),this.b=4*n/(1+4*n),this.eps=4/(r*r*s*(1+4*n))},r.prototype.computeB=function(t,e,i){var n=this.computeGW();return-this.computeGq()*t-n*e-this.computeGiMf()*i},r.prototype.computeGq=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,n=this.bj,s=i.position,r=n.position;return t.spatial.dot(s)+e.spatial.dot(r)};var o=new s;r.prototype.computeGW=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,n=this.bj,s=i.velocity,r=n.velocity,a=i.angularVelocity||o,h=n.angularVelocity||o;return t.multiplyVectors(s,a)+e.multiplyVectors(r,h)},r.prototype.computeGWlambda=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,n=this.bj,s=i.vlambda,r=n.vlambda,a=i.wlambda||o,h=n.wlambda||o;return t.multiplyVectors(s,a)+e.multiplyVectors(r,h)};var a=new s,h=new s,l=new s,c=new s;r.prototype.computeGiMf=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,n=this.bj,s=i.force,r=i.torque,o=n.force,u=n.torque,p=i.invMassSolve,d=n.invMassSolve;return i.invInertiaWorldSolve?i.invInertiaWorldSolve.vmult(r,l):l.set(0,0,0),n.invInertiaWorldSolve?n.invInertiaWorldSolve.vmult(u,c):c.set(0,0,0),s.mult(p,a),o.mult(d,h),t.multiplyVectors(a,l)+e.multiplyVectors(h,c)};var u=new s;r.prototype.computeGiMGt=function(){var t=this.jacobianElementA,e=this.jacobianElementB,i=this.bi,n=this.bj,s=i.invMassSolve,r=n.invMassSolve,o=i.invInertiaWorldSolve,a=n.invInertiaWorldSolve,h=s+r;return o&&(o.vmult(t.rotational,u),h+=u.dot(t.rotational)),a&&(a.vmult(e.rotational,u),h+=u.dot(e.rotational)),h};var p=new s;new s,new s,new s,new s,new s,r.prototype.addToWlambda=function(t){var e=this.jacobianElementA,i=this.jacobianElementB,n=this.bi,s=this.bj,r=p;e.spatial.mult(n.invMassSolve*t,r),n.vlambda.vadd(r,n.vlambda),i.spatial.mult(s.invMassSolve*t,r),s.vlambda.vadd(r,s.vlambda),n.invInertiaWorldSolve&&(n.invInertiaWorldSolve.vmult(e.rotational,r),r.mult(t,r),n.wlambda.vadd(r,n.wlambda)),s.invInertiaWorldSolve&&(s.invInertiaWorldSolve.vmult(i.rotational,r),r.mult(t,r),s.wlambda.vadd(r,s.wlambda))},r.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(t,e,i){e.exports=r;var n=t("./Equation"),s=t("../math/Vec3");function r(t,e,i){n.call(this,t,e,-i,i),this.ri=new s,this.rj=new s,this.t=new s}t("../math/Mat3"),r.prototype=new n,r.prototype.constructor=r;var o=new s,a=new s;r.prototype.computeB=function(t){this.a;var e=this.b,i=(this.bi,this.bj,this.ri),n=this.rj,s=o,r=a,h=this.t;i.cross(h,s),n.cross(h,r);var l=this.jacobianElementA,c=this.jacobianElementB;return h.negate(l.spatial),s.negate(l.rotational),c.spatial.copy(h),c.rotational.copy(r),-this.computeGW()*e-t*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(t,e,i){e.exports=r;var n=t("../math/Vec3"),s=(t("../math/Mat3"),t("./Equation"));function r(t,e,i){var r=void 0!==(i=i||{}).maxForce?i.maxForce:1e6;s.call(this,t,e,-r,r),this.axisA=i.axisA?i.axisA.clone():new n(1,0,0),this.axisB=i.axisB?i.axisB.clone():new n(0,1,0),this.maxAngle=Math.PI/2}r.prototype=new s,r.prototype.constructor=r;var o=new n,a=new n;r.prototype.computeB=function(t){var e=this.a,i=this.b,n=this.axisA,s=this.axisB,r=o,h=a,l=this.jacobianElementA,c=this.jacobianElementB;return n.cross(s,r),s.cross(n,h),l.rotational.copy(h),c.rotational.copy(r),-(Math.cos(this.maxAngle)-n.dot(s))*e-this.computeGW()*i-t*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(t,e,i){e.exports=r;var n=t("../math/Vec3"),s=(t("../math/Mat3"),t("./Equation"));function r(t,e,i){i=void 0!==i?i:1e6,s.call(this,t,e,-i,i),this.axisA=new n,this.axisB=new n,this.targetVelocity=0}r.prototype=new s,r.prototype.constructor=r,r.prototype.computeB=function(t){this.a;var e=this.b,i=(this.bi,this.bj,this.axisA),n=this.axisB,s=this.jacobianElementA,r=this.jacobianElementB;return s.rotational.copy(i),n.negate(r.rotational),-(this.computeGW()-this.targetVelocity)*e-t*this.computeGiMf()}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(t,e,i){var n=t("../utils/Utils");function s(t,e,i){i=n.defaults(i,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=s.idCounter++,this.materials=[t,e],this.friction=i.friction,this.restitution=i.restitution,this.contactEquationStiffness=i.contactEquationStiffness,this.contactEquationRelaxation=i.contactEquationRelaxation,this.frictionEquationStiffness=i.frictionEquationStiffness,this.frictionEquationRelaxation=i.frictionEquationRelaxation}e.exports=s,s.idCounter=0},{"../utils/Utils":53}],25:[function(t,e,i){function n(t){var e="";"string"==typeof(t=t||{})?(e=t,t={}):"object"==typeof t&&(e=""),this.name=e,this.id=n.idCounter++,this.friction=void 0!==t.friction?t.friction:-1,this.restitution=void 0!==t.restitution?t.restitution:-1}e.exports=n,n.idCounter=0},{}],26:[function(t,e,i){e.exports=s;var n=t("./Vec3");function s(){this.spatial=new n,this.rotational=new n}s.prototype.multiplyElement=function(t){return t.spatial.dot(this.spatial)+t.rotational.dot(this.rotational)},s.prototype.multiplyVectors=function(t,e){return t.dot(this.spatial)+e.dot(this.rotational)}},{"./Vec3":30}],27:[function(t,e,i){e.exports=s;var n=t("./Vec3");function s(t){this.elements=t||[0,0,0,0,0,0,0,0,0]}s.prototype.identity=function(){var t=this.elements;t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1},s.prototype.setZero=function(){var t=this.elements;t[0]=0,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t[8]=0},s.prototype.setTrace=function(t){var e=this.elements;e[0]=t.x,e[4]=t.y,e[8]=t.z},s.prototype.getTrace=function(t){t=t||new n;var e=this.elements;t.x=e[0],t.y=e[4],t.z=e[8]},s.prototype.vmult=function(t,e){e=e||new n;var i=this.elements,s=t.x,r=t.y,o=t.z;return e.x=i[0]*s+i[1]*r+i[2]*o,e.y=i[3]*s+i[4]*r+i[5]*o,e.z=i[6]*s+i[7]*r+i[8]*o,e},s.prototype.smult=function(t){for(var e=0;e<this.elements.length;e++)this.elements[e]*=t},s.prototype.mmult=function(t,e){for(var i=e||new s,n=0;n<3;n++)for(var r=0;r<3;r++){for(var o=0,a=0;a<3;a++)o+=t.elements[n+3*a]*this.elements[a+3*r];i.elements[n+3*r]=o}return i},s.prototype.scale=function(t,e){e=e||new s;for(var i=this.elements,n=e.elements,r=0;3!==r;r++)n[3*r+0]=t.x*i[3*r+0],n[3*r+1]=t.y*i[3*r+1],n[3*r+2]=t.z*i[3*r+2];return e},s.prototype.solve=function(t,e){e=e||new n;for(var i,s=[],r=0;r<12;r++)s.push(0);for(r=0;r<3;r++)for(i=0;i<3;i++)s[r+4*i]=this.elements[r+3*i];s[3]=t.x,s[7]=t.y,s[11]=t.z;var o,a,h=3,l=h;do{if(0===s[(r=l-h)+4*r])for(i=r+1;i<l;i++)if(0!==s[r+4*i]){o=4;do{s[(a=4-o)+4*r]+=s[a+4*i]}while(--o);break}if(0!==s[r+4*r])for(i=r+1;i<l;i++){var c=s[r+4*i]/s[r+4*r];o=4;do{s[(a=4-o)+4*i]=a<=r?0:s[a+4*i]-s[a+4*r]*c}while(--o)}}while(--h);if(e.z=s[11]/s[10],e.y=(s[7]-s[6]*e.z)/s[5],e.x=(s[3]-s[2]*e.z-s[1]*e.y)/s[0],isNaN(e.x)||isNaN(e.y)||isNaN(e.z)||e.x===1/0||e.y===1/0||e.z===1/0)throw"Could not solve equation! Got x=["+e.toString()+"], b=["+t.toString()+"], A=["+this.toString()+"]";return e},s.prototype.e=function(t,e,i){if(void 0===i)return this.elements[e+3*t];this.elements[e+3*t]=i},s.prototype.copy=function(t){for(var e=0;e<t.elements.length;e++)this.elements[e]=t.elements[e];return this},s.prototype.toString=function(){for(var t="",e=0;e<9;e++)t+=this.elements[e]+",";return t},s.prototype.reverse=function(t){t=t||new s;for(var e,i=[],n=0;n<18;n++)i.push(0);for(n=0;n<3;n++)for(e=0;e<3;e++)i[n+6*e]=this.elements[n+3*e];i[3]=1,i[9]=0,i[15]=0,i[4]=0,i[10]=1,i[16]=0,i[5]=0,i[11]=0,i[17]=1;var r,o,a=3,h=a;do{if(0===i[(n=h-a)+6*n])for(e=n+1;e<h;e++)if(0!==i[n+6*e]){r=6;do{i[(o=6-r)+6*n]+=i[o+6*e]}while(--r);break}if(0!==i[n+6*n])for(e=n+1;e<h;e++){var l=i[n+6*e]/i[n+6*n];r=6;do{i[(o=6-r)+6*e]=o<=n?0:i[o+6*e]-i[o+6*n]*l}while(--r)}}while(--a);n=2;do{e=n-1;do{l=i[n+6*e]/i[n+6*n],r=6;do{i[(o=6-r)+6*e]=i[o+6*e]-i[o+6*n]*l}while(--r)}while(e--)}while(--n);n=2;do{l=1/i[n+6*n],r=6;do{i[(o=6-r)+6*n]=i[o+6*n]*l}while(--r)}while(n--);n=2;do{e=2;do{if(o=i[3+e+6*n],isNaN(o)||o===1/0)throw"Could not reverse! A=["+this.toString()+"]";t.e(n,e,o)}while(e--)}while(n--);return t},s.prototype.setRotationFromQuaternion=function(t){var e=t.x,i=t.y,n=t.z,s=t.w,r=e+e,o=i+i,a=n+n,h=e*r,l=e*o,c=e*a,u=i*o,p=i*a,d=n*a,m=s*r,f=s*o,y=s*a,v=this.elements;return v[0]=1-(u+d),v[1]=l-y,v[2]=c+f,v[3]=l+y,v[4]=1-(h+d),v[5]=p-m,v[6]=c-f,v[7]=p+m,v[8]=1-(h+u),this},s.prototype.transpose=function(t){for(var e=(t=t||new s).elements,i=this.elements,n=0;3!==n;n++)for(var r=0;3!==r;r++)e[3*n+r]=i[3*r+n];return t}},{"./Vec3":30}],28:[function(t,e,i){e.exports=s;var n=t("./Vec3");function s(t,e,i,n){this.x=void 0!==t?t:0,this.y=void 0!==e?e:0,this.z=void 0!==i?i:0,this.w=void 0!==n?n:1}s.prototype.set=function(t,e,i,n){this.x=t,this.y=e,this.z=i,this.w=n},s.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},s.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},s.prototype.setFromAxisAngle=function(t,e){var i=Math.sin(.5*e);this.x=t.x*i,this.y=t.y*i,this.z=t.z*i,this.w=Math.cos(.5*e)},s.prototype.toAxisAngle=function(t){t=t||new n,this.normalize();var e=2*Math.acos(this.w),i=Math.sqrt(1-this.w*this.w);return i<.001?(t.x=this.x,t.y=this.y,t.z=this.z):(t.x=this.x/i,t.y=this.y/i,t.z=this.z/i),[t,e]};var r=new n,o=new n;s.prototype.setFromVectors=function(t,e){if(t.isAntiparallelTo(e)){var i=r,n=o;t.tangents(i,n),this.setFromAxisAngle(i,Math.PI)}else{var s=t.cross(e);this.x=s.x,this.y=s.y,this.z=s.z,this.w=Math.sqrt(Math.pow(t.norm(),2)*Math.pow(e.norm(),2))+t.dot(e),this.normalize()}};var a=new n,h=new n,l=new n;s.prototype.mult=function(t,e){e=e||new s;var i=this.w,n=a,r=h,o=l;return n.set(this.x,this.y,this.z),r.set(t.x,t.y,t.z),e.w=i*t.w-n.dot(r),n.cross(r,o),e.x=i*r.x+t.w*n.x+o.x,e.y=i*r.y+t.w*n.y+o.y,e.z=i*r.z+t.w*n.z+o.z,e},s.prototype.inverse=function(t){var e=this.x,i=this.y,n=this.z,r=this.w;t=t||new s,this.conjugate(t);var o=1/(e*e+i*i+n*n+r*r);return t.x*=o,t.y*=o,t.z*=o,t.w*=o,t},s.prototype.conjugate=function(t){return(t=t||new s).x=-this.x,t.y=-this.y,t.z=-this.z,t.w=this.w,t},s.prototype.normalize=function(){var t=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t)},s.prototype.normalizeFast=function(){var t=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;0===t?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=t,this.y*=t,this.z*=t,this.w*=t)},s.prototype.vmult=function(t,e){e=e||new n;var i=t.x,s=t.y,r=t.z,o=this.x,a=this.y,h=this.z,l=this.w,c=l*i+a*r-h*s,u=l*s+h*i-o*r,p=l*r+o*s-a*i,d=-o*i-a*s-h*r;return e.x=c*l+d*-o+u*-h-p*-a,e.y=u*l+d*-a+p*-o-c*-h,e.z=p*l+d*-h+c*-a-u*-o,e},s.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},s.prototype.toEuler=function(t,e){var i,n,s;e=e||"YZX";var r=this.x,o=this.y,a=this.z,h=this.w;if("YZX"!==e)throw new Error("Euler order "+e+" not supported yet.");var l=r*o+a*h;if(l>.499&&(i=2*Math.atan2(r,h),n=Math.PI/2,s=0),l<-.499&&(i=-2*Math.atan2(r,h),n=-Math.PI/2,s=0),isNaN(i)){var c=r*r,u=o*o,p=a*a;i=Math.atan2(2*o*h-2*r*a,1-2*u-2*p),n=Math.asin(2*l),s=Math.atan2(2*r*h-2*o*a,1-2*c-2*p)}t.y=i,t.z=n,t.x=s},s.prototype.setFromEuler=function(t,e,i,n){n=n||"XYZ";var s=Math.cos(t/2),r=Math.cos(e/2),o=Math.cos(i/2),a=Math.sin(t/2),h=Math.sin(e/2),l=Math.sin(i/2);return"XYZ"===n?(this.x=a*r*o+s*h*l,this.y=s*h*o-a*r*l,this.z=s*r*l+a*h*o,this.w=s*r*o-a*h*l):"YXZ"===n?(this.x=a*r*o+s*h*l,this.y=s*h*o-a*r*l,this.z=s*r*l-a*h*o,this.w=s*r*o+a*h*l):"ZXY"===n?(this.x=a*r*o-s*h*l,this.y=s*h*o+a*r*l,this.z=s*r*l+a*h*o,this.w=s*r*o-a*h*l):"ZYX"===n?(this.x=a*r*o-s*h*l,this.y=s*h*o+a*r*l,this.z=s*r*l-a*h*o,this.w=s*r*o+a*h*l):"YZX"===n?(this.x=a*r*o+s*h*l,this.y=s*h*o+a*r*l,this.z=s*r*l-a*h*o,this.w=s*r*o-a*h*l):"XZY"===n&&(this.x=a*r*o-s*h*l,this.y=s*h*o-a*r*l,this.z=s*r*l+a*h*o,this.w=s*r*o+a*h*l),this},s.prototype.clone=function(){return new s(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(t,e,i){var n=t("./Vec3"),s=t("./Quaternion");function r(t){t=t||{},this.position=new n,t.position&&this.position.copy(t.position),this.quaternion=new s,t.quaternion&&this.quaternion.copy(t.quaternion)}e.exports=r;var o=new s;r.pointToLocalFrame=function(t,e,i,s){return s=s||new n,i.vsub(t,s),e.conjugate(o),o.vmult(s,s),s},r.prototype.pointToLocal=function(t,e){return r.pointToLocalFrame(this.position,this.quaternion,t,e)},r.pointToWorldFrame=function(t,e,i,s){return s=s||new n,e.vmult(i,s),s.vadd(t,s),s},r.prototype.pointToWorld=function(t,e){return r.pointToWorldFrame(this.position,this.quaternion,t,e)},r.prototype.vectorToWorldFrame=function(t,e){return e=e||new n,this.quaternion.vmult(t,e),e},r.vectorToWorldFrame=function(t,e,i){return t.vmult(e,i),i},r.vectorToLocalFrame=function(t,e,i,s){return s=s||new n,e.w*=-1,e.vmult(i,s),e.w*=-1,s}},{"./Quaternion":28,"./Vec3":30}],30:[function(t,e,i){e.exports=s;var n=t("./Mat3");function s(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0}s.ZERO=new s(0,0,0),s.UNIT_X=new s(1,0,0),s.UNIT_Y=new s(0,1,0),s.UNIT_Z=new s(0,0,1),s.prototype.cross=function(t,e){var i=t.x,n=t.y,r=t.z,o=this.x,a=this.y,h=this.z;return(e=e||new s).x=a*r-h*n,e.y=h*i-o*r,e.z=o*n-a*i,e},s.prototype.set=function(t,e,i){return this.x=t,this.y=e,this.z=i,this},s.prototype.setZero=function(){this.x=this.y=this.z=0},s.prototype.vadd=function(t,e){if(!e)return new s(this.x+t.x,this.y+t.y,this.z+t.z);e.x=t.x+this.x,e.y=t.y+this.y,e.z=t.z+this.z},s.prototype.vsub=function(t,e){if(!e)return new s(this.x-t.x,this.y-t.y,this.z-t.z);e.x=this.x-t.x,e.y=this.y-t.y,e.z=this.z-t.z},s.prototype.crossmat=function(){return new n([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},s.prototype.normalize=function(){var t=this.x,e=this.y,i=this.z,n=Math.sqrt(t*t+e*e+i*i);if(n>0){var s=1/n;this.x*=s,this.y*=s,this.z*=s}else this.x=0,this.y=0,this.z=0;return n},s.prototype.unit=function(t){t=t||new s;var e=this.x,i=this.y,n=this.z,r=Math.sqrt(e*e+i*i+n*n);return r>0?(r=1/r,t.x=e*r,t.y=i*r,t.z=n*r):(t.x=1,t.y=0,t.z=0),t},s.prototype.norm=function(){var t=this.x,e=this.y,i=this.z;return Math.sqrt(t*t+e*e+i*i)},s.prototype.length=s.prototype.norm,s.prototype.norm2=function(){return this.dot(this)},s.prototype.lengthSquared=s.prototype.norm2,s.prototype.distanceTo=function(t){var e=this.x,i=this.y,n=this.z,s=t.x,r=t.y,o=t.z;return Math.sqrt((s-e)*(s-e)+(r-i)*(r-i)+(o-n)*(o-n))},s.prototype.distanceSquared=function(t){var e=this.x,i=this.y,n=this.z,s=t.x,r=t.y,o=t.z;return(s-e)*(s-e)+(r-i)*(r-i)+(o-n)*(o-n)},s.prototype.mult=function(t,e){e=e||new s;var i=this.x,n=this.y,r=this.z;return e.x=t*i,e.y=t*n,e.z=t*r,e},s.prototype.scale=s.prototype.mult,s.prototype.dot=function(t){return this.x*t.x+this.y*t.y+this.z*t.z},s.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},s.prototype.negate=function(t){return(t=t||new s).x=-this.x,t.y=-this.y,t.z=-this.z,t};var r=new s,o=new s;s.prototype.tangents=function(t,e){var i=this.norm();if(i>0){var n=r,s=1/i;n.set(this.x*s,this.y*s,this.z*s);var a=o;Math.abs(n.x)<.9?(a.set(1,0,0),n.cross(a,t)):(a.set(0,1,0),n.cross(a,t)),n.cross(t,e)}else t.set(1,0,0),e.set(0,1,0)},s.prototype.toString=function(){return this.x+","+this.y+","+this.z},s.prototype.toArray=function(){return[this.x,this.y,this.z]},s.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},s.prototype.lerp=function(t,e,i){var n=this.x,s=this.y,r=this.z;i.x=n+(t.x-n)*e,i.y=s+(t.y-s)*e,i.z=r+(t.z-r)*e},s.prototype.almostEquals=function(t,e){return void 0===e&&(e=1e-6),!(Math.abs(this.x-t.x)>e||Math.abs(this.y-t.y)>e||Math.abs(this.z-t.z)>e)},s.prototype.almostZero=function(t){return void 0===t&&(t=1e-6),!(Math.abs(this.x)>t||Math.abs(this.y)>t||Math.abs(this.z)>t)};var a=new s;s.prototype.isAntiparallelTo=function(t,e){return this.negate(a),a.almostEquals(t,e)},s.prototype.clone=function(){return new s(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(t,e,i){e.exports=l;var n=t("../utils/EventTarget"),s=(t("../shapes/Shape"),t("../math/Vec3")),r=t("../math/Mat3"),o=t("../math/Quaternion"),a=(t("../material/Material"),t("../collision/AABB")),h=t("../shapes/Box");function l(t){t=t||{},n.apply(this),this.id=l.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new s,this.collisionFilterGroup="number"==typeof t.collisionFilterGroup?t.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof t.collisionFilterMask?t.collisionFilterMask:1,this.collisionResponse=!0,this.position=new s,t.position&&this.position.copy(t.position),this.previousPosition=new s,this.initPosition=new s,this.velocity=new s,t.velocity&&this.velocity.copy(t.velocity),this.initVelocity=new s,this.force=new s;var e="number"==typeof t.mass?t.mass:0;this.mass=e,this.invMass=e>0?1/e:0,this.material=t.material||null,this.linearDamping="number"==typeof t.linearDamping?t.linearDamping:.01,this.type=e<=0?l.STATIC:l.DYNAMIC,typeof t.type==typeof l.STATIC&&(this.type=t.type),this.allowSleep=void 0===t.allowSleep||t.allowSleep,this.sleepState=0,this.sleepSpeedLimit=void 0!==t.sleepSpeedLimit?t.sleepSpeedLimit:.1,this.sleepTimeLimit=void 0!==t.sleepTimeLimit?t.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new s,this.quaternion=new o,t.quaternion&&this.quaternion.copy(t.quaternion),this.initQuaternion=new o,this.angularVelocity=new s,t.angularVelocity&&this.angularVelocity.copy(t.angularVelocity),this.initAngularVelocity=new s,this.interpolatedPosition=new s,this.interpolatedQuaternion=new o,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new s,this.invInertia=new s,this.invInertiaWorld=new r,this.invMassSolve=0,this.invInertiaSolve=new s,this.invInertiaWorldSolve=new r,this.fixedRotation=void 0!==t.fixedRotation&&t.fixedRotation,this.angularDamping=void 0!==t.angularDamping?t.angularDamping:.01,this.aabb=new a,this.aabbNeedsUpdate=!0,this.wlambda=new s,t.shape&&this.addShape(t.shape),this.updateMassProperties()}l.prototype=new n,l.prototype.constructor=l,l.DYNAMIC=1,l.STATIC=2,l.KINEMATIC=4,l.AWAKE=0,l.SLEEPY=1,l.SLEEPING=2,l.idCounter=0,l.prototype.wakeUp=function(){var t=this.sleepState;this.sleepState=0,t===l.SLEEPING&&this.dispatchEvent({type:"wakeup"})},l.prototype.sleep=function(){this.sleepState=l.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},l.sleepyEvent={type:"sleepy"},l.sleepEvent={type:"sleep"},l.prototype.sleepTick=function(t){if(this.allowSleep){var e=this.sleepState,i=this.velocity.norm2()+this.angularVelocity.norm2(),n=Math.pow(this.sleepSpeedLimit,2);e===l.AWAKE&&i<n?(this.sleepState=l.SLEEPY,this.timeLastSleepy=t,this.dispatchEvent(l.sleepyEvent)):e===l.SLEEPY&&i>n?this.wakeUp():e===l.SLEEPY&&t-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(l.sleepEvent))}},l.prototype.updateSolveMassProperties=function(){this.sleepState===l.SLEEPING||this.type===l.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},l.prototype.pointToLocalFrame=function(t,e){return e=e||new s,t.vsub(this.position,e),this.quaternion.conjugate().vmult(e,e),e},l.prototype.vectorToLocalFrame=function(t,e){return e=e||new s,this.quaternion.conjugate().vmult(t,e),e},l.prototype.pointToWorldFrame=function(t,e){return e=e||new s,this.quaternion.vmult(t,e),e.vadd(this.position,e),e},l.prototype.vectorToWorldFrame=function(t,e){return e=e||new s,this.quaternion.vmult(t,e),e};var c=new s,u=new o;l.prototype.addShape=function(t,e,i){var n=new s,r=new o;return e&&n.copy(e),i&&r.copy(i),this.shapes.push(t),this.shapeOffsets.push(n),this.shapeOrientations.push(r),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this},l.prototype.updateBoundingRadius=function(){for(var t=this.shapes,e=this.shapeOffsets,i=t.length,n=0,s=0;s!==i;s++){var r=t[s];r.updateBoundingSphereRadius();var o=e[s].norm(),a=r.boundingSphereRadius;o+a>n&&(n=o+a)}this.boundingRadius=n};var p=new a;l.prototype.computeAABB=function(){for(var t=this.shapes,e=this.shapeOffsets,i=this.shapeOrientations,n=t.length,s=c,r=u,o=this.quaternion,a=this.aabb,h=p,l=0;l!==n;l++){var d=t[l];i[l].mult(o,r),r.vmult(e[l],s),s.vadd(this.position,s),d.calculateWorldAABB(s,r,h.lowerBound,h.upperBound),0===l?a.copy(h):a.extend(h)}this.aabbNeedsUpdate=!1};var d=new r,m=new r;new r,l.prototype.updateInertiaWorld=function(t){var e=this.invInertia;if(e.x!==e.y||e.y!==e.z||t){var i=d,n=m;i.setRotationFromQuaternion(this.quaternion),i.transpose(n),i.scale(e,i),i.mmult(n,this.invInertiaWorld)}};var f=new s,y=new s;l.prototype.applyForce=function(t,e){if(this.type===l.DYNAMIC){var i=f;e.vsub(this.position,i);var n=y;i.cross(t,n),this.force.vadd(t,this.force),this.torque.vadd(n,this.torque)}};var v=new s,g=new s;l.prototype.applyLocalForce=function(t,e){if(this.type===l.DYNAMIC){var i=v,n=g;this.vectorToWorldFrame(t,i),this.pointToWorldFrame(e,n),this.applyForce(i,n)}};var x=new s,b=new s,w=new s;l.prototype.applyImpulse=function(t,e){if(this.type===l.DYNAMIC){var i=x;e.vsub(this.position,i);var n=b;n.copy(t),n.mult(this.invMass,n),this.velocity.vadd(n,this.velocity);var s=w;i.cross(t,s),this.invInertiaWorld.vmult(s,s),this.angularVelocity.vadd(s,this.angularVelocity)}};var _=new s,M=new s;l.prototype.applyLocalImpulse=function(t,e){if(this.type===l.DYNAMIC){var i=_,n=M;this.vectorToWorldFrame(t,i),this.pointToWorldFrame(e,n),this.applyImpulse(i,n)}};var S=new s;l.prototype.updateMassProperties=function(){var t=S;this.invMass=this.mass>0?1/this.mass:0;var e=this.inertia,i=this.fixedRotation;this.computeAABB(),t.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),h.calculateInertia(t,this.mass,e),this.invInertia.set(e.x>0&&!i?1/e.x:0,e.y>0&&!i?1/e.y:0,e.z>0&&!i?1/e.z:0),this.updateInertiaWorld(!0)},l.prototype.getVelocityAtWorldPoint=function(t,e){var i=new s;return t.vsub(this.position,i),this.angularVelocity.cross(i,e),this.velocity.vadd(e,e),e}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(t,e,i){t("./Body");var n=t("../math/Vec3"),s=t("../math/Quaternion"),r=(t("../collision/RaycastResult"),t("../collision/Ray")),o=t("../objects/WheelInfo");function a(t){this.chassisBody=t.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==t.indexRightAxis?t.indexRightAxis:1,this.indexForwardAxis=void 0!==t.indexForwardAxis?t.indexForwardAxis:0,this.indexUpAxis=void 0!==t.indexUpAxis?t.indexUpAxis:2}e.exports=a,new n,new n,new n;var h=new n,l=new n,c=new n;new r,a.prototype.addWheel=function(t){var e=new o(t=t||{}),i=this.wheelInfos.length;return this.wheelInfos.push(e),i},a.prototype.setSteeringValue=function(t,e){this.wheelInfos[e].steering=t},new n,a.prototype.applyEngineForce=function(t,e){this.wheelInfos[e].engineForce=t},a.prototype.setBrake=function(t,e){this.wheelInfos[e].brake=t},a.prototype.addToWorld=function(t){this.constraints,t.add(this.chassisBody);var e=this;this.preStepCallback=function(){e.updateVehicle(t.dt)},t.addEventListener("preStep",this.preStepCallback),this.world=t},a.prototype.getVehicleAxisWorld=function(t,e){e.set(0===t?1:0,1===t?1:0,2===t?1:0),this.chassisBody.vectorToWorldFrame(e,e)},a.prototype.updateVehicle=function(t){for(var e=this.wheelInfos,i=e.length,s=this.chassisBody,r=0;r<i;r++)this.updateWheelTransform(r);this.currentVehicleSpeedKmHour=3.6*s.velocity.norm();var o=new n;for(this.getVehicleAxisWorld(this.indexForwardAxis,o),o.dot(s.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),r=0;r<i;r++)this.castRay(e[r]);this.updateSuspension(t);var a=new n,h=new n;for(r=0;r<i;r++){var l=(d=e[r]).suspensionForce;l>d.maxSuspensionForce&&(l=d.maxSuspensionForce),d.raycastResult.hitNormalWorld.scale(l*t,a),d.raycastResult.hitPointWorld.vsub(s.position,h),s.applyImpulse(a,d.raycastResult.hitPointWorld)}this.updateFriction(t);var c=new n,u=new n,p=new n;for(r=0;r<i;r++){var d=e[r];s.getVelocityAtWorldPoint(d.chassisConnectionPointWorld,p);var m=1;if(1===this.indexUpAxis&&(m=-1),d.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,u);var f=u.dot(d.raycastResult.hitNormalWorld);d.raycastResult.hitNormalWorld.scale(f,c),u.vsub(c,u);var y=u.dot(p);d.deltaRotation=m*y*t/d.radius}!d.sliding&&d.isInContact||0===d.engineForce||!d.useCustomSlidingRotationalSpeed||(d.deltaRotation=(d.engineForce>0?1:-1)*d.customSlidingRotationalSpeed*t),Math.abs(d.brake)>Math.abs(d.engineForce)&&(d.deltaRotation=0),d.rotation+=d.deltaRotation,d.deltaRotation*=.99}},a.prototype.updateSuspension=function(t){for(var e=this.chassisBody.mass,i=this.wheelInfos,n=i.length,s=0;s<n;s++){var r=i[s];if(r.isInContact){var o,a=r.suspensionRestLength-r.suspensionLength;o=r.suspensionStiffness*a*r.clippedInvContactDotSuspension;var h=r.suspensionRelativeVelocity;o-=(h<0?r.dampingCompression:r.dampingRelaxation)*h,r.suspensionForce=o*e,r.suspensionForce<0&&(r.suspensionForce=0)}else r.suspensionForce=0}},a.prototype.removeFromWorld=function(t){this.constraints,t.remove(this.chassisBody),t.removeEventListener("preStep",this.preStepCallback),this.world=null};var u=new n,p=new n;a.prototype.castRay=function(t){var e=u,i=p;this.updateWheelTransformWorld(t);var s=this.chassisBody,r=-1,o=t.suspensionRestLength+t.radius;t.directionWorld.scale(o,e);var a=t.chassisConnectionPointWorld;a.vadd(e,i);var h=t.raycastResult;h.reset();var l=s.collisionResponse;s.collisionResponse=!1,this.world.rayTest(a,i,h),s.collisionResponse=l;var c=h.body;if(t.raycastResult.groundObject=0,c){r=h.distance,t.raycastResult.hitNormalWorld=h.hitNormalWorld,t.isInContact=!0;var d=h.distance;t.suspensionLength=d-t.radius;var m=t.suspensionRestLength-t.maxSuspensionTravel,f=t.suspensionRestLength+t.maxSuspensionTravel;t.suspensionLength<m&&(t.suspensionLength=m),t.suspensionLength>f&&(t.suspensionLength=f,t.raycastResult.reset());var y=t.raycastResult.hitNormalWorld.dot(t.directionWorld),v=new n;s.getVelocityAtWorldPoint(t.raycastResult.hitPointWorld,v);var g=t.raycastResult.hitNormalWorld.dot(v);if(y>=-.1)t.suspensionRelativeVelocity=0,t.clippedInvContactDotSuspension=10;else{var x=-1/y;t.suspensionRelativeVelocity=g*x,t.clippedInvContactDotSuspension=x}}else t.suspensionLength=t.suspensionRestLength+0*t.maxSuspensionTravel,t.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.raycastResult.hitNormalWorld),t.clippedInvContactDotSuspension=1;return r},a.prototype.updateWheelTransformWorld=function(t){t.isInContact=!1;var e=this.chassisBody;e.pointToWorldFrame(t.chassisConnectionPointLocal,t.chassisConnectionPointWorld),e.vectorToWorldFrame(t.directionLocal,t.directionWorld),e.vectorToWorldFrame(t.axleLocal,t.axleWorld)},a.prototype.updateWheelTransform=function(t){var e=h,i=l,n=c,r=this.wheelInfos[t];this.updateWheelTransformWorld(r),r.directionLocal.scale(-1,e),i.copy(r.axleLocal),e.cross(i,n),n.normalize(),i.normalize();var o=r.steering,a=new s;a.setFromAxisAngle(e,o);var u=new s;u.setFromAxisAngle(i,r.rotation);var p=r.worldTransform.quaternion;this.chassisBody.quaternion.mult(a,p),p.mult(u,p),p.normalize();var d=r.worldTransform.position;d.copy(r.directionWorld),d.scale(r.suspensionLength,d),d.vadd(r.chassisConnectionPointWorld,d)};var d=[new n(1,0,0),new n(0,1,0),new n(0,0,1)];a.prototype.getWheelTransformWorld=function(t){return this.wheelInfos[t].worldTransform};var m=new n,f=[],y=[];a.prototype.updateFriction=function(t){for(var e=m,i=this.wheelInfos,s=i.length,r=this.chassisBody,o=y,a=f,h=0;h<s;h++)p=(z=i[h]).raycastResult.body,z.sideImpulse=0,z.forwardImpulse=0,o[h]||(o[h]=new n),a[h]||(a[h]=new n);for(h=0;h<s;h++)if(p=(z=i[h]).raycastResult.body){var l=a[h];this.getWheelTransformWorld(h).vectorToWorldFrame(d[this.indexRightAxis],l);var c=z.raycastResult.hitNormalWorld,u=l.dot(c);c.scale(u,e),l.vsub(e,l),l.normalize(),c.cross(l,o[h]),o[h].normalize(),z.sideImpulse=k(r,z.raycastResult.hitPointWorld,p,z.raycastResult.hitPointWorld,l),z.sideImpulse*=1}for(this.sliding=!1,h=0;h<s;h++){var p=(z=i[h]).raycastResult.body,v=0;if(z.slipInfo=1,p){var g=z.brake?z.brake:0;v=b(r,p,z.raycastResult.hitPointWorld,o[h],g);var x=g/(v+=z.engineForce*t);z.slipInfo*=x}if(z.forwardImpulse=0,z.skidInfo=1,p){z.skidInfo=1;var w=z.suspensionForce*t*z.frictionSlip,_=w*w;z.forwardImpulse=v;var M=.5*z.forwardImpulse,S=1*z.sideImpulse,A=M*M+S*S;z.sliding=!1,A>_&&(this.sliding=!0,z.sliding=!0,x=w/Math.sqrt(A),z.skidInfo*=x)}}if(this.sliding)for(h=0;h<s;h++)0!==(z=i[h]).sideImpulse&&z.skidInfo<1&&(z.forwardImpulse*=z.skidInfo,z.sideImpulse*=z.skidInfo);for(h=0;h<s;h++){var z=i[h],T=new n;if(T.copy(z.raycastResult.hitPointWorld),0!==z.forwardImpulse){var P=new n;o[h].scale(z.forwardImpulse,P),r.applyImpulse(P,T)}if(0!==z.sideImpulse){p=z.raycastResult.body;var E=new n;E.copy(z.raycastResult.hitPointWorld);var B=new n;a[h].scale(z.sideImpulse,B),r.pointToLocalFrame(T,T),T["xyz"[this.indexUpAxis]]*=z.rollInfluence,r.pointToWorldFrame(T,T),r.applyImpulse(B,T),B.scale(-1,B),p.applyImpulse(B,E)}}};var v=new n,g=new n,x=new n;function b(t,e,i,n,s){var r=0,o=i,a=v,h=g,l=x;return t.getVelocityAtWorldPoint(o,a),e.getVelocityAtWorldPoint(o,h),a.vsub(h,l),s<(r=-n.dot(l)*(1/(A(t,i,n)+A(e,i,n))))&&(r=s),r<-s&&(r=-s),r}var w=new n,_=new n,M=new n,S=new n;function A(t,e,i){var n=w,s=_,r=M,o=S;return e.vsub(t.position,n),n.cross(i,s),t.invInertiaWorld.vmult(s,o),o.cross(n,r),t.invMass+i.dot(r)}var z=new n,T=new n,P=new n;function k(t,e,i,n,s,r){if(s.norm2()>1.1)return 0;var o=z,a=T,h=P;return t.getVelocityAtWorldPoint(e,o),i.getVelocityAtWorldPoint(n,a),o.vsub(a,h),-.2*s.dot(h)*(1/(t.invMass+i.invMass))}},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(t,e,i){var n=t("./Body"),s=t("../shapes/Sphere"),r=t("../shapes/Box"),o=t("../math/Vec3"),a=t("../constraints/HingeConstraint");function h(t){if(this.wheelBodies=[],this.coordinateSystem=void 0===t.coordinateSystem?new o(1,2,3):t.coordinateSystem.clone(),this.chassisBody=t.chassisBody,!this.chassisBody){var e=new r(new o(5,2,.5));this.chassisBody=new n(1,e)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}e.exports=h,h.prototype.addWheel=function(t){var e=(t=t||{}).body;e||(e=new n(1,new s(1.2))),this.wheelBodies.push(e),this.wheelForces.push(0),new o;var i=void 0!==t.position?t.position.clone():new o,r=new o;this.chassisBody.pointToWorldFrame(i,r),e.position.set(r.x,r.y,r.z);var h=void 0!==t.axis?t.axis.clone():new o(0,1,0);this.wheelAxes.push(h);var l=new a(this.chassisBody,e,{pivotA:i,axisA:h,pivotB:o.ZERO,axisB:h,collideConnected:!1});return this.constraints.push(l),this.wheelBodies.length-1},h.prototype.setSteeringValue=function(t,e){var i=this.wheelAxes[e],n=Math.cos(t),s=Math.sin(t),r=i.x,o=i.y;this.constraints[e].axisA.set(n*r-s*o,s*r+n*o,0)},h.prototype.setMotorSpeed=function(t,e){var i=this.constraints[e];i.enableMotor(),i.motorTargetVelocity=t},h.prototype.disableMotor=function(t){this.constraints[t].disableMotor()};var l=new o;h.prototype.setWheelForce=function(t,e){this.wheelForces[e]=t},h.prototype.applyWheelForce=function(t,e){var i=this.wheelAxes[e],n=this.wheelBodies[e],s=n.torque;i.scale(t,l),n.vectorToWorldFrame(l,l),s.vadd(l,s)},h.prototype.addToWorld=function(t){for(var e=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),n=0;n<i.length;n++)t.add(i[n]);for(n=0;n<e.length;n++)t.addConstraint(e[n]);t.addEventListener("preStep",this._update.bind(this))},h.prototype._update=function(){for(var t=this.wheelForces,e=0;e<t.length;e++)this.applyWheelForce(t[e],e)},h.prototype.removeFromWorld=function(t){for(var e=this.constraints,i=this.wheelBodies.concat([this.chassisBody]),n=0;n<i.length;n++)t.remove(i[n]);for(n=0;n<e.length;n++)t.removeConstraint(e[n])};var c=new o;h.prototype.getWheelSpeed=function(t){var e=this.wheelAxes[t],i=this.wheelBodies[t].angularVelocity;return this.chassisBody.vectorToWorldFrame(e,c),i.dot(c)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(t,e,i){e.exports=s,t("../shapes/Shape");var n=t("../math/Vec3");function s(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}t("../math/Quaternion"),t("../shapes/Particle"),t("../objects/Body"),t("../material/Material"),s.prototype.add=function(t){this.particles.push(t),this.neighbors.length<this.particles.length&&this.neighbors.push([])},s.prototype.remove=function(t){var e=this.particles.indexOf(t);-1!==e&&(this.particles.splice(e,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var r=new n;s.prototype.getNeighbors=function(t,e){for(var i=this.particles.length,n=t.id,s=this.smoothingRadius*this.smoothingRadius,o=r,a=0;a!==i;a++){var h=this.particles[a];h.position.vsub(t.position,o),n!==h.id&&o.norm2()<s&&e.push(h)}};var o=new n,a=new n,h=new n,l=new n,c=new n,u=new n;s.prototype.update=function(){for(var t=this.particles.length,e=o,i=this.speedOfSound,n=this.eps,s=0;s!==t;s++){var r=this.particles[s];(S=this.neighbors[s]).length=0,this.getNeighbors(r,S),S.push(this.particles[s]);for(var p=S.length,d=0,m=0;m!==p;m++){r.position.vsub(S[m].position,e);var f=e.norm(),y=this.w(f);d+=S[m].mass*y}this.densities[s]=d,this.pressures[s]=i*i*(this.densities[s]-this.density)}var v=a,g=h,x=l,b=c,w=u;for(s=0;s!==t;s++){var _,M,S,A=this.particles[s];for(v.set(0,0,0),g.set(0,0,0),p=(S=this.neighbors[s]).length,m=0;m!==p;m++){var z=S[m];A.position.vsub(z.position,b);var T=b.norm();_=-z.mass*(this.pressures[s]/(this.densities[s]*this.densities[s]+n)+this.pressures[m]/(this.densities[m]*this.densities[m]+n)),this.gradw(b,x),x.mult(_,x),v.vadd(x,v),z.velocity.vsub(A.velocity,w),w.mult(1/(1e-4+this.densities[s]*this.densities[m])*this.viscosity*z.mass,w),M=this.nablaw(T),w.mult(M,w),g.vadd(w,g)}g.mult(A.mass,g),v.mult(A.mass,v),A.force.vadd(g,A.force),A.force.vadd(v,A.force)}},s.prototype.w=function(t){var e=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(e,9))*Math.pow(e*e-t*t,3)},s.prototype.gradw=function(t,e){var i=t.norm(),n=this.smoothingRadius;t.mult(945/(32*Math.PI*Math.pow(n,9))*Math.pow(n*n-i*i,2),e)},s.prototype.nablaw=function(t){var e=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(e,9))*(e*e-t*t)*(7*t*t-3*e*e)}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(t,e,i){var n=t("../math/Vec3");function s(t,e,i){i=i||{},this.restLength="number"==typeof i.restLength?i.restLength:1,this.stiffness=i.stiffness||100,this.damping=i.damping||1,this.bodyA=t,this.bodyB=e,this.localAnchorA=new n,this.localAnchorB=new n,i.localAnchorA&&this.localAnchorA.copy(i.localAnchorA),i.localAnchorB&&this.localAnchorB.copy(i.localAnchorB),i.worldAnchorA&&this.setWorldAnchorA(i.worldAnchorA),i.worldAnchorB&&this.setWorldAnchorB(i.worldAnchorB)}e.exports=s,s.prototype.setWorldAnchorA=function(t){this.bodyA.pointToLocalFrame(t,this.localAnchorA)},s.prototype.setWorldAnchorB=function(t){this.bodyB.pointToLocalFrame(t,this.localAnchorB)},s.prototype.getWorldAnchorA=function(t){this.bodyA.pointToWorldFrame(this.localAnchorA,t)},s.prototype.getWorldAnchorB=function(t){this.bodyB.pointToWorldFrame(this.localAnchorB,t)};var r=new n,o=new n,a=new n,h=new n,l=new n,c=new n,u=new n,p=new n,d=new n,m=new n,f=new n;s.prototype.applyForce=function(){var t=this.stiffness,e=this.damping,i=this.restLength,n=this.bodyA,s=this.bodyB,y=r,v=o,g=a,x=h,b=f,w=l,_=c,M=u,S=p,A=d,z=m;this.getWorldAnchorA(w),this.getWorldAnchorB(_),w.vsub(n.position,M),_.vsub(s.position,S),_.vsub(w,y);var T=y.norm();v.copy(y),v.normalize(),s.velocity.vsub(n.velocity,g),s.angularVelocity.cross(S,b),g.vadd(b,g),n.angularVelocity.cross(M,b),g.vsub(b,g),v.mult(-t*(T-i)-e*g.dot(v),x),n.force.vsub(x,n.force),s.force.vadd(x,s.force),M.cross(x,A),S.cross(x,z),n.torque.vsub(A,n.torque),s.torque.vadd(z,s.torque)}},{"../math/Vec3":30}],36:[function(t,e,i){var n=t("../math/Vec3"),s=t("../math/Transform"),r=t("../collision/RaycastResult"),o=t("../utils/Utils");function a(t){t=o.defaults(t,{chassisConnectionPointLocal:new n,chassisConnectionPointWorld:new n,directionLocal:new n,directionWorld:new n,axleLocal:new n,axleWorld:new n,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=t.maxSuspensionTravel,this.customSlidingRotationalSpeed=t.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=t.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=t.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=t.chassisConnectionPointWorld.clone(),this.directionLocal=t.directionLocal.clone(),this.directionWorld=t.directionWorld.clone(),this.axleLocal=t.axleLocal.clone(),this.axleWorld=t.axleWorld.clone(),this.suspensionRestLength=t.suspensionRestLength,this.suspensionMaxLength=t.suspensionMaxLength,this.radius=t.radius,this.suspensionStiffness=t.suspensionStiffness,this.dampingCompression=t.dampingCompression,this.dampingRelaxation=t.dampingRelaxation,this.frictionSlip=t.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=t.rollInfluence,this.maxSuspensionForce=t.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=t.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new r,this.worldTransform=new s,this.isInContact=!1}e.exports=a;var h=new n,l=new n;h=new n,a.prototype.updateWheel=function(t){var e=this.raycastResult;if(this.isInContact){var i=e.hitNormalWorld.dot(e.directionWorld);e.hitPointWorld.vsub(t.position,l),t.getVelocityAtWorldPoint(l,h);var n=e.hitNormalWorld.dot(h);if(i>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var s=-1/i;this.suspensionRelativeVelocity=n*s,this.clippedInvContactDotSuspension=s}}else e.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(t,e,i){e.exports=o;var n=t("./Shape"),s=t("../math/Vec3"),r=t("./ConvexPolyhedron");function o(t){n.call(this),this.type=n.types.BOX,this.halfExtents=t,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}o.prototype=new n,o.prototype.constructor=o,o.prototype.updateConvexPolyhedronRepresentation=function(){var t=this.halfExtents.x,e=this.halfExtents.y,i=this.halfExtents.z,n=s,o=[new n(-t,-e,-i),new n(t,-e,-i),new n(t,e,-i),new n(-t,e,-i),new n(-t,-e,i),new n(t,-e,i),new n(t,e,i),new n(-t,e,i)],a=(new n(0,0,1),new n(0,1,0),new n(1,0,0),new r(o,[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]]));this.convexPolyhedronRepresentation=a,a.material=this.material},o.prototype.calculateLocalInertia=function(t,e){return e=e||new s,o.calculateInertia(this.halfExtents,t,e),e},o.calculateInertia=function(t,e,i){var n=t;i.x=1/12*e*(2*n.y*2*n.y+2*n.z*2*n.z),i.y=1/12*e*(2*n.x*2*n.x+2*n.z*2*n.z),i.z=1/12*e*(2*n.y*2*n.y+2*n.x*2*n.x)},o.prototype.getSideNormals=function(t,e){var i=t,n=this.halfExtents;if(i[0].set(n.x,0,0),i[1].set(0,n.y,0),i[2].set(0,0,n.z),i[3].set(-n.x,0,0),i[4].set(0,-n.y,0),i[5].set(0,0,-n.z),void 0!==e)for(var s=0;s!==i.length;s++)e.vmult(i[s],i[s]);return i},o.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},o.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var a=new s;new s,o.prototype.forEachWorldCorner=function(t,e,i){for(var n=this.halfExtents,s=[[n.x,n.y,n.z],[-n.x,n.y,n.z],[-n.x,-n.y,n.z],[-n.x,-n.y,-n.z],[n.x,-n.y,-n.z],[n.x,n.y,-n.z],[-n.x,n.y,-n.z],[n.x,-n.y,n.z]],r=0;r<s.length;r++)a.set(s[r][0],s[r][1],s[r][2]),e.vmult(a,a),t.vadd(a,a),i(a.x,a.y,a.z)};var h=[new s,new s,new s,new s,new s,new s,new s,new s];o.prototype.calculateWorldAABB=function(t,e,i,n){var s=this.halfExtents;h[0].set(s.x,s.y,s.z),h[1].set(-s.x,s.y,s.z),h[2].set(-s.x,-s.y,s.z),h[3].set(-s.x,-s.y,-s.z),h[4].set(s.x,-s.y,-s.z),h[5].set(s.x,s.y,-s.z),h[6].set(-s.x,s.y,-s.z),h[7].set(s.x,-s.y,s.z);var r=h[0];e.vmult(r,r),t.vadd(r,r),n.copy(r),i.copy(r);for(var o=1;o<8;o++){r=h[o],e.vmult(r,r),t.vadd(r,r);var a=r.x,l=r.y,c=r.z;a>n.x&&(n.x=a),l>n.y&&(n.y=l),c>n.z&&(n.z=c),a<i.x&&(i.x=a),l<i.y&&(i.y=l),c<i.z&&(i.z=c)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(t,e,i){e.exports=o;var n=t("./Shape"),s=t("../math/Vec3"),r=(t("../math/Quaternion"),t("../math/Transform"));function o(t,e,i){n.call(this),this.type=n.types.CONVEXPOLYHEDRON,this.vertices=t||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=e||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=i?i.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}o.prototype=new n,o.prototype.constructor=o;var a=new s;o.prototype.computeEdges=function(){var t=this.faces,e=this.vertices,i=(e.length,this.uniqueEdges);i.length=0;for(var n=a,s=0;s!==t.length;s++)for(var r=t[s],o=r.length,h=0;h!==o;h++){var l=(h+1)%o;e[r[h]].vsub(e[r[l]],n),n.normalize();for(var c=!1,u=0;u!==i.length;u++)if(i[u].almostEquals(n)||i[u].almostEquals(n)){c=!0;break}c||i.push(n.clone())}},o.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var t=0;t<this.faces.length;t++){for(var e=0;e<this.faces[t].length;e++)if(!this.vertices[this.faces[t][e]])throw new Error("Vertex "+this.faces[t][e]+" not found!");var i=this.faceNormals[t]||new s;this.getFaceNormal(t,i),i.negate(i),this.faceNormals[t]=i;var n=this.vertices[this.faces[t][0]];if(i.dot(n)<0)for(console.error(".faceNormals["+t+"] = Vec3("+i.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule."),e=0;e<this.faces[t].length;e++)console.warn(".vertices["+this.faces[t][e]+"] = Vec3("+this.vertices[this.faces[t][e]].toString()+")")}};var h=new s,l=new s;o.computeNormal=function(t,e,i,n){e.vsub(t,l),i.vsub(e,h),h.cross(l,n),n.isZero()||n.normalize()},o.prototype.getFaceNormal=function(t,e){var i=this.faces[t],n=this.vertices[i[0]],s=this.vertices[i[1]],r=this.vertices[i[2]];return o.computeNormal(n,s,r,e)};var c=new s;o.prototype.clipAgainstHull=function(t,e,i,n,r,o,a,h,l){for(var u=c,p=-1,d=-Number.MAX_VALUE,m=0;m<i.faces.length;m++){u.copy(i.faceNormals[m]),r.vmult(u,u);var f=u.dot(o);f>d&&(d=f,p=m)}for(var y=[],v=i.faces[p],g=v.length,x=0;x<g;x++){var b=i.vertices[v[x]],w=new s;w.copy(b),r.vmult(w,w),n.vadd(w,w),y.push(w)}p>=0&&this.clipFaceAgainstHull(o,t,e,y,a,h,l)};var u=new s,p=new s,d=new s,m=new s,f=new s,y=new s;o.prototype.findSeparatingAxis=function(t,e,i,n,s,r,o,a){var h=u,l=p,c=d,v=m,g=f,x=y,b=Number.MAX_VALUE,w=this;if(w.uniqueAxes)for(M=0;M!==w.uniqueAxes.length;M++){if(i.vmult(w.uniqueAxes[M],h),!1===(z=w.testSepAxis(h,t,e,i,n,s)))return!1;z<b&&(b=z,r.copy(h))}else for(var _=o?o.length:w.faces.length,M=0;M<_;M++){var S=o?o[M]:M;if(h.copy(w.faceNormals[S]),i.vmult(h,h),!1===(z=w.testSepAxis(h,t,e,i,n,s)))return!1;z<b&&(b=z,r.copy(h))}if(t.uniqueAxes)for(M=0;M!==t.uniqueAxes.length;M++){if(s.vmult(t.uniqueAxes[M],l),!1===(z=w.testSepAxis(l,t,e,i,n,s)))return!1;z<b&&(b=z,r.copy(l))}else{var A=a?a.length:t.faces.length;for(M=0;M<A;M++){var z;if(S=a?a[M]:M,l.copy(t.faceNormals[S]),s.vmult(l,l),!1===(z=w.testSepAxis(l,t,e,i,n,s)))return!1;z<b&&(b=z,r.copy(l))}}for(var T=0;T!==w.uniqueEdges.length;T++){i.vmult(w.uniqueEdges[T],v);for(var P=0;P!==t.uniqueEdges.length;P++)if(s.vmult(t.uniqueEdges[P],g),v.cross(g,x),!x.almostZero()){x.normalize();var k=w.testSepAxis(x,t,e,i,n,s);if(!1===k)return!1;k<b&&(b=k,r.copy(x))}}return n.vsub(e,c),c.dot(r)>0&&r.negate(r),!0};var v=[],g=[];o.prototype.testSepAxis=function(t,e,i,n,s,r){o.project(this,t,i,n,v),o.project(e,t,s,r,g);var a=v[0],h=v[1],l=g[0],c=g[1];if(a<c||l<h)return!1;var u=a-c,p=l-h;return u<p?u:p};var x=new s,b=new s;o.prototype.calculateLocalInertia=function(t,e){this.computeLocalAABB(x,b);var i=b.x-x.x,n=b.y-x.y,s=b.z-x.z;e.x=1/12*t*(2*n*2*n+2*s*2*s),e.y=1/12*t*(2*i*2*i+2*s*2*s),e.z=1/12*t*(2*n*2*n+2*i*2*i)},o.prototype.getPlaneConstantOfFace=function(t){var e=this.faces[t],i=this.faceNormals[t],n=this.vertices[e[0]];return-i.dot(n)};var w=new s,_=new s,M=new s,S=new s,A=new s,z=new s,T=new s,P=new s;o.prototype.clipFaceAgainstHull=function(t,e,i,n,s,r,o){for(var a=w,h=_,l=M,c=S,u=A,p=z,d=T,m=P,f=this,y=n,v=[],g=-1,x=Number.MAX_VALUE,b=0;b<f.faces.length;b++){a.copy(f.faceNormals[b]),i.vmult(a,a);var k=a.dot(t);k<x&&(x=k,g=b)}if(!(g<0)){var E=f.faces[g];E.connectedFaces=[];for(var B=0;B<f.faces.length;B++)for(var C=0;C<f.faces[B].length;C++)-1!==E.indexOf(f.faces[B][C])&&B!==g&&-1===E.connectedFaces.indexOf(B)&&E.connectedFaces.push(B);y.length;for(var I=E.length,R=0;R<I;R++){var V=f.vertices[E[R]],F=f.vertices[E[(R+1)%I]];V.vsub(F,h),l.copy(h),i.vmult(l,l),e.vadd(l,l),c.copy(this.faceNormals[g]),i.vmult(c,c),e.vadd(c,c),l.cross(c,u),u.negate(u),p.copy(V),i.vmult(p,p),e.vadd(p,p),p.dot(u);var O=E.connectedFaces[R];d.copy(this.faceNormals[O]);var j=this.getPlaneConstantOfFace(O);m.copy(d),i.vmult(m,m);var N=j-m.dot(e);for(this.clipFaceAgainstPlane(y,v,m,N);y.length;)y.shift();for(;v.length;)y.push(v.shift())}for(d.copy(this.faceNormals[g]),j=this.getPlaneConstantOfFace(g),m.copy(d),i.vmult(m,m),N=j-m.dot(e),B=0;B<y.length;B++){var q=m.dot(y[B])+N;if(q<=s&&(console.log("clamped: depth="+q+" to minDist="+s),q=s),q<=r){var L=y[B];if(q<=0){var D={point:L,normal:m,depth:q};o.push(D)}}}}},o.prototype.clipFaceAgainstPlane=function(t,e,i,n){var r,o,a=t.length;if(a<2)return e;var h=t[t.length-1],l=t[0];r=i.dot(h)+n;for(var c=0;c<a;c++){if(l=t[c],o=i.dot(l)+n,r<0)if(o<0)(u=new s).copy(l),e.push(u);else{var u=new s;h.lerp(l,r/(r-o),u),e.push(u)}else o<0&&(u=new s,h.lerp(l,r/(r-o),u),e.push(u),e.push(l));h=l,r=o}return e},o.prototype.computeWorldVertices=function(t,e){for(var i=this.vertices.length;this.worldVertices.length<i;)this.worldVertices.push(new s);for(var n=this.vertices,r=this.worldVertices,o=0;o!==i;o++)e.vmult(n[o],r[o]),t.vadd(r[o],r[o]);this.worldVerticesNeedsUpdate=!1},new s,o.prototype.computeLocalAABB=function(t,e){var i=this.vertices.length,n=this.vertices;t.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),e.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var s=0;s<i;s++){var r=n[s];r.x<t.x?t.x=r.x:r.x>e.x&&(e.x=r.x),r.y<t.y?t.y=r.y:r.y>e.y&&(e.y=r.y),r.z<t.z?t.z=r.z:r.z>e.z&&(e.z=r.z)}},o.prototype.computeWorldFaceNormals=function(t){for(var e=this.faceNormals.length;this.worldFaceNormals.length<e;)this.worldFaceNormals.push(new s);for(var i=this.faceNormals,n=this.worldFaceNormals,r=0;r!==e;r++)t.vmult(i[r],n[r]);this.worldFaceNormalsNeedsUpdate=!1},o.prototype.updateBoundingSphereRadius=function(){for(var t=0,e=this.vertices,i=0,n=e.length;i!==n;i++){var s=e[i].norm2();s>t&&(t=s)}this.boundingSphereRadius=Math.sqrt(t)};var k=new s;o.prototype.calculateWorldAABB=function(t,e,i,n){for(var s,r,o,a,h,l,c=this.vertices.length,u=this.vertices,p=0;p<c;p++){k.copy(u[p]),e.vmult(k,k),t.vadd(k,k);var d=k;d.x<s||void 0===s?s=d.x:(d.x>a||void 0===a)&&(a=d.x),d.y<r||void 0===r?r=d.y:(d.y>h||void 0===h)&&(h=d.y),d.z<o||void 0===o?o=d.z:(d.z>l||void 0===l)&&(l=d.z)}i.set(s,r,o),n.set(a,h,l)},o.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},o.prototype.getAveragePointLocal=function(t){t=t||new s;for(var e=this.vertices.length,i=this.vertices,n=0;n<e;n++)t.vadd(i[n],t);return t.mult(1/e,t),t},o.prototype.transformAllPoints=function(t,e){var i=this.vertices.length,n=this.vertices;if(e){for(var s=0;s<i;s++){var r=n[s];e.vmult(r,r)}for(s=0;s<this.faceNormals.length;s++)r=this.faceNormals[s],e.vmult(r,r)}if(t)for(s=0;s<i;s++)(r=n[s]).vadd(t,r)};var E=new s,B=new s,C=new s;o.prototype.pointIsInside=function(t){var e=this.vertices.length,i=this.vertices,n=this.faces,s=this.faceNormals,r=this.faces.length,o=E;this.getAveragePointLocal(o);for(var a=0;a<r;a++){this.faces[a].length,e=s[a];var h=i[n[a][0]],l=B;t.vsub(h,l);var c=e.dot(l),u=C;o.vsub(h,u);var p=e.dot(u);if(c<0&&p>0||c>0&&p<0)return!1}return-1},new s;var I=new s,R=new s;o.project=function(t,e,i,n,s){var o=t.vertices.length,a=I,h=0,l=0,c=R,u=t.vertices;c.setZero(),r.vectorToLocalFrame(i,n,e,a),r.pointToLocalFrame(i,n,c,c);var p=c.dot(a);l=h=u[0].dot(a);for(var d=1;d<o;d++){var m=u[d].dot(a);m>h&&(h=m),m<l&&(l=m)}if((l-=p)>(h-=p)){var f=l;l=h,h=f}s[0]=h,s[1]=l}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(t,e,i){e.exports=o;var n=t("./Shape"),s=t("../math/Vec3"),r=(t("../math/Quaternion"),t("./ConvexPolyhedron"));function o(t,e,i,o){var a=o,h=[],l=[],c=[],u=[],p=[],d=Math.cos,m=Math.sin;h.push(new s(e*d(0),e*m(0),.5*-i)),u.push(0),h.push(new s(t*d(0),t*m(0),.5*i)),p.push(1);for(var f=0;f<a;f++){var y=2*Math.PI/a*(f+1),v=2*Math.PI/a*(f+.5);f<a-1?(h.push(new s(e*d(y),e*m(y),.5*-i)),u.push(2*f+2),h.push(new s(t*d(y),t*m(y),.5*i)),p.push(2*f+3),c.push([2*f+2,2*f+3,2*f+1,2*f])):c.push([0,1,2*f+1,2*f]),(a%2==1||f<a/2)&&l.push(new s(d(v),m(v),0))}c.push(p),l.push(new s(0,0,1));var g=[];for(f=0;f<u.length;f++)g.push(u[u.length-f-1]);c.push(g),this.type=n.types.CONVEXPOLYHEDRON,r.call(this,h,c,l)}o.prototype=new r},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(t,e,i){var n=t("./Shape"),s=t("./ConvexPolyhedron"),r=t("../math/Vec3"),o=t("../utils/Utils");function a(t,e){e=o.defaults(e,{maxValue:null,minValue:null,elementSize:1}),this.data=t,this.maxValue=e.maxValue,this.minValue=e.minValue,this.elementSize=e.elementSize,null===e.minValue&&this.updateMinValue(),null===e.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,n.call(this),this.pillarConvex=new s,this.pillarOffset=new r,this.type=n.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}e.exports=a,a.prototype=new n,a.prototype.update=function(){this._cachedPillars={}},a.prototype.updateMinValue=function(){for(var t=this.data,e=t[0][0],i=0;i!==t.length;i++)for(var n=0;n!==t[i].length;n++){var s=t[i][n];s<e&&(e=s)}this.minValue=e},a.prototype.updateMaxValue=function(){for(var t=this.data,e=t[0][0],i=0;i!==t.length;i++)for(var n=0;n!==t[i].length;n++){var s=t[i][n];s>e&&(e=s)}this.maxValue=e},a.prototype.setHeightValueAtIndex=function(t,e,i){this.data[t][e]=i,this.clearCachedConvexTrianglePillar(t,e,!1),t>0&&(this.clearCachedConvexTrianglePillar(t-1,e,!0),this.clearCachedConvexTrianglePillar(t-1,e,!1)),e>0&&(this.clearCachedConvexTrianglePillar(t,e-1,!0),this.clearCachedConvexTrianglePillar(t,e-1,!1)),e>0&&t>0&&this.clearCachedConvexTrianglePillar(t-1,e-1,!0)},a.prototype.getRectMinMax=function(t,e,i,n,s){s=s||[];for(var r=this.data,o=this.minValue,a=t;a<=i;a++)for(var h=e;h<=n;h++){var l=r[a][h];l>o&&(o=l)}s[0]=this.minValue,s[1]=o},a.prototype.getIndexOfPosition=function(t,e,i,n){var s=this.elementSize,r=this.data,o=Math.floor(t/s),a=Math.floor(e/s);return i[0]=o,i[1]=a,n&&(o<0&&(o=0),a<0&&(a=0),o>=r.length-1&&(o=r.length-1),a>=r[0].length-1&&(a=r[0].length-1)),!(o<0||a<0||o>=r.length-1||a>=r[0].length-1)},a.prototype.getHeightAt=function(t,e,i){var n=[];this.getIndexOfPosition(t,e,n,i);var s=[];return this.getRectMinMax(n[0],n[1]+1,n[0],n[1]+1,s),(s[0]+s[1])/2},a.prototype.getCacheConvexTrianglePillarKey=function(t,e,i){return t+"_"+e+"_"+(i?1:0)},a.prototype.getCachedConvexTrianglePillar=function(t,e,i){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,i)]},a.prototype.setCachedConvexTrianglePillar=function(t,e,i,n,s){this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,i)]={convex:n,offset:s}},a.prototype.clearCachedConvexTrianglePillar=function(t,e,i){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(t,e,i)]},a.prototype.getConvexTrianglePillar=function(t,e,i){var n=this.pillarConvex,o=this.pillarOffset;if(this.cacheEnabled){if(a=this.getCachedConvexTrianglePillar(t,e,i))return this.pillarConvex=a.convex,void(this.pillarOffset=a.offset);n=new s,o=new r,this.pillarConvex=n,this.pillarOffset=o}var a=this.data,h=this.elementSize,l=n.faces;n.vertices.length=6;for(var c=0;c<6;c++)n.vertices[c]||(n.vertices[c]=new r);for(l.length=5,c=0;c<5;c++)l[c]||(l[c]=[]);var u=n.vertices,p=(Math.min(a[t][e],a[t+1][e],a[t][e+1],a[t+1][e+1])-this.minValue)/2+this.minValue;i?(o.set((t+.75)*h,(e+.75)*h,p),u[0].set(.25*h,.25*h,a[t+1][e+1]-p),u[1].set(-.75*h,.25*h,a[t][e+1]-p),u[2].set(.25*h,-.75*h,a[t+1][e]-p),u[3].set(.25*h,.25*h,-p-1),u[4].set(-.75*h,.25*h,-p-1),u[5].set(.25*h,-.75*h,-p-1),l[0][0]=0,l[0][1]=1,l[0][2]=2,l[1][0]=5,l[1][1]=4,l[1][2]=3,l[2][0]=2,l[2][1]=5,l[2][2]=3,l[2][3]=0,l[3][0]=3,l[3][1]=4,l[3][2]=1,l[3][3]=0,l[4][0]=1,l[4][1]=4,l[4][2]=5,l[4][3]=2):(o.set((t+.25)*h,(e+.25)*h,p),u[0].set(-.25*h,-.25*h,a[t][e]-p),u[1].set(.75*h,-.25*h,a[t+1][e]-p),u[2].set(-.25*h,.75*h,a[t][e+1]-p),u[3].set(-.25*h,-.25*h,-p-1),u[4].set(.75*h,-.25*h,-p-1),u[5].set(-.25*h,.75*h,-p-1),l[0][0]=0,l[0][1]=1,l[0][2]=2,l[1][0]=5,l[1][1]=4,l[1][2]=3,l[2][0]=0,l[2][1]=2,l[2][2]=5,l[2][3]=3,l[3][0]=1,l[3][1]=0,l[3][2]=3,l[3][3]=4,l[4][0]=4,l[4][1]=5,l[4][2]=2,l[4][3]=1),n.computeNormals(),n.computeEdges(),n.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(t,e,i,n,o)},a.prototype.calculateLocalInertia=function(t,e){return(e=e||new r).set(0,0,0),e},a.prototype.volume=function(){return Number.MAX_VALUE},a.prototype.calculateWorldAABB=function(t,e,i,n){i.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),n.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},a.prototype.updateBoundingSphereRadius=function(){var t=this.data,e=this.elementSize;this.boundingSphereRadius=new r(t.length*e,t[0].length*e,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(t,e,i){e.exports=r;var n=t("./Shape"),s=t("../math/Vec3");function r(){n.call(this),this.type=n.types.PARTICLE}r.prototype=new n,r.prototype.constructor=r,r.prototype.calculateLocalInertia=function(t,e){return(e=e||new s).set(0,0,0),e},r.prototype.volume=function(){return 0},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},r.prototype.calculateWorldAABB=function(t,e,i,n){i.copy(t),n.copy(t)}},{"../math/Vec3":30,"./Shape":43}],42:[function(t,e,i){e.exports=r;var n=t("./Shape"),s=t("../math/Vec3");function r(){n.call(this),this.type=n.types.PLANE,this.worldNormal=new s,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}r.prototype=new n,r.prototype.constructor=r,r.prototype.computeWorldNormal=function(t){var e=this.worldNormal;e.set(0,0,1),t.vmult(e,e),this.worldNormalNeedsUpdate=!1},r.prototype.calculateLocalInertia=function(t,e){return e||new s},r.prototype.volume=function(){return Number.MAX_VALUE};var o=new s;r.prototype.calculateWorldAABB=function(t,e,i,n){o.set(0,0,1),e.vmult(o,o);var s=Number.MAX_VALUE;i.set(-s,-s,-s),n.set(s,s,s),1===o.x&&(n.x=t.x),1===o.y&&(n.y=t.y),1===o.z&&(n.z=t.z),-1===o.x&&(i.x=t.x),-1===o.y&&(i.y=t.y),-1===o.z&&(i.z=t.z)},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(t,e,i){e.exports=n;var n=t("./Shape");function n(){this.id=n.idCounter++,this.type=0,this.boundingSphereRadius=0,this.collisionResponse=!0,this.material=null}t("../math/Vec3"),t("../math/Quaternion"),t("../material/Material"),n.prototype.constructor=n,n.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},n.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},n.prototype.calculateLocalInertia=function(t,e){throw"calculateLocalInertia() not implemented for shape type "+this.type},n.idCounter=0,n.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(t,e,i){e.exports=r;var n=t("./Shape"),s=t("../math/Vec3");function r(t){if(n.call(this),this.radius=void 0!==t?Number(t):1,this.type=n.types.SPHERE,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}r.prototype=new n,r.prototype.constructor=r,r.prototype.calculateLocalInertia=function(t,e){e=e||new s;var i=2*t*this.radius*this.radius/5;return e.x=i,e.y=i,e.z=i,e},r.prototype.volume=function(){return 4*Math.PI*this.radius/3},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},r.prototype.calculateWorldAABB=function(t,e,i,n){for(var s=this.radius,r=["x","y","z"],o=0;o<r.length;o++){var a=r[o];i[a]=t[a]-s,n[a]=t[a]+s}}},{"../math/Vec3":30,"./Shape":43}],45:[function(t,e,i){e.exports=h;var n=t("./Shape"),s=t("../math/Vec3"),r=(t("../math/Quaternion"),t("../math/Transform")),o=t("../collision/AABB"),a=t("../utils/Octree");function h(t,e){n.call(this),this.type=n.types.TRIMESH,this.vertices=new Float32Array(t),this.indices=new Int16Array(e),this.normals=new Float32Array(e.length),this.aabb=new o,this.edges=null,this.scale=new s(1,1,1),this.tree=new a,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}h.prototype=new n,h.prototype.constructor=h;var l=new s;h.prototype.updateTree=function(){var t=this.tree;t.reset(),t.aabb.copy(this.aabb);var e=this.scale;t.aabb.lowerBound.x*=1/e.x,t.aabb.lowerBound.y*=1/e.y,t.aabb.lowerBound.z*=1/e.z,t.aabb.upperBound.x*=1/e.x,t.aabb.upperBound.y*=1/e.y,t.aabb.upperBound.z*=1/e.z;for(var i=new o,n=new s,r=new s,a=new s,h=[n,r,a],l=0;l<this.indices.length/3;l++){var c=3*l;this._getUnscaledVertex(this.indices[c],n),this._getUnscaledVertex(this.indices[c+1],r),this._getUnscaledVertex(this.indices[c+2],a),i.setFromPoints(h),t.insert(i,l)}t.removeEmptyNodes()};var c=new o;h.prototype.getTrianglesInAABB=function(t,e){c.copy(t);var i=this.scale,n=i.x,s=i.y,r=i.z,o=c.lowerBound,a=c.upperBound;return o.x/=n,o.y/=s,o.z/=r,a.x/=n,a.y/=s,a.z/=r,this.tree.aabbQuery(c,e)},h.prototype.setScale=function(t){var e=this.scale.x===this.scale.y===this.scale.z,i=t.x===t.y===t.z;e&&i||this.updateNormals(),this.scale.copy(t),this.updateAABB(),this.updateBoundingSphereRadius()},h.prototype.updateNormals=function(){for(var t=l,e=this.normals,i=0;i<this.indices.length/3;i++){var n=3*i,s=this.indices[n],r=this.indices[n+1],o=this.indices[n+2];this.getVertex(s,f),this.getVertex(r,y),this.getVertex(o,v),h.computeNormal(y,f,v,t),e[n]=t.x,e[n+1]=t.y,e[n+2]=t.z}},h.prototype.updateEdges=function(){for(var t={},e=function(e,i){t[s<r?s+"_"+r:r+"_"+s]=!0},i=0;i<this.indices.length/3;i++){var n=3*i,s=this.indices[n],r=this.indices[n+1];this.indices[n+2];e(),e(),e()}var o=Object.keys(t);for(this.edges=new Int16Array(2*o.length),i=0;i<o.length;i++){var a=o[i].split("_");this.edges[2*i]=parseInt(a[0],10),this.edges[2*i+1]=parseInt(a[1],10)}},h.prototype.getEdgeVertex=function(t,e,i){var n=this.edges[2*t+(e?1:0)];this.getVertex(n,i)};var u=new s,p=new s;h.prototype.getEdgeVector=function(t,e){var i=u,n=p;this.getEdgeVertex(t,0,i),this.getEdgeVertex(t,1,n),n.vsub(i,e)};var d=new s,m=new s;h.computeNormal=function(t,e,i,n){e.vsub(t,m),i.vsub(e,d),d.cross(m,n),n.isZero()||n.normalize()};var f=new s,y=new s,v=new s;h.prototype.getVertex=function(t,e){var i=this.scale;return this._getUnscaledVertex(t,e),e.x*=i.x,e.y*=i.y,e.z*=i.z,e},h.prototype._getUnscaledVertex=function(t,e){var i=3*t,n=this.vertices;return e.set(n[i],n[i+1],n[i+2])},h.prototype.getWorldVertex=function(t,e,i,n){return this.getVertex(t,n),r.pointToWorldFrame(e,i,n,n),n},h.prototype.getTriangleVertices=function(t,e,i,n){var s=3*t;this.getVertex(this.indices[s],e),this.getVertex(this.indices[s+1],i),this.getVertex(this.indices[s+2],n)},h.prototype.getNormal=function(t,e){var i=3*t;return e.set(this.normals[i],this.normals[i+1],this.normals[i+2])};var g=new o;h.prototype.calculateLocalInertia=function(t,e){this.computeLocalAABB(g);var i=g.upperBound.x-g.lowerBound.x,n=g.upperBound.y-g.lowerBound.y,s=g.upperBound.z-g.lowerBound.z;return e.set(1/12*t*(2*n*2*n+2*s*2*s),1/12*t*(2*i*2*i+2*s*2*s),1/12*t*(2*n*2*n+2*i*2*i))};var x=new s;h.prototype.computeLocalAABB=function(t){var e=t.lowerBound,i=t.upperBound,n=this.vertices.length,s=(this.vertices,x);this.getVertex(0,s),e.copy(s),i.copy(s);for(var r=0;r!==n;r++)this.getVertex(r,s),s.x<e.x?e.x=s.x:s.x>i.x&&(i.x=s.x),s.y<e.y?e.y=s.y:s.y>i.y&&(i.y=s.y),s.z<e.z?e.z=s.z:s.z>i.z&&(i.z=s.z)},h.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},h.prototype.updateBoundingSphereRadius=function(){for(var t=0,e=this.vertices,i=new s,n=0,r=e.length/3;n!==r;n++){this.getVertex(n,i);var o=i.norm2();o>t&&(t=o)}this.boundingSphereRadius=Math.sqrt(t)},new s;var b=new r,w=new o;h.prototype.calculateWorldAABB=function(t,e,i,n){var s=b,r=w;s.position=t,s.quaternion=e,this.aabb.toWorldFrame(s,r),i.copy(r.lowerBound),n.copy(r.upperBound)},h.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},h.createTorus=function(t,e,i,n,s){t=t||1,e=e||.5,i=i||8,n=n||6,s=s||2*Math.PI;for(var r=[],o=[],a=0;a<=i;a++)for(var l=0;l<=n;l++){var c=l/n*s,u=a/i*Math.PI*2,p=(t+e*Math.cos(u))*Math.cos(c),d=(t+e*Math.cos(u))*Math.sin(c),m=e*Math.sin(u);r.push(p,d,m)}for(a=1;a<=i;a++)for(l=1;l<=n;l++){var f=(n+1)*a+l-1,y=(n+1)*(a-1)+l-1,v=(n+1)*(a-1)+l,g=(n+1)*a+l;o.push(f,y,g),o.push(y,v,g)}return new h(r,o)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(t,e,i){e.exports=s,t("../math/Vec3"),t("../math/Quaternion");var n=t("./Solver");function s(){n.call(this),this.iterations=10,this.tolerance=1e-7}s.prototype=new n;var r=[],o=[],a=[];s.prototype.solve=function(t,e){var i,n,s,h,l,c=0,u=this.iterations,p=this.tolerance*this.tolerance,d=this.equations,m=d.length,f=e.bodies,y=f.length,v=t;if(0!==m)for(var g=0;g!==y;g++)f[g].updateSolveMassProperties();var x=o,b=a,w=r;for(x.length=m,b.length=m,w.length=m,g=0;g!==m;g++){var _=d[g];w[g]=0,b[g]=_.computeB(v),x[g]=1/_.computeC()}if(0!==m){for(g=0;g!==y;g++){var M=(z=f[g]).vlambda,S=z.wlambda;M.set(0,0,0),S&&S.set(0,0,0)}for(c=0;c!==u;c++){h=0;for(var A=0;A!==m;A++)_=d[A],i=b[A],n=x[A],(l=w[A])+(s=n*(i-_.computeGWlambda()-_.eps*l))<_.minForce?s=_.minForce-l:l+s>_.maxForce&&(s=_.maxForce-l),w[A]+=s,h+=s>0?s:-s,_.addToWlambda(s);if(h*h<p)break}for(g=0;g!==y;g++){var z,T=(z=f[g]).velocity,P=z.angularVelocity;T.vadd(z.vlambda,T),P&&P.vadd(z.wlambda,P)}}return c}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(t,e,i){function n(){this.equations=[]}e.exports=n,n.prototype.solve=function(t,e){return 0},n.prototype.addEquation=function(t){t.enabled&&this.equations.push(t)},n.prototype.removeEquation=function(t){var e=this.equations,i=e.indexOf(t);-1!==i&&e.splice(i,1)},n.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(t,e,i){e.exports=r,t("../math/Vec3"),t("../math/Quaternion");var n=t("./Solver"),s=t("../objects/Body");function r(t){for(n.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=t,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}r.prototype=new n;var o=[],a=[],h={bodies:[]},l=s.STATIC;function c(t){for(var e=t.length,i=0;i!==e;i++){var n=t[i];if(!(n.visited||n.body.type&l))return n}return!1}var u=[];function p(t,e,i,n){for(u.push(t),t.visited=!0,e(t,i,n);u.length;)for(var s,r=u.pop();s=c(r.children);)s.visited=!0,e(s,i,n),u.push(s)}function d(t,e,i){e.push(t.body);for(var n=t.eqs.length,s=0;s!==n;s++){var r=t.eqs[s];-1===i.indexOf(r)&&i.push(r)}}function m(t,e){return e.id-t.id}r.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},r.prototype.solve=function(t,e){for(var i=o,n=this.nodePool,s=e.bodies,r=this.equations,l=r.length,u=s.length,f=this.subsolver;n.length<u;)n.push(this.createNode());i.length=u;for(var y=0;y<u;y++)i[y]=n[y];for(y=0;y!==u;y++){var v=i[y];v.body=s[y],v.children.length=0,v.eqs.length=0,v.visited=!1}for(var g=0;g!==l;g++){var x=r[g],b=(y=s.indexOf(x.bi),s.indexOf(x.bj)),w=i[y],_=i[b];w.children.push(_),w.eqs.push(x),_.children.push(w),_.eqs.push(x)}var M,S=0,A=a;f.tolerance=this.tolerance,f.iterations=this.iterations;for(var z=h;M=c(i);){A.length=0,z.bodies.length=0,p(M,d,z.bodies,A);var T=A.length;for(A=A.sort(m),y=0;y!==T;y++)f.addEquation(A[y]);f.solve(t,z),f.removeAllEquations(),S++}return S}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(t,e,i){var n=function(){};e.exports=n,n.prototype={constructor:n,addEventListener:function(t,e){void 0===this._listeners&&(this._listeners={});var i=this._listeners;return void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e),this},hasEventListener:function(t,e){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)},removeEventListener:function(t,e){if(void 0===this._listeners)return this;var i=this._listeners;if(void 0===i[t])return this;var n=i[t].indexOf(e);return-1!==n&&i[t].splice(n,1),this},dispatchEvent:function(t){if(void 0===this._listeners)return this;var e=this._listeners[t.type];if(void 0!==e){t.target=this;for(var i=0,n=e.length;i<n;i++)e[i].call(this,t)}return this}}},{}],50:[function(t,e,i){var n=t("../collision/AABB"),s=t("../math/Vec3");function r(t){t=t||{},this.root=t.root||null,this.aabb=t.aabb?t.aabb.clone():new n,this.data=[],this.children=[]}function o(t,e){(e=e||{}).root=null,e.aabb=t,r.call(this,e),this.maxDepth=void 0!==e.maxDepth?e.maxDepth:8}e.exports=o,o.prototype=new r,r.prototype.reset=function(t,e){this.children.length=this.data.length=0},r.prototype.insert=function(t,e,i){var n=this.data;if(i=i||0,!this.aabb.contains(t))return!1;var s=this.children;if(i<(this.maxDepth||this.root.maxDepth)){var r=!1;s.length||(this.subdivide(),r=!0);for(var o=0;8!==o;o++)if(s[o].insert(t,e,i+1))return!0;r&&(s.length=0)}return n.push(e),!0};var a=new s;r.prototype.subdivide=function(){var t=this.aabb,e=t.lowerBound,i=t.upperBound,o=this.children;o.push(new r({aabb:new n({lowerBound:new s(0,0,0)})}),new r({aabb:new n({lowerBound:new s(1,0,0)})}),new r({aabb:new n({lowerBound:new s(1,1,0)})}),new r({aabb:new n({lowerBound:new s(1,1,1)})}),new r({aabb:new n({lowerBound:new s(0,1,1)})}),new r({aabb:new n({lowerBound:new s(0,0,1)})}),new r({aabb:new n({lowerBound:new s(1,0,1)})}),new r({aabb:new n({lowerBound:new s(0,1,0)})})),i.vsub(e,a),a.scale(.5,a);for(var h=this.root||this,l=0;8!==l;l++){var c=o[l];c.root=h;var u=c.aabb.lowerBound;u.x*=a.x,u.y*=a.y,u.z*=a.z,u.vadd(e,u),u.vadd(a,c.aabb.upperBound)}},r.prototype.aabbQuery=function(t,e){this.data,this.children;for(var i=[this];i.length;){var n=i.pop();n.aabb.overlaps(t)&&Array.prototype.push.apply(e,n.data),Array.prototype.push.apply(i,n.children)}return e};var h=new n;r.prototype.rayQuery=function(t,e,i){return t.getAABB(h),h.toLocalFrame(e,h),this.aabbQuery(h,i),i},r.prototype.removeEmptyNodes=function(){for(var t=[this];t.length;){for(var e=t.pop(),i=e.children.length-1;i>=0;i--)e.children[i].data.length||e.children.splice(i,1);Array.prototype.push.apply(t,e.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(t,e,i){function n(){this.objects=[],this.type=Object}e.exports=n,n.prototype.release=function(){for(var t=arguments.length,e=0;e!==t;e++)this.objects.push(arguments[e])},n.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},n.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(t,e,i){function n(){this.data={keys:[]}}e.exports=n,n.prototype.get=function(t,e){if(t>e){var i=e;e=t,t=i}return this.data[t+"-"+e]},n.prototype.set=function(t,e,i){if(t>e){var n=e;e=t,t=n}var s=t+"-"+e;this.get(t,e)||this.data.keys.push(s),this.data[s]=i},n.prototype.reset=function(){for(var t=this.data,e=t.keys;e.length>0;)delete t[e.pop()]}},{}],53:[function(t,e,i){function n(){}e.exports=n,n.defaults=function(t,e){for(var i in t=t||{},e)i in t||(t[i]=e[i]);return t}},{}],54:[function(t,e,i){e.exports=r;var n=t("../math/Vec3"),s=t("./Pool");function r(){s.call(this),this.type=n}r.prototype=new s,r.prototype.constructObject=function(){return new n}},{"../math/Vec3":30,"./Pool":51}],55:[function(t,e,i){e.exports=p;var n=t("../collision/AABB"),s=t("../shapes/Shape"),r=t("../collision/Ray"),o=t("../math/Vec3"),a=t("../math/Transform"),h=(t("../shapes/ConvexPolyhedron"),t("../math/Quaternion")),l=(t("../solver/Solver"),t("../utils/Vec3Pool")),c=t("../equations/ContactEquation"),u=t("../equations/FrictionEquation");function p(t){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new l,this.world=t,this.currentContactMaterial=null,this.enableFrictionReduction=!1}p.prototype.createContactEquation=function(t,e,i,n,s,r){var o;this.contactPointPool.length?((o=this.contactPointPool.pop()).bi=t,o.bj=e):o=new c(t,e),o.enabled=t.collisionResponse&&e.collisionResponse&&i.collisionResponse&&n.collisionResponse;var a=this.currentContactMaterial;o.restitution=a.restitution,o.setSpookParams(a.contactEquationStiffness,a.contactEquationRelaxation,this.world.dt);var h=i.material||t.material,l=n.material||e.material;return h&&l&&h.restitution>=0&&l.restitution>=0&&(o.restitution=h.restitution*l.restitution),o.si=s||i,o.sj=r||n,o},p.prototype.createFrictionEquationsFromContact=function(t,e){var i=t.bi,n=t.bj,s=t.si,r=t.sj,o=this.world,a=this.currentContactMaterial,h=a.friction,l=s.material||i.material,c=r.material||n.material;if(l&&c&&l.friction>=0&&c.friction>=0&&(h=l.friction*c.friction),h>0){var p=h*o.gravity.length(),d=i.invMass+n.invMass;d>0&&(d=1/d);var m=this.frictionEquationPool,f=m.length?m.pop():new u(i,n,p*d),y=m.length?m.pop():new u(i,n,p*d);return f.bi=y.bi=i,f.bj=y.bj=n,f.minForce=y.minForce=-p*d,f.maxForce=y.maxForce=p*d,f.ri.copy(t.ri),f.rj.copy(t.rj),y.ri.copy(t.ri),y.rj.copy(t.rj),t.ni.tangents(f.t,y.t),f.setSpookParams(a.frictionEquationStiffness,a.frictionEquationRelaxation,o.dt),y.setSpookParams(a.frictionEquationStiffness,a.frictionEquationRelaxation,o.dt),f.enabled=y.enabled=t.enabled,e.push(f,y),!0}return!1};var d=new o,m=new o,f=new o;p.prototype.createFrictionFromAverage=function(t){var e=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(e,this.frictionResult)&&1!==t){var i=this.frictionResult[this.frictionResult.length-2],n=this.frictionResult[this.frictionResult.length-1];d.setZero(),m.setZero(),f.setZero();for(var s=e.bi,r=(e.bj,0);r!==t;r++)(e=this.result[this.result.length-1-r]).bodyA!==s?(d.vadd(e.ni,d),m.vadd(e.ri,m),f.vadd(e.rj,f)):(d.vsub(e.ni,d),m.vadd(e.rj,m),f.vadd(e.ri,f));var o=1/t;m.scale(o,i.ri),f.scale(o,i.rj),n.ri.copy(i.ri),n.rj.copy(i.rj),d.normalize(),d.tangents(i.t,n.t)}};var y=new o,v=new o,g=new h,x=new h;p.prototype.getContacts=function(t,e,i,n,s,r,o){this.contactPointPool=s,this.frictionEquationPool=o,this.result=n,this.frictionResult=r;for(var a=g,h=x,l=y,c=v,u=0,p=t.length;u!==p;u++){var d=t[u],m=e[u],f=null;d.material&&m.material&&(f=i.getContactMaterial(d.material,m.material)||null);for(var b=0;b<d.shapes.length;b++){d.quaternion.mult(d.shapeOrientations[b],a),d.quaternion.vmult(d.shapeOffsets[b],l),l.vadd(d.position,l);for(var w=d.shapes[b],_=0;_<m.shapes.length;_++){m.quaternion.mult(m.shapeOrientations[_],h),m.quaternion.vmult(m.shapeOffsets[_],c),c.vadd(m.position,c);var M=m.shapes[_];if(!(l.distanceTo(c)>w.boundingSphereRadius+M.boundingSphereRadius)){var S=null;w.material&&M.material&&(S=i.getContactMaterial(w.material,M.material)||null),this.currentContactMaterial=S||f||i.defaultContactMaterial;var A=this[w.type|M.type];A&&(w.type<M.type?A.call(this,w,M,l,c,a,h,d,m,w,M):A.call(this,M,w,c,l,h,a,m,d,w,M))}}}}},p.prototype[s.types.BOX|s.types.BOX]=p.prototype.boxBox=function(t,e,i,n,s,r,o,a){t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,e.convexPolyhedronRepresentation,i,n,s,r,o,a,t,e)},p.prototype[s.types.BOX|s.types.CONVEXPOLYHEDRON]=p.prototype.boxConvex=function(t,e,i,n,s,r,o,a){t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(t.convexPolyhedronRepresentation,e,i,n,s,r,o,a,t,e)},p.prototype[s.types.BOX|s.types.PARTICLE]=p.prototype.boxParticle=function(t,e,i,n,s,r,o,a){t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexParticle(t.convexPolyhedronRepresentation,e,i,n,s,r,o,a,t,e)},p.prototype[s.types.SPHERE]=p.prototype.sphereSphere=function(t,e,i,n,s,r,o,a){var h=this.createContactEquation(o,a,t,e);n.vsub(i,h.ni),h.ni.normalize(),h.ri.copy(h.ni),h.rj.copy(h.ni),h.ri.mult(t.radius,h.ri),h.rj.mult(-e.radius,h.rj),h.ri.vadd(i,h.ri),h.ri.vsub(o.position,h.ri),h.rj.vadd(n,h.rj),h.rj.vsub(a.position,h.rj),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)};var b=new o,w=new o,_=new o;p.prototype[s.types.PLANE|s.types.TRIMESH]=p.prototype.planeTrimesh=function(t,e,i,n,s,r,h,l){var c=new o,u=b;u.set(0,0,1),s.vmult(u,u);for(var p=0;p<e.vertices.length/3;p++){e.getVertex(p,c);var d=new o;d.copy(c),a.pointToWorldFrame(n,r,d,c);var m=w;if(c.vsub(i,m),u.dot(m)<=0){var f=this.createContactEquation(h,l,t,e);f.ni.copy(u);var y=_;u.scale(m.dot(u),y),c.vsub(y,y),f.ri.copy(y),f.ri.vsub(h.position,f.ri),f.rj.copy(c),f.rj.vsub(l.position,f.rj),this.result.push(f),this.createFrictionEquationsFromContact(f,this.frictionResult)}}};var M=new o,S=new o,A=(new o,new o),z=new o,T=new o,P=new o,k=new o,E=new o,B=new o,C=new o,I=new o,R=new o,V=new o,F=new n,O=[];p.prototype[s.types.SPHERE|s.types.TRIMESH]=p.prototype.sphereTrimesh=function(t,e,i,n,s,o,h,l){var c=T,u=P,p=k,d=E,m=B,f=C,y=F,v=z,g=S,x=O;a.pointToLocalFrame(n,o,i,m);var b=t.radius;y.lowerBound.set(m.x-b,m.y-b,m.z-b),y.upperBound.set(m.x+b,m.y+b,m.z+b),e.getTrianglesInAABB(y,x);for(var w=A,_=t.radius*t.radius,j=0;j<x.length;j++)for(var N=0;N<3;N++)e.getVertex(e.indices[3*x[j]+N],w),w.vsub(m,g),g.norm2()<=_&&(v.copy(w),a.pointToWorldFrame(n,o,v,w),w.vsub(i,g),(D=this.createContactEquation(h,l,t,e)).ni.copy(g),D.ni.normalize(),D.ri.copy(D.ni),D.ri.scale(t.radius,D.ri),D.ri.vadd(i,D.ri),D.ri.vsub(h.position,D.ri),D.rj.copy(w),D.rj.vsub(l.position,D.rj),this.result.push(D),this.createFrictionEquationsFromContact(D,this.frictionResult));for(j=0;j<x.length;j++)for(N=0;N<3;N++){e.getVertex(e.indices[3*x[j]+N],c),e.getVertex(e.indices[3*x[j]+(N+1)%3],u),u.vsub(c,p),m.vsub(u,f);var q=f.dot(p);m.vsub(c,f);var L=f.dot(p);if(L>0&&q<0&&(m.vsub(c,f),d.copy(p),d.normalize(),L=f.dot(d),d.scale(L,f),f.vadd(c,f),(Y=f.distanceTo(m))<t.radius)){var D=this.createContactEquation(h,l,t,e);f.vsub(m,D.ni),D.ni.normalize(),D.ni.scale(t.radius,D.ri),a.pointToWorldFrame(n,o,f,f),f.vsub(l.position,D.rj),a.vectorToWorldFrame(o,D.ni,D.ni),a.vectorToWorldFrame(o,D.ri,D.ri),this.result.push(D),this.createFrictionEquationsFromContact(D,this.frictionResult)}}for(var W=I,U=R,H=V,G=M,X=(j=0,x.length);j!==X;j++){e.getTriangleVertices(x[j],W,U,H),e.getNormal(x[j],G),m.vsub(W,f);var Y=f.dot(G);G.scale(Y,f),m.vsub(f,f),Y=f.distanceTo(m),r.pointInTriangle(f,W,U,H)&&Y<t.radius&&(D=this.createContactEquation(h,l,t,e),f.vsub(m,D.ni),D.ni.normalize(),D.ni.scale(t.radius,D.ri),a.pointToWorldFrame(n,o,f,f),f.vsub(l.position,D.rj),a.vectorToWorldFrame(o,D.ni,D.ni),a.vectorToWorldFrame(o,D.ri,D.ri),this.result.push(D),this.createFrictionEquationsFromContact(D,this.frictionResult))}x.length=0};var j=new o,N=new o;p.prototype[s.types.SPHERE|s.types.PLANE]=p.prototype.spherePlane=function(t,e,i,n,s,r,o,a){var h=this.createContactEquation(o,a,t,e);if(h.ni.set(0,0,1),r.vmult(h.ni,h.ni),h.ni.negate(h.ni),h.ni.normalize(),h.ni.mult(t.radius,h.ri),i.vsub(n,j),h.ni.mult(h.ni.dot(j),N),j.vsub(N,h.rj),-j.dot(h.ni)<=t.radius){var l=h.ri,c=h.rj;l.vadd(i,l),l.vsub(o.position,l),c.vadd(n,c),c.vsub(a.position,c),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)}};var q=new o,L=new o,D=new o;function W(t,e,i){for(var n=null,s=t.length,r=0;r!==s;r++){var o=t[r],a=q;t[(r+1)%s].vsub(o,a);var h=L;a.cross(e,h);var l=D;i.vsub(o,l);var c=h.dot(l);if(!(null===n||c>0&&!0===n||c<=0&&!1===n))return!1;null===n&&(n=c>0)}return!0}var U=new o,H=new o,G=new o,X=new o,Y=[new o,new o,new o,new o,new o,new o],Z=new o,Q=new o,J=new o,$=new o;p.prototype[s.types.SPHERE|s.types.BOX]=p.prototype.sphereBox=function(t,e,i,n,s,r,o,a){var h=this.v3pool,l=Y;i.vsub(n,U),e.getSideNormals(l,r);for(var c=t.radius,u=!1,p=Q,d=J,m=$,f=null,y=0,v=0,g=0,x=null,b=0,w=l.length;b!==w&&!1===u;b++){var _=H;_.copy(l[b]);var M=_.norm();_.normalize();var S=U.dot(_);if(S<M+c&&S>0){var A=G,z=X;A.copy(l[(b+1)%3]),z.copy(l[(b+2)%3]);var T=A.norm(),P=z.norm();A.normalize(),z.normalize();var k=U.dot(A),E=U.dot(z);if(k<T&&k>-T&&E<P&&E>-P){var B=Math.abs(S-M-c);(null===x||B<x)&&(x=B,v=k,g=E,f=M,p.copy(_),d.copy(A),m.copy(z),y++)}}}if(y){u=!0;var C=this.createContactEquation(o,a,t,e);p.mult(-c,C.ri),C.ni.copy(p),C.ni.negate(C.ni),p.mult(f,p),d.mult(v,d),p.vadd(d,p),m.mult(g,m),p.vadd(m,C.rj),C.ri.vadd(i,C.ri),C.ri.vsub(o.position,C.ri),C.rj.vadd(n,C.rj),C.rj.vsub(a.position,C.rj),this.result.push(C),this.createFrictionEquationsFromContact(C,this.frictionResult)}for(var I=h.get(),R=Z,V=0;2!==V&&!u;V++)for(var F=0;2!==F&&!u;F++)for(var O=0;2!==O&&!u;O++)I.set(0,0,0),V?I.vadd(l[0],I):I.vsub(l[0],I),F?I.vadd(l[1],I):I.vsub(l[1],I),O?I.vadd(l[2],I):I.vsub(l[2],I),n.vadd(I,R),R.vsub(i,R),R.norm2()<c*c&&(u=!0,(C=this.createContactEquation(o,a,t,e)).ri.copy(R),C.ri.normalize(),C.ni.copy(C.ri),C.ri.mult(c,C.ri),C.rj.copy(I),C.ri.vadd(i,C.ri),C.ri.vsub(o.position,C.ri),C.rj.vadd(n,C.rj),C.rj.vsub(a.position,C.rj),this.result.push(C),this.createFrictionEquationsFromContact(C,this.frictionResult));h.release(I),I=null;var j=h.get(),N=h.get(),q=(C=h.get(),h.get()),L=(B=h.get(),l.length);for(V=0;V!==L&&!u;V++)for(F=0;F!==L&&!u;F++)if(V%3!=F%3){l[F].cross(l[V],j),j.normalize(),l[V].vadd(l[F],N),C.copy(i),C.vsub(N,C),C.vsub(n,C);var D=C.dot(j);for(j.mult(D,q),O=0;O===V%3||O===F%3;)O++;B.copy(i),B.vsub(q,B),B.vsub(N,B),B.vsub(n,B);var W=Math.abs(D),K=B.norm();if(W<l[O].norm()&&K<c){u=!0;var tt=this.createContactEquation(o,a,t,e);N.vadd(q,tt.rj),tt.rj.copy(tt.rj),B.negate(tt.ni),tt.ni.normalize(),tt.ri.copy(tt.rj),tt.ri.vadd(n,tt.ri),tt.ri.vsub(i,tt.ri),tt.ri.normalize(),tt.ri.mult(c,tt.ri),tt.ri.vadd(i,tt.ri),tt.ri.vsub(o.position,tt.ri),tt.rj.vadd(n,tt.rj),tt.rj.vsub(a.position,tt.rj),this.result.push(tt),this.createFrictionEquationsFromContact(tt,this.frictionResult)}}h.release(j,N,C,q,B)};var K=new o,tt=new o,et=new o,it=new o,nt=new o,st=new o,rt=new o,ot=new o,at=new o,ht=new o;p.prototype[s.types.SPHERE|s.types.CONVEXPOLYHEDRON]=p.prototype.sphereConvex=function(t,e,i,n,s,r,o,a){var h=this.v3pool;i.vsub(n,K);for(var l=e.faceNormals,c=e.faces,u=e.vertices,p=t.radius,d=0;d!==u.length;d++){var m=u[d],f=nt;r.vmult(m,f),n.vadd(f,f);var y=it;if(f.vsub(i,y),y.norm2()<p*p)return v=!0,(B=this.createContactEquation(o,a,t,e)).ri.copy(y),B.ri.normalize(),B.ni.copy(B.ri),B.ri.mult(p,B.ri),f.vsub(n,B.rj),B.ri.vadd(i,B.ri),B.ri.vsub(o.position,B.ri),B.rj.vadd(n,B.rj),B.rj.vsub(a.position,B.rj),this.result.push(B),void this.createFrictionEquationsFromContact(B,this.frictionResult)}for(var v=!1,g=(d=0,c.length);d!==g&&!1===v;d++){var x=l[d],b=c[d],w=st;r.vmult(x,w);var _=rt;r.vmult(u[b[0]],_),_.vadd(n,_);var M=ot;w.mult(-p,M),i.vadd(M,M);var S=at;M.vsub(_,S);var A=S.dot(w),z=ht;if(i.vsub(_,z),A<0&&z.dot(w)>0){for(var T=[],P=0,k=b.length;P!==k;P++){var E=h.get();r.vmult(u[b[P]],E),n.vadd(E,E),T.push(E)}if(W(T,w,i)){v=!0;var B=this.createContactEquation(o,a,t,e);w.mult(-p,B.ri),w.negate(B.ni);var C=h.get();w.mult(-A,C);var I=h.get();w.mult(-p,I),i.vsub(n,B.rj),B.rj.vadd(I,B.rj),B.rj.vadd(C,B.rj),B.rj.vadd(n,B.rj),B.rj.vsub(a.position,B.rj),B.ri.vadd(i,B.ri),B.ri.vsub(o.position,B.ri),h.release(C),h.release(I),this.result.push(B),this.createFrictionEquationsFromContact(B,this.frictionResult),P=0;for(var R=T.length;P!==R;P++)h.release(T[P]);return}for(P=0;P!==b.length;P++){var V=h.get(),F=h.get();r.vmult(u[b[(P+1)%b.length]],V),r.vmult(u[b[(P+2)%b.length]],F),n.vadd(V,V),n.vadd(F,F);var O=tt;F.vsub(V,O);var j=et;O.unit(j);var N=h.get(),q=h.get();i.vsub(V,q);var L=q.dot(j);j.mult(L,N),N.vadd(V,N);var D=h.get();if(N.vsub(i,D),L>0&&L*L<O.norm2()&&D.norm2()<p*p){for(B=this.createContactEquation(o,a,t,e),N.vsub(n,B.rj),N.vsub(i,B.ni),B.ni.normalize(),B.ni.mult(p,B.ri),B.rj.vadd(n,B.rj),B.rj.vsub(a.position,B.rj),B.ri.vadd(i,B.ri),B.ri.vsub(o.position,B.ri),this.result.push(B),this.createFrictionEquationsFromContact(B,this.frictionResult),P=0,R=T.length;P!==R;P++)h.release(T[P]);return h.release(V),h.release(F),h.release(N),h.release(D),void h.release(q)}h.release(V),h.release(F),h.release(N),h.release(D),h.release(q)}for(P=0,R=T.length;P!==R;P++)h.release(T[P])}}},new o,new o,p.prototype[s.types.PLANE|s.types.BOX]=p.prototype.planeBox=function(t,e,i,n,s,r,o,a){e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.planeConvex(t,e.convexPolyhedronRepresentation,i,n,s,r,o,a)};var lt=new o,ct=new o,ut=new o,pt=new o;p.prototype[s.types.PLANE|s.types.CONVEXPOLYHEDRON]=p.prototype.planeConvex=function(t,e,i,n,s,r,o,a){var h=lt,l=ct;l.set(0,0,1),s.vmult(l,l);for(var c=0,u=ut,p=0;p!==e.vertices.length;p++)if(h.copy(e.vertices[p]),r.vmult(h,h),n.vadd(h,h),h.vsub(i,u),l.dot(u)<=0){var d=this.createContactEquation(o,a,t,e),m=pt;l.mult(l.dot(u),m),h.vsub(m,m),m.vsub(i,d.ri),d.ni.copy(l),h.vsub(n,d.rj),d.ri.vadd(i,d.ri),d.ri.vsub(o.position,d.ri),d.rj.vadd(n,d.rj),d.rj.vsub(a.position,d.rj),this.result.push(d),c++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(d,this.frictionResult)}this.enableFrictionReduction&&c&&this.createFrictionFromAverage(c)};var dt=new o,mt=new o;p.prototype[s.types.CONVEXPOLYHEDRON]=p.prototype.convexConvex=function(t,e,i,n,s,r,o,a,h,l,c,u){var p=dt;if(!(i.distanceTo(n)>t.boundingSphereRadius+e.boundingSphereRadius)&&t.findSeparatingAxis(e,i,s,n,r,p,c,u)){var d=[],m=mt;t.clipAgainstHull(i,s,e,n,r,p,-100,100,d);for(var f=0,y=0;y!==d.length;y++){var v=this.createContactEquation(o,a,t,e,h,l),g=v.ri,x=v.rj;p.negate(v.ni),d[y].normal.negate(m),m.mult(d[y].depth,m),d[y].point.vadd(m,g),x.copy(d[y].point),g.vsub(i,g),x.vsub(n,x),g.vadd(i,g),g.vsub(o.position,g),x.vadd(n,x),x.vsub(a.position,x),this.result.push(v),f++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(v,this.frictionResult)}this.enableFrictionReduction&&f&&this.createFrictionFromAverage(f)}};var ft=new o,yt=new o,vt=new o;p.prototype[s.types.PLANE|s.types.PARTICLE]=p.prototype.planeParticle=function(t,e,i,n,s,r,o,a){var h=ft;h.set(0,0,1),o.quaternion.vmult(h,h);var l=yt;if(n.vsub(o.position,l),h.dot(l)<=0){var c=this.createContactEquation(a,o,e,t);c.ni.copy(h),c.ni.negate(c.ni),c.ri.set(0,0,0);var u=vt;h.mult(h.dot(n),u),n.vsub(u,u),c.rj.copy(u),this.result.push(c),this.createFrictionEquationsFromContact(c,this.frictionResult)}};var gt=new o;p.prototype[s.types.PARTICLE|s.types.SPHERE]=p.prototype.sphereParticle=function(t,e,i,n,s,r,o,a){var h=gt;if(h.set(0,0,1),n.vsub(i,h),h.norm2()<=t.radius*t.radius){var l=this.createContactEquation(a,o,e,t);h.normalize(),l.rj.copy(h),l.rj.mult(t.radius,l.rj),l.ni.copy(h),l.ni.negate(l.ni),l.ri.set(0,0,0),this.result.push(l),this.createFrictionEquationsFromContact(l,this.frictionResult)}};var xt=new h,bt=new o,wt=(new o,new o),_t=new o,Mt=new o;p.prototype[s.types.PARTICLE|s.types.CONVEXPOLYHEDRON]=p.prototype.convexParticle=function(t,e,i,n,s,r,o,a){var h=-1,l=wt,c=Mt,u=null,p=bt;if(p.copy(n),p.vsub(i,p),s.conjugate(xt),xt.vmult(p,p),t.pointIsInside(p)){t.worldVerticesNeedsUpdate&&t.computeWorldVertices(i,s),t.worldFaceNormalsNeedsUpdate&&t.computeWorldFaceNormals(s);for(var d=0,m=t.faces.length;d!==m;d++){var f=[t.worldVertices[t.faces[d][0]]],y=t.worldFaceNormals[d];n.vsub(f[0],_t);var v=-y.dot(_t);(null===u||Math.abs(v)<Math.abs(u))&&(u=v,h=d,l.copy(y))}if(-1!==h){var g=this.createContactEquation(a,o,e,t);l.mult(u,c),c.vadd(n,c),c.vsub(i,c),g.rj.copy(c),l.negate(g.ni),g.ri.set(0,0,0);var x=g.ri,b=g.rj;x.vadd(n,x),x.vsub(a.position,x),b.vadd(i,b),b.vsub(o.position,b),this.result.push(g),this.createFrictionEquationsFromContact(g,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},p.prototype[s.types.BOX|s.types.HEIGHTFIELD]=p.prototype.boxHeightfield=function(t,e,i,n,s,r,o,a){t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexHeightfield(t.convexPolyhedronRepresentation,e,i,n,s,r,o,a)};var St=new o,At=new o,zt=[0];p.prototype[s.types.CONVEXPOLYHEDRON|s.types.HEIGHTFIELD]=p.prototype.convexHeightfield=function(t,e,i,n,s,r,o,h){var l=e.data,c=e.elementSize,u=t.boundingSphereRadius,p=At,d=zt,m=St;a.pointToLocalFrame(n,r,i,m);var f=Math.floor((m.x-u)/c)-1,y=Math.ceil((m.x+u)/c)+1,v=Math.floor((m.y-u)/c)-1,g=Math.ceil((m.y+u)/c)+1;if(!(y<0||g<0||f>l.length||v>l[0].length)){f<0&&(f=0),y<0&&(y=0),v<0&&(v=0),g<0&&(g=0),f>=l.length&&(f=l.length-1),y>=l.length&&(y=l.length-1),g>=l[0].length&&(g=l[0].length-1),v>=l[0].length&&(v=l[0].length-1);var x=[];e.getRectMinMax(f,v,y,g,x);var b=x[0],w=x[1];if(!(m.z-u>w||m.z+u<b))for(var _=f;_<y;_++)for(var M=v;M<g;M++)e.getConvexTrianglePillar(_,M,!1),a.pointToWorldFrame(n,r,e.pillarOffset,p),i.distanceTo(p)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.convexConvex(t,e.pillarConvex,i,p,s,r,o,h,null,null,d,null),e.getConvexTrianglePillar(_,M,!0),a.pointToWorldFrame(n,r,e.pillarOffset,p),i.distanceTo(p)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.convexConvex(t,e.pillarConvex,i,p,s,r,o,h,null,null,d,null)}};var Tt=new o,Pt=new o;p.prototype[s.types.SPHERE|s.types.HEIGHTFIELD]=p.prototype.sphereHeightfield=function(t,e,i,n,s,r,o,h){var l=e.data,c=t.radius,u=e.elementSize,p=Pt,d=Tt;a.pointToLocalFrame(n,r,i,d);var m=Math.floor((d.x-c)/u)-1,f=Math.ceil((d.x+c)/u)+1,y=Math.floor((d.y-c)/u)-1,v=Math.ceil((d.y+c)/u)+1;if(!(f<0||v<0||m>l.length||v>l[0].length)){m<0&&(m=0),f<0&&(f=0),y<0&&(y=0),v<0&&(v=0),m>=l.length&&(m=l.length-1),f>=l.length&&(f=l.length-1),v>=l[0].length&&(v=l[0].length-1),y>=l[0].length&&(y=l[0].length-1);var g=[];e.getRectMinMax(m,y,f,v,g);var x=g[0],b=g[1];if(!(d.z-c>b||d.z+c<x))for(var w=this.result,_=m;_<f;_++)for(var M=y;M<v;M++){var S=w.length;if(e.getConvexTrianglePillar(_,M,!1),a.pointToWorldFrame(n,r,e.pillarOffset,p),i.distanceTo(p)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.sphereConvex(t,e.pillarConvex,i,p,s,r,o,h),e.getConvexTrianglePillar(_,M,!0),a.pointToWorldFrame(n,r,e.pillarOffset,p),i.distanceTo(p)<e.pillarConvex.boundingSphereRadius+t.boundingSphereRadius&&this.sphereConvex(t,e.pillarConvex,i,p,s,r,o,h),w.length-S>2)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(t,e,i){e.exports=g;var n=t("../shapes/Shape"),s=t("../math/Vec3"),r=t("../math/Quaternion"),o=t("../solver/GSSolver"),a=(t("../utils/Vec3Pool"),t("../equations/ContactEquation"),t("../equations/FrictionEquation"),t("./Narrowphase")),h=t("../utils/EventTarget"),l=t("../collision/ArrayCollisionMatrix"),c=t("../material/Material"),u=t("../material/ContactMaterial"),p=t("../objects/Body"),d=t("../utils/TupleDictionary"),m=t("../collision/RaycastResult"),f=t("../collision/AABB"),y=t("../collision/Ray"),v=t("../collision/NaiveBroadphase");function g(){h.apply(this),this.dt=-1,this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new s,this.broadphase=new v,this.bodies=[],this.solver=new o,this.constraints=[],this.narrowphase=new a(this),this.collisionMatrix=new l,this.collisionMatrixPrevious=new l,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new d,this.defaultMaterial=new c("default"),this.defaultContactMaterial=new u(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}g.prototype=new h,new f;var x=new y;if(g.prototype.getContactMaterial=function(t,e){return this.contactMaterialTable.get(t.id,e.id)},g.prototype.numObjects=function(){return this.bodies.length},g.prototype.collisionMatrixTick=function(){var t=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=t,this.collisionMatrix.reset()},g.prototype.add=g.prototype.addBody=function(t){-1===this.bodies.indexOf(t)&&(t.index=this.bodies.length,this.bodies.push(t),t.world=this,t.initPosition.copy(t.position),t.initVelocity.copy(t.velocity),t.timeLastSleepy=this.time,t instanceof p&&(t.initAngularVelocity.copy(t.angularVelocity),t.initQuaternion.copy(t.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=t,this.dispatchEvent(this.addBodyEvent))},g.prototype.addConstraint=function(t){this.constraints.push(t)},g.prototype.removeConstraint=function(t){var e=this.constraints.indexOf(t);-1!==e&&this.constraints.splice(e,1)},g.prototype.rayTest=function(t,e,i){i instanceof m?this.raycastClosest(t,e,{skipBackfaces:!0},i):this.raycastAll(t,e,{skipBackfaces:!0},i)},g.prototype.raycastAll=function(t,e,i,n){return i.mode=y.ALL,i.from=t,i.to=e,i.callback=n,x.intersectWorld(this,i)},g.prototype.raycastAny=function(t,e,i,n){return i.mode=y.ANY,i.from=t,i.to=e,i.result=n,x.intersectWorld(this,i)},g.prototype.raycastClosest=function(t,e,i,n){return i.mode=y.CLOSEST,i.from=t,i.to=e,i.result=n,x.intersectWorld(this,i)},g.prototype.remove=function(t){t.world=null;var e=this.bodies.length-1,i=this.bodies,n=i.indexOf(t);if(-1!==n){i.splice(n,1);for(var s=0;s!==i.length;s++)i[s].index=s;this.collisionMatrix.setNumObjects(e),this.removeBodyEvent.body=t,this.dispatchEvent(this.removeBodyEvent)}},g.prototype.removeBody=g.prototype.remove,g.prototype.addMaterial=function(t){this.materials.push(t)},g.prototype.addContactMaterial=function(t){this.contactmaterials.push(t),this.contactMaterialTable.set(t.materials[0].id,t.materials[1].id,t)},"undefined"==typeof performance&&(performance={}),!performance.now){var b=Date.now();performance.timing&&performance.timing.navigationStart&&(b=performance.timing.navigationStart),performance.now=function(){return Date.now()-b}}var w=new s;g.prototype.step=function(t,e,i){if(i=i||10,0===(e=e||0))this.internalStep(t),this.time+=t;else{var n=Math.floor((this.time+e)/t)-Math.floor(this.time/t);n=Math.min(n,i);for(var s=performance.now(),r=0;r!==n&&(this.internalStep(t),!(performance.now()-s>1e3*t));r++);this.time+=e;for(var o=this.time%t/t,a=w,h=this.bodies,l=0;l!==h.length;l++){var c=h[l];c.type!==p.STATIC&&c.sleepState!==p.SLEEPING?(c.position.vsub(c.previousPosition,a),a.scale(o,a),c.position.vadd(a,c.interpolatedPosition)):(c.interpolatedPosition.copy(c.position),c.interpolatedQuaternion.copy(c.quaternion))}}};var _={type:"postStep"},M={type:"preStep"},S={type:"collide",body:null,contact:null},A=[],z=[],T=[],P=[],k=(new s,new s,new s,new s,new s,new s,new s,new s,new s,new r,new r),E=new r,B=new s;g.prototype.internalStep=function(t){this.dt=t;var e,i=this.contacts,s=T,r=P,o=this.numObjects(),a=this.bodies,h=this.solver,l=this.gravity,c=this.doProfiling,u=this.profile,d=p.DYNAMIC,m=this.constraints,f=z,y=(l.norm(),l.x),v=l.y,g=l.z,x=0;for(c&&(e=performance.now()),x=0;x!==o;x++)if((q=a[x]).type&d){var b=q.force,w=q.mass;b.x+=w*y,b.y+=w*v,b.z+=w*g}x=0;for(var C=this.subsystems.length;x!==C;x++)this.subsystems[x].update();c&&(e=performance.now()),s.length=0,r.length=0,this.broadphase.collisionPairs(this,s,r),c&&(u.broadphase=performance.now()-e);var I=m.length;for(x=0;x!==I;x++)if(!(D=m[x]).collideConnected)for(var R=s.length-1;R>=0;R-=1)(D.bodyA===s[R]&&D.bodyB===r[R]||D.bodyB===s[R]&&D.bodyA===r[R])&&(s.splice(R,1),r.splice(R,1));this.collisionMatrixTick(),c&&(e=performance.now());var V=A,F=i.length;for(x=0;x!==F;x++)V.push(i[x]);i.length=0;var O=this.frictionEquations.length;for(x=0;x!==O;x++)f.push(this.frictionEquations[x]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(s,r,this,i,V,this.frictionEquations,f),c&&(u.narrowphase=performance.now()-e),c&&(e=performance.now()),x=0;x<this.frictionEquations.length;x++)h.addEquation(this.frictionEquations[x]);for(var j=i.length,N=0;N!==j;N++){var q=(D=i[N]).bi,L=D.bj;D.si,D.sj,(q.material&&L.material&&this.getContactMaterial(q.material,L.material)||this.defaultContactMaterial).friction,q.material&&L.material&&(q.material.friction>=0&&L.material.friction>=0&&(q.material.friction,L.material.friction),q.material.restitution>=0&&L.material.restitution>=0&&(D.restitution=q.material.restitution*L.material.restitution)),h.addEquation(D),q.allowSleep&&q.type===p.DYNAMIC&&q.sleepState===p.SLEEPING&&L.sleepState===p.AWAKE&&L.type!==p.STATIC&&L.velocity.norm2()+L.angularVelocity.norm2()>=2*Math.pow(L.sleepSpeedLimit,2)&&(q._wakeUpAfterNarrowphase=!0),L.allowSleep&&L.type===p.DYNAMIC&&L.sleepState===p.SLEEPING&&q.sleepState===p.AWAKE&&q.type!==p.STATIC&&q.velocity.norm2()+q.angularVelocity.norm2()>=2*Math.pow(q.sleepSpeedLimit,2)&&(L._wakeUpAfterNarrowphase=!0),this.collisionMatrix.set(q,L,!0),this.collisionMatrixPrevious.get(q,L)||(S.body=L,S.contact=D,q.dispatchEvent(S),S.body=q,L.dispatchEvent(S))}for(c&&(u.makeContactConstraints=performance.now()-e,e=performance.now()),x=0;x!==o;x++)(q=a[x])._wakeUpAfterNarrowphase&&(q.wakeUp(),q._wakeUpAfterNarrowphase=!1);for(I=m.length,x=0;x!==I;x++){var D;(D=m[x]).update(),R=0;for(var W=D.equations.length;R!==W;R++){var U=D.equations[R];h.addEquation(U)}}h.solve(t,this),c&&(u.solve=performance.now()-e),h.removeAllEquations();var H=Math.pow;for(x=0;x!==o;x++)if((q=a[x]).type&d){var G=H(1-q.linearDamping,t),X=q.velocity;X.mult(G,X);var Y=q.angularVelocity;if(Y){var Z=H(1-q.angularDamping,t);Y.mult(Z,Y)}}for(this.dispatchEvent(M),x=0;x!==o;x++)(q=a[x]).preStep&&q.preStep.call(q);c&&(e=performance.now());var Q=k,J=E,$=this.stepnumber,K=p.DYNAMIC|p.KINEMATIC,tt=$%(this.quatNormalizeSkip+1)==0,et=this.quatNormalizeFast,it=.5*t;for(n.types.PLANE,n.types.CONVEXPOLYHEDRON,x=0;x!==o;x++){var nt=a[x],st=nt.force,rt=nt.torque;if(nt.type&K&&nt.sleepState!==p.SLEEPING){var ot=nt.velocity,at=nt.angularVelocity,ht=nt.position,lt=nt.quaternion,ct=nt.invMass,ut=nt.invInertiaWorld;ot.x+=st.x*ct*t,ot.y+=st.y*ct*t,ot.z+=st.z*ct*t,nt.angularVelocity&&(ut.vmult(rt,B),B.mult(t,B),B.vadd(at,at)),ht.x+=ot.x*t,ht.y+=ot.y*t,ht.z+=ot.z*t,nt.angularVelocity&&(Q.set(at.x,at.y,at.z,0),Q.mult(lt,J),lt.x+=it*J.x,lt.y+=it*J.y,lt.z+=it*J.z,lt.w+=it*J.w,tt&&(et?lt.normalizeFast():lt.normalize())),nt.aabb&&(nt.aabbNeedsUpdate=!0),nt.updateInertiaWorld&&nt.updateInertiaWorld()}}for(this.clearForces(),this.broadphase.dirty=!0,c&&(u.integrate=performance.now()-e),this.time+=t,this.stepnumber+=1,this.dispatchEvent(_),x=0;x!==o;x++){var pt=(q=a[x]).postStep;pt&&pt.call(q)}if(this.allowSleep)for(x=0;x!==o;x++)a[x].sleepTick(this.time)},g.prototype.clearForces=function(){for(var t=this.bodies,e=t.length,i=0;i!==e;i++){var n=t[i];n.force,n.torque,n.force.set(0,0,0),n.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)}},e={};function i(n){var s=e[n];if(void 0!==s)return s.exports;var r=e[n]={exports:{}};return t[n](r,r.exports,i),r.exports}(()=>{"use strict";const t=1e3,e=2300,n=2301,s=2302,r="srgb",o="srgb-linear",a="display-p3",h="display-p3-linear",l="linear",c="srgb",u="rec709",p=7680,d=35044,m=2e3,f=2001;class y{addEventListener(t,e){void 0===this._listeners&&(this._listeners={});const i=this._listeners;void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e)}hasEventListener(t,e){if(void 0===this._listeners)return!1;const i=this._listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)}removeEventListener(t,e){if(void 0===this._listeners)return;const i=this._listeners[t];if(void 0!==i){const t=i.indexOf(e);-1!==t&&i.splice(t,1)}}dispatchEvent(t){if(void 0===this._listeners)return;const e=this._listeners[t.type];if(void 0!==e){t.target=this;const i=e.slice(0);for(let e=0,n=i.length;e<n;e++)i[e].call(this,t);t.target=null}}}const v=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"],g=Math.PI/180,x=180/Math.PI;function b(){const t=4294967295*Math.random()|0,e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return(v[255&t]+v[t>>8&255]+v[t>>16&255]+v[t>>24&255]+"-"+v[255&e]+v[e>>8&255]+"-"+v[e>>16&15|64]+v[e>>24&255]+"-"+v[63&i|128]+v[i>>8&255]+"-"+v[i>>16&255]+v[i>>24&255]+v[255&n]+v[n>>8&255]+v[n>>16&255]+v[n>>24&255]).toLowerCase()}function w(t,e,i){return Math.max(e,Math.min(i,t))}function _(t,e,i){return(1-i)*t+i*e}function M(t,e){switch(e.constructor){case Float32Array:return t;case Uint32Array:return t/4294967295;case Uint16Array:return t/65535;case Uint8Array:return t/255;case Int32Array:return Math.max(t/2147483647,-1);case Int16Array:return Math.max(t/32767,-1);case Int8Array:return Math.max(t/127,-1);default:throw new Error("Invalid component type.")}}function S(t,e){switch(e.constructor){case Float32Array:return t;case Uint32Array:return Math.round(4294967295*t);case Uint16Array:return Math.round(65535*t);case Uint8Array:return Math.round(255*t);case Int32Array:return Math.round(2147483647*t);case Int16Array:return Math.round(32767*t);case Int8Array:return Math.round(127*t);default:throw new Error("Invalid component type.")}}class A{constructor(t=0,e=0){A.prototype.isVector2=!0,this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t){return this.x+=t.x,this.y+=t.y,this}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){const e=this.x,i=this.y,n=t.elements;return this.x=n[0]*e+n[3]*i+n[6],this.y=n[1]*e+n[4]*i+n[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const i=this.dot(t)/e;return Math.acos(w(i,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,i=this.y-t.y;return e*e+i*i}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){const i=Math.cos(e),n=Math.sin(e),s=this.x-t.x,r=this.y-t.y;return this.x=s*i-r*n+t.x,this.y=s*n+r*i+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class z{constructor(t,e,i,n,s,r,o,a,h){z.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==t&&this.set(t,e,i,n,s,r,o,a,h)}set(t,e,i,n,s,r,o,a,h){const l=this.elements;return l[0]=t,l[1]=n,l[2]=o,l[3]=e,l[4]=s,l[5]=a,l[6]=i,l[7]=r,l[8]=h,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(t){const e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],this}extractBasis(t,e,i){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),i.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const i=t.elements,n=e.elements,s=this.elements,r=i[0],o=i[3],a=i[6],h=i[1],l=i[4],c=i[7],u=i[2],p=i[5],d=i[8],m=n[0],f=n[3],y=n[6],v=n[1],g=n[4],x=n[7],b=n[2],w=n[5],_=n[8];return s[0]=r*m+o*v+a*b,s[3]=r*f+o*g+a*w,s[6]=r*y+o*x+a*_,s[1]=h*m+l*v+c*b,s[4]=h*f+l*g+c*w,s[7]=h*y+l*x+c*_,s[2]=u*m+p*v+d*b,s[5]=u*f+p*g+d*w,s[8]=u*y+p*x+d*_,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],i=t[1],n=t[2],s=t[3],r=t[4],o=t[5],a=t[6],h=t[7],l=t[8];return e*r*l-e*o*h-i*s*l+i*o*a+n*s*h-n*r*a}invert(){const t=this.elements,e=t[0],i=t[1],n=t[2],s=t[3],r=t[4],o=t[5],a=t[6],h=t[7],l=t[8],c=l*r-o*h,u=o*a-l*s,p=h*s-r*a,d=e*c+i*u+n*p;if(0===d)return this.set(0,0,0,0,0,0,0,0,0);const m=1/d;return t[0]=c*m,t[1]=(n*h-l*i)*m,t[2]=(o*i-n*r)*m,t[3]=u*m,t[4]=(l*e-n*a)*m,t[5]=(n*s-o*e)*m,t[6]=p*m,t[7]=(i*a-h*e)*m,t[8]=(r*e-i*s)*m,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).invert().transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,i,n,s,r,o){const a=Math.cos(s),h=Math.sin(s);return this.set(i*a,i*h,-i*(a*r+h*o)+r+t,-n*h,n*a,-n*(-h*r+a*o)+o+e,0,0,1),this}scale(t,e){return this.premultiply(T.makeScale(t,e)),this}rotate(t){return this.premultiply(T.makeRotation(-t)),this}translate(t,e){return this.premultiply(T.makeTranslation(t,e)),this}makeTranslation(t,e){return t.isVector2?this.set(1,0,t.x,0,1,t.y,0,0,1):this.set(1,0,t,0,1,e,0,0,1),this}makeRotation(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,-i,0,i,e,0,0,0,1),this}makeScale(t,e){return this.set(t,0,0,0,e,0,0,0,1),this}equals(t){const e=this.elements,i=t.elements;for(let t=0;t<9;t++)if(e[t]!==i[t])return!1;return!0}fromArray(t,e=0){for(let i=0;i<9;i++)this.elements[i]=t[i+e];return this}toArray(t=[],e=0){const i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t}clone(){return(new this.constructor).fromArray(this.elements)}}const T=new z;function P(t){return document.createElementNS("http://www.w3.org/1999/xhtml",t)}Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array;const k={};const E=(new z).set(.8224621,.177538,0,.0331941,.9668058,0,.0170827,.0723974,.9105199),B=(new z).set(1.2249401,-.2249404,0,-.0420569,1.0420571,0,-.0196376,-.0786361,1.0982735),C={[o]:{transfer:l,primaries:u,toReference:t=>t,fromReference:t=>t},[r]:{transfer:c,primaries:u,toReference:t=>t.convertSRGBToLinear(),fromReference:t=>t.convertLinearToSRGB()},[h]:{transfer:l,primaries:"p3",toReference:t=>t.applyMatrix3(B),fromReference:t=>t.applyMatrix3(E)},[a]:{transfer:c,primaries:"p3",toReference:t=>t.convertSRGBToLinear().applyMatrix3(B),fromReference:t=>t.applyMatrix3(E).convertLinearToSRGB()}},I=new Set([o,h]),R={enabled:!0,_workingColorSpace:o,get workingColorSpace(){return this._workingColorSpace},set workingColorSpace(t){if(!I.has(t))throw new Error(`Unsupported working color space, "${t}".`);this._workingColorSpace=t},convert:function(t,e,i){if(!1===this.enabled||e===i||!e||!i)return t;const n=C[e].toReference;return(0,C[i].fromReference)(n(t))},fromWorkingColorSpace:function(t,e){return this.convert(t,this._workingColorSpace,e)},toWorkingColorSpace:function(t,e){return this.convert(t,e,this._workingColorSpace)},getPrimaries:function(t){return C[t].primaries},getTransfer:function(t){return""===t?l:C[t].transfer}};function V(t){return t<.04045?.0773993808*t:Math.pow(.9478672986*t+.0521327014,2.4)}function F(t){return t<.0031308?12.92*t:1.055*Math.pow(t,.41666)-.055}let O;class j{static getDataURL(t){if(/^data:/i.test(t.src))return t.src;if("undefined"==typeof HTMLCanvasElement)return t.src;let e;if(t instanceof HTMLCanvasElement)e=t;else{void 0===O&&(O=P("canvas")),O.width=t.width,O.height=t.height;const i=O.getContext("2d");t instanceof ImageData?i.putImageData(t,0,0):i.drawImage(t,0,0,t.width,t.height),e=O}return e.width>2048||e.height>2048?(console.warn("THREE.ImageUtils.getDataURL: Image converted to jpg for performance reasons",t),e.toDataURL("image/jpeg",.6)):e.toDataURL("image/png")}static sRGBToLinear(t){if("undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap){const e=P("canvas");e.width=t.width,e.height=t.height;const i=e.getContext("2d");i.drawImage(t,0,0,t.width,t.height);const n=i.getImageData(0,0,t.width,t.height),s=n.data;for(let t=0;t<s.length;t++)s[t]=255*V(s[t]/255);return i.putImageData(n,0,0),e}if(t.data){const e=t.data.slice(0);for(let t=0;t<e.length;t++)e instanceof Uint8Array||e instanceof Uint8ClampedArray?e[t]=Math.floor(255*V(e[t]/255)):e[t]=V(e[t]);return{data:e,width:t.width,height:t.height}}return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),t}}let N=0;class q{constructor(t=null){this.isSource=!0,Object.defineProperty(this,"id",{value:N++}),this.uuid=b(),this.data=t,this.dataReady=!0,this.version=0}set needsUpdate(t){!0===t&&this.version++}toJSON(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.images[this.uuid])return t.images[this.uuid];const i={uuid:this.uuid,url:""},n=this.data;if(null!==n){let t;if(Array.isArray(n)){t=[];for(let e=0,i=n.length;e<i;e++)n[e].isDataTexture?t.push(L(n[e].image)):t.push(L(n[e]))}else t=L(n);i.url=t}return e||(t.images[this.uuid]=i),i}}function L(t){return"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap?j.getDataURL(t):t.data?{data:Array.from(t.data),width:t.width,height:t.height,type:t.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let D=0;class W extends y{constructor(t=W.DEFAULT_IMAGE,e=W.DEFAULT_MAPPING,i=1001,n=1001,s=1006,r=1008,o=1023,a=1009,h=W.DEFAULT_ANISOTROPY,l=""){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:D++}),this.uuid=b(),this.name="",this.source=new q(t),this.mipmaps=[],this.mapping=e,this.channel=0,this.wrapS=i,this.wrapT=n,this.magFilter=s,this.minFilter=r,this.anisotropy=h,this.format=o,this.internalFormat=null,this.type=a,this.offset=new A(0,0),this.repeat=new A(1,1),this.center=new A(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new z,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=l,this.userData={},this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1,this.pmremVersion=0}get image(){return this.source.data}set image(t=null){this.source.data=t}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return(new this.constructor).copy(this)}copy(t){return this.name=t.name,this.source=t.source,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.channel=t.channel,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.internalFormat=t.internalFormat,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.colorSpace=t.colorSpace,this.userData=JSON.parse(JSON.stringify(t.userData)),this.needsUpdate=!0,this}toJSON(t){const e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.textures[this.uuid])return t.textures[this.uuid];const i={metadata:{version:4.6,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(t).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(i.userData=this.userData),e||(t.textures[this.uuid]=i),i}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(300!==this.mapping)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case t:e.x=e.x-Math.floor(e.x);break;case 1001:e.x=e.x<0?0:1;break;case 1002:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case t:e.y=e.y-Math.floor(e.y);break;case 1001:e.y=e.y<0?0:1;break;case 1002:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(t){!0===t&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(t){!0===t&&this.pmremVersion++}}W.DEFAULT_IMAGE=null,W.DEFAULT_MAPPING=300,W.DEFAULT_ANISOTROPY=1;class U{constructor(t=0,e=0,i=0,n=1){U.prototype.isVector4=!0,this.x=t,this.y=e,this.z=i,this.w=n}get width(){return this.z}set width(t){this.z=t}get height(){return this.w}set height(t){this.w=t}set(t,e,i,n){return this.x=t,this.y=e,this.z=i,this.w=n,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this.w=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setW(t){return this.w=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;case 3:this.w=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=void 0!==t.w?t.w:1,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}applyMatrix4(t){const e=this.x,i=this.y,n=this.z,s=this.w,r=t.elements;return this.x=r[0]*e+r[4]*i+r[8]*n+r[12]*s,this.y=r[1]*e+r[5]*i+r[9]*n+r[13]*s,this.z=r[2]*e+r[6]*i+r[10]*n+r[14]*s,this.w=r[3]*e+r[7]*i+r[11]*n+r[15]*s,this}divideScalar(t){return this.multiplyScalar(1/t)}setAxisAngleFromQuaternion(t){this.w=2*Math.acos(t.w);const e=Math.sqrt(1-t.w*t.w);return e<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this}setAxisAngleFromRotationMatrix(t){let e,i,n,s;const r=.01,o=.1,a=t.elements,h=a[0],l=a[4],c=a[8],u=a[1],p=a[5],d=a[9],m=a[2],f=a[6],y=a[10];if(Math.abs(l-u)<r&&Math.abs(c-m)<r&&Math.abs(d-f)<r){if(Math.abs(l+u)<o&&Math.abs(c+m)<o&&Math.abs(d+f)<o&&Math.abs(h+p+y-3)<o)return this.set(1,0,0,0),this;e=Math.PI;const t=(h+1)/2,a=(p+1)/2,v=(y+1)/2,g=(l+u)/4,x=(c+m)/4,b=(d+f)/4;return t>a&&t>v?t<r?(i=0,n=.707106781,s=.707106781):(i=Math.sqrt(t),n=g/i,s=x/i):a>v?a<r?(i=.707106781,n=0,s=.707106781):(n=Math.sqrt(a),i=g/n,s=b/n):v<r?(i=.707106781,n=.707106781,s=0):(s=Math.sqrt(v),i=x/s,n=b/s),this.set(i,n,s,e),this}let v=Math.sqrt((f-d)*(f-d)+(c-m)*(c-m)+(u-l)*(u-l));return Math.abs(v)<.001&&(v=1),this.x=(f-d)/v,this.y=(c-m)/v,this.z=(u-l)/v,this.w=Math.acos((h+p+y-1)/2),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this.w=e[15],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this.w=Math.max(t.w,Math.min(e.w,this.w)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this.w=Math.max(t,Math.min(e,this.w)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this.z=t.z+(e.z-t.z)*i,this.w=t.w+(e.w-t.w)*i,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this.w=t.getW(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class H{constructor(t=0,e=0,i=0,n=1){this.isQuaternion=!0,this._x=t,this._y=e,this._z=i,this._w=n}static slerpFlat(t,e,i,n,s,r,o){let a=i[n+0],h=i[n+1],l=i[n+2],c=i[n+3];const u=s[r+0],p=s[r+1],d=s[r+2],m=s[r+3];if(0===o)return t[e+0]=a,t[e+1]=h,t[e+2]=l,void(t[e+3]=c);if(1===o)return t[e+0]=u,t[e+1]=p,t[e+2]=d,void(t[e+3]=m);if(c!==m||a!==u||h!==p||l!==d){let t=1-o;const e=a*u+h*p+l*d+c*m,i=e>=0?1:-1,n=1-e*e;if(n>Number.EPSILON){const s=Math.sqrt(n),r=Math.atan2(s,e*i);t=Math.sin(t*r)/s,o=Math.sin(o*r)/s}const s=o*i;if(a=a*t+u*s,h=h*t+p*s,l=l*t+d*s,c=c*t+m*s,t===1-o){const t=1/Math.sqrt(a*a+h*h+l*l+c*c);a*=t,h*=t,l*=t,c*=t}}t[e]=a,t[e+1]=h,t[e+2]=l,t[e+3]=c}static multiplyQuaternionsFlat(t,e,i,n,s,r){const o=i[n],a=i[n+1],h=i[n+2],l=i[n+3],c=s[r],u=s[r+1],p=s[r+2],d=s[r+3];return t[e]=o*d+l*c+a*p-h*u,t[e+1]=a*d+l*u+h*c-o*p,t[e+2]=h*d+l*p+o*u-a*c,t[e+3]=l*d-o*c-a*u-h*p,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,i,n){return this._x=t,this._y=e,this._z=i,this._w=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e=!0){const i=t._x,n=t._y,s=t._z,r=t._order,o=Math.cos,a=Math.sin,h=o(i/2),l=o(n/2),c=o(s/2),u=a(i/2),p=a(n/2),d=a(s/2);switch(r){case"XYZ":this._x=u*l*c+h*p*d,this._y=h*p*c-u*l*d,this._z=h*l*d+u*p*c,this._w=h*l*c-u*p*d;break;case"YXZ":this._x=u*l*c+h*p*d,this._y=h*p*c-u*l*d,this._z=h*l*d-u*p*c,this._w=h*l*c+u*p*d;break;case"ZXY":this._x=u*l*c-h*p*d,this._y=h*p*c+u*l*d,this._z=h*l*d+u*p*c,this._w=h*l*c-u*p*d;break;case"ZYX":this._x=u*l*c-h*p*d,this._y=h*p*c+u*l*d,this._z=h*l*d-u*p*c,this._w=h*l*c+u*p*d;break;case"YZX":this._x=u*l*c+h*p*d,this._y=h*p*c+u*l*d,this._z=h*l*d-u*p*c,this._w=h*l*c-u*p*d;break;case"XZY":this._x=u*l*c-h*p*d,this._y=h*p*c-u*l*d,this._z=h*l*d+u*p*c,this._w=h*l*c+u*p*d;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+r)}return!0===e&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const i=e/2,n=Math.sin(i);return this._x=t.x*n,this._y=t.y*n,this._z=t.z*n,this._w=Math.cos(i),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,i=e[0],n=e[4],s=e[8],r=e[1],o=e[5],a=e[9],h=e[2],l=e[6],c=e[10],u=i+o+c;if(u>0){const t=.5/Math.sqrt(u+1);this._w=.25/t,this._x=(l-a)*t,this._y=(s-h)*t,this._z=(r-n)*t}else if(i>o&&i>c){const t=2*Math.sqrt(1+i-o-c);this._w=(l-a)/t,this._x=.25*t,this._y=(n+r)/t,this._z=(s+h)/t}else if(o>c){const t=2*Math.sqrt(1+o-i-c);this._w=(s-h)/t,this._x=(n+r)/t,this._y=.25*t,this._z=(a+l)/t}else{const t=2*Math.sqrt(1+c-i-o);this._w=(r-n)/t,this._x=(s+h)/t,this._y=(a+l)/t,this._z=.25*t}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let i=t.dot(e)+1;return i<Number.EPSILON?(i=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=i):(this._x=0,this._y=-t.z,this._z=t.y,this._w=i)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=i),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(w(this.dot(t),-1,1)))}rotateTowards(t,e){const i=this.angleTo(t);if(0===i)return this;const n=Math.min(1,e/i);return this.slerp(t,n),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t){return this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const i=t._x,n=t._y,s=t._z,r=t._w,o=e._x,a=e._y,h=e._z,l=e._w;return this._x=i*l+r*o+n*h-s*a,this._y=n*l+r*a+s*o-i*h,this._z=s*l+r*h+i*a-n*o,this._w=r*l-i*o-n*a-s*h,this._onChangeCallback(),this}slerp(t,e){if(0===e)return this;if(1===e)return this.copy(t);const i=this._x,n=this._y,s=this._z,r=this._w;let o=r*t._w+i*t._x+n*t._y+s*t._z;if(o<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,o=-o):this.copy(t),o>=1)return this._w=r,this._x=i,this._y=n,this._z=s,this;const a=1-o*o;if(a<=Number.EPSILON){const t=1-e;return this._w=t*r+e*this._w,this._x=t*i+e*this._x,this._y=t*n+e*this._y,this._z=t*s+e*this._z,this.normalize(),this}const h=Math.sqrt(a),l=Math.atan2(h,o),c=Math.sin((1-e)*l)/h,u=Math.sin(e*l)/h;return this._w=r*c+this._w*u,this._x=i*c+this._x*u,this._y=n*c+this._y*u,this._z=s*c+this._z*u,this._onChangeCallback(),this}slerpQuaternions(t,e,i){return this.copy(t).slerp(e,i)}random(){const t=2*Math.PI*Math.random(),e=2*Math.PI*Math.random(),i=Math.random(),n=Math.sqrt(1-i),s=Math.sqrt(i);return this.set(n*Math.sin(t),n*Math.cos(t),s*Math.sin(e),s*Math.cos(e))}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class G{constructor(t=0,e=0,i=0){G.prototype.isVector3=!0,this.x=t,this.y=e,this.z=i}set(t,e,i){return void 0===i&&(i=this.z),this.x=t,this.y=e,this.z=i,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return this.applyQuaternion(Y.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(Y.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,i=this.y,n=this.z,s=t.elements;return this.x=s[0]*e+s[3]*i+s[6]*n,this.y=s[1]*e+s[4]*i+s[7]*n,this.z=s[2]*e+s[5]*i+s[8]*n,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,i=this.y,n=this.z,s=t.elements,r=1/(s[3]*e+s[7]*i+s[11]*n+s[15]);return this.x=(s[0]*e+s[4]*i+s[8]*n+s[12])*r,this.y=(s[1]*e+s[5]*i+s[9]*n+s[13])*r,this.z=(s[2]*e+s[6]*i+s[10]*n+s[14])*r,this}applyQuaternion(t){const e=this.x,i=this.y,n=this.z,s=t.x,r=t.y,o=t.z,a=t.w,h=2*(r*n-o*i),l=2*(o*e-s*n),c=2*(s*i-r*e);return this.x=e+a*h+r*c-o*l,this.y=i+a*l+o*h-s*c,this.z=n+a*c+s*l-r*h,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){const e=this.x,i=this.y,n=this.z,s=t.elements;return this.x=s[0]*e+s[4]*i+s[8]*n,this.y=s[1]*e+s[5]*i+s[9]*n,this.z=s[2]*e+s[6]*i+s[10]*n,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this.z=t.z+(e.z-t.z)*i,this}cross(t){return this.crossVectors(this,t)}crossVectors(t,e){const i=t.x,n=t.y,s=t.z,r=e.x,o=e.y,a=e.z;return this.x=n*a-s*o,this.y=s*r-i*a,this.z=i*o-n*r,this}projectOnVector(t){const e=t.lengthSq();if(0===e)return this.set(0,0,0);const i=t.dot(this)/e;return this.copy(t).multiplyScalar(i)}projectOnPlane(t){return X.copy(this).projectOnVector(t),this.sub(X)}reflect(t){return this.sub(X.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const i=this.dot(t)/e;return Math.acos(w(i,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,i=this.y-t.y,n=this.z-t.z;return e*e+i*i+n*n}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,i){const n=Math.sin(e)*t;return this.x=n*Math.sin(i),this.y=Math.cos(e)*t,this.z=n*Math.cos(i),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,i){return this.x=t*Math.sin(e),this.y=i,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),i=this.setFromMatrixColumn(t,1).length(),n=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=i,this.z=n,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,4*e)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,3*e)}setFromEuler(t){return this.x=t._x,this.y=t._y,this.z=t._z,this}setFromColor(t){return this.x=t.r,this.y=t.g,this.z=t.b,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const t=Math.random()*Math.PI*2,e=2*Math.random()-1,i=Math.sqrt(1-e*e);return this.x=i*Math.cos(t),this.y=e,this.z=i*Math.sin(t),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const X=new G,Y=new H;class Z{constructor(t=new G(1/0,1/0,1/0),e=new G(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=t,this.max=e}set(t,e){return this.min.copy(t),this.max.copy(e),this}setFromArray(t){this.makeEmpty();for(let e=0,i=t.length;e<i;e+=3)this.expandByPoint(J.fromArray(t,e));return this}setFromBufferAttribute(t){this.makeEmpty();for(let e=0,i=t.count;e<i;e++)this.expandByPoint(J.fromBufferAttribute(t,e));return this}setFromPoints(t){this.makeEmpty();for(let e=0,i=t.length;e<i;e++)this.expandByPoint(t[e]);return this}setFromCenterAndSize(t,e){const i=J.copy(e).multiplyScalar(.5);return this.min.copy(t).sub(i),this.max.copy(t).add(i),this}setFromObject(t,e=!1){return this.makeEmpty(),this.expandByObject(t,e)}clone(){return(new this.constructor).copy(this)}copy(t){return this.min.copy(t.min),this.max.copy(t.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(t){return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(t){return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)}expandByPoint(t){return this.min.min(t),this.max.max(t),this}expandByVector(t){return this.min.sub(t),this.max.add(t),this}expandByScalar(t){return this.min.addScalar(-t),this.max.addScalar(t),this}expandByObject(t,e=!1){t.updateWorldMatrix(!1,!1);const i=t.geometry;if(void 0!==i){const n=i.getAttribute("position");if(!0===e&&void 0!==n&&!0!==t.isInstancedMesh)for(let e=0,i=n.count;e<i;e++)!0===t.isMesh?t.getVertexPosition(e,J):J.fromBufferAttribute(n,e),J.applyMatrix4(t.matrixWorld),this.expandByPoint(J);else void 0!==t.boundingBox?(null===t.boundingBox&&t.computeBoundingBox(),$.copy(t.boundingBox)):(null===i.boundingBox&&i.computeBoundingBox(),$.copy(i.boundingBox)),$.applyMatrix4(t.matrixWorld),this.union($)}const n=t.children;for(let t=0,i=n.length;t<i;t++)this.expandByObject(n[t],e);return this}containsPoint(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y||t.z<this.min.z||t.z>this.max.z)}containsBox(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z}getParameter(t,e){return e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)}intersectsSphere(t){return this.clampPoint(t.center,J),J.distanceToSquared(t.center)<=t.radius*t.radius}intersectsPlane(t){let e,i;return t.normal.x>0?(e=t.normal.x*this.min.x,i=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,i=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,i+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,i+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,i+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,i+=t.normal.z*this.min.z),e<=-t.constant&&i>=-t.constant}intersectsTriangle(t){if(this.isEmpty())return!1;this.getCenter(rt),ot.subVectors(this.max,rt),K.subVectors(t.a,rt),tt.subVectors(t.b,rt),et.subVectors(t.c,rt),it.subVectors(tt,K),nt.subVectors(et,tt),st.subVectors(K,et);let e=[0,-it.z,it.y,0,-nt.z,nt.y,0,-st.z,st.y,it.z,0,-it.x,nt.z,0,-nt.x,st.z,0,-st.x,-it.y,it.x,0,-nt.y,nt.x,0,-st.y,st.x,0];return!!lt(e,K,tt,et,ot)&&(e=[1,0,0,0,1,0,0,0,1],!!lt(e,K,tt,et,ot)&&(at.crossVectors(it,nt),e=[at.x,at.y,at.z],lt(e,K,tt,et,ot)))}clampPoint(t,e){return e.copy(t).clamp(this.min,this.max)}distanceToPoint(t){return this.clampPoint(t,J).distanceTo(t)}getBoundingSphere(t){return this.isEmpty()?t.makeEmpty():(this.getCenter(t.center),t.radius=.5*this.getSize(J).length()),t}intersect(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this}union(t){return this.min.min(t.min),this.max.max(t.max),this}applyMatrix4(t){return this.isEmpty()||(Q[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),Q[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),Q[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),Q[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),Q[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),Q[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),Q[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),Q[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(Q)),this}translate(t){return this.min.add(t),this.max.add(t),this}equals(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}const Q=[new G,new G,new G,new G,new G,new G,new G,new G],J=new G,$=new Z,K=new G,tt=new G,et=new G,it=new G,nt=new G,st=new G,rt=new G,ot=new G,at=new G,ht=new G;function lt(t,e,i,n,s){for(let r=0,o=t.length-3;r<=o;r+=3){ht.fromArray(t,r);const o=s.x*Math.abs(ht.x)+s.y*Math.abs(ht.y)+s.z*Math.abs(ht.z),a=e.dot(ht),h=i.dot(ht),l=n.dot(ht);if(Math.max(-Math.max(a,h,l),Math.min(a,h,l))>o)return!1}return!0}const ct=new Z,ut=new G,pt=new G;class dt{constructor(t=new G,e=-1){this.isSphere=!0,this.center=t,this.radius=e}set(t,e){return this.center.copy(t),this.radius=e,this}setFromPoints(t,e){const i=this.center;void 0!==e?i.copy(e):ct.setFromPoints(t).getCenter(i);let n=0;for(let e=0,s=t.length;e<s;e++)n=Math.max(n,i.distanceToSquared(t[e]));return this.radius=Math.sqrt(n),this}copy(t){return this.center.copy(t.center),this.radius=t.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(t){return t.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(t){return t.distanceTo(this.center)-this.radius}intersectsSphere(t){const e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=e*e}intersectsBox(t){return t.intersectsSphere(this)}intersectsPlane(t){return Math.abs(t.distanceToPoint(this.center))<=this.radius}clampPoint(t,e){const i=this.center.distanceToSquared(t);return e.copy(t),i>this.radius*this.radius&&(e.sub(this.center).normalize(),e.multiplyScalar(this.radius).add(this.center)),e}getBoundingBox(t){return this.isEmpty()?(t.makeEmpty(),t):(t.set(this.center,this.center),t.expandByScalar(this.radius),t)}applyMatrix4(t){return this.center.applyMatrix4(t),this.radius=this.radius*t.getMaxScaleOnAxis(),this}translate(t){return this.center.add(t),this}expandByPoint(t){if(this.isEmpty())return this.center.copy(t),this.radius=0,this;ut.subVectors(t,this.center);const e=ut.lengthSq();if(e>this.radius*this.radius){const t=Math.sqrt(e),i=.5*(t-this.radius);this.center.addScaledVector(ut,i/t),this.radius+=i}return this}union(t){return t.isEmpty()?this:this.isEmpty()?(this.copy(t),this):(!0===this.center.equals(t.center)?this.radius=Math.max(this.radius,t.radius):(pt.subVectors(t.center,this.center).setLength(t.radius),this.expandByPoint(ut.copy(t.center).add(pt)),this.expandByPoint(ut.copy(t.center).sub(pt))),this)}equals(t){return t.center.equals(this.center)&&t.radius===this.radius}clone(){return(new this.constructor).copy(this)}}const mt=new G,ft=new G,yt=new G,vt=new G,gt=new G,xt=new G,bt=new G;class wt{constructor(t=new G,e=new G(0,0,-1)){this.origin=t,this.direction=e}set(t,e){return this.origin.copy(t),this.direction.copy(e),this}copy(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this}at(t,e){return e.copy(this.origin).addScaledVector(this.direction,t)}lookAt(t){return this.direction.copy(t).sub(this.origin).normalize(),this}recast(t){return this.origin.copy(this.at(t,mt)),this}closestPointToPoint(t,e){e.subVectors(t,this.origin);const i=e.dot(this.direction);return i<0?e.copy(this.origin):e.copy(this.origin).addScaledVector(this.direction,i)}distanceToPoint(t){return Math.sqrt(this.distanceSqToPoint(t))}distanceSqToPoint(t){const e=mt.subVectors(t,this.origin).dot(this.direction);return e<0?this.origin.distanceToSquared(t):(mt.copy(this.origin).addScaledVector(this.direction,e),mt.distanceToSquared(t))}distanceSqToSegment(t,e,i,n){ft.copy(t).add(e).multiplyScalar(.5),yt.copy(e).sub(t).normalize(),vt.copy(this.origin).sub(ft);const s=.5*t.distanceTo(e),r=-this.direction.dot(yt),o=vt.dot(this.direction),a=-vt.dot(yt),h=vt.lengthSq(),l=Math.abs(1-r*r);let c,u,p,d;if(l>0)if(c=r*a-o,u=r*o-a,d=s*l,c>=0)if(u>=-d)if(u<=d){const t=1/l;c*=t,u*=t,p=c*(c+r*u+2*o)+u*(r*c+u+2*a)+h}else u=s,c=Math.max(0,-(r*u+o)),p=-c*c+u*(u+2*a)+h;else u=-s,c=Math.max(0,-(r*u+o)),p=-c*c+u*(u+2*a)+h;else u<=-d?(c=Math.max(0,-(-r*s+o)),u=c>0?-s:Math.min(Math.max(-s,-a),s),p=-c*c+u*(u+2*a)+h):u<=d?(c=0,u=Math.min(Math.max(-s,-a),s),p=u*(u+2*a)+h):(c=Math.max(0,-(r*s+o)),u=c>0?s:Math.min(Math.max(-s,-a),s),p=-c*c+u*(u+2*a)+h);else u=r>0?-s:s,c=Math.max(0,-(r*u+o)),p=-c*c+u*(u+2*a)+h;return i&&i.copy(this.origin).addScaledVector(this.direction,c),n&&n.copy(ft).addScaledVector(yt,u),p}intersectSphere(t,e){mt.subVectors(t.center,this.origin);const i=mt.dot(this.direction),n=mt.dot(mt)-i*i,s=t.radius*t.radius;if(n>s)return null;const r=Math.sqrt(s-n),o=i-r,a=i+r;return a<0?null:o<0?this.at(a,e):this.at(o,e)}intersectsSphere(t){return this.distanceSqToPoint(t.center)<=t.radius*t.radius}distanceToPlane(t){const e=t.normal.dot(this.direction);if(0===e)return 0===t.distanceToPoint(this.origin)?0:null;const i=-(this.origin.dot(t.normal)+t.constant)/e;return i>=0?i:null}intersectPlane(t,e){const i=this.distanceToPlane(t);return null===i?null:this.at(i,e)}intersectsPlane(t){const e=t.distanceToPoint(this.origin);return 0===e||t.normal.dot(this.direction)*e<0}intersectBox(t,e){let i,n,s,r,o,a;const h=1/this.direction.x,l=1/this.direction.y,c=1/this.direction.z,u=this.origin;return h>=0?(i=(t.min.x-u.x)*h,n=(t.max.x-u.x)*h):(i=(t.max.x-u.x)*h,n=(t.min.x-u.x)*h),l>=0?(s=(t.min.y-u.y)*l,r=(t.max.y-u.y)*l):(s=(t.max.y-u.y)*l,r=(t.min.y-u.y)*l),i>r||s>n?null:((s>i||isNaN(i))&&(i=s),(r<n||isNaN(n))&&(n=r),c>=0?(o=(t.min.z-u.z)*c,a=(t.max.z-u.z)*c):(o=(t.max.z-u.z)*c,a=(t.min.z-u.z)*c),i>a||o>n?null:((o>i||i!=i)&&(i=o),(a<n||n!=n)&&(n=a),n<0?null:this.at(i>=0?i:n,e)))}intersectsBox(t){return null!==this.intersectBox(t,mt)}intersectTriangle(t,e,i,n,s){gt.subVectors(e,t),xt.subVectors(i,t),bt.crossVectors(gt,xt);let r,o=this.direction.dot(bt);if(o>0){if(n)return null;r=1}else{if(!(o<0))return null;r=-1,o=-o}vt.subVectors(this.origin,t);const a=r*this.direction.dot(xt.crossVectors(vt,xt));if(a<0)return null;const h=r*this.direction.dot(gt.cross(vt));if(h<0)return null;if(a+h>o)return null;const l=-r*vt.dot(bt);return l<0?null:this.at(l/o,s)}applyMatrix4(t){return this.origin.applyMatrix4(t),this.direction.transformDirection(t),this}equals(t){return t.origin.equals(this.origin)&&t.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}class _t{constructor(t,e,i,n,s,r,o,a,h,l,c,u,p,d,m,f){_t.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==t&&this.set(t,e,i,n,s,r,o,a,h,l,c,u,p,d,m,f)}set(t,e,i,n,s,r,o,a,h,l,c,u,p,d,m,f){const y=this.elements;return y[0]=t,y[4]=e,y[8]=i,y[12]=n,y[1]=s,y[5]=r,y[9]=o,y[13]=a,y[2]=h,y[6]=l,y[10]=c,y[14]=u,y[3]=p,y[7]=d,y[11]=m,y[15]=f,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new _t).fromArray(this.elements)}copy(t){const e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],this}copyPosition(t){const e=this.elements,i=t.elements;return e[12]=i[12],e[13]=i[13],e[14]=i[14],this}setFromMatrix3(t){const e=t.elements;return this.set(e[0],e[3],e[6],0,e[1],e[4],e[7],0,e[2],e[5],e[8],0,0,0,0,1),this}extractBasis(t,e,i){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this}makeBasis(t,e,i){return this.set(t.x,e.x,i.x,0,t.y,e.y,i.y,0,t.z,e.z,i.z,0,0,0,0,1),this}extractRotation(t){const e=this.elements,i=t.elements,n=1/Mt.setFromMatrixColumn(t,0).length(),s=1/Mt.setFromMatrixColumn(t,1).length(),r=1/Mt.setFromMatrixColumn(t,2).length();return e[0]=i[0]*n,e[1]=i[1]*n,e[2]=i[2]*n,e[3]=0,e[4]=i[4]*s,e[5]=i[5]*s,e[6]=i[6]*s,e[7]=0,e[8]=i[8]*r,e[9]=i[9]*r,e[10]=i[10]*r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){const e=this.elements,i=t.x,n=t.y,s=t.z,r=Math.cos(i),o=Math.sin(i),a=Math.cos(n),h=Math.sin(n),l=Math.cos(s),c=Math.sin(s);if("XYZ"===t.order){const t=r*l,i=r*c,n=o*l,s=o*c;e[0]=a*l,e[4]=-a*c,e[8]=h,e[1]=i+n*h,e[5]=t-s*h,e[9]=-o*a,e[2]=s-t*h,e[6]=n+i*h,e[10]=r*a}else if("YXZ"===t.order){const t=a*l,i=a*c,n=h*l,s=h*c;e[0]=t+s*o,e[4]=n*o-i,e[8]=r*h,e[1]=r*c,e[5]=r*l,e[9]=-o,e[2]=i*o-n,e[6]=s+t*o,e[10]=r*a}else if("ZXY"===t.order){const t=a*l,i=a*c,n=h*l,s=h*c;e[0]=t-s*o,e[4]=-r*c,e[8]=n+i*o,e[1]=i+n*o,e[5]=r*l,e[9]=s-t*o,e[2]=-r*h,e[6]=o,e[10]=r*a}else if("ZYX"===t.order){const t=r*l,i=r*c,n=o*l,s=o*c;e[0]=a*l,e[4]=n*h-i,e[8]=t*h+s,e[1]=a*c,e[5]=s*h+t,e[9]=i*h-n,e[2]=-h,e[6]=o*a,e[10]=r*a}else if("YZX"===t.order){const t=r*a,i=r*h,n=o*a,s=o*h;e[0]=a*l,e[4]=s-t*c,e[8]=n*c+i,e[1]=c,e[5]=r*l,e[9]=-o*l,e[2]=-h*l,e[6]=i*c+n,e[10]=t-s*c}else if("XZY"===t.order){const t=r*a,i=r*h,n=o*a,s=o*h;e[0]=a*l,e[4]=-c,e[8]=h*l,e[1]=t*c+s,e[5]=r*l,e[9]=i*c-n,e[2]=n*c-i,e[6]=o*l,e[10]=s*c+t}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromQuaternion(t){return this.compose(At,t,zt)}lookAt(t,e,i){const n=this.elements;return kt.subVectors(t,e),0===kt.lengthSq()&&(kt.z=1),kt.normalize(),Tt.crossVectors(i,kt),0===Tt.lengthSq()&&(1===Math.abs(i.z)?kt.x+=1e-4:kt.z+=1e-4,kt.normalize(),Tt.crossVectors(i,kt)),Tt.normalize(),Pt.crossVectors(kt,Tt),n[0]=Tt.x,n[4]=Pt.x,n[8]=kt.x,n[1]=Tt.y,n[5]=Pt.y,n[9]=kt.y,n[2]=Tt.z,n[6]=Pt.z,n[10]=kt.z,this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const i=t.elements,n=e.elements,s=this.elements,r=i[0],o=i[4],a=i[8],h=i[12],l=i[1],c=i[5],u=i[9],p=i[13],d=i[2],m=i[6],f=i[10],y=i[14],v=i[3],g=i[7],x=i[11],b=i[15],w=n[0],_=n[4],M=n[8],S=n[12],A=n[1],z=n[5],T=n[9],P=n[13],k=n[2],E=n[6],B=n[10],C=n[14],I=n[3],R=n[7],V=n[11],F=n[15];return s[0]=r*w+o*A+a*k+h*I,s[4]=r*_+o*z+a*E+h*R,s[8]=r*M+o*T+a*B+h*V,s[12]=r*S+o*P+a*C+h*F,s[1]=l*w+c*A+u*k+p*I,s[5]=l*_+c*z+u*E+p*R,s[9]=l*M+c*T+u*B+p*V,s[13]=l*S+c*P+u*C+p*F,s[2]=d*w+m*A+f*k+y*I,s[6]=d*_+m*z+f*E+y*R,s[10]=d*M+m*T+f*B+y*V,s[14]=d*S+m*P+f*C+y*F,s[3]=v*w+g*A+x*k+b*I,s[7]=v*_+g*z+x*E+b*R,s[11]=v*M+g*T+x*B+b*V,s[15]=v*S+g*P+x*C+b*F,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){const t=this.elements,e=t[0],i=t[4],n=t[8],s=t[12],r=t[1],o=t[5],a=t[9],h=t[13],l=t[2],c=t[6],u=t[10],p=t[14];return t[3]*(+s*a*c-n*h*c-s*o*u+i*h*u+n*o*p-i*a*p)+t[7]*(+e*a*p-e*h*u+s*r*u-n*r*p+n*h*l-s*a*l)+t[11]*(+e*h*c-e*o*p-s*r*c+i*r*p+s*o*l-i*h*l)+t[15]*(-n*o*l-e*a*c+e*o*u+n*r*c-i*r*u+i*a*l)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,i){const n=this.elements;return t.isVector3?(n[12]=t.x,n[13]=t.y,n[14]=t.z):(n[12]=t,n[13]=e,n[14]=i),this}invert(){const t=this.elements,e=t[0],i=t[1],n=t[2],s=t[3],r=t[4],o=t[5],a=t[6],h=t[7],l=t[8],c=t[9],u=t[10],p=t[11],d=t[12],m=t[13],f=t[14],y=t[15],v=c*f*h-m*u*h+m*a*p-o*f*p-c*a*y+o*u*y,g=d*u*h-l*f*h-d*a*p+r*f*p+l*a*y-r*u*y,x=l*m*h-d*c*h+d*o*p-r*m*p-l*o*y+r*c*y,b=d*c*a-l*m*a-d*o*u+r*m*u+l*o*f-r*c*f,w=e*v+i*g+n*x+s*b;if(0===w)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const _=1/w;return t[0]=v*_,t[1]=(m*u*s-c*f*s-m*n*p+i*f*p+c*n*y-i*u*y)*_,t[2]=(o*f*s-m*a*s+m*n*h-i*f*h-o*n*y+i*a*y)*_,t[3]=(c*a*s-o*u*s-c*n*h+i*u*h+o*n*p-i*a*p)*_,t[4]=g*_,t[5]=(l*f*s-d*u*s+d*n*p-e*f*p-l*n*y+e*u*y)*_,t[6]=(d*a*s-r*f*s-d*n*h+e*f*h+r*n*y-e*a*y)*_,t[7]=(r*u*s-l*a*s+l*n*h-e*u*h-r*n*p+e*a*p)*_,t[8]=x*_,t[9]=(d*c*s-l*m*s-d*i*p+e*m*p+l*i*y-e*c*y)*_,t[10]=(r*m*s-d*o*s+d*i*h-e*m*h-r*i*y+e*o*y)*_,t[11]=(l*o*s-r*c*s-l*i*h+e*c*h+r*i*p-e*o*p)*_,t[12]=b*_,t[13]=(l*m*n-d*c*n+d*i*u-e*m*u-l*i*f+e*c*f)*_,t[14]=(d*o*n-r*m*n-d*i*a+e*m*a+r*i*f-e*o*f)*_,t[15]=(r*c*n-l*o*n+l*i*a-e*c*a-r*i*u+e*o*u)*_,this}scale(t){const e=this.elements,i=t.x,n=t.y,s=t.z;return e[0]*=i,e[4]*=n,e[8]*=s,e[1]*=i,e[5]*=n,e[9]*=s,e[2]*=i,e[6]*=n,e[10]*=s,e[3]*=i,e[7]*=n,e[11]*=s,this}getMaxScaleOnAxis(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],i=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],n=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,i,n))}makeTranslation(t,e,i){return t.isVector3?this.set(1,0,0,t.x,0,1,0,t.y,0,0,1,t.z,0,0,0,1):this.set(1,0,0,t,0,1,0,e,0,0,1,i,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),i=Math.sin(t);return this.set(1,0,0,0,0,e,-i,0,0,i,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,0,i,0,0,1,0,0,-i,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,-i,0,0,i,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){const i=Math.cos(e),n=Math.sin(e),s=1-i,r=t.x,o=t.y,a=t.z,h=s*r,l=s*o;return this.set(h*r+i,h*o-n*a,h*a+n*o,0,h*o+n*a,l*o+i,l*a-n*r,0,h*a-n*o,l*a+n*r,s*a*a+i,0,0,0,0,1),this}makeScale(t,e,i){return this.set(t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1),this}makeShear(t,e,i,n,s,r){return this.set(1,i,s,0,t,1,r,0,e,n,1,0,0,0,0,1),this}compose(t,e,i){const n=this.elements,s=e._x,r=e._y,o=e._z,a=e._w,h=s+s,l=r+r,c=o+o,u=s*h,p=s*l,d=s*c,m=r*l,f=r*c,y=o*c,v=a*h,g=a*l,x=a*c,b=i.x,w=i.y,_=i.z;return n[0]=(1-(m+y))*b,n[1]=(p+x)*b,n[2]=(d-g)*b,n[3]=0,n[4]=(p-x)*w,n[5]=(1-(u+y))*w,n[6]=(f+v)*w,n[7]=0,n[8]=(d+g)*_,n[9]=(f-v)*_,n[10]=(1-(u+m))*_,n[11]=0,n[12]=t.x,n[13]=t.y,n[14]=t.z,n[15]=1,this}decompose(t,e,i){const n=this.elements;let s=Mt.set(n[0],n[1],n[2]).length();const r=Mt.set(n[4],n[5],n[6]).length(),o=Mt.set(n[8],n[9],n[10]).length();this.determinant()<0&&(s=-s),t.x=n[12],t.y=n[13],t.z=n[14],St.copy(this);const a=1/s,h=1/r,l=1/o;return St.elements[0]*=a,St.elements[1]*=a,St.elements[2]*=a,St.elements[4]*=h,St.elements[5]*=h,St.elements[6]*=h,St.elements[8]*=l,St.elements[9]*=l,St.elements[10]*=l,e.setFromRotationMatrix(St),i.x=s,i.y=r,i.z=o,this}makePerspective(t,e,i,n,s,r,o=2e3){const a=this.elements,h=2*s/(e-t),l=2*s/(i-n),c=(e+t)/(e-t),u=(i+n)/(i-n);let p,d;if(o===m)p=-(r+s)/(r-s),d=-2*r*s/(r-s);else{if(o!==f)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+o);p=-r/(r-s),d=-r*s/(r-s)}return a[0]=h,a[4]=0,a[8]=c,a[12]=0,a[1]=0,a[5]=l,a[9]=u,a[13]=0,a[2]=0,a[6]=0,a[10]=p,a[14]=d,a[3]=0,a[7]=0,a[11]=-1,a[15]=0,this}makeOrthographic(t,e,i,n,s,r,o=2e3){const a=this.elements,h=1/(e-t),l=1/(i-n),c=1/(r-s),u=(e+t)*h,p=(i+n)*l;let d,y;if(o===m)d=(r+s)*c,y=-2*c;else{if(o!==f)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+o);d=s*c,y=-1*c}return a[0]=2*h,a[4]=0,a[8]=0,a[12]=-u,a[1]=0,a[5]=2*l,a[9]=0,a[13]=-p,a[2]=0,a[6]=0,a[10]=y,a[14]=-d,a[3]=0,a[7]=0,a[11]=0,a[15]=1,this}equals(t){const e=this.elements,i=t.elements;for(let t=0;t<16;t++)if(e[t]!==i[t])return!1;return!0}fromArray(t,e=0){for(let i=0;i<16;i++)this.elements[i]=t[i+e];return this}toArray(t=[],e=0){const i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t[e+9]=i[9],t[e+10]=i[10],t[e+11]=i[11],t[e+12]=i[12],t[e+13]=i[13],t[e+14]=i[14],t[e+15]=i[15],t}}const Mt=new G,St=new _t,At=new G(0,0,0),zt=new G(1,1,1),Tt=new G,Pt=new G,kt=new G,Et=new _t,Bt=new H;class Ct{constructor(t=0,e=0,i=0,n=Ct.DEFAULT_ORDER){this.isEuler=!0,this._x=t,this._y=e,this._z=i,this._order=n}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get order(){return this._order}set order(t){this._order=t,this._onChangeCallback()}set(t,e,i,n=this._order){return this._x=t,this._y=e,this._z=i,this._order=n,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this}setFromRotationMatrix(t,e=this._order,i=!0){const n=t.elements,s=n[0],r=n[4],o=n[8],a=n[1],h=n[5],l=n[9],c=n[2],u=n[6],p=n[10];switch(e){case"XYZ":this._y=Math.asin(w(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-l,p),this._z=Math.atan2(-r,s)):(this._x=Math.atan2(u,h),this._z=0);break;case"YXZ":this._x=Math.asin(-w(l,-1,1)),Math.abs(l)<.9999999?(this._y=Math.atan2(o,p),this._z=Math.atan2(a,h)):(this._y=Math.atan2(-c,s),this._z=0);break;case"ZXY":this._x=Math.asin(w(u,-1,1)),Math.abs(u)<.9999999?(this._y=Math.atan2(-c,p),this._z=Math.atan2(-r,h)):(this._y=0,this._z=Math.atan2(a,s));break;case"ZYX":this._y=Math.asin(-w(c,-1,1)),Math.abs(c)<.9999999?(this._x=Math.atan2(u,p),this._z=Math.atan2(a,s)):(this._x=0,this._z=Math.atan2(-r,h));break;case"YZX":this._z=Math.asin(w(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-l,h),this._y=Math.atan2(-c,s)):(this._x=0,this._y=Math.atan2(o,p));break;case"XZY":this._z=Math.asin(-w(r,-1,1)),Math.abs(r)<.9999999?(this._x=Math.atan2(u,h),this._y=Math.atan2(o,s)):(this._x=Math.atan2(-l,p),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+e)}return this._order=e,!0===i&&this._onChangeCallback(),this}setFromQuaternion(t,e,i){return Et.makeRotationFromQuaternion(t),this.setFromRotationMatrix(Et,e,i)}setFromVector3(t,e=this._order){return this.set(t.x,t.y,t.z,e)}reorder(t){return Bt.setFromEuler(this),this.setFromQuaternion(Bt,t)}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}Ct.DEFAULT_ORDER="XYZ";class It{constructor(){this.mask=1}set(t){this.mask=1<<t>>>0}enable(t){this.mask|=1<<t}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t}disable(t){this.mask&=~(1<<t)}disableAll(){this.mask=0}test(t){return!!(this.mask&t.mask)}isEnabled(t){return!!(this.mask&1<<t)}}let Rt=0;const Vt=new G,Ft=new H,Ot=new _t,jt=new G,Nt=new G,qt=new G,Lt=new H,Dt=new G(1,0,0),Wt=new G(0,1,0),Ut=new G(0,0,1),Ht={type:"added"},Gt={type:"removed"},Xt={type:"childadded",child:null},Yt={type:"childremoved",child:null};class Zt extends y{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:Rt++}),this.uuid=b(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Zt.DEFAULT_UP.clone();const t=new G,e=new Ct,i=new H,n=new G(1,1,1);e._onChange((function(){i.setFromEuler(e,!1)})),i._onChange((function(){e.setFromQuaternion(i,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:t},rotation:{configurable:!0,enumerable:!0,value:e},quaternion:{configurable:!0,enumerable:!0,value:i},scale:{configurable:!0,enumerable:!0,value:n},modelViewMatrix:{value:new _t},normalMatrix:{value:new z}}),this.matrix=new _t,this.matrixWorld=new _t,this.matrixAutoUpdate=Zt.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=Zt.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new It,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(t){return this.quaternion.premultiply(t),this}setRotationFromAxisAngle(t,e){this.quaternion.setFromAxisAngle(t,e)}setRotationFromEuler(t){this.quaternion.setFromEuler(t,!0)}setRotationFromMatrix(t){this.quaternion.setFromRotationMatrix(t)}setRotationFromQuaternion(t){this.quaternion.copy(t)}rotateOnAxis(t,e){return Ft.setFromAxisAngle(t,e),this.quaternion.multiply(Ft),this}rotateOnWorldAxis(t,e){return Ft.setFromAxisAngle(t,e),this.quaternion.premultiply(Ft),this}rotateX(t){return this.rotateOnAxis(Dt,t)}rotateY(t){return this.rotateOnAxis(Wt,t)}rotateZ(t){return this.rotateOnAxis(Ut,t)}translateOnAxis(t,e){return Vt.copy(t).applyQuaternion(this.quaternion),this.position.add(Vt.multiplyScalar(e)),this}translateX(t){return this.translateOnAxis(Dt,t)}translateY(t){return this.translateOnAxis(Wt,t)}translateZ(t){return this.translateOnAxis(Ut,t)}localToWorld(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(this.matrixWorld)}worldToLocal(t){return this.updateWorldMatrix(!0,!1),t.applyMatrix4(Ot.copy(this.matrixWorld).invert())}lookAt(t,e,i){t.isVector3?jt.copy(t):jt.set(t,e,i);const n=this.parent;this.updateWorldMatrix(!0,!1),Nt.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?Ot.lookAt(Nt,jt,this.up):Ot.lookAt(jt,Nt,this.up),this.quaternion.setFromRotationMatrix(Ot),n&&(Ot.extractRotation(n.matrixWorld),Ft.setFromRotationMatrix(Ot),this.quaternion.premultiply(Ft.invert()))}add(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return t===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",t),this):(t&&t.isObject3D?(t.removeFromParent(),t.parent=this,this.children.push(t),t.dispatchEvent(Ht),Xt.child=t,this.dispatchEvent(Xt),Xt.child=null):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t),this)}remove(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.remove(arguments[t]);return this}const e=this.children.indexOf(t);return-1!==e&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(Gt),Yt.child=t,this.dispatchEvent(Yt),Yt.child=null),this}removeFromParent(){const t=this.parent;return null!==t&&t.remove(this),this}clear(){return this.remove(...this.children)}attach(t){return this.updateWorldMatrix(!0,!1),Ot.copy(this.matrixWorld).invert(),null!==t.parent&&(t.parent.updateWorldMatrix(!0,!1),Ot.multiply(t.parent.matrixWorld)),t.applyMatrix4(Ot),t.removeFromParent(),t.parent=this,this.children.push(t),t.updateWorldMatrix(!1,!0),t.dispatchEvent(Ht),Xt.child=t,this.dispatchEvent(Xt),Xt.child=null,this}getObjectById(t){return this.getObjectByProperty("id",t)}getObjectByName(t){return this.getObjectByProperty("name",t)}getObjectByProperty(t,e){if(this[t]===e)return this;for(let i=0,n=this.children.length;i<n;i++){const n=this.children[i].getObjectByProperty(t,e);if(void 0!==n)return n}}getObjectsByProperty(t,e,i=[]){this[t]===e&&i.push(this);const n=this.children;for(let s=0,r=n.length;s<r;s++)n[s].getObjectsByProperty(t,e,i);return i}getWorldPosition(t){return this.updateWorldMatrix(!0,!1),t.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Nt,t,qt),t}getWorldScale(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(Nt,Lt,t),t}getWorldDirection(t){this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()}raycast(){}traverse(t){t(this);const e=this.children;for(let i=0,n=e.length;i<n;i++)e[i].traverse(t)}traverseVisible(t){if(!1===this.visible)return;t(this);const e=this.children;for(let i=0,n=e.length;i<n;i++)e[i].traverseVisible(t)}traverseAncestors(t){const e=this.parent;null!==e&&(t(e),e.traverseAncestors(t))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let i=0,n=e.length;i<n;i++)e[i].updateMatrixWorld(t)}updateWorldMatrix(t,e){const i=this.parent;if(!0===t&&null!==i&&i.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),!0===e){const t=this.children;for(let e=0,i=t.length;e<i;e++)t[e].updateWorldMatrix(!1,!0)}}toJSON(t){const e=void 0===t||"string"==typeof t,i={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},i.metadata={version:4.6,type:"Object",generator:"Object3D.toJSON"});const n={};function s(e,i){return void 0===e[i.uuid]&&(e[i.uuid]=i.toJSON(t)),i.uuid}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),!0===this.castShadow&&(n.castShadow=!0),!0===this.receiveShadow&&(n.receiveShadow=!0),!1===this.visible&&(n.visible=!1),!1===this.frustumCulled&&(n.frustumCulled=!1),0!==this.renderOrder&&(n.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(n.userData=this.userData),n.layers=this.layers.mask,n.matrix=this.matrix.toArray(),n.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(n.matrixAutoUpdate=!1),this.isInstancedMesh&&(n.type="InstancedMesh",n.count=this.count,n.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(n.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(n.type="BatchedMesh",n.perObjectFrustumCulled=this.perObjectFrustumCulled,n.sortObjects=this.sortObjects,n.drawRanges=this._drawRanges,n.reservedRanges=this._reservedRanges,n.visibility=this._visibility,n.active=this._active,n.bounds=this._bounds.map((t=>({boxInitialized:t.boxInitialized,boxMin:t.box.min.toArray(),boxMax:t.box.max.toArray(),sphereInitialized:t.sphereInitialized,sphereRadius:t.sphere.radius,sphereCenter:t.sphere.center.toArray()}))),n.maxInstanceCount=this._maxInstanceCount,n.maxVertexCount=this._maxVertexCount,n.maxIndexCount=this._maxIndexCount,n.geometryInitialized=this._geometryInitialized,n.geometryCount=this._geometryCount,n.matricesTexture=this._matricesTexture.toJSON(t),null!==this._colorsTexture&&(n.colorsTexture=this._colorsTexture.toJSON(t)),null!==this.boundingSphere&&(n.boundingSphere={center:n.boundingSphere.center.toArray(),radius:n.boundingSphere.radius}),null!==this.boundingBox&&(n.boundingBox={min:n.boundingBox.min.toArray(),max:n.boundingBox.max.toArray()})),this.isScene)this.background&&(this.background.isColor?n.background=this.background.toJSON():this.background.isTexture&&(n.background=this.background.toJSON(t).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(n.environment=this.environment.toJSON(t).uuid);else if(this.isMesh||this.isLine||this.isPoints){n.geometry=s(t.geometries,this.geometry);const e=this.geometry.parameters;if(void 0!==e&&void 0!==e.shapes){const i=e.shapes;if(Array.isArray(i))for(let e=0,n=i.length;e<n;e++){const n=i[e];s(t.shapes,n)}else s(t.shapes,i)}}if(this.isSkinnedMesh&&(n.bindMode=this.bindMode,n.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(s(t.skeletons,this.skeleton),n.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const e=[];for(let i=0,n=this.material.length;i<n;i++)e.push(s(t.materials,this.material[i]));n.material=e}else n.material=s(t.materials,this.material);if(this.children.length>0){n.children=[];for(let e=0;e<this.children.length;e++)n.children.push(this.children[e].toJSON(t).object)}if(this.animations.length>0){n.animations=[];for(let e=0;e<this.animations.length;e++){const i=this.animations[e];n.animations.push(s(t.animations,i))}}if(e){const e=r(t.geometries),n=r(t.materials),s=r(t.textures),o=r(t.images),a=r(t.shapes),h=r(t.skeletons),l=r(t.animations),c=r(t.nodes);e.length>0&&(i.geometries=e),n.length>0&&(i.materials=n),s.length>0&&(i.textures=s),o.length>0&&(i.images=o),a.length>0&&(i.shapes=a),h.length>0&&(i.skeletons=h),l.length>0&&(i.animations=l),c.length>0&&(i.nodes=c)}return i.object=n,i;function r(t){const e=[];for(const i in t){const n=t[i];delete n.metadata,e.push(n)}return e}}clone(t){return(new this.constructor).copy(this,t)}copy(t,e=!0){if(this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldAutoUpdate=t.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.animations=t.animations.slice(),this.userData=JSON.parse(JSON.stringify(t.userData)),!0===e)for(let e=0;e<t.children.length;e++){const i=t.children[e];this.add(i.clone())}return this}}Zt.DEFAULT_UP=new G(0,1,0),Zt.DEFAULT_MATRIX_AUTO_UPDATE=!0,Zt.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const Qt=new G,Jt=new G,$t=new G,Kt=new G,te=new G,ee=new G,ie=new G,ne=new G,se=new G,re=new G;class oe{constructor(t=new G,e=new G,i=new G){this.a=t,this.b=e,this.c=i}static getNormal(t,e,i,n){n.subVectors(i,e),Qt.subVectors(t,e),n.cross(Qt);const s=n.lengthSq();return s>0?n.multiplyScalar(1/Math.sqrt(s)):n.set(0,0,0)}static getBarycoord(t,e,i,n,s){Qt.subVectors(n,e),Jt.subVectors(i,e),$t.subVectors(t,e);const r=Qt.dot(Qt),o=Qt.dot(Jt),a=Qt.dot($t),h=Jt.dot(Jt),l=Jt.dot($t),c=r*h-o*o;if(0===c)return s.set(0,0,0),null;const u=1/c,p=(h*a-o*l)*u,d=(r*l-o*a)*u;return s.set(1-p-d,d,p)}static containsPoint(t,e,i,n){return null!==this.getBarycoord(t,e,i,n,Kt)&&Kt.x>=0&&Kt.y>=0&&Kt.x+Kt.y<=1}static getInterpolation(t,e,i,n,s,r,o,a){return null===this.getBarycoord(t,e,i,n,Kt)?(a.x=0,a.y=0,"z"in a&&(a.z=0),"w"in a&&(a.w=0),null):(a.setScalar(0),a.addScaledVector(s,Kt.x),a.addScaledVector(r,Kt.y),a.addScaledVector(o,Kt.z),a)}static isFrontFacing(t,e,i,n){return Qt.subVectors(i,e),Jt.subVectors(t,e),Qt.cross(Jt).dot(n)<0}set(t,e,i){return this.a.copy(t),this.b.copy(e),this.c.copy(i),this}setFromPointsAndIndices(t,e,i,n){return this.a.copy(t[e]),this.b.copy(t[i]),this.c.copy(t[n]),this}setFromAttributeAndIndices(t,e,i,n){return this.a.fromBufferAttribute(t,e),this.b.fromBufferAttribute(t,i),this.c.fromBufferAttribute(t,n),this}clone(){return(new this.constructor).copy(this)}copy(t){return this.a.copy(t.a),this.b.copy(t.b),this.c.copy(t.c),this}getArea(){return Qt.subVectors(this.c,this.b),Jt.subVectors(this.a,this.b),.5*Qt.cross(Jt).length()}getMidpoint(t){return t.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(t){return oe.getNormal(this.a,this.b,this.c,t)}getPlane(t){return t.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(t,e){return oe.getBarycoord(t,this.a,this.b,this.c,e)}getInterpolation(t,e,i,n,s){return oe.getInterpolation(t,this.a,this.b,this.c,e,i,n,s)}containsPoint(t){return oe.containsPoint(t,this.a,this.b,this.c)}isFrontFacing(t){return oe.isFrontFacing(this.a,this.b,this.c,t)}intersectsBox(t){return t.intersectsTriangle(this)}closestPointToPoint(t,e){const i=this.a,n=this.b,s=this.c;let r,o;te.subVectors(n,i),ee.subVectors(s,i),ne.subVectors(t,i);const a=te.dot(ne),h=ee.dot(ne);if(a<=0&&h<=0)return e.copy(i);se.subVectors(t,n);const l=te.dot(se),c=ee.dot(se);if(l>=0&&c<=l)return e.copy(n);const u=a*c-l*h;if(u<=0&&a>=0&&l<=0)return r=a/(a-l),e.copy(i).addScaledVector(te,r);re.subVectors(t,s);const p=te.dot(re),d=ee.dot(re);if(d>=0&&p<=d)return e.copy(s);const m=p*h-a*d;if(m<=0&&h>=0&&d<=0)return o=h/(h-d),e.copy(i).addScaledVector(ee,o);const f=l*d-p*c;if(f<=0&&c-l>=0&&p-d>=0)return ie.subVectors(s,n),o=(c-l)/(c-l+(p-d)),e.copy(n).addScaledVector(ie,o);const y=1/(f+m+u);return r=m*y,o=u*y,e.copy(i).addScaledVector(te,r).addScaledVector(ee,o)}equals(t){return t.a.equals(this.a)&&t.b.equals(this.b)&&t.c.equals(this.c)}}const ae={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},he={h:0,s:0,l:0},le={h:0,s:0,l:0};function ce(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+6*(e-t)*(2/3-i):t}class ue{constructor(t,e,i){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(t,e,i)}set(t,e,i){if(void 0===e&&void 0===i){const e=t;e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e)}else this.setRGB(t,e,i);return this}setScalar(t){return this.r=t,this.g=t,this.b=t,this}setHex(t,e=r){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,R.toWorkingColorSpace(this,e),this}setRGB(t,e,i,n=R.workingColorSpace){return this.r=t,this.g=e,this.b=i,R.toWorkingColorSpace(this,n),this}setHSL(t,e,i,n=R.workingColorSpace){if(t=(t%(s=1)+s)%s,e=w(e,0,1),i=w(i,0,1),0===e)this.r=this.g=this.b=i;else{const n=i<=.5?i*(1+e):i+e-i*e,s=2*i-n;this.r=ce(s,n,t+1/3),this.g=ce(s,n,t),this.b=ce(s,n,t-1/3)}var s;return R.toWorkingColorSpace(this,n),this}setStyle(t,e=r){function i(e){void 0!==e&&parseFloat(e)<1&&console.warn("THREE.Color: Alpha component of "+t+" will be ignored.")}let n;if(n=/^(\w+)\(([^\)]*)\)/.exec(t)){let s;const r=n[1],o=n[2];switch(r){case"rgb":case"rgba":if(s=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return i(s[4]),this.setRGB(Math.min(255,parseInt(s[1],10))/255,Math.min(255,parseInt(s[2],10))/255,Math.min(255,parseInt(s[3],10))/255,e);if(s=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return i(s[4]),this.setRGB(Math.min(100,parseInt(s[1],10))/100,Math.min(100,parseInt(s[2],10))/100,Math.min(100,parseInt(s[3],10))/100,e);break;case"hsl":case"hsla":if(s=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(o))return i(s[4]),this.setHSL(parseFloat(s[1])/360,parseFloat(s[2])/100,parseFloat(s[3])/100,e);break;default:console.warn("THREE.Color: Unknown color model "+t)}}else if(n=/^\#([A-Fa-f\d]+)$/.exec(t)){const i=n[1],s=i.length;if(3===s)return this.setRGB(parseInt(i.charAt(0),16)/15,parseInt(i.charAt(1),16)/15,parseInt(i.charAt(2),16)/15,e);if(6===s)return this.setHex(parseInt(i,16),e);console.warn("THREE.Color: Invalid hex color "+t)}else if(t&&t.length>0)return this.setColorName(t,e);return this}setColorName(t,e=r){const i=ae[t.toLowerCase()];return void 0!==i?this.setHex(i,e):console.warn("THREE.Color: Unknown color "+t),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this}copySRGBToLinear(t){return this.r=V(t.r),this.g=V(t.g),this.b=V(t.b),this}copyLinearToSRGB(t){return this.r=F(t.r),this.g=F(t.g),this.b=F(t.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(t=r){return R.fromWorkingColorSpace(pe.copy(this),t),65536*Math.round(w(255*pe.r,0,255))+256*Math.round(w(255*pe.g,0,255))+Math.round(w(255*pe.b,0,255))}getHexString(t=r){return("000000"+this.getHex(t).toString(16)).slice(-6)}getHSL(t,e=R.workingColorSpace){R.fromWorkingColorSpace(pe.copy(this),e);const i=pe.r,n=pe.g,s=pe.b,r=Math.max(i,n,s),o=Math.min(i,n,s);let a,h;const l=(o+r)/2;if(o===r)a=0,h=0;else{const t=r-o;switch(h=l<=.5?t/(r+o):t/(2-r-o),r){case i:a=(n-s)/t+(n<s?6:0);break;case n:a=(s-i)/t+2;break;case s:a=(i-n)/t+4}a/=6}return t.h=a,t.s=h,t.l=l,t}getRGB(t,e=R.workingColorSpace){return R.fromWorkingColorSpace(pe.copy(this),e),t.r=pe.r,t.g=pe.g,t.b=pe.b,t}getStyle(t=r){R.fromWorkingColorSpace(pe.copy(this),t);const e=pe.r,i=pe.g,n=pe.b;return t!==r?`color(${t} ${e.toFixed(3)} ${i.toFixed(3)} ${n.toFixed(3)})`:`rgb(${Math.round(255*e)},${Math.round(255*i)},${Math.round(255*n)})`}offsetHSL(t,e,i){return this.getHSL(he),this.setHSL(he.h+t,he.s+e,he.l+i)}add(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this}addColors(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this}addScalar(t){return this.r+=t,this.g+=t,this.b+=t,this}sub(t){return this.r=Math.max(0,this.r-t.r),this.g=Math.max(0,this.g-t.g),this.b=Math.max(0,this.b-t.b),this}multiply(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this}multiplyScalar(t){return this.r*=t,this.g*=t,this.b*=t,this}lerp(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this}lerpColors(t,e,i){return this.r=t.r+(e.r-t.r)*i,this.g=t.g+(e.g-t.g)*i,this.b=t.b+(e.b-t.b)*i,this}lerpHSL(t,e){this.getHSL(he),t.getHSL(le);const i=_(he.h,le.h,e),n=_(he.s,le.s,e),s=_(he.l,le.l,e);return this.setHSL(i,n,s),this}setFromVector3(t){return this.r=t.x,this.g=t.y,this.b=t.z,this}applyMatrix3(t){const e=this.r,i=this.g,n=this.b,s=t.elements;return this.r=s[0]*e+s[3]*i+s[6]*n,this.g=s[1]*e+s[4]*i+s[7]*n,this.b=s[2]*e+s[5]*i+s[8]*n,this}equals(t){return t.r===this.r&&t.g===this.g&&t.b===this.b}fromArray(t,e=0){return this.r=t[e],this.g=t[e+1],this.b=t[e+2],this}toArray(t=[],e=0){return t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t}fromBufferAttribute(t,e){return this.r=t.getX(e),this.g=t.getY(e),this.b=t.getZ(e),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const pe=new ue;ue.NAMES=ae;let de=0;class me extends y{constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:de++}),this.uuid=b(),this.name="",this.type="Material",this.blending=1,this.side=0,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=204,this.blendDst=205,this.blendEquation=100,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new ue(0,0,0),this.blendAlpha=0,this.depthFunc=3,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=p,this.stencilZFail=p,this.stencilZPass=p,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(t){this._alphaTest>0!=t>0&&this.version++,this._alphaTest=t}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(t){if(void 0!==t)for(const e in t){const i=t[e];if(void 0===i){console.warn(`THREE.Material: parameter '${e}' has value of undefined.`);continue}const n=this[e];void 0!==n?n&&n.isColor?n.set(i):n&&n.isVector3&&i&&i.isVector3?n.copy(i):this[e]=i:console.warn(`THREE.Material: '${e}' is not a property of THREE.${this.type}.`)}}toJSON(t){const e=void 0===t||"string"==typeof t;e&&(t={textures:{},images:{}});const i={metadata:{version:4.6,type:"Material",generator:"Material.toJSON"}};function n(t){const e=[];for(const i in t){const n=t[i];delete n.metadata,e.push(n)}return e}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),this.color&&this.color.isColor&&(i.color=this.color.getHex()),void 0!==this.roughness&&(i.roughness=this.roughness),void 0!==this.metalness&&(i.metalness=this.metalness),void 0!==this.sheen&&(i.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(i.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(i.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(i.emissive=this.emissive.getHex()),void 0!==this.emissiveIntensity&&1!==this.emissiveIntensity&&(i.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(i.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(i.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(i.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(i.shininess=this.shininess),void 0!==this.clearcoat&&(i.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(i.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(i.clearcoatMap=this.clearcoatMap.toJSON(t).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(i.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(t).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(i.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(t).uuid,i.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),void 0!==this.dispersion&&(i.dispersion=this.dispersion),void 0!==this.iridescence&&(i.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(i.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(i.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(i.iridescenceMap=this.iridescenceMap.toJSON(t).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(i.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(t).uuid),void 0!==this.anisotropy&&(i.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(i.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(i.anisotropyMap=this.anisotropyMap.toJSON(t).uuid),this.map&&this.map.isTexture&&(i.map=this.map.toJSON(t).uuid),this.matcap&&this.matcap.isTexture&&(i.matcap=this.matcap.toJSON(t).uuid),this.alphaMap&&this.alphaMap.isTexture&&(i.alphaMap=this.alphaMap.toJSON(t).uuid),this.lightMap&&this.lightMap.isTexture&&(i.lightMap=this.lightMap.toJSON(t).uuid,i.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(i.aoMap=this.aoMap.toJSON(t).uuid,i.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(i.bumpMap=this.bumpMap.toJSON(t).uuid,i.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(i.normalMap=this.normalMap.toJSON(t).uuid,i.normalMapType=this.normalMapType,i.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(i.displacementMap=this.displacementMap.toJSON(t).uuid,i.displacementScale=this.displacementScale,i.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(i.roughnessMap=this.roughnessMap.toJSON(t).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(i.metalnessMap=this.metalnessMap.toJSON(t).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(i.emissiveMap=this.emissiveMap.toJSON(t).uuid),this.specularMap&&this.specularMap.isTexture&&(i.specularMap=this.specularMap.toJSON(t).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(i.specularIntensityMap=this.specularIntensityMap.toJSON(t).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(i.specularColorMap=this.specularColorMap.toJSON(t).uuid),this.envMap&&this.envMap.isTexture&&(i.envMap=this.envMap.toJSON(t).uuid,void 0!==this.combine&&(i.combine=this.combine)),void 0!==this.envMapRotation&&(i.envMapRotation=this.envMapRotation.toArray()),void 0!==this.envMapIntensity&&(i.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(i.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(i.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(i.gradientMap=this.gradientMap.toJSON(t).uuid),void 0!==this.transmission&&(i.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(i.transmissionMap=this.transmissionMap.toJSON(t).uuid),void 0!==this.thickness&&(i.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(i.thicknessMap=this.thicknessMap.toJSON(t).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(i.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(i.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(i.size=this.size),null!==this.shadowSide&&(i.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(i.sizeAttenuation=this.sizeAttenuation),1!==this.blending&&(i.blending=this.blending),0!==this.side&&(i.side=this.side),!0===this.vertexColors&&(i.vertexColors=!0),this.opacity<1&&(i.opacity=this.opacity),!0===this.transparent&&(i.transparent=!0),204!==this.blendSrc&&(i.blendSrc=this.blendSrc),205!==this.blendDst&&(i.blendDst=this.blendDst),100!==this.blendEquation&&(i.blendEquation=this.blendEquation),null!==this.blendSrcAlpha&&(i.blendSrcAlpha=this.blendSrcAlpha),null!==this.blendDstAlpha&&(i.blendDstAlpha=this.blendDstAlpha),null!==this.blendEquationAlpha&&(i.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(i.blendColor=this.blendColor.getHex()),0!==this.blendAlpha&&(i.blendAlpha=this.blendAlpha),3!==this.depthFunc&&(i.depthFunc=this.depthFunc),!1===this.depthTest&&(i.depthTest=this.depthTest),!1===this.depthWrite&&(i.depthWrite=this.depthWrite),!1===this.colorWrite&&(i.colorWrite=this.colorWrite),255!==this.stencilWriteMask&&(i.stencilWriteMask=this.stencilWriteMask),519!==this.stencilFunc&&(i.stencilFunc=this.stencilFunc),0!==this.stencilRef&&(i.stencilRef=this.stencilRef),255!==this.stencilFuncMask&&(i.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==p&&(i.stencilFail=this.stencilFail),this.stencilZFail!==p&&(i.stencilZFail=this.stencilZFail),this.stencilZPass!==p&&(i.stencilZPass=this.stencilZPass),!0===this.stencilWrite&&(i.stencilWrite=this.stencilWrite),void 0!==this.rotation&&0!==this.rotation&&(i.rotation=this.rotation),!0===this.polygonOffset&&(i.polygonOffset=!0),0!==this.polygonOffsetFactor&&(i.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(i.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(i.linewidth=this.linewidth),void 0!==this.dashSize&&(i.dashSize=this.dashSize),void 0!==this.gapSize&&(i.gapSize=this.gapSize),void 0!==this.scale&&(i.scale=this.scale),!0===this.dithering&&(i.dithering=!0),this.alphaTest>0&&(i.alphaTest=this.alphaTest),!0===this.alphaHash&&(i.alphaHash=!0),!0===this.alphaToCoverage&&(i.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(i.premultipliedAlpha=!0),!0===this.forceSinglePass&&(i.forceSinglePass=!0),!0===this.wireframe&&(i.wireframe=!0),this.wireframeLinewidth>1&&(i.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(i.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(i.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(i.flatShading=!0),!1===this.visible&&(i.visible=!1),!1===this.toneMapped&&(i.toneMapped=!1),!1===this.fog&&(i.fog=!1),Object.keys(this.userData).length>0&&(i.userData=this.userData),e){const e=n(t.textures),s=n(t.images);e.length>0&&(i.textures=e),s.length>0&&(i.images=s)}return i}clone(){return(new this.constructor).copy(this)}copy(t){this.name=t.name,this.blending=t.blending,this.side=t.side,this.vertexColors=t.vertexColors,this.opacity=t.opacity,this.transparent=t.transparent,this.blendSrc=t.blendSrc,this.blendDst=t.blendDst,this.blendEquation=t.blendEquation,this.blendSrcAlpha=t.blendSrcAlpha,this.blendDstAlpha=t.blendDstAlpha,this.blendEquationAlpha=t.blendEquationAlpha,this.blendColor.copy(t.blendColor),this.blendAlpha=t.blendAlpha,this.depthFunc=t.depthFunc,this.depthTest=t.depthTest,this.depthWrite=t.depthWrite,this.stencilWriteMask=t.stencilWriteMask,this.stencilFunc=t.stencilFunc,this.stencilRef=t.stencilRef,this.stencilFuncMask=t.stencilFuncMask,this.stencilFail=t.stencilFail,this.stencilZFail=t.stencilZFail,this.stencilZPass=t.stencilZPass,this.stencilWrite=t.stencilWrite;const e=t.clippingPlanes;let i=null;if(null!==e){const t=e.length;i=new Array(t);for(let n=0;n!==t;++n)i[n]=e[n].clone()}return this.clippingPlanes=i,this.clipIntersection=t.clipIntersection,this.clipShadows=t.clipShadows,this.shadowSide=t.shadowSide,this.colorWrite=t.colorWrite,this.precision=t.precision,this.polygonOffset=t.polygonOffset,this.polygonOffsetFactor=t.polygonOffsetFactor,this.polygonOffsetUnits=t.polygonOffsetUnits,this.dithering=t.dithering,this.alphaTest=t.alphaTest,this.alphaHash=t.alphaHash,this.alphaToCoverage=t.alphaToCoverage,this.premultipliedAlpha=t.premultipliedAlpha,this.forceSinglePass=t.forceSinglePass,this.visible=t.visible,this.toneMapped=t.toneMapped,this.userData=JSON.parse(JSON.stringify(t.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(t){!0===t&&this.version++}onBuild(){console.warn("Material: onBuild() has been removed.")}onBeforeRender(){console.warn("Material: onBeforeRender() has been removed.")}}class fe extends me{constructor(t){super(),this.isMeshBasicMaterial=!0,this.type="MeshBasicMaterial",this.color=new ue(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Ct,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.envMapRotation.copy(t.envMapRotation),this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.fog=t.fog,this}}const ye=new G,ve=new A;class ge{constructor(t,e,i=!1){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,this.name="",this.array=t,this.itemSize=e,this.count=void 0!==t?t.length/e:0,this.normalized=i,this.usage=d,this._updateRange={offset:0,count:-1},this.updateRanges=[],this.gpuType=1015,this.version=0}onUploadCallback(){}set needsUpdate(t){!0===t&&this.version++}get updateRange(){return(t="THREE.BufferAttribute: updateRange() is deprecated and will be removed in r169. Use addUpdateRange() instead.")in k||(k[t]=!0,console.warn(t)),this._updateRange;var t}setUsage(t){return this.usage=t,this}addUpdateRange(t,e){this.updateRanges.push({start:t,count:e})}clearUpdateRanges(){this.updateRanges.length=0}copy(t){return this.name=t.name,this.array=new t.array.constructor(t.array),this.itemSize=t.itemSize,this.count=t.count,this.normalized=t.normalized,this.usage=t.usage,this.gpuType=t.gpuType,this}copyAt(t,e,i){t*=this.itemSize,i*=e.itemSize;for(let n=0,s=this.itemSize;n<s;n++)this.array[t+n]=e.array[i+n];return this}copyArray(t){return this.array.set(t),this}applyMatrix3(t){if(2===this.itemSize)for(let e=0,i=this.count;e<i;e++)ve.fromBufferAttribute(this,e),ve.applyMatrix3(t),this.setXY(e,ve.x,ve.y);else if(3===this.itemSize)for(let e=0,i=this.count;e<i;e++)ye.fromBufferAttribute(this,e),ye.applyMatrix3(t),this.setXYZ(e,ye.x,ye.y,ye.z);return this}applyMatrix4(t){for(let e=0,i=this.count;e<i;e++)ye.fromBufferAttribute(this,e),ye.applyMatrix4(t),this.setXYZ(e,ye.x,ye.y,ye.z);return this}applyNormalMatrix(t){for(let e=0,i=this.count;e<i;e++)ye.fromBufferAttribute(this,e),ye.applyNormalMatrix(t),this.setXYZ(e,ye.x,ye.y,ye.z);return this}transformDirection(t){for(let e=0,i=this.count;e<i;e++)ye.fromBufferAttribute(this,e),ye.transformDirection(t),this.setXYZ(e,ye.x,ye.y,ye.z);return this}set(t,e=0){return this.array.set(t,e),this}getComponent(t,e){let i=this.array[t*this.itemSize+e];return this.normalized&&(i=M(i,this.array)),i}setComponent(t,e,i){return this.normalized&&(i=S(i,this.array)),this.array[t*this.itemSize+e]=i,this}getX(t){let e=this.array[t*this.itemSize];return this.normalized&&(e=M(e,this.array)),e}setX(t,e){return this.normalized&&(e=S(e,this.array)),this.array[t*this.itemSize]=e,this}getY(t){let e=this.array[t*this.itemSize+1];return this.normalized&&(e=M(e,this.array)),e}setY(t,e){return this.normalized&&(e=S(e,this.array)),this.array[t*this.itemSize+1]=e,this}getZ(t){let e=this.array[t*this.itemSize+2];return this.normalized&&(e=M(e,this.array)),e}setZ(t,e){return this.normalized&&(e=S(e,this.array)),this.array[t*this.itemSize+2]=e,this}getW(t){let e=this.array[t*this.itemSize+3];return this.normalized&&(e=M(e,this.array)),e}setW(t,e){return this.normalized&&(e=S(e,this.array)),this.array[t*this.itemSize+3]=e,this}setXY(t,e,i){return t*=this.itemSize,this.normalized&&(e=S(e,this.array),i=S(i,this.array)),this.array[t+0]=e,this.array[t+1]=i,this}setXYZ(t,e,i,n){return t*=this.itemSize,this.normalized&&(e=S(e,this.array),i=S(i,this.array),n=S(n,this.array)),this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=n,this}setXYZW(t,e,i,n,s){return t*=this.itemSize,this.normalized&&(e=S(e,this.array),i=S(i,this.array),n=S(n,this.array),s=S(s,this.array)),this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=n,this.array[t+3]=s,this}onUpload(t){return this.onUploadCallback=t,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const t={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(t.name=this.name),this.usage!==d&&(t.usage=this.usage),t}}class xe extends ge{constructor(t,e,i){super(new Uint16Array(t),e,i)}}class be extends ge{constructor(t,e,i){super(new Uint32Array(t),e,i)}}class we extends ge{constructor(t,e,i){super(new Float32Array(t),e,i)}}let _e=0;const Me=new _t,Se=new Zt,Ae=new G,ze=new Z,Te=new Z,Pe=new G;class ke extends y{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:_e++}),this.uuid=b(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(t){return Array.isArray(t)?this.index=new(function(t){for(let e=t.length-1;e>=0;--e)if(t[e]>=65535)return!0;return!1}(t)?be:xe)(t,1):this.index=t,this}getAttribute(t){return this.attributes[t]}setAttribute(t,e){return this.attributes[t]=e,this}deleteAttribute(t){return delete this.attributes[t],this}hasAttribute(t){return void 0!==this.attributes[t]}addGroup(t,e,i=0){this.groups.push({start:t,count:e,materialIndex:i})}clearGroups(){this.groups=[]}setDrawRange(t,e){this.drawRange.start=t,this.drawRange.count=e}applyMatrix4(t){const e=this.attributes.position;void 0!==e&&(e.applyMatrix4(t),e.needsUpdate=!0);const i=this.attributes.normal;if(void 0!==i){const e=(new z).getNormalMatrix(t);i.applyNormalMatrix(e),i.needsUpdate=!0}const n=this.attributes.tangent;return void 0!==n&&(n.transformDirection(t),n.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(t){return Me.makeRotationFromQuaternion(t),this.applyMatrix4(Me),this}rotateX(t){return Me.makeRotationX(t),this.applyMatrix4(Me),this}rotateY(t){return Me.makeRotationY(t),this.applyMatrix4(Me),this}rotateZ(t){return Me.makeRotationZ(t),this.applyMatrix4(Me),this}translate(t,e,i){return Me.makeTranslation(t,e,i),this.applyMatrix4(Me),this}scale(t,e,i){return Me.makeScale(t,e,i),this.applyMatrix4(Me),this}lookAt(t){return Se.lookAt(t),Se.updateMatrix(),this.applyMatrix4(Se.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(Ae).negate(),this.translate(Ae.x,Ae.y,Ae.z),this}setFromPoints(t){const e=[];for(let i=0,n=t.length;i<n;i++){const n=t[i];e.push(n.x,n.y,n.z||0)}return this.setAttribute("position",new we(e,3)),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new Z);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)return console.error("THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box.",this),void this.boundingBox.set(new G(-1/0,-1/0,-1/0),new G(1/0,1/0,1/0));if(void 0!==t){if(this.boundingBox.setFromBufferAttribute(t),e)for(let t=0,i=e.length;t<i;t++){const i=e[t];ze.setFromBufferAttribute(i),this.morphTargetsRelative?(Pe.addVectors(this.boundingBox.min,ze.min),this.boundingBox.expandByPoint(Pe),Pe.addVectors(this.boundingBox.max,ze.max),this.boundingBox.expandByPoint(Pe)):(this.boundingBox.expandByPoint(ze.min),this.boundingBox.expandByPoint(ze.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new dt);const t=this.attributes.position,e=this.morphAttributes.position;if(t&&t.isGLBufferAttribute)return console.error("THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere.",this),void this.boundingSphere.set(new G,1/0);if(t){const i=this.boundingSphere.center;if(ze.setFromBufferAttribute(t),e)for(let t=0,i=e.length;t<i;t++){const i=e[t];Te.setFromBufferAttribute(i),this.morphTargetsRelative?(Pe.addVectors(ze.min,Te.min),ze.expandByPoint(Pe),Pe.addVectors(ze.max,Te.max),ze.expandByPoint(Pe)):(ze.expandByPoint(Te.min),ze.expandByPoint(Te.max))}ze.getCenter(i);let n=0;for(let e=0,s=t.count;e<s;e++)Pe.fromBufferAttribute(t,e),n=Math.max(n,i.distanceToSquared(Pe));if(e)for(let s=0,r=e.length;s<r;s++){const r=e[s],o=this.morphTargetsRelative;for(let e=0,s=r.count;e<s;e++)Pe.fromBufferAttribute(r,e),o&&(Ae.fromBufferAttribute(t,e),Pe.add(Ae)),n=Math.max(n,i.distanceToSquared(Pe))}this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){const t=this.index,e=this.attributes;if(null===t||void 0===e.position||void 0===e.normal||void 0===e.uv)return void console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");const i=e.position,n=e.normal,s=e.uv;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new ge(new Float32Array(4*i.count),4));const r=this.getAttribute("tangent"),o=[],a=[];for(let t=0;t<i.count;t++)o[t]=new G,a[t]=new G;const h=new G,l=new G,c=new G,u=new A,p=new A,d=new A,m=new G,f=new G;function y(t,e,n){h.fromBufferAttribute(i,t),l.fromBufferAttribute(i,e),c.fromBufferAttribute(i,n),u.fromBufferAttribute(s,t),p.fromBufferAttribute(s,e),d.fromBufferAttribute(s,n),l.sub(h),c.sub(h),p.sub(u),d.sub(u);const r=1/(p.x*d.y-d.x*p.y);isFinite(r)&&(m.copy(l).multiplyScalar(d.y).addScaledVector(c,-p.y).multiplyScalar(r),f.copy(c).multiplyScalar(p.x).addScaledVector(l,-d.x).multiplyScalar(r),o[t].add(m),o[e].add(m),o[n].add(m),a[t].add(f),a[e].add(f),a[n].add(f))}let v=this.groups;0===v.length&&(v=[{start:0,count:t.count}]);for(let e=0,i=v.length;e<i;++e){const i=v[e],n=i.start;for(let e=n,s=n+i.count;e<s;e+=3)y(t.getX(e+0),t.getX(e+1),t.getX(e+2))}const g=new G,x=new G,b=new G,w=new G;function _(t){b.fromBufferAttribute(n,t),w.copy(b);const e=o[t];g.copy(e),g.sub(b.multiplyScalar(b.dot(e))).normalize(),x.crossVectors(w,e);const i=x.dot(a[t])<0?-1:1;r.setXYZW(t,g.x,g.y,g.z,i)}for(let e=0,i=v.length;e<i;++e){const i=v[e],n=i.start;for(let e=n,s=n+i.count;e<s;e+=3)_(t.getX(e+0)),_(t.getX(e+1)),_(t.getX(e+2))}}computeVertexNormals(){const t=this.index,e=this.getAttribute("position");if(void 0!==e){let i=this.getAttribute("normal");if(void 0===i)i=new ge(new Float32Array(3*e.count),3),this.setAttribute("normal",i);else for(let t=0,e=i.count;t<e;t++)i.setXYZ(t,0,0,0);const n=new G,s=new G,r=new G,o=new G,a=new G,h=new G,l=new G,c=new G;if(t)for(let u=0,p=t.count;u<p;u+=3){const p=t.getX(u+0),d=t.getX(u+1),m=t.getX(u+2);n.fromBufferAttribute(e,p),s.fromBufferAttribute(e,d),r.fromBufferAttribute(e,m),l.subVectors(r,s),c.subVectors(n,s),l.cross(c),o.fromBufferAttribute(i,p),a.fromBufferAttribute(i,d),h.fromBufferAttribute(i,m),o.add(l),a.add(l),h.add(l),i.setXYZ(p,o.x,o.y,o.z),i.setXYZ(d,a.x,a.y,a.z),i.setXYZ(m,h.x,h.y,h.z)}else for(let t=0,o=e.count;t<o;t+=3)n.fromBufferAttribute(e,t+0),s.fromBufferAttribute(e,t+1),r.fromBufferAttribute(e,t+2),l.subVectors(r,s),c.subVectors(n,s),l.cross(c),i.setXYZ(t+0,l.x,l.y,l.z),i.setXYZ(t+1,l.x,l.y,l.z),i.setXYZ(t+2,l.x,l.y,l.z);this.normalizeNormals(),i.needsUpdate=!0}}normalizeNormals(){const t=this.attributes.normal;for(let e=0,i=t.count;e<i;e++)Pe.fromBufferAttribute(t,e),Pe.normalize(),t.setXYZ(e,Pe.x,Pe.y,Pe.z)}toNonIndexed(){function t(t,e){const i=t.array,n=t.itemSize,s=t.normalized,r=new i.constructor(e.length*n);let o=0,a=0;for(let s=0,h=e.length;s<h;s++){o=t.isInterleavedBufferAttribute?e[s]*t.data.stride+t.offset:e[s]*n;for(let t=0;t<n;t++)r[a++]=i[o++]}return new ge(r,n,s)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const e=new ke,i=this.index.array,n=this.attributes;for(const s in n){const r=t(n[s],i);e.setAttribute(s,r)}const s=this.morphAttributes;for(const n in s){const r=[],o=s[n];for(let e=0,n=o.length;e<n;e++){const n=t(o[e],i);r.push(n)}e.morphAttributes[n]=r}e.morphTargetsRelative=this.morphTargetsRelative;const r=this.groups;for(let t=0,i=r.length;t<i;t++){const i=r[t];e.addGroup(i.start,i.count,i.materialIndex)}return e}toJSON(){const t={metadata:{version:4.6,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(t.uuid=this.uuid,t.type=this.type,""!==this.name&&(t.name=this.name),Object.keys(this.userData).length>0&&(t.userData=this.userData),void 0!==this.parameters){const e=this.parameters;for(const i in e)void 0!==e[i]&&(t[i]=e[i]);return t}t.data={attributes:{}};const e=this.index;null!==e&&(t.data.index={type:e.array.constructor.name,array:Array.prototype.slice.call(e.array)});const i=this.attributes;for(const e in i){const n=i[e];t.data.attributes[e]=n.toJSON(t.data)}const n={};let s=!1;for(const e in this.morphAttributes){const i=this.morphAttributes[e],r=[];for(let e=0,n=i.length;e<n;e++){const n=i[e];r.push(n.toJSON(t.data))}r.length>0&&(n[e]=r,s=!0)}s&&(t.data.morphAttributes=n,t.data.morphTargetsRelative=this.morphTargetsRelative);const r=this.groups;r.length>0&&(t.data.groups=JSON.parse(JSON.stringify(r)));const o=this.boundingSphere;return null!==o&&(t.data.boundingSphere={center:o.center.toArray(),radius:o.radius}),t}clone(){return(new this.constructor).copy(this)}copy(t){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const e={};this.name=t.name;const i=t.index;null!==i&&this.setIndex(i.clone(e));const n=t.attributes;for(const t in n){const i=n[t];this.setAttribute(t,i.clone(e))}const s=t.morphAttributes;for(const t in s){const i=[],n=s[t];for(let t=0,s=n.length;t<s;t++)i.push(n[t].clone(e));this.morphAttributes[t]=i}this.morphTargetsRelative=t.morphTargetsRelative;const r=t.groups;for(let t=0,e=r.length;t<e;t++){const e=r[t];this.addGroup(e.start,e.count,e.materialIndex)}const o=t.boundingBox;null!==o&&(this.boundingBox=o.clone());const a=t.boundingSphere;return null!==a&&(this.boundingSphere=a.clone()),this.drawRange.start=t.drawRange.start,this.drawRange.count=t.drawRange.count,this.userData=t.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}const Ee=new _t,Be=new wt,Ce=new dt,Ie=new G,Re=new G,Ve=new G,Fe=new G,Oe=new G,je=new G,Ne=new A,qe=new A,Le=new A,De=new G,We=new G,Ue=new G,He=new G,Ge=new G;class Xe extends Zt{constructor(t=new ke,e=new fe){super(),this.isMesh=!0,this.type="Mesh",this.geometry=t,this.material=e,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),void 0!==t.morphTargetInfluences&&(this.morphTargetInfluences=t.morphTargetInfluences.slice()),void 0!==t.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},t.morphTargetDictionary)),this.material=Array.isArray(t.material)?t.material.slice():t.material,this.geometry=t.geometry,this}updateMorphTargets(){const t=this.geometry.morphAttributes,e=Object.keys(t);if(e.length>0){const i=t[e[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,e=i.length;t<e;t++){const e=i[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[e]=t}}}}getVertexPosition(t,e){const i=this.geometry,n=i.attributes.position,s=i.morphAttributes.position,r=i.morphTargetsRelative;e.fromBufferAttribute(n,t);const o=this.morphTargetInfluences;if(s&&o){je.set(0,0,0);for(let i=0,n=s.length;i<n;i++){const n=o[i],a=s[i];0!==n&&(Oe.fromBufferAttribute(a,t),r?je.addScaledVector(Oe,n):je.addScaledVector(Oe.sub(e),n))}e.add(je)}return e}raycast(t,e){const i=this.geometry,n=this.material,s=this.matrixWorld;if(void 0!==n){if(null===i.boundingSphere&&i.computeBoundingSphere(),Ce.copy(i.boundingSphere),Ce.applyMatrix4(s),Be.copy(t.ray).recast(t.near),!1===Ce.containsPoint(Be.origin)){if(null===Be.intersectSphere(Ce,Ie))return;if(Be.origin.distanceToSquared(Ie)>(t.far-t.near)**2)return}Ee.copy(s).invert(),Be.copy(t.ray).applyMatrix4(Ee),null!==i.boundingBox&&!1===Be.intersectsBox(i.boundingBox)||this._computeIntersections(t,e,Be)}}_computeIntersections(t,e,i){let n;const s=this.geometry,r=this.material,o=s.index,a=s.attributes.position,h=s.attributes.uv,l=s.attributes.uv1,c=s.attributes.normal,u=s.groups,p=s.drawRange;if(null!==o)if(Array.isArray(r))for(let s=0,a=u.length;s<a;s++){const a=u[s],d=r[a.materialIndex];for(let s=Math.max(a.start,p.start),r=Math.min(o.count,Math.min(a.start+a.count,p.start+p.count));s<r;s+=3)n=Ye(this,d,t,i,h,l,c,o.getX(s),o.getX(s+1),o.getX(s+2)),n&&(n.faceIndex=Math.floor(s/3),n.face.materialIndex=a.materialIndex,e.push(n))}else for(let s=Math.max(0,p.start),a=Math.min(o.count,p.start+p.count);s<a;s+=3)n=Ye(this,r,t,i,h,l,c,o.getX(s),o.getX(s+1),o.getX(s+2)),n&&(n.faceIndex=Math.floor(s/3),e.push(n));else if(void 0!==a)if(Array.isArray(r))for(let s=0,o=u.length;s<o;s++){const o=u[s],d=r[o.materialIndex];for(let s=Math.max(o.start,p.start),r=Math.min(a.count,Math.min(o.start+o.count,p.start+p.count));s<r;s+=3)n=Ye(this,d,t,i,h,l,c,s,s+1,s+2),n&&(n.faceIndex=Math.floor(s/3),n.face.materialIndex=o.materialIndex,e.push(n))}else for(let s=Math.max(0,p.start),o=Math.min(a.count,p.start+p.count);s<o;s+=3)n=Ye(this,r,t,i,h,l,c,s,s+1,s+2),n&&(n.faceIndex=Math.floor(s/3),e.push(n))}}function Ye(t,e,i,n,s,r,o,a,h,l){t.getVertexPosition(a,Re),t.getVertexPosition(h,Ve),t.getVertexPosition(l,Fe);const c=function(t,e,i,n,s,r,o,a){let h;if(h=1===e.side?n.intersectTriangle(o,r,s,!0,a):n.intersectTriangle(s,r,o,0===e.side,a),null===h)return null;Ge.copy(a),Ge.applyMatrix4(t.matrixWorld);const l=i.ray.origin.distanceTo(Ge);return l<i.near||l>i.far?null:{distance:l,point:Ge.clone(),object:t}}(t,e,i,n,Re,Ve,Fe,He);if(c){s&&(Ne.fromBufferAttribute(s,a),qe.fromBufferAttribute(s,h),Le.fromBufferAttribute(s,l),c.uv=oe.getInterpolation(He,Re,Ve,Fe,Ne,qe,Le,new A)),r&&(Ne.fromBufferAttribute(r,a),qe.fromBufferAttribute(r,h),Le.fromBufferAttribute(r,l),c.uv1=oe.getInterpolation(He,Re,Ve,Fe,Ne,qe,Le,new A)),o&&(De.fromBufferAttribute(o,a),We.fromBufferAttribute(o,h),Ue.fromBufferAttribute(o,l),c.normal=oe.getInterpolation(He,Re,Ve,Fe,De,We,Ue,new G),c.normal.dot(n.direction)>0&&c.normal.multiplyScalar(-1));const t={a,b:h,c:l,normal:new G,materialIndex:0};oe.getNormal(Re,Ve,Fe,t.normal),c.face=t}return c}class Ze extends ke{constructor(t=1,e=1,i=1,n=1,s=1,r=1){super(),this.type="BoxGeometry",this.parameters={width:t,height:e,depth:i,widthSegments:n,heightSegments:s,depthSegments:r};const o=this;n=Math.floor(n),s=Math.floor(s),r=Math.floor(r);const a=[],h=[],l=[],c=[];let u=0,p=0;function d(t,e,i,n,s,r,d,m,f,y,v){const g=r/f,x=d/y,b=r/2,w=d/2,_=m/2,M=f+1,S=y+1;let A=0,z=0;const T=new G;for(let r=0;r<S;r++){const o=r*x-w;for(let a=0;a<M;a++){const u=a*g-b;T[t]=u*n,T[e]=o*s,T[i]=_,h.push(T.x,T.y,T.z),T[t]=0,T[e]=0,T[i]=m>0?1:-1,l.push(T.x,T.y,T.z),c.push(a/f),c.push(1-r/y),A+=1}}for(let t=0;t<y;t++)for(let e=0;e<f;e++){const i=u+e+M*t,n=u+e+M*(t+1),s=u+(e+1)+M*(t+1),r=u+(e+1)+M*t;a.push(i,n,r),a.push(n,s,r),z+=6}o.addGroup(p,z,v),p+=z,u+=A}d("z","y","x",-1,-1,i,e,t,r,s,0),d("z","y","x",1,-1,i,e,-t,r,s,1),d("x","z","y",1,1,t,i,e,n,r,2),d("x","z","y",1,-1,t,i,-e,n,r,3),d("x","y","z",1,-1,t,e,i,n,s,4),d("x","y","z",-1,-1,t,e,-i,n,s,5),this.setIndex(a),this.setAttribute("position",new we(h,3)),this.setAttribute("normal",new we(l,3)),this.setAttribute("uv",new we(c,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new Ze(t.width,t.height,t.depth,t.widthSegments,t.heightSegments,t.depthSegments)}}function Qe(t){const e={};for(const i in t){e[i]={};for(const n in t[i]){const s=t[i][n];s&&(s.isColor||s.isMatrix3||s.isMatrix4||s.isVector2||s.isVector3||s.isVector4||s.isTexture||s.isQuaternion)?s.isRenderTargetTexture?(console.warn("UniformsUtils: Textures of render targets cannot be cloned via cloneUniforms() or mergeUniforms()."),e[i][n]=null):e[i][n]=s.clone():Array.isArray(s)?e[i][n]=s.slice():e[i][n]=s}}return e}function Je(t){const e={};for(let i=0;i<t.length;i++){const n=Qe(t[i]);for(const t in n)e[t]=n[t]}return e}class $e extends me{constructor(t){super(),this.isShaderMaterial=!0,this.type="ShaderMaterial",this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={clipCullDistance:!1,multiDraw:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==t&&this.setValues(t)}copy(t){return super.copy(t),this.fragmentShader=t.fragmentShader,this.vertexShader=t.vertexShader,this.uniforms=Qe(t.uniforms),this.uniformsGroups=function(t){const e=[];for(let i=0;i<t.length;i++)e.push(t[i].clone());return e}(t.uniformsGroups),this.defines=Object.assign({},t.defines),this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.fog=t.fog,this.lights=t.lights,this.clipping=t.clipping,this.extensions=Object.assign({},t.extensions),this.glslVersion=t.glslVersion,this}toJSON(t){const e=super.toJSON(t);e.glslVersion=this.glslVersion,e.uniforms={};for(const i in this.uniforms){const n=this.uniforms[i].value;n&&n.isTexture?e.uniforms[i]={type:"t",value:n.toJSON(t).uuid}:n&&n.isColor?e.uniforms[i]={type:"c",value:n.getHex()}:n&&n.isVector2?e.uniforms[i]={type:"v2",value:n.toArray()}:n&&n.isVector3?e.uniforms[i]={type:"v3",value:n.toArray()}:n&&n.isVector4?e.uniforms[i]={type:"v4",value:n.toArray()}:n&&n.isMatrix3?e.uniforms[i]={type:"m3",value:n.toArray()}:n&&n.isMatrix4?e.uniforms[i]={type:"m4",value:n.toArray()}:e.uniforms[i]={value:n}}Object.keys(this.defines).length>0&&(e.defines=this.defines),e.vertexShader=this.vertexShader,e.fragmentShader=this.fragmentShader,e.lights=this.lights,e.clipping=this.clipping;const i={};for(const t in this.extensions)!0===this.extensions[t]&&(i[t]=!0);return Object.keys(i).length>0&&(e.extensions=i),e}}class Ke extends Zt{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new _t,this.projectionMatrix=new _t,this.projectionMatrixInverse=new _t,this.coordinateSystem=m}copy(t,e){return super.copy(t,e),this.matrixWorldInverse.copy(t.matrixWorldInverse),this.projectionMatrix.copy(t.projectionMatrix),this.projectionMatrixInverse.copy(t.projectionMatrixInverse),this.coordinateSystem=t.coordinateSystem,this}getWorldDirection(t){return super.getWorldDirection(t).negate()}updateMatrixWorld(t){super.updateMatrixWorld(t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(t,e){super.updateWorldMatrix(t,e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}const ti=new G,ei=new A,ii=new A;class ni extends Ke{constructor(t=50,e=1,i=.1,n=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=t,this.zoom=1,this.near=i,this.far=n,this.focus=10,this.aspect=e,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.fov=t.fov,this.zoom=t.zoom,this.near=t.near,this.far=t.far,this.focus=t.focus,this.aspect=t.aspect,this.view=null===t.view?null:Object.assign({},t.view),this.filmGauge=t.filmGauge,this.filmOffset=t.filmOffset,this}setFocalLength(t){const e=.5*this.getFilmHeight()/t;this.fov=2*x*Math.atan(e),this.updateProjectionMatrix()}getFocalLength(){const t=Math.tan(.5*g*this.fov);return.5*this.getFilmHeight()/t}getEffectiveFOV(){return 2*x*Math.atan(Math.tan(.5*g*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(t,e,i){ti.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),e.set(ti.x,ti.y).multiplyScalar(-t/ti.z),ti.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),i.set(ti.x,ti.y).multiplyScalar(-t/ti.z)}getViewSize(t,e){return this.getViewBounds(t,ei,ii),e.subVectors(ii,ei)}setViewOffset(t,e,i,n,s,r){this.aspect=t/e,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=n,this.view.width=s,this.view.height=r,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=this.near;let e=t*Math.tan(.5*g*this.fov)/this.zoom,i=2*e,n=this.aspect*i,s=-.5*n;const r=this.view;if(null!==this.view&&this.view.enabled){const t=r.fullWidth,o=r.fullHeight;s+=r.offsetX*n/t,e-=r.offsetY*i/o,n*=r.width/t,i*=r.height/o}const o=this.filmOffset;0!==o&&(s+=t*o/this.getFilmWidth()),this.projectionMatrix.makePerspective(s,s+n,e,e-i,t,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){const e=super.toJSON(t);return e.object.fov=this.fov,e.object.zoom=this.zoom,e.object.near=this.near,e.object.far=this.far,e.object.focus=this.focus,e.object.aspect=this.aspect,null!==this.view&&(e.object.view=Object.assign({},this.view)),e.object.filmGauge=this.filmGauge,e.object.filmOffset=this.filmOffset,e}}const si=new G,ri=new G,oi=new z;class ai{constructor(t=new G(1,0,0),e=0){this.isPlane=!0,this.normal=t,this.constant=e}set(t,e){return this.normal.copy(t),this.constant=e,this}setComponents(t,e,i,n){return this.normal.set(t,e,i),this.constant=n,this}setFromNormalAndCoplanarPoint(t,e){return this.normal.copy(t),this.constant=-e.dot(this.normal),this}setFromCoplanarPoints(t,e,i){const n=si.subVectors(i,e).cross(ri.subVectors(t,e)).normalize();return this.setFromNormalAndCoplanarPoint(n,t),this}copy(t){return this.normal.copy(t.normal),this.constant=t.constant,this}normalize(){const t=1/this.normal.length();return this.normal.multiplyScalar(t),this.constant*=t,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(t){return this.normal.dot(t)+this.constant}distanceToSphere(t){return this.distanceToPoint(t.center)-t.radius}projectPoint(t,e){return e.copy(t).addScaledVector(this.normal,-this.distanceToPoint(t))}intersectLine(t,e){const i=t.delta(si),n=this.normal.dot(i);if(0===n)return 0===this.distanceToPoint(t.start)?e.copy(t.start):null;const s=-(t.start.dot(this.normal)+this.constant)/n;return s<0||s>1?null:e.copy(t.start).addScaledVector(i,s)}intersectsLine(t){const e=this.distanceToPoint(t.start),i=this.distanceToPoint(t.end);return e<0&&i>0||i<0&&e>0}intersectsBox(t){return t.intersectsPlane(this)}intersectsSphere(t){return t.intersectsPlane(this)}coplanarPoint(t){return t.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(t,e){const i=e||oi.getNormalMatrix(t),n=this.coplanarPoint(si).applyMatrix4(t),s=this.normal.applyMatrix3(i).normalize();return this.constant=-n.dot(s),this}translate(t){return this.constant-=t.dot(this.normal),this}equals(t){return t.normal.equals(this.normal)&&t.constant===this.constant}clone(){return(new this.constructor).copy(this)}}const hi=new dt,li=new G;class ci{constructor(t=new ai,e=new ai,i=new ai,n=new ai,s=new ai,r=new ai){this.planes=[t,e,i,n,s,r]}set(t,e,i,n,s,r){const o=this.planes;return o[0].copy(t),o[1].copy(e),o[2].copy(i),o[3].copy(n),o[4].copy(s),o[5].copy(r),this}copy(t){const e=this.planes;for(let i=0;i<6;i++)e[i].copy(t.planes[i]);return this}setFromProjectionMatrix(t,e=2e3){const i=this.planes,n=t.elements,s=n[0],r=n[1],o=n[2],a=n[3],h=n[4],l=n[5],c=n[6],u=n[7],p=n[8],d=n[9],y=n[10],v=n[11],g=n[12],x=n[13],b=n[14],w=n[15];if(i[0].setComponents(a-s,u-h,v-p,w-g).normalize(),i[1].setComponents(a+s,u+h,v+p,w+g).normalize(),i[2].setComponents(a+r,u+l,v+d,w+x).normalize(),i[3].setComponents(a-r,u-l,v-d,w-x).normalize(),i[4].setComponents(a-o,u-c,v-y,w-b).normalize(),e===m)i[5].setComponents(a+o,u+c,v+y,w+b).normalize();else{if(e!==f)throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+e);i[5].setComponents(o,c,y,b).normalize()}return this}intersectsObject(t){if(void 0!==t.boundingSphere)null===t.boundingSphere&&t.computeBoundingSphere(),hi.copy(t.boundingSphere).applyMatrix4(t.matrixWorld);else{const e=t.geometry;null===e.boundingSphere&&e.computeBoundingSphere(),hi.copy(e.boundingSphere).applyMatrix4(t.matrixWorld)}return this.intersectsSphere(hi)}intersectsSprite(t){return hi.center.set(0,0,0),hi.radius=.7071067811865476,hi.applyMatrix4(t.matrixWorld),this.intersectsSphere(hi)}intersectsSphere(t){const e=this.planes,i=t.center,n=-t.radius;for(let t=0;t<6;t++)if(e[t].distanceToPoint(i)<n)return!1;return!0}intersectsBox(t){const e=this.planes;for(let i=0;i<6;i++){const n=e[i];if(li.x=n.normal.x>0?t.max.x:t.min.x,li.y=n.normal.y>0?t.max.y:t.min.y,li.z=n.normal.z>0?t.max.z:t.min.z,n.distanceToPoint(li)<0)return!1}return!0}containsPoint(t){const e=this.planes;for(let i=0;i<6;i++)if(e[i].distanceToPoint(t)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}class ui extends ke{constructor(t=1,e=1,i=1,n=1){super(),this.type="PlaneGeometry",this.parameters={width:t,height:e,widthSegments:i,heightSegments:n};const s=t/2,r=e/2,o=Math.floor(i),a=Math.floor(n),h=o+1,l=a+1,c=t/o,u=e/a,p=[],d=[],m=[],f=[];for(let t=0;t<l;t++){const e=t*u-r;for(let i=0;i<h;i++){const n=i*c-s;d.push(n,-e,0),m.push(0,0,1),f.push(i/o),f.push(1-t/a)}}for(let t=0;t<a;t++)for(let e=0;e<o;e++){const i=e+h*t,n=e+h*(t+1),s=e+1+h*(t+1),r=e+1+h*t;p.push(i,n,r),p.push(n,s,r)}this.setIndex(p),this.setAttribute("position",new we(d,3)),this.setAttribute("normal",new we(m,3)),this.setAttribute("uv",new we(f,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new ui(t.width,t.height,t.widthSegments,t.heightSegments)}}const pi="varying vec2 vUv;\nuniform mat3 uvTransform;\nvoid main() {\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n}",di="uniform sampler2D t2D;\nuniform float backgroundIntensity;\nvarying vec2 vUv;\nvoid main() {\n\tvec4 texColor = texture2D( t2D, vUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\ttexColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",mi="varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",fi="#ifdef ENVMAP_TYPE_CUBE\n\tuniform samplerCube envMap;\n#elif defined( ENVMAP_TYPE_CUBE_UV )\n\tuniform sampler2D envMap;\n#endif\nuniform float flipEnvMap;\nuniform float backgroundBlurriness;\nuniform float backgroundIntensity;\nuniform mat3 backgroundRotation;\nvarying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main() {\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 texColor = textureCube( envMap, backgroundRotation * vec3( flipEnvMap * vWorldDirection.x, vWorldDirection.yz ) );\n\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\tvec4 texColor = textureCubeUV( envMap, backgroundRotation * vWorldDirection, backgroundBlurriness );\n\t#else\n\t\tvec4 texColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",yi="varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",vi="uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldDirection;\nvoid main() {\n\tvec4 texColor = textureCube( tCube, vec3( tFlip * vWorldDirection.x, vWorldDirection.yz ) );\n\tgl_FragColor = texColor;\n\tgl_FragColor.a *= opacity;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",gi="#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <skinbase_vertex>\n\t#include <morphinstance_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvHighPrecisionZW = gl_Position.zw;\n}",xi="#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <clipping_planes_fragment>\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <logdepthbuf_fragment>\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( fragCoordZ );\n\t#endif\n}",bi="#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <skinbase_vertex>\n\t#include <morphinstance_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}",wi="#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <clipping_planes_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}",_i="varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}",Mi="uniform sampler2D tEquirect;\nvarying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldDirection );\n\tvec2 sampleUV = equirectUv( direction );\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",Si="uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tvLineDistance = scale * lineDistance;\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",Ai="uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",zi="#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinbase_vertex>\n\t\t#include <skinnormal_vertex>\n\t\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",Ti="uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",Pi="#define LAMBERT\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",ki="#define LAMBERT\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_lambert_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_lambert_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",Ei="#define MATCAP\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\tvViewPosition = - mvPosition.xyz;\n}",Bi="#define MATCAP\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;\n\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t#else\n\t\tvec4 matcapColor = vec4( vec3( mix( 0.2, 0.8, uv.y ) ), 1.0 );\n\t#endif\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",Ci="#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}",Ii="#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( 0.0, 0.0, 0.0, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), diffuseColor.a );\n\t#ifdef OPAQUE\n\t\tgl_FragColor.a = 1.0;\n\t#endif\n}",Ri="#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",Vi="#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",Fi="#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\n\tvarying vec3 vWorldPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n#ifdef USE_TRANSMISSION\n\tvWorldPosition = worldPosition.xyz;\n#endif\n}",Oi="#define STANDARD\n#ifdef PHYSICAL\n\t#define IOR\n\t#define USE_SPECULAR\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef IOR\n\tuniform float ior;\n#endif\n#ifdef USE_SPECULAR\n\tuniform float specularIntensity;\n\tuniform vec3 specularColor;\n\t#ifdef USE_SPECULAR_COLORMAP\n\t\tuniform sampler2D specularColorMap;\n\t#endif\n\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\tuniform sampler2D specularIntensityMap;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n#ifdef USE_DISPERSION\n\tuniform float dispersion;\n#endif\n#ifdef USE_IRIDESCENCE\n\tuniform float iridescence;\n\tuniform float iridescenceIOR;\n\tuniform float iridescenceThicknessMinimum;\n\tuniform float iridescenceThicknessMaximum;\n#endif\n#ifdef USE_SHEEN\n\tuniform vec3 sheenColor;\n\tuniform float sheenRoughness;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tuniform sampler2D sheenColorMap;\n\t#endif\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tuniform sampler2D sheenRoughnessMap;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\tuniform vec2 anisotropyVector;\n\t#ifdef USE_ANISOTROPYMAP\n\t\tuniform sampler2D anisotropyMap;\n\t#endif\n#endif\nvarying vec3 vViewPosition;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <iridescence_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <iridescence_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n\tvec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n\t#include <transmission_fragment>\n\tvec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n\t#ifdef USE_SHEEN\n\t\tfloat sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );\n\t\toutgoingLight = outgoingLight * sheenEnergyComp + sheenSpecularDirect + sheenSpecularIndirect;\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNVcc = saturate( dot( geometryClearcoatNormal, geometryViewDir ) );\n\t\tvec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n\t\toutgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + ( clearcoatSpecularDirect + clearcoatSpecularIndirect ) * material.clearcoat;\n\t#endif\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",ji="#define TOON\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",Ni="#define TOON\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_toon_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",qi="uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#ifdef USE_POINTS_UV\n\tvarying vec2 vUv;\n\tuniform mat3 uvTransform;\n#endif\nvoid main() {\n\t#ifdef USE_POINTS_UV\n\t\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\t#endif\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\tgl_PointSize = size;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",Li="uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",Di="#include <common>\n#include <batching_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",Wi="uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <logdepthbuf_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\t#include <logdepthbuf_fragment>\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}",Ui="uniform float rotation;\nuniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\tvec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\n\tvec2 scale;\n\tscale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );\n\tscale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",Hi="uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}",Gi={common:{diffuse:{value:new ue(16777215)},opacity:{value:1},map:{value:null},mapTransform:{value:new z},alphaMap:{value:null},alphaMapTransform:{value:new z},alphaTest:{value:0}},specularmap:{specularMap:{value:null},specularMapTransform:{value:new z}},envmap:{envMap:{value:null},envMapRotation:{value:new z},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1},aoMapTransform:{value:new z}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1},lightMapTransform:{value:new z}},bumpmap:{bumpMap:{value:null},bumpMapTransform:{value:new z},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalMapTransform:{value:new z},normalScale:{value:new A(1,1)}},displacementmap:{displacementMap:{value:null},displacementMapTransform:{value:new z},displacementScale:{value:1},displacementBias:{value:0}},emissivemap:{emissiveMap:{value:null},emissiveMapTransform:{value:new z}},metalnessmap:{metalnessMap:{value:null},metalnessMapTransform:{value:new z}},roughnessmap:{roughnessMap:{value:null},roughnessMapTransform:{value:new z}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new ue(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new ue(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaMapTransform:{value:new z},alphaTest:{value:0},uvTransform:{value:new z}},sprite:{diffuse:{value:new ue(16777215)},opacity:{value:1},center:{value:new A(.5,.5)},rotation:{value:0},map:{value:null},mapTransform:{value:new z},alphaMap:{value:null},alphaMapTransform:{value:new z},alphaTest:{value:0}}},Xi={basic:{uniforms:Je([Gi.common,Gi.specularmap,Gi.envmap,Gi.aomap,Gi.lightmap,Gi.fog]),vertexShader:zi,fragmentShader:Ti},lambert:{uniforms:Je([Gi.common,Gi.specularmap,Gi.envmap,Gi.aomap,Gi.lightmap,Gi.emissivemap,Gi.bumpmap,Gi.normalmap,Gi.displacementmap,Gi.fog,Gi.lights,{emissive:{value:new ue(0)}}]),vertexShader:Pi,fragmentShader:ki},phong:{uniforms:Je([Gi.common,Gi.specularmap,Gi.envmap,Gi.aomap,Gi.lightmap,Gi.emissivemap,Gi.bumpmap,Gi.normalmap,Gi.displacementmap,Gi.fog,Gi.lights,{emissive:{value:new ue(0)},specular:{value:new ue(1118481)},shininess:{value:30}}]),vertexShader:Ri,fragmentShader:Vi},standard:{uniforms:Je([Gi.common,Gi.envmap,Gi.aomap,Gi.lightmap,Gi.emissivemap,Gi.bumpmap,Gi.normalmap,Gi.displacementmap,Gi.roughnessmap,Gi.metalnessmap,Gi.fog,Gi.lights,{emissive:{value:new ue(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:Fi,fragmentShader:Oi},toon:{uniforms:Je([Gi.common,Gi.aomap,Gi.lightmap,Gi.emissivemap,Gi.bumpmap,Gi.normalmap,Gi.displacementmap,Gi.gradientmap,Gi.fog,Gi.lights,{emissive:{value:new ue(0)}}]),vertexShader:ji,fragmentShader:Ni},matcap:{uniforms:Je([Gi.common,Gi.bumpmap,Gi.normalmap,Gi.displacementmap,Gi.fog,{matcap:{value:null}}]),vertexShader:Ei,fragmentShader:Bi},points:{uniforms:Je([Gi.points,Gi.fog]),vertexShader:qi,fragmentShader:Li},dashed:{uniforms:Je([Gi.common,Gi.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:Si,fragmentShader:Ai},depth:{uniforms:Je([Gi.common,Gi.displacementmap]),vertexShader:gi,fragmentShader:xi},normal:{uniforms:Je([Gi.common,Gi.bumpmap,Gi.normalmap,Gi.displacementmap,{opacity:{value:1}}]),vertexShader:Ci,fragmentShader:Ii},sprite:{uniforms:Je([Gi.sprite,Gi.fog]),vertexShader:Ui,fragmentShader:Hi},background:{uniforms:{uvTransform:{value:new z},t2D:{value:null},backgroundIntensity:{value:1}},vertexShader:pi,fragmentShader:di},backgroundCube:{uniforms:{envMap:{value:null},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1},backgroundRotation:{value:new z}},vertexShader:mi,fragmentShader:fi},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:yi,fragmentShader:vi},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:_i,fragmentShader:Mi},distanceRGBA:{uniforms:Je([Gi.common,Gi.displacementmap,{referencePosition:{value:new G},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:bi,fragmentShader:wi},shadow:{uniforms:Je([Gi.lights,Gi.fog,{color:{value:new ue(0)},opacity:{value:1}}]),vertexShader:Di,fragmentShader:Wi}};Xi.physical={uniforms:Je([Xi.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new z},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new z},clearcoatNormalScale:{value:new A(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new z},dispersion:{value:0},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new z},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new z},sheen:{value:0},sheenColor:{value:new ue(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new z},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new z},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new z},transmissionSamplerSize:{value:new A},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new z},attenuationDistance:{value:0},attenuationColor:{value:new ue(0)},specularColor:{value:new ue(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new z},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new z},anisotropyVector:{value:new A},anisotropyMap:{value:null},anisotropyMapTransform:{value:new z}}]),vertexShader:Fi,fragmentShader:Oi},Math.sqrt(5),new Float32Array(16),new Float32Array(9),new Float32Array(4),new Map;class Yi extends Zt{constructor(){super(),this.isGroup=!0,this.type="Group"}}class Zi extends Zt{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.backgroundRotation=new Ct,this.environmentIntensity=1,this.environmentRotation=new Ct,this.overrideMaterial=null,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(t,e){return super.copy(t,e),null!==t.background&&(this.background=t.background.clone()),null!==t.environment&&(this.environment=t.environment.clone()),null!==t.fog&&(this.fog=t.fog.clone()),this.backgroundBlurriness=t.backgroundBlurriness,this.backgroundIntensity=t.backgroundIntensity,this.backgroundRotation.copy(t.backgroundRotation),this.environmentIntensity=t.environmentIntensity,this.environmentRotation.copy(t.environmentRotation),null!==t.overrideMaterial&&(this.overrideMaterial=t.overrideMaterial.clone()),this.matrixAutoUpdate=t.matrixAutoUpdate,this}toJSON(t){const e=super.toJSON(t);return null!==this.fog&&(e.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(e.object.backgroundBlurriness=this.backgroundBlurriness),1!==this.backgroundIntensity&&(e.object.backgroundIntensity=this.backgroundIntensity),e.object.backgroundRotation=this.backgroundRotation.toArray(),1!==this.environmentIntensity&&(e.object.environmentIntensity=this.environmentIntensity),e.object.environmentRotation=this.environmentRotation.toArray(),e}}class Qi extends W{constructor(t=null,e=1,i=1,n,s,r,o,a,h=1003,l=1003,c,u){super(null,r,o,a,h,l,n,s,c,u),this.isDataTexture=!0,this.image={data:t,width:e,height:i},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class Ji extends ge{constructor(t,e,i,n=1){super(t,e,i),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=n}copy(t){return super.copy(t),this.meshPerAttribute=t.meshPerAttribute,this}toJSON(){const t=super.toJSON();return t.meshPerAttribute=this.meshPerAttribute,t.isInstancedBufferAttribute=!0,t}}const $i=new _t,Ki=new _t,tn=[],en=new Z,nn=new _t,sn=new Xe,rn=new dt;class on extends Xe{constructor(t,e,i){super(t,e),this.isInstancedMesh=!0,this.instanceMatrix=new Ji(new Float32Array(16*i),16),this.instanceColor=null,this.morphTexture=null,this.count=i,this.boundingBox=null,this.boundingSphere=null;for(let t=0;t<i;t++)this.setMatrixAt(t,nn)}computeBoundingBox(){const t=this.geometry,e=this.count;null===this.boundingBox&&(this.boundingBox=new Z),null===t.boundingBox&&t.computeBoundingBox(),this.boundingBox.makeEmpty();for(let i=0;i<e;i++)this.getMatrixAt(i,$i),en.copy(t.boundingBox).applyMatrix4($i),this.boundingBox.union(en)}computeBoundingSphere(){const t=this.geometry,e=this.count;null===this.boundingSphere&&(this.boundingSphere=new dt),null===t.boundingSphere&&t.computeBoundingSphere(),this.boundingSphere.makeEmpty();for(let i=0;i<e;i++)this.getMatrixAt(i,$i),rn.copy(t.boundingSphere).applyMatrix4($i),this.boundingSphere.union(rn)}copy(t,e){return super.copy(t,e),this.instanceMatrix.copy(t.instanceMatrix),null!==t.morphTexture&&(this.morphTexture=t.morphTexture.clone()),null!==t.instanceColor&&(this.instanceColor=t.instanceColor.clone()),this.count=t.count,null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone()),null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),this}getColorAt(t,e){e.fromArray(this.instanceColor.array,3*t)}getMatrixAt(t,e){e.fromArray(this.instanceMatrix.array,16*t)}getMorphAt(t,e){const i=e.morphTargetInfluences,n=this.morphTexture.source.data.data,s=t*(i.length+1)+1;for(let t=0;t<i.length;t++)i[t]=n[s+t]}raycast(t,e){const i=this.matrixWorld,n=this.count;if(sn.geometry=this.geometry,sn.material=this.material,void 0!==sn.material&&(null===this.boundingSphere&&this.computeBoundingSphere(),rn.copy(this.boundingSphere),rn.applyMatrix4(i),!1!==t.ray.intersectsSphere(rn)))for(let s=0;s<n;s++){this.getMatrixAt(s,$i),Ki.multiplyMatrices(i,$i),sn.matrixWorld=Ki,sn.raycast(t,tn);for(let t=0,i=tn.length;t<i;t++){const i=tn[t];i.instanceId=s,i.object=this,e.push(i)}tn.length=0}}setColorAt(t,e){null===this.instanceColor&&(this.instanceColor=new Ji(new Float32Array(3*this.instanceMatrix.count),3)),e.toArray(this.instanceColor.array,3*t)}setMatrixAt(t,e){e.toArray(this.instanceMatrix.array,16*t)}setMorphAt(t,e){const i=e.morphTargetInfluences,n=i.length+1;null===this.morphTexture&&(this.morphTexture=new Qi(new Float32Array(n*this.count),n,this.count,1028,1015));const s=this.morphTexture.source.data.data;let r=0;for(let t=0;t<i.length;t++)r+=i[t];const o=this.geometry.morphTargetsRelative?1:1-r,a=n*t;s[a]=o,s.set(i,a+1)}updateMorphTargets(){}dispose(){return this.dispatchEvent({type:"dispose"}),null!==this.morphTexture&&(this.morphTexture.dispose(),this.morphTexture=null),this}}class an extends me{constructor(t){super(),this.isLineBasicMaterial=!0,this.type="LineBasicMaterial",this.color=new ue(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.linewidth=t.linewidth,this.linecap=t.linecap,this.linejoin=t.linejoin,this.fog=t.fog,this}}const hn=new G,ln=new G,cn=new _t,un=new wt,pn=new dt,dn=new G,mn=new G;class fn extends Zt{constructor(t=new ke,e=new an){super(),this.isLine=!0,this.type="Line",this.geometry=t,this.material=e,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),this.material=Array.isArray(t.material)?t.material.slice():t.material,this.geometry=t.geometry,this}computeLineDistances(){const t=this.geometry;if(null===t.index){const e=t.attributes.position,i=[0];for(let t=1,n=e.count;t<n;t++)hn.fromBufferAttribute(e,t-1),ln.fromBufferAttribute(e,t),i[t]=i[t-1],i[t]+=hn.distanceTo(ln);t.setAttribute("lineDistance",new we(i,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}raycast(t,e){const i=this.geometry,n=this.matrixWorld,s=t.params.Line.threshold,r=i.drawRange;if(null===i.boundingSphere&&i.computeBoundingSphere(),pn.copy(i.boundingSphere),pn.applyMatrix4(n),pn.radius+=s,!1===t.ray.intersectsSphere(pn))return;cn.copy(n).invert(),un.copy(t.ray).applyMatrix4(cn);const o=s/((this.scale.x+this.scale.y+this.scale.z)/3),a=o*o,h=this.isLineSegments?2:1,l=i.index,c=i.attributes.position;if(null!==l){const i=Math.max(0,r.start),n=Math.min(l.count,r.start+r.count);for(let s=i,r=n-1;s<r;s+=h){const i=l.getX(s),n=l.getX(s+1),r=yn(this,t,un,a,i,n);r&&e.push(r)}if(this.isLineLoop){const s=l.getX(n-1),r=l.getX(i),o=yn(this,t,un,a,s,r);o&&e.push(o)}}else{const i=Math.max(0,r.start),n=Math.min(c.count,r.start+r.count);for(let s=i,r=n-1;s<r;s+=h){const i=yn(this,t,un,a,s,s+1);i&&e.push(i)}if(this.isLineLoop){const s=yn(this,t,un,a,n-1,i);s&&e.push(s)}}}updateMorphTargets(){const t=this.geometry.morphAttributes,e=Object.keys(t);if(e.length>0){const i=t[e[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,e=i.length;t<e;t++){const e=i[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[e]=t}}}}}function yn(t,e,i,n,s,r){const o=t.geometry.attributes.position;if(hn.fromBufferAttribute(o,s),ln.fromBufferAttribute(o,r),i.distanceSqToSegment(hn,ln,dn,mn)>n)return;dn.applyMatrix4(t.matrixWorld);const a=e.ray.origin.distanceTo(dn);return a<e.near||a>e.far?void 0:{distance:a,point:mn.clone().applyMatrix4(t.matrixWorld),index:s,face:null,faceIndex:null,object:t}}const vn=new G,gn=new G;class xn extends fn{constructor(t,e){super(t,e),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){const t=this.geometry;if(null===t.index){const e=t.attributes.position,i=[];for(let t=0,n=e.count;t<n;t+=2)vn.fromBufferAttribute(e,t),gn.fromBufferAttribute(e,t+1),i[t]=0===t?0:i[t-1],i[t+1]=i[t]+vn.distanceTo(gn);t.setAttribute("lineDistance",new we(i,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}}class bn extends me{constructor(t){super(),this.isPointsMaterial=!0,this.type="PointsMaterial",this.color=new ue(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.map=t.map,this.alphaMap=t.alphaMap,this.size=t.size,this.sizeAttenuation=t.sizeAttenuation,this.fog=t.fog,this}}const wn=new _t,_n=new wt,Mn=new dt,Sn=new G;class An extends Zt{constructor(t=new ke,e=new bn){super(),this.isPoints=!0,this.type="Points",this.geometry=t,this.material=e,this.updateMorphTargets()}copy(t,e){return super.copy(t,e),this.material=Array.isArray(t.material)?t.material.slice():t.material,this.geometry=t.geometry,this}raycast(t,e){const i=this.geometry,n=this.matrixWorld,s=t.params.Points.threshold,r=i.drawRange;if(null===i.boundingSphere&&i.computeBoundingSphere(),Mn.copy(i.boundingSphere),Mn.applyMatrix4(n),Mn.radius+=s,!1===t.ray.intersectsSphere(Mn))return;wn.copy(n).invert(),_n.copy(t.ray).applyMatrix4(wn);const o=s/((this.scale.x+this.scale.y+this.scale.z)/3),a=o*o,h=i.index,l=i.attributes.position;if(null!==h)for(let i=Math.max(0,r.start),s=Math.min(h.count,r.start+r.count);i<s;i++){const s=h.getX(i);Sn.fromBufferAttribute(l,s),zn(Sn,s,a,n,t,e,this)}else for(let i=Math.max(0,r.start),s=Math.min(l.count,r.start+r.count);i<s;i++)Sn.fromBufferAttribute(l,i),zn(Sn,i,a,n,t,e,this)}updateMorphTargets(){const t=this.geometry.morphAttributes,e=Object.keys(t);if(e.length>0){const i=t[e[0]];if(void 0!==i){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let t=0,e=i.length;t<e;t++){const e=i[t].name||String(t);this.morphTargetInfluences.push(0),this.morphTargetDictionary[e]=t}}}}}function zn(t,e,i,n,s,r,o){const a=_n.distanceSqToPoint(t);if(a<i){const i=new G;_n.closestPointToPoint(t,i),i.applyMatrix4(n);const h=s.ray.origin.distanceTo(i);if(h<s.near||h>s.far)return;r.push({distance:h,distanceToRay:Math.sqrt(a),point:i,index:e,face:null,object:o})}}class Tn extends ke{constructor(t=1,e=1,i=1,n=32,s=1,r=!1,o=0,a=2*Math.PI){super(),this.type="CylinderGeometry",this.parameters={radiusTop:t,radiusBottom:e,height:i,radialSegments:n,heightSegments:s,openEnded:r,thetaStart:o,thetaLength:a};const h=this;n=Math.floor(n),s=Math.floor(s);const l=[],c=[],u=[],p=[];let d=0;const m=[],f=i/2;let y=0;function v(i){const s=d,r=new A,m=new G;let v=0;const g=!0===i?t:e,x=!0===i?1:-1;for(let t=1;t<=n;t++)c.push(0,f*x,0),u.push(0,x,0),p.push(.5,.5),d++;const b=d;for(let t=0;t<=n;t++){const e=t/n*a+o,i=Math.cos(e),s=Math.sin(e);m.x=g*s,m.y=f*x,m.z=g*i,c.push(m.x,m.y,m.z),u.push(0,x,0),r.x=.5*i+.5,r.y=.5*s*x+.5,p.push(r.x,r.y),d++}for(let t=0;t<n;t++){const e=s+t,n=b+t;!0===i?l.push(n,n+1,e):l.push(n+1,n,e),v+=3}h.addGroup(y,v,!0===i?1:2),y+=v}!function(){const r=new G,v=new G;let g=0;const x=(e-t)/i;for(let h=0;h<=s;h++){const l=[],y=h/s,g=y*(e-t)+t;for(let t=0;t<=n;t++){const e=t/n,s=e*a+o,h=Math.sin(s),m=Math.cos(s);v.x=g*h,v.y=-y*i+f,v.z=g*m,c.push(v.x,v.y,v.z),r.set(h,x,m).normalize(),u.push(r.x,r.y,r.z),p.push(e,1-y),l.push(d++)}m.push(l)}for(let t=0;t<n;t++)for(let e=0;e<s;e++){const i=m[e][t],n=m[e+1][t],s=m[e+1][t+1],r=m[e][t+1];l.push(i,n,r),l.push(n,s,r),g+=6}h.addGroup(y,g,0),y+=g}(),!1===r&&(t>0&&v(!0),e>0&&v(!1)),this.setIndex(l),this.setAttribute("position",new we(c,3)),this.setAttribute("normal",new we(u,3)),this.setAttribute("uv",new we(p,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new Tn(t.radiusTop,t.radiusBottom,t.height,t.radialSegments,t.heightSegments,t.openEnded,t.thetaStart,t.thetaLength)}}const Pn=new G,kn=new G,En=new G,Bn=new oe;class Cn extends ke{constructor(t=null,e=1){if(super(),this.type="EdgesGeometry",this.parameters={geometry:t,thresholdAngle:e},null!==t){const i=4,n=Math.pow(10,i),s=Math.cos(g*e),r=t.getIndex(),o=t.getAttribute("position"),a=r?r.count:o.count,h=[0,0,0],l=["a","b","c"],c=new Array(3),u={},p=[];for(let t=0;t<a;t+=3){r?(h[0]=r.getX(t),h[1]=r.getX(t+1),h[2]=r.getX(t+2)):(h[0]=t,h[1]=t+1,h[2]=t+2);const{a:e,b:i,c:a}=Bn;if(e.fromBufferAttribute(o,h[0]),i.fromBufferAttribute(o,h[1]),a.fromBufferAttribute(o,h[2]),Bn.getNormal(En),c[0]=`${Math.round(e.x*n)},${Math.round(e.y*n)},${Math.round(e.z*n)}`,c[1]=`${Math.round(i.x*n)},${Math.round(i.y*n)},${Math.round(i.z*n)}`,c[2]=`${Math.round(a.x*n)},${Math.round(a.y*n)},${Math.round(a.z*n)}`,c[0]!==c[1]&&c[1]!==c[2]&&c[2]!==c[0])for(let t=0;t<3;t++){const e=(t+1)%3,i=c[t],n=c[e],r=Bn[l[t]],o=Bn[l[e]],a=`${i}_${n}`,d=`${n}_${i}`;d in u&&u[d]?(En.dot(u[d].normal)<=s&&(p.push(r.x,r.y,r.z),p.push(o.x,o.y,o.z)),u[d]=null):a in u||(u[a]={index0:h[t],index1:h[e],normal:En.clone()})}}for(const t in u)if(u[t]){const{index0:e,index1:i}=u[t];Pn.fromBufferAttribute(o,e),kn.fromBufferAttribute(o,i),p.push(Pn.x,Pn.y,Pn.z),p.push(kn.x,kn.y,kn.z)}this.setAttribute("position",new we(p,3))}}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}}class In extends ke{constructor(t=1,e=32,i=16,n=0,s=2*Math.PI,r=0,o=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:t,widthSegments:e,heightSegments:i,phiStart:n,phiLength:s,thetaStart:r,thetaLength:o},e=Math.max(3,Math.floor(e)),i=Math.max(2,Math.floor(i));const a=Math.min(r+o,Math.PI);let h=0;const l=[],c=new G,u=new G,p=[],d=[],m=[],f=[];for(let p=0;p<=i;p++){const y=[],v=p/i;let g=0;0===p&&0===r?g=.5/e:p===i&&a===Math.PI&&(g=-.5/e);for(let i=0;i<=e;i++){const a=i/e;c.x=-t*Math.cos(n+a*s)*Math.sin(r+v*o),c.y=t*Math.cos(r+v*o),c.z=t*Math.sin(n+a*s)*Math.sin(r+v*o),d.push(c.x,c.y,c.z),u.copy(c).normalize(),m.push(u.x,u.y,u.z),f.push(a+g,1-v),y.push(h++)}l.push(y)}for(let t=0;t<i;t++)for(let n=0;n<e;n++){const e=l[t][n+1],s=l[t][n],o=l[t+1][n],h=l[t+1][n+1];(0!==t||r>0)&&p.push(e,s,h),(t!==i-1||a<Math.PI)&&p.push(s,o,h)}this.setIndex(p),this.setAttribute("position",new we(d,3)),this.setAttribute("normal",new we(m,3)),this.setAttribute("uv",new we(f,2))}copy(t){return super.copy(t),this.parameters=Object.assign({},t.parameters),this}static fromJSON(t){return new In(t.radius,t.widthSegments,t.heightSegments,t.phiStart,t.phiLength,t.thetaStart,t.thetaLength)}}class Rn extends me{constructor(t){super(),this.isMeshStandardMaterial=!0,this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new ue(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new ue(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new A(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Ct,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.defines={STANDARD:""},this.color.copy(t.color),this.roughness=t.roughness,this.metalness=t.metalness,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.roughnessMap=t.roughnessMap,this.metalnessMap=t.metalnessMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.envMapRotation.copy(t.envMapRotation),this.envMapIntensity=t.envMapIntensity,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.flatShading=t.flatShading,this.fog=t.fog,this}}class Vn extends me{constructor(t){super(),this.isMeshPhongMaterial=!0,this.type="MeshPhongMaterial",this.color=new ue(16777215),this.specular=new ue(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new ue(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new A(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new Ct,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(t)}copy(t){return super.copy(t),this.color.copy(t.color),this.specular.copy(t.specular),this.shininess=t.shininess,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.envMapRotation.copy(t.envMapRotation),this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.flatShading=t.flatShading,this.fog=t.fog,this}}class Fn extends an{constructor(t){super(),this.isLineDashedMaterial=!0,this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(t)}copy(t){return super.copy(t),this.scale=t.scale,this.dashSize=t.dashSize,this.gapSize=t.gapSize,this}}function On(t,e,i){return!t||!i&&t.constructor===e?t:"number"==typeof e.BYTES_PER_ELEMENT?new e(t):Array.prototype.slice.call(t)}class jn{constructor(t,e,i,n){this.parameterPositions=t,this._cachedIndex=0,this.resultBuffer=void 0!==n?n:new e.constructor(i),this.sampleValues=e,this.valueSize=i,this.settings=null,this.DefaultSettings_={}}evaluate(t){const e=this.parameterPositions;let i=this._cachedIndex,n=e[i],s=e[i-1];t:{e:{let r;i:{n:if(!(t<n)){for(let r=i+2;;){if(void 0===n){if(t<s)break n;return i=e.length,this._cachedIndex=i,this.copySampleValue_(i-1)}if(i===r)break;if(s=n,n=e[++i],t<n)break e}r=e.length;break i}if(t>=s)break t;{const o=e[1];t<o&&(i=2,s=o);for(let r=i-2;;){if(void 0===s)return this._cachedIndex=0,this.copySampleValue_(0);if(i===r)break;if(n=s,s=e[--i-1],t>=s)break e}r=i,i=0}}for(;i<r;){const n=i+r>>>1;t<e[n]?r=n:i=n+1}if(n=e[i],s=e[i-1],void 0===s)return this._cachedIndex=0,this.copySampleValue_(0);if(void 0===n)return i=e.length,this._cachedIndex=i,this.copySampleValue_(i-1)}this._cachedIndex=i,this.intervalChanged_(i,s,n)}return this.interpolate_(i,s,t,n)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(t){const e=this.resultBuffer,i=this.sampleValues,n=this.valueSize,s=t*n;for(let t=0;t!==n;++t)e[t]=i[s+t];return e}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}}class Nn extends jn{constructor(t,e,i,n){super(t,e,i,n),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:2400,endingEnd:2400}}intervalChanged_(t,e,i){const n=this.parameterPositions;let s=t-2,r=t+1,o=n[s],a=n[r];if(void 0===o)switch(this.getSettings_().endingStart){case 2401:s=t,o=2*e-i;break;case 2402:s=n.length-2,o=e+n[s]-n[s+1];break;default:s=t,o=i}if(void 0===a)switch(this.getSettings_().endingEnd){case 2401:r=t,a=2*i-e;break;case 2402:r=1,a=i+n[1]-n[0];break;default:r=t-1,a=e}const h=.5*(i-e),l=this.valueSize;this._weightPrev=h/(e-o),this._weightNext=h/(a-i),this._offsetPrev=s*l,this._offsetNext=r*l}interpolate_(t,e,i,n){const s=this.resultBuffer,r=this.sampleValues,o=this.valueSize,a=t*o,h=a-o,l=this._offsetPrev,c=this._offsetNext,u=this._weightPrev,p=this._weightNext,d=(i-e)/(n-e),m=d*d,f=m*d,y=-u*f+2*u*m-u*d,v=(1+u)*f+(-1.5-2*u)*m+(-.5+u)*d+1,g=(-1-p)*f+(1.5+p)*m+.5*d,x=p*f-p*m;for(let t=0;t!==o;++t)s[t]=y*r[l+t]+v*r[h+t]+g*r[a+t]+x*r[c+t];return s}}class qn extends jn{constructor(t,e,i,n){super(t,e,i,n)}interpolate_(t,e,i,n){const s=this.resultBuffer,r=this.sampleValues,o=this.valueSize,a=t*o,h=a-o,l=(i-e)/(n-e),c=1-l;for(let t=0;t!==o;++t)s[t]=r[h+t]*c+r[a+t]*l;return s}}class Ln extends jn{constructor(t,e,i,n){super(t,e,i,n)}interpolate_(t){return this.copySampleValue_(t-1)}}class Dn{constructor(t,e,i,n){if(void 0===t)throw new Error("THREE.KeyframeTrack: track name is undefined");if(void 0===e||0===e.length)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+t);this.name=t,this.times=On(e,this.TimeBufferType),this.values=On(i,this.ValueBufferType),this.setInterpolation(n||this.DefaultInterpolation)}static toJSON(t){const e=t.constructor;let i;if(e.toJSON!==this.toJSON)i=e.toJSON(t);else{i={name:t.name,times:On(t.times,Array),values:On(t.values,Array)};const e=t.getInterpolation();e!==t.DefaultInterpolation&&(i.interpolation=e)}return i.type=t.ValueTypeName,i}InterpolantFactoryMethodDiscrete(t){return new Ln(this.times,this.values,this.getValueSize(),t)}InterpolantFactoryMethodLinear(t){return new qn(this.times,this.values,this.getValueSize(),t)}InterpolantFactoryMethodSmooth(t){return new Nn(this.times,this.values,this.getValueSize(),t)}setInterpolation(t){let i;switch(t){case e:i=this.InterpolantFactoryMethodDiscrete;break;case n:i=this.InterpolantFactoryMethodLinear;break;case s:i=this.InterpolantFactoryMethodSmooth}if(void 0===i){const e="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(t===this.DefaultInterpolation)throw new Error(e);this.setInterpolation(this.DefaultInterpolation)}return console.warn("THREE.KeyframeTrack:",e),this}return this.createInterpolant=i,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return e;case this.InterpolantFactoryMethodLinear:return n;case this.InterpolantFactoryMethodSmooth:return s}}getValueSize(){return this.values.length/this.times.length}shift(t){if(0!==t){const e=this.times;for(let i=0,n=e.length;i!==n;++i)e[i]+=t}return this}scale(t){if(1!==t){const e=this.times;for(let i=0,n=e.length;i!==n;++i)e[i]*=t}return this}trim(t,e){const i=this.times,n=i.length;let s=0,r=n-1;for(;s!==n&&i[s]<t;)++s;for(;-1!==r&&i[r]>e;)--r;if(++r,0!==s||r!==n){s>=r&&(r=Math.max(r,1),s=r-1);const t=this.getValueSize();this.times=i.slice(s,r),this.values=this.values.slice(s*t,r*t)}return this}validate(){let t=!0;const e=this.getValueSize();e-Math.floor(e)!=0&&(console.error("THREE.KeyframeTrack: Invalid value size in track.",this),t=!1);const i=this.times,n=this.values,s=i.length;0===s&&(console.error("THREE.KeyframeTrack: Track is empty.",this),t=!1);let r=null;for(let e=0;e!==s;e++){const n=i[e];if("number"==typeof n&&isNaN(n)){console.error("THREE.KeyframeTrack: Time is not a valid number.",this,e,n),t=!1;break}if(null!==r&&r>n){console.error("THREE.KeyframeTrack: Out of order keys.",this,e,n,r),t=!1;break}r=n}if(void 0!==n&&(o=n,ArrayBuffer.isView(o)&&!(o instanceof DataView)))for(let e=0,i=n.length;e!==i;++e){const i=n[e];if(isNaN(i)){console.error("THREE.KeyframeTrack: Value is not a valid number.",this,e,i),t=!1;break}}var o;return t}optimize(){const t=this.times.slice(),e=this.values.slice(),i=this.getValueSize(),n=this.getInterpolation()===s,r=t.length-1;let o=1;for(let s=1;s<r;++s){let r=!1;const a=t[s];if(a!==t[s+1]&&(1!==s||a!==t[0]))if(n)r=!0;else{const t=s*i,n=t-i,o=t+i;for(let s=0;s!==i;++s){const i=e[t+s];if(i!==e[n+s]||i!==e[o+s]){r=!0;break}}}if(r){if(s!==o){t[o]=t[s];const n=s*i,r=o*i;for(let t=0;t!==i;++t)e[r+t]=e[n+t]}++o}}if(r>0){t[o]=t[r];for(let t=r*i,n=o*i,s=0;s!==i;++s)e[n+s]=e[t+s];++o}return o!==t.length?(this.times=t.slice(0,o),this.values=e.slice(0,o*i)):(this.times=t,this.values=e),this}clone(){const t=this.times.slice(),e=this.values.slice(),i=new(0,this.constructor)(this.name,t,e);return i.createInterpolant=this.createInterpolant,i}}Dn.prototype.TimeBufferType=Float32Array,Dn.prototype.ValueBufferType=Float32Array,Dn.prototype.DefaultInterpolation=n;class Wn extends Dn{constructor(t,e,i){super(t,e,i)}}Wn.prototype.ValueTypeName="bool",Wn.prototype.ValueBufferType=Array,Wn.prototype.DefaultInterpolation=e,Wn.prototype.InterpolantFactoryMethodLinear=void 0,Wn.prototype.InterpolantFactoryMethodSmooth=void 0;(class extends Dn{}).prototype.ValueTypeName="color";(class extends Dn{}).prototype.ValueTypeName="number";class Un extends jn{constructor(t,e,i,n){super(t,e,i,n)}interpolate_(t,e,i,n){const s=this.resultBuffer,r=this.sampleValues,o=this.valueSize,a=(i-e)/(n-e);let h=t*o;for(let t=h+o;h!==t;h+=4)H.slerpFlat(s,0,r,h-o,r,h,a);return s}}class Hn extends Dn{InterpolantFactoryMethodLinear(t){return new Un(this.times,this.values,this.getValueSize(),t)}}Hn.prototype.ValueTypeName="quaternion",Hn.prototype.InterpolantFactoryMethodSmooth=void 0;class Gn extends Dn{constructor(t,e,i){super(t,e,i)}}Gn.prototype.ValueTypeName="string",Gn.prototype.ValueBufferType=Array,Gn.prototype.DefaultInterpolation=e,Gn.prototype.InterpolantFactoryMethodLinear=void 0,Gn.prototype.InterpolantFactoryMethodSmooth=void 0;(class extends Dn{}).prototype.ValueTypeName="vector";Error;class Xn extends Zt{constructor(t,e=1){super(),this.isLight=!0,this.type="Light",this.color=new ue(t),this.intensity=e}dispose(){}copy(t,e){return super.copy(t,e),this.color.copy(t.color),this.intensity=t.intensity,this}toJSON(t){const e=super.toJSON(t);return e.object.color=this.color.getHex(),e.object.intensity=this.intensity,void 0!==this.groundColor&&(e.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(e.object.distance=this.distance),void 0!==this.angle&&(e.object.angle=this.angle),void 0!==this.decay&&(e.object.decay=this.decay),void 0!==this.penumbra&&(e.object.penumbra=this.penumbra),void 0!==this.shadow&&(e.object.shadow=this.shadow.toJSON()),void 0!==this.target&&(e.object.target=this.target.uuid),e}}const Yn=new _t,Zn=new G,Qn=new G;class Jn{constructor(t){this.camera=t,this.intensity=1,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new A(512,512),this.map=null,this.mapPass=null,this.matrix=new _t,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new ci,this._frameExtents=new A(1,1),this._viewportCount=1,this._viewports=[new U(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(t){const e=this.camera,i=this.matrix;Zn.setFromMatrixPosition(t.matrixWorld),e.position.copy(Zn),Qn.setFromMatrixPosition(t.target.matrixWorld),e.lookAt(Qn),e.updateMatrixWorld(),Yn.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),this._frustum.setFromProjectionMatrix(Yn),i.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),i.multiply(Yn)}getViewport(t){return this._viewports[t]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(t){return this.camera=t.camera.clone(),this.intensity=t.intensity,this.bias=t.bias,this.radius=t.radius,this.mapSize.copy(t.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){const t={};return 1!==this.intensity&&(t.intensity=this.intensity),0!==this.bias&&(t.bias=this.bias),0!==this.normalBias&&(t.normalBias=this.normalBias),1!==this.radius&&(t.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(t.mapSize=this.mapSize.toArray()),t.camera=this.camera.toJSON(!1).object,delete t.camera.matrix,t}}const $n=new _t,Kn=new G,ts=new G;class es extends Jn{constructor(){super(new ni(90,1,.5,500)),this.isPointLightShadow=!0,this._frameExtents=new A(4,2),this._viewportCount=6,this._viewports=[new U(2,1,1,1),new U(0,1,1,1),new U(3,1,1,1),new U(1,1,1,1),new U(3,0,1,1),new U(1,0,1,1)],this._cubeDirections=[new G(1,0,0),new G(-1,0,0),new G(0,0,1),new G(0,0,-1),new G(0,1,0),new G(0,-1,0)],this._cubeUps=[new G(0,1,0),new G(0,1,0),new G(0,1,0),new G(0,1,0),new G(0,0,1),new G(0,0,-1)]}updateMatrices(t,e=0){const i=this.camera,n=this.matrix,s=t.distance||i.far;s!==i.far&&(i.far=s,i.updateProjectionMatrix()),Kn.setFromMatrixPosition(t.matrixWorld),i.position.copy(Kn),ts.copy(i.position),ts.add(this._cubeDirections[e]),i.up.copy(this._cubeUps[e]),i.lookAt(ts),i.updateMatrixWorld(),n.makeTranslation(-Kn.x,-Kn.y,-Kn.z),$n.multiplyMatrices(i.projectionMatrix,i.matrixWorldInverse),this._frustum.setFromProjectionMatrix($n)}}class is extends Xn{constructor(t,e,i=0,n=2){super(t,e),this.isPointLight=!0,this.type="PointLight",this.distance=i,this.decay=n,this.shadow=new es}get power(){return 4*this.intensity*Math.PI}set power(t){this.intensity=t/(4*Math.PI)}dispose(){this.shadow.dispose()}copy(t,e){return super.copy(t,e),this.distance=t.distance,this.decay=t.decay,this.shadow=t.shadow.clone(),this}}class ns{constructor(t=!0){this.autoStart=t,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}start(){this.startTime=ss(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}stop(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}getElapsedTime(){return this.getDelta(),this.elapsedTime}getDelta(){let t=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){const e=ss();t=(e-this.oldTime)/1e3,this.oldTime=e,this.elapsedTime+=t}return t}}function ss(){return("undefined"==typeof performance?Date:performance).now()}const rs="\\[\\]\\.:\\/",os=new RegExp("["+rs+"]","g"),as="[^"+rs+"]",hs="[^"+rs.replace("\\.","")+"]",ls=new RegExp("^"+/((?:WC+[\/:])*)/.source.replace("WC",as)+/(WCOD+)?/.source.replace("WCOD",hs)+/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",as)+/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",as)+"$"),cs=["material","materials","bones","map"];class us{constructor(t,e,i){this.path=e,this.parsedPath=i||us.parseTrackName(e),this.node=us.findNode(t,this.parsedPath.nodeName),this.rootNode=t,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}static create(t,e,i){return t&&t.isAnimationObjectGroup?new us.Composite(t,e,i):new us(t,e,i)}static sanitizeNodeName(t){return t.replace(/\s/g,"_").replace(os,"")}static parseTrackName(t){const e=ls.exec(t);if(null===e)throw new Error("PropertyBinding: Cannot parse trackName: "+t);const i={nodeName:e[2],objectName:e[3],objectIndex:e[4],propertyName:e[5],propertyIndex:e[6]},n=i.nodeName&&i.nodeName.lastIndexOf(".");if(void 0!==n&&-1!==n){const t=i.nodeName.substring(n+1);-1!==cs.indexOf(t)&&(i.nodeName=i.nodeName.substring(0,n),i.objectName=t)}if(null===i.propertyName||0===i.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+t);return i}static findNode(t,e){if(void 0===e||""===e||"."===e||-1===e||e===t.name||e===t.uuid)return t;if(t.skeleton){const i=t.skeleton.getBoneByName(e);if(void 0!==i)return i}if(t.children){const i=function(t){for(let n=0;n<t.length;n++){const s=t[n];if(s.name===e||s.uuid===e)return s;const r=i(s.children);if(r)return r}return null},n=i(t.children);if(n)return n}return null}_getValue_unavailable(){}_setValue_unavailable(){}_getValue_direct(t,e){t[e]=this.targetObject[this.propertyName]}_getValue_array(t,e){const i=this.resolvedProperty;for(let n=0,s=i.length;n!==s;++n)t[e++]=i[n]}_getValue_arrayElement(t,e){t[e]=this.resolvedProperty[this.propertyIndex]}_getValue_toArray(t,e){this.resolvedProperty.toArray(t,e)}_setValue_direct(t,e){this.targetObject[this.propertyName]=t[e]}_setValue_direct_setNeedsUpdate(t,e){this.targetObject[this.propertyName]=t[e],this.targetObject.needsUpdate=!0}_setValue_direct_setMatrixWorldNeedsUpdate(t,e){this.targetObject[this.propertyName]=t[e],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_array(t,e){const i=this.resolvedProperty;for(let n=0,s=i.length;n!==s;++n)i[n]=t[e++]}_setValue_array_setNeedsUpdate(t,e){const i=this.resolvedProperty;for(let n=0,s=i.length;n!==s;++n)i[n]=t[e++];this.targetObject.needsUpdate=!0}_setValue_array_setMatrixWorldNeedsUpdate(t,e){const i=this.resolvedProperty;for(let n=0,s=i.length;n!==s;++n)i[n]=t[e++];this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_arrayElement(t,e){this.resolvedProperty[this.propertyIndex]=t[e]}_setValue_arrayElement_setNeedsUpdate(t,e){this.resolvedProperty[this.propertyIndex]=t[e],this.targetObject.needsUpdate=!0}_setValue_arrayElement_setMatrixWorldNeedsUpdate(t,e){this.resolvedProperty[this.propertyIndex]=t[e],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_fromArray(t,e){this.resolvedProperty.fromArray(t,e)}_setValue_fromArray_setNeedsUpdate(t,e){this.resolvedProperty.fromArray(t,e),this.targetObject.needsUpdate=!0}_setValue_fromArray_setMatrixWorldNeedsUpdate(t,e){this.resolvedProperty.fromArray(t,e),this.targetObject.matrixWorldNeedsUpdate=!0}_getValue_unbound(t,e){this.bind(),this.getValue(t,e)}_setValue_unbound(t,e){this.bind(),this.setValue(t,e)}bind(){let t=this.node;const e=this.parsedPath,i=e.objectName,n=e.propertyName;let s=e.propertyIndex;if(t||(t=us.findNode(this.rootNode,e.nodeName),this.node=t),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!t)return void console.warn("THREE.PropertyBinding: No target node found for track: "+this.path+".");if(i){let n=e.objectIndex;switch(i){case"materials":if(!t.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!t.material.materials)return void console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);t=t.material.materials;break;case"bones":if(!t.skeleton)return void console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);t=t.skeleton.bones;for(let e=0;e<t.length;e++)if(t[e].name===n){n=e;break}break;case"map":if("map"in t){t=t.map;break}if(!t.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!t.material.map)return void console.error("THREE.PropertyBinding: Can not bind to material.map as node.material does not have a map.",this);t=t.material.map;break;default:if(void 0===t[i])return void console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);t=t[i]}if(void 0!==n){if(void 0===t[n])return void console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,t);t=t[n]}}const r=t[n];if(void 0===r){const i=e.nodeName;return void console.error("THREE.PropertyBinding: Trying to update property for track: "+i+"."+n+" but it wasn't found.",t)}let o=this.Versioning.None;this.targetObject=t,void 0!==t.needsUpdate?o=this.Versioning.NeedsUpdate:void 0!==t.matrixWorldNeedsUpdate&&(o=this.Versioning.MatrixWorldNeedsUpdate);let a=this.BindingType.Direct;if(void 0!==s){if("morphTargetInfluences"===n){if(!t.geometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(!t.geometry.morphAttributes)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);void 0!==t.morphTargetDictionary[s]&&(s=t.morphTargetDictionary[s])}a=this.BindingType.ArrayElement,this.resolvedProperty=r,this.propertyIndex=s}else void 0!==r.fromArray&&void 0!==r.toArray?(a=this.BindingType.HasFromToArray,this.resolvedProperty=r):Array.isArray(r)?(a=this.BindingType.EntireArray,this.resolvedProperty=r):this.propertyName=n;this.getValue=this.GetterByBindingType[a],this.setValue=this.SetterByBindingTypeAndVersioning[a][o]}unbind(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}us.Composite=class{constructor(t,e,i){const n=i||us.parseTrackName(e);this._targetGroup=t,this._bindings=t.subscribe_(e,n)}getValue(t,e){this.bind();const i=this._targetGroup.nCachedObjects_,n=this._bindings[i];void 0!==n&&n.getValue(t,e)}setValue(t,e){const i=this._bindings;for(let n=this._targetGroup.nCachedObjects_,s=i.length;n!==s;++n)i[n].setValue(t,e)}bind(){const t=this._bindings;for(let e=this._targetGroup.nCachedObjects_,i=t.length;e!==i;++e)t[e].bind()}unbind(){const t=this._bindings;for(let e=this._targetGroup.nCachedObjects_,i=t.length;e!==i;++e)t[e].unbind()}},us.prototype.BindingType={Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},us.prototype.Versioning={None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},us.prototype.GetterByBindingType=[us.prototype._getValue_direct,us.prototype._getValue_array,us.prototype._getValue_arrayElement,us.prototype._getValue_toArray],us.prototype.SetterByBindingTypeAndVersioning=[[us.prototype._setValue_direct,us.prototype._setValue_direct_setNeedsUpdate,us.prototype._setValue_direct_setMatrixWorldNeedsUpdate],[us.prototype._setValue_array,us.prototype._setValue_array_setNeedsUpdate,us.prototype._setValue_array_setMatrixWorldNeedsUpdate],[us.prototype._setValue_arrayElement,us.prototype._setValue_arrayElement_setNeedsUpdate,us.prototype._setValue_arrayElement_setMatrixWorldNeedsUpdate],[us.prototype._setValue_fromArray,us.prototype._setValue_fromArray_setNeedsUpdate,us.prototype._setValue_fromArray_setMatrixWorldNeedsUpdate]],new Float32Array(1),"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:"166"}})),"undefined"!=typeof window&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__="166");var ps=i(206);function ds(t){return ds="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ds(t)}function ms(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,fs(n.key),n)}}function fs(t){var e=function(t,e){if("object"!=ds(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=ds(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==ds(e)?e:e+""}var ys,vs,gs=function(){return t=function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.position=e,this.size=i,this.createPhysicsBody()},(e=[{key:"createPhysicsBody",value:function(){var t=new ps.Box(new ps.Vec3(this.size/2,this.size/2,this.size/2));this.body=new ps.Body({mass:0}),this.body.addShape(t),this.body.position.copy(this.position)}},{key:"update",value:function(){}}])&&ms(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function xs(t){return xs="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},xs(t)}function bs(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,ws(n.key),n)}}function ws(t){var e=function(t,e){if("object"!=xs(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=xs(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==xs(e)?e:e+""}ys=gs,(vs=fs(vs="objectId"))in ys?Object.defineProperty(ys,vs,{value:1,enumerable:!0,configurable:!0,writable:!0}):ys[vs]=1;var _s=function(){return function(t,e,i){return e&&bs(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(e,i,n){var s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new G(.2,.2,.2);!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.scene=e,this.position=i,this.color=n,this.size=r,this.rotation=s,this.velocity=new G,this.angularVelocity=new G(5*Math.random()-2.5,5*Math.random()-2.5,5*Math.random()-2.5),this.removed=!1,this.createMesh()}),[{key:"createMesh",value:function(){var t=new Ze(this.size.x,this.size.y,this.size.z),e=new Vn({color:this.color});this.mesh=new Xe(t,e),this.mesh.rotateY(this.rotation),this.mesh.position.copy(this.position),this.scene.add(this.mesh)}},{key:"update",value:function(t){if(!this.removed){if(this.mesh.position.y<-this.size.y)return this.remove();this.mesh.position.addScaledVector(this.velocity,t),this.mesh.rotation.x+=this.angularVelocity.x*t,this.mesh.rotation.y+=this.angularVelocity.y*t,this.mesh.rotation.z+=this.angularVelocity.z*t,this.velocity.y-=9.8*t,this.velocity.multiplyScalar(.99)}}},{key:"remove",value:function(){this.removed||this.scene.remove(this.mesh),this.removed=!0}}])}();function Ms(t){return Ms="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Ms(t)}function Ss(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,As(n.key),n)}}function As(t){var e=function(t,e){if("object"!=Ms(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=Ms(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==Ms(e)?e:e+""}var zs=function(){return function(t,e,i){return e&&Ss(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(e,i,n,s){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.scene=e,this.crate=i,this.world=n,this.debris=[],this.duration=3,this.elapsedTime=0,this.rectangles=s,this.createDebris()}),[{key:"createDebris",value:function(){for(var t=0;t<this.rectangles.length;t++){var e=this.rectangles[t],i=new G(e.position.x+this.crate.position.x,e.position.y+this.crate.position.y,e.position.z+this.crate.position.z),n=new _s(this.scene,i,this.crate.color,e.isVertical?0:Math.PI/2,new G(2*this.crate.cubeSize,this.crate.cubeSize,this.crate.cubeSize));this.debris.push(n);var s=i.clone();s.y=0;var r=(new G).subVectors(i,s).normalize();n.velocity.copy(r).multiplyScalar(2)}}},{key:"update",value:function(t){return this.elapsedTime+=t,this.elapsedTime>=this.duration?(this.remove(),!1):(this.debris.forEach((function(e){return e.update(t)})),!0)}},{key:"remove",value:function(){this.debris.forEach((function(t){return t.remove()}))}}])}();function Ts(t){return Ts="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Ts(t)}function Ps(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,s,r,o,a=[],h=!0,l=!1;try{if(r=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;h=!1}else for(;!(h=(n=r.call(i)).done)&&(a.push(n.value),a.length!==e);h=!0);}catch(t){l=!0,s=t}finally{try{if(!h&&null!=i.return&&(o=i.return(),Object(o)!==o))return}finally{if(l)throw s}}return a}}(t,e)||function(t,e){if(t){if("string"==typeof t)return ks(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?ks(t,e):void 0}}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ks(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function Es(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Bs(n.key),n)}}function Bs(t){var e=function(t,e){if("object"!=Ts(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=Ts(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==Ts(e)?e:e+""}var Cs=function(){return function(t,e,i){return e&&Es(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(e,i,n,s,r,o,a){var h=arguments.length>7&&void 0!==arguments[7]?arguments[7]:2,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:6,c=arguments.length>9&&void 0!==arguments[9]?arguments[9]:6;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.id=i.generateCrateId(),this.scene=e,this.game=i,this.mesh=s,this.color=a,this.colorHex=new ue,this.colorHex.setHex(a),this.offset=r,this.geometryScale=o,this.world=i.world,this.position=n,this.size=h,this.resolution=l,this.height=c,this.cubeSize=h/l,this.cubes=[],this.shapes=[],this.scale=1,this.rectSizes=null,this.boxQuaternion=new H,this.scaleVec=new G(1,1,1),this.boxIndexes=[],this.rectIndexes=[],this.isDirty=!1,this.activeCount=0,this.buildMesh(),this.createPhysicsBody()}),[{key:"buildMesh",value:function(){var t=this;this.geometry=new Ze(2*this.cubeSize,this.cubeSize,this.cubeSize),this.verticalGeometry=new Ze(this.cubeSize,this.cubeSize,2*this.cubeSize),this.rectSizes=new G(2*this.cubeSize,this.cubeSize,this.cubeSize);for(var e=this.offset,i=new _t,n=function(n,s){for(var r=0;r<t.resolution-(s?1:0);r++)for(var o=0;o<t.resolution/2-r-(s?1:0);o++){var a=s+r*t.cubeSize+o*(2*t.cubeSize)-t.size/2+2*t.cubeSize/2,h=r*t.cubeSize-t.size/2+t.cubeSize/2,l=i.makeRotationY(0);l.setPosition(t.position.x+a,t.position.y+n,t.position.z+h),l.scale(t.geometryScale),t.mesh.setMatrixAt(e,l);var c=new ps.Box(new ps.Vec3(t.cubeSize,t.cubeSize/2,t.cubeSize/2));t.shapes.push({shape:c,offset:new G(a,n,h),active:!1}),t.cubes.push({index:e,isVertical:!1,position:new G(a,n,h),active:!0}),e++,t.activeCount++}},s=function(n,s){for(var r=0;r<t.resolution/2-(s?1:0);r++)for(var o=0;o<t.resolution/2-r-(s?1:0);o++){var a=s+r*t.cubeSize+o*(2*t.cubeSize)-t.size/2+2*t.cubeSize/2,h=r*t.cubeSize-t.size/2+t.cubeSize/2,l=i.makeRotationY(Math.PI/2);l.setPosition(t.position.x+h,t.position.y+n,t.position.z+a),l.scale(t.geometryScale),t.mesh.setMatrixAt(e,l);var c=new ps.Box(new ps.Vec3(t.cubeSize/2,t.cubeSize/2,t.cubeSize));t.shapes.push({shape:c,offset:new G(h,n,a),active:!1}),t.cubes.push({index:e,isVertical:!0,position:new G(h,n,a),active:!0}),e++,t.activeCount++}},r=function(n,s){for(var r=0,o=t.resolution-1-(s?1:0);o>=t.resolution/2;o--){for(var a=t.resolution/2-r-1-(s?1:0);a>=0;a--){var h=r*t.cubeSize+a*(2*t.cubeSize)-t.size/2+2*t.cubeSize/2+s,l=o*t.cubeSize-t.size/2+t.cubeSize/2+s,c=i.makeRotationY(Math.PI/2);c.setPosition(t.position.x+l,t.position.y+n,t.position.z+h),c.scale(t.geometryScale),t.mesh.setMatrixAt(e,c);var u=new ps.Box(new ps.Vec3(t.cubeSize/2,t.cubeSize/2,t.cubeSize));t.shapes.push({shape:u,offset:new G(l,n,h),active:!1}),t.cubes.push({index:e,isVertical:!0,position:new G(l,n,h),active:!0}),e++,t.activeCount++}r++}},o=function(n,s){for(var r=0,o=t.resolution-1-(s?1:0);o>=0;o--){for(var a=0;a<t.resolution/2-r-(s?1:0);a++){var h=r*t.cubeSize+a*(2*t.cubeSize)-t.size/2+2*t.cubeSize/2+s,l=o*t.cubeSize-t.size/2+t.cubeSize/2+s,c=i.makeRotationY(0);c.setPosition(t.position.x+h,t.position.y+n,t.position.z+l),c.scale(t.geometryScale),t.mesh.setMatrixAt(e,c);var u=new ps.Box(new ps.Vec3(t.cubeSize,t.cubeSize/2,t.cubeSize/2));t.shapes.push({shape:u,offset:new G(h,n,l),active:!1}),t.cubes.push({index:e,isVertical:!1,position:new G(h,n,l),active:!0}),e++,t.activeCount++}r++}},a=0;a<this.height;a++){var h=a%2==0,l=a*this.cubeSize-this.size/2+this.cubeSize/2;n(l,h?this.cubeSize:0),o(l,h?this.cubeSize:0),s(l,h?0:this.cubeSize),r(l,h?0:this.cubeSize)}this.indexBlocks()}},{key:"indexBlocks",value:function(){this.boxIndexes=new Array(this.height*Math.pow(this.resolution,2)).fill(null);for(var t=0;t<this.height;t++)for(var e=0;e<this.resolution;e++)for(var i=0;i<this.resolution;i++)for(var n=i*this.cubeSize-this.size/2+this.cubeSize/2,s=t*this.cubeSize-this.size/2+this.cubeSize/2,r=e*this.cubeSize-this.size/2+this.cubeSize/2,o=new G(n,s,r),a=t*Math.pow(this.resolution,2)/2;a<(t+1)*Math.pow(this.resolution,2)/2;a++){var h=this.cubes[a],l=h.position,c=h.isVertical?this.verticalGeometry:this.geometry;if(this.isPointInsideBox(o,c,l)){var u=t*this.resolution*this.resolution+e*this.resolution+i;this.boxIndexes[u]=a}}}},{key:"addBodyShapes",value:function(t){var e=this;t.forEach((function(t){var i=t.shape,n=t.offset,s=t.orientation,r=new ps.Vec3,o=new ps.Quaternion;n&&r.copy(n),s&&o.copy(s),e.body.shapes.push(i),e.body.shapeOffsets.push(r),e.body.shapeOrientations.push(o)})),this.body.updateMassProperties(),this.body.updateBoundingRadius(),this.body.aabbNeedsUpdate=!0}},{key:"removeBodyShapes",value:function(t){var e=this;t.forEach((function(t){var i=t.shape,n=e.body.shapes.indexOf(i);e.body.shapes.splice(n,1),e.body.shapeOffsets.splice(n,1),e.body.shapeOrientations.splice(n,1)})),this.body.updateMassProperties(),this.body.updateBoundingRadius(),this.body.aabbNeedsUpdate=!0}},{key:"updatePhysicalBody",value:function(){var t=this;if(!this.isDirty){this.removeBodyShapes([this.initialShape]);var e=this.shapes.filter((function(e,i){return t.cubes[i].active}));return this.addBodyShapes(e),e.forEach((function(t){return t.active=!0})),void(this.isDirty=!0)}var i=this.shapes.filter((function(e,i){return!t.cubes[i].active&&e.active}));i.forEach((function(t){return t.active=!1})),this.removeBodyShapes(i)}},{key:"createPhysicsBody",value:function(){this.body=new ps.Body({mass:0}),this.body.position.copy(this.position),this.body.isCrate=!0,this.body.model=this,this.initialShape={shape:new ps.Box(new ps.Vec3(this.size/2,this.cubeSize*this.height/2,this.size/2))},this.addBodyShapes([this.initialShape]),this.world.addBody(this.body)}},{key:"applyState",value:function(t){var e=this,i=t.isDirty,n=t.inactiveCubes,s=new _t;this.isDirty=i,i&&(n.forEach((function(t){var i=e.cubes.find((function(e){return e.index===t}));i.active&&(e.mesh.setMatrixAt(i.index,s.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)),e.mesh.instanceMatrix.addUpdateRange(16*i.index,16),i.active=!1,e.activeCount--)})),this.mesh.instanceMatrix.needsUpdate=!0,this.updatePhysicalBody(),this.activeCount||this.remove())}},{key:"destroyCubesInRadius",value:function(t,e){var i=this,n=new _t,s=null,r=0;this.cubes.forEach((function(o){o.active&&o.position.distanceTo(t)<=e&&(i.mesh.setMatrixAt(o.index,n.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)),i.mesh.instanceMatrix.addUpdateRange(16*o.index,16),s=o.position,o.active=!1,i.activeCount--,r++)}));var o=this.findFloatingCubes();return o.size&&this.clearFloatingCubes(o),this.mesh.instanceMatrix.needsUpdate=!0,this.updatePhysicalBody(),this.activeCount||this.remove(),new U(s?this.position.x+s.x:this.position.x,s?this.position.y+s.y:this.position.y,s?this.position.z+s.z:this.position.z,r)}},{key:"clearFloatingCubes",value:function(t){var e=this,i=new _t,n=this.cubes.filter((function(e,i){return e.active&&t.has(i)})).map((function(t){return e.mesh.setMatrixAt(t.index,i.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)),e.mesh.instanceMatrix.addUpdateRange(16*t.index,16),t.active=!1,e.activeCount--,t}));this.activeCount||this.remove(),this.game.headless||this.createFallingCrateDerbisEffect(n)}},{key:"findFloatingCubes",value:function(){for(var t=this,e=new Set,i=new Set(this.boxIndexes.map((function(t,e){return[t,e]})).filter((function(e){var i=Ps(e,1)[0];return t.cubes[i].active})).map((function(t){var e=Ps(t,2);return e[0],e[1]}))),n=function n(s,r,o){var a=t.getIndex(s,r,o);-1!==a&&i.has(a)&&(i.delete(a),e.add(a),[[s+1,r,o],[s-1,r,o],[s,r+1,o],[s,r-1,o],[s,r,o+1],[s,r,o-1]].forEach((function(i){var s=Ps(i,3),r=s[0],o=s[1],a=s[2];e.has(t.getIndex(r,o,a))||n(r,o,a)})))},s=0;s<this.resolution;s++)for(var r=0;r<this.resolution;r++)n(r,0,s);return new Set(Array.from(i).map((function(e){return t.boxIndexes[e]})))}},{key:"getIndex",value:function(t,e,i){return t<0||t>=this.resolution||e<0||e>=this.height||i<0||i>=this.resolution?-1:e*this.resolution*this.resolution+i*this.resolution+t}},{key:"isPointInsideBox",value:function(t,e,i){var n=new G;e.computeBoundingBox(),e.boundingBox.getSize(n);var s=new _t;s.compose(i,this.boxQuaternion,this.scaleVec);var r=new _t;r.copy(s).invert();var o=t.clone().applyMatrix4(r);return Math.abs(o.x)<=n.x/2&&Math.abs(o.y)<=n.y/2&&Math.abs(o.z)<=n.z/2}},{key:"createFallingCrateDerbisEffect",value:function(t){var e=new zs(this.scene,this,this.world,t);this.game.addDestroyedEffect(e)}},{key:"remove",value:function(){this.game.battleMap.removeCrate(this),this.world.removeBody(this.body)}},{key:"update",value:function(){}}])}();function Is(t){return Is="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Is(t)}function Rs(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Vs(n.key),n)}}function Vs(t){var e=function(t,e){if("object"!=Is(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=Is(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==Is(e)?e:e+""}!function(t,e,i){(e=Bs(e))in t?Object.defineProperty(t,e,{value:2,enumerable:!0,configurable:!0,writable:!0}):t[e]=2}(Cs,"objectId");var Fs=function(){return function(t,e,i){return e&&Rs(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(e,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:6,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:50;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.scene=e,this.game=i,this.size=n,this.resolution=s,this.basicCount=r,this.cubeSize=n/s,this.offset=0;var o=this.game.loader.getModel("red_crate"),a=this.game.loader.getTexture("red_crate"),h=this.game.loader.getTexture("red_crate_normal"),l=new Rn({map:a,normalMap:h,roughness:1,metalness:.1});o.traverse((function(t){t instanceof Xe&&(t.material=l)}));var c=new G;o.children[0].geometry.computeBoundingBox(),o.children[0].geometry.boundingBox.getSize(c),this.geometryScale=new G(2*this.cubeSize/c.x,this.cubeSize/c.y,this.cubeSize/c.z),this.material=o.children[0].material,this.geometry=o.children[0].geometry}),[{key:"produceCrates",value:function(t){var e=this,i=t.reduce((function(t,i){var n=i.height;return t+Math.pow(e.resolution,2)/2*n}),0);return this.mesh=new on(this.geometry,this.material,i),this.mesh.castShadow=!0,this.mesh.instanceMatrix.setUsage(d),this.scene.add(this.mesh),t.map((function(t){var i=t.position,n=t.height,s=t.isDirty,r=new Cs(e.scene,e.game,i,e.mesh,e.offset,e.geometryScale,16162934,e.size,e.resolution,n);return s&&r.applyState(t),e.offset+=r.cubes.length,r}))}}])}();function Os(t){return Os="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Os(t)}function js(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function Ns(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function qs(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Ns(Object(i),!0).forEach((function(e){Ls(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Ns(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function Ls(t,e,i){return(e=Ws(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function Ds(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Ws(n.key),n)}}function Ws(t){var e=function(t,e){if("object"!=Os(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=Os(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==Os(e)?e:e+""}var Us=function(){function e(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:6,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),this.scene=t,this.game=i,this.world=i.world,this.size=n,this.fence=[],this.crates=[],this.cratesMeta=[],this.crateSize=2,this.crateResolution=6,this.obstaclesLevel=s,this.map=r,this.spawnPoints=r?r.spawnPoints:null,this.obstacles=r?r.obstacles:null,this.crateInstancedMesh=null,this.tempPosition=new G,this.tempQuaternion=new H,this.tempScale=new G(1,1,1),this.tempMatrix=new _t,this.map||this.createMap(),this.createGround(),this.createCrateInstancedMesh(),this.createFence(),this.createObstacles()}return function(t,e,i){return e&&Ds(t.prototype,e),i&&Ds(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(e,[{key:"createCrateInstancedMesh",value:function(){var t=new Ze(2,2,2),e=this.game.loader.getTexture("crate").clone(),i=this.game.loader.getTexture("crate_normal").clone(),n=this.game.loader.getTexture("crate_metallic").clone(),s=this.game.loader.getTexture("crate_roughness").clone(),r=this.game.loader.getTexture("crate_ao").clone(),o=(this.game.loader.getTexture("crate"),new Rn({roughness:.8,color:new ue(.2,.2,.2),metalness:.6,map:e,roughnessMap:s,normalMap:i,metalnessMap:n,aoMap:r}));this.crateInstancedMesh=new on(t,o,1e3),this.crateInstancedMesh.instanceMatrix.setUsage(d),this.crateInstancedMesh.castShadow=!0,this.crateInstancedMesh.receiveShadow=!0,this.crateInstancedMesh.count=0,this.scene.add(this.crateInstancedMesh)}},{key:"addCrate",value:function(t){var e=new gs(t);this.fence.push(e),this.world.addBody(e.body);var i=new _t;return i.setPosition(t.x,t.y,t.z),this.crateInstancedMesh.count=this.fence.length,this.crateInstancedMesh.setMatrixAt(this.fence.length-1,i),this.crateInstancedMesh.instanceMatrix.needsUpdate=!0,e}},{key:"createGround",value:function(){var e=this.game.loader.getTexture("grass");e.wrapS=t,e.wrapT=t,e.repeat.set(5,5);var i=this.game.loader.getTexture("metal").clone();i.wrapS=t,i.wrapT=t,i.repeat.set(6,6);var n=this.game.loader.getTexture("metal_normal").clone();n.wrapS=t,n.wrapT=t,n.repeat.set(6,6);var s=this.game.loader.getTexture("metal_metallic").clone();s.wrapS=t,s.wrapT=t,s.repeat.set(6,6);var r=this.game.loader.getTexture("metal_roughness").clone();r.wrapS=t,r.wrapT=t,r.repeat.set(6,6);var o=this.game.loader.getTexture("metal_ao").clone();o.wrapS=t,o.wrapT=t,o.repeat.set(6,6);var a=new ui(this.size,this.size),h=new Rn({roughness:.8,color:new ue(.2,.2,.2),metalness:.6,map:i,roughnessMap:r,normalMap:n,metalnessMap:s,aoMap:o});this.ground=new Xe(a,h),this.ground.rotation.x=-Math.PI/2,this.ground.receiveShadow=!0,this.scene.add(this.ground);var l=new ps.Plane,c=new ps.Body({mass:0,material:new ps.Material({friction:1.5,restitution:.3})});c.addShape(l),c.quaternion.setFromAxisAngle(new ps.Vec3(1,0,0),-Math.PI/2),this.world.addBody(c)}},{key:"createFence",value:function(){for(var t=this.size/2,e=-t;e<=t;e+=2)this.addCrate(new G(e,1,-t)),this.addCrate(new G(e,1,t));for(var i=2-t;i<t;i+=2)this.addCrate(new G(-t,1,i)),this.addCrate(new G(t,1,i));this.crateInstancedMesh.instanceMatrix.needsUpdate=!0}},{key:"createMap",value:function(){var t=this,e=this.obstaclesLevel,i=this.size/e,n=this.size/2;this.spawnPoints=[{box:new Z(new G(-n,0,-n),new G(1.25*i-n,1.25*i,1.25*i-n)),position:new G(-25,.5,-25),rotation:-3*Math.PI/4},{box:new Z(new G(n-1.25*i,0,n-1.25*i),new G(n,1.25*i,n)),position:new G(25,.5,25),rotation:Math.PI/4},{box:new Z(new G(-n,0,n-1.25*i),new G(1.25*i-n,1.25*i,n)),position:new G(-25,.5,25),rotation:3*Math.PI/4},{box:new Z(new G(n-1.25*i,0,-n),new G(n,1.25*i,1.25*i-n)),position:new G(25,.5,-25),rotation:-Math.PI/4}];for(var s=[],r=0;r<e;r++)for(var o=function(){if(Math.random()<.7){var n=new G((r-e/2+.5)*i,1,(a-e/2+.5)*i);if(!t.spawnPoints.some((function(t){return t.box.containsPoint(n)}))){var o=Math.random()<.3?2*t.crateResolution:t.crateResolution;s.push({position:n,height:o,isDirty:!1,inactiveCubes:[]})}}},a=0;a<e;a++)o();this.obstacles=Ls({},Cs.objectId,{id:Cs.objectId,options:{size:this.crateSize,resolution:this.crateResolution,basicCount:50,crates:s}}),this.map=qs(qs({},this.map),{},{spawnPoints:this.spawnPoints,obstacles:this.obstacles,obstaclesLevel:this.obstaclesLevel,size:this.size})}},{key:"getMap",value:function(){var t=this,e=this.map;return e.obstacles[Cs.objectId].options.crates=e.obstacles[Cs.objectId].options.crates.map((function(e,i){var n=t.crates[i];return qs(qs({},e),{},{isDirty:n.isDirty,inactiveCubes:n.cubes.filter((function(t){return!t.active})).map((function(t){return t.index}))})})),e}},{key:"createObstacles",value:function(){var t,e=this.obstacles[Cs.objectId].options,i=new Fs(this.scene,this.game,e.size,e.resolution,e.basicCount);(t=this.crates).push.apply(t,function(t){return function(t){if(Array.isArray(t))return js(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(t){if("string"==typeof t)return js(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?js(t,e):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}(i.produceCrates(e.crates)))}},{key:"removeCrate",value:function(t){var e=this.crates.indexOf(t);-1!=e&&this.crates.splice(e,1)}},{key:"update",value:function(){}},{key:"getSpawnPoints",value:function(){return this.spawnPoints.map((function(t){return{position:t.position.clone(),rotation:t.rotation}}))}}],[{key:"fromMap",value:function(t,i,n){return new e(t,i,n.size,n.obstaclesLevel,n)}}])}();function Hs(t){return Hs="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Hs(t)}function Gs(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Xs(n.key),n)}}function Xs(t){var e=function(t,e){if("object"!=Hs(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=Hs(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==Hs(e)?e:e+""}var Ys=function(){return function(t,e,i){return e&&Gs(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(e,i,n,s,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.scene=e,this.position=i,this.radius=n,this.duration=1,this.elapsedTime=0,this.game=s,this.owner=r,this.createExplosionCore(),this.createShockwave()}),[{key:"createExplosionCore",value:function(){var t=new In(this.radius/3,32,32),e=new Vn({color:16724736,emissive:16742144,transparent:!0,opacity:.9});this.core=new Xe(t,e),this.core.position.copy(this.position),this.scene.add(this.core)}},{key:"createShockwave",value:function(){var t=new In(this.radius/3,32,32),e=new fe({color:16750848,transparent:!0,opacity:.7,side:2});this.shockwave=new Xe(t,e),this.shockwave.position.copy(this.position),this.shockwave.rotation.x=Math.PI/2,this.scene.add(this.shockwave)}},{key:"update",value:function(t){this.elapsedTime+=t;var e=this.elapsedTime/this.duration;if(e>=1)return this.remove(),!1;var i=1+.5*e;this.core.scale.set(i,i,i),this.core.material.opacity=.9*(1-e);var n=1+2*e;return this.shockwave.scale.set(n,n,n),this.shockwave.material.opacity=.7*(1-e),!0}},{key:"remove",value:function(){this.scene.remove(this.core),this.scene.remove(this.shockwave),this.scene.remove(this.particles),this.scene.remove(this.light)}}])}();const Zs=Ys;function Qs(t){return Qs="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Qs(t)}function Js(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,$s(n.key),n)}}function $s(t){var e=function(t,e){if("object"!=Qs(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=Qs(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==Qs(e)?e:e+""}var Ks=function(){return function(t,e,i){return e&&Js(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(e,i,n){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.scene=e,this.particleCount=n,this.isFadingOut=!1,this.fadeOutDuration=1,this.fadeOutTimer=0,this.activeParticles=0,this.setupParticles(i)}),[{key:"setupParticles",value:function(t){this.particles=new ke,this.particlePositions=new Float32Array(3*this.particleCount),this.particleOpacities=new Float32Array(this.particleCount),this.particleSizes=new Float32Array(this.particleCount),this.particleColors=new Float32Array(3*this.particleCount);for(var e=0;e<this.particleCount;e++)this.particlePositions[3*e]=t.x,this.particlePositions[3*e+1]=t.y,this.particlePositions[3*e+2]=t.z,this.particleOpacities[e]=0,this.particleSizes[e]=0,this.particleColors[3*e]=.7,this.particleColors[3*e+1]=.7,this.particleColors[3*e+2]=.7;this.particles.setAttribute("position",new ge(this.particlePositions,3)),this.particles.setAttribute("opacity",new ge(this.particleOpacities,1)),this.particles.setAttribute("size",new ge(this.particleSizes,1)),this.particles.setAttribute("color",new ge(this.particleColors,3)),this.particleMaterial=new bn({size:.2,transparent:!0,blending:2,depthWrite:!1,vertexColors:!0,sizeAttenuation:!0}),this.particleSystem=new An(this.particles,this.particleMaterial),this.scene.add(this.particleSystem)}},{key:"update",value:function(t,e,i){this.isFadingOut?this.updateFadeOut(t):this.updateActiveParticles(t,e,i),this.particles.attributes.position.needsUpdate=!0,this.particles.attributes.opacity.needsUpdate=!0,this.particles.attributes.size.needsUpdate=!0,this.particles.attributes.color.needsUpdate=!0}},{key:"updateActiveParticles",value:function(t,e,i){var n=(new G).subVectors(e,i).divideScalar(t).length();this.activeParticles=Math.min(this.activeParticles+2,this.particleCount);for(var s=this.activeParticles-1;s>0;s--){this.particlePositions[3*s]=this.particlePositions[3*(s-1)],this.particlePositions[3*s+1]=this.particlePositions[3*(s-1)+1],this.particlePositions[3*s+2]=this.particlePositions[3*(s-1)+2],this.particleOpacities[s]=.95*this.particleOpacities[s-1],this.particleSizes[s]=.95*this.particleSizes[s-1];var r=1-s/this.activeParticles;this.particleColors[3*s]=.7*r,this.particleColors[3*s+1]=.7*r,this.particleColors[3*s+2]=.7*r}this.particlePositions[0]=e.x,this.particlePositions[1]=e.y,this.particlePositions[2]=e.z,this.particleOpacities[0]=Math.min(n/5,1),this.particleSizes[0]=Math.min(n/2,.4);for(var o=1;o<this.activeParticles;o++)Math.random()<.2&&(this.particlePositions[3*o]+=.15*(Math.random()-.5),this.particlePositions[3*o+1]+=.15*(Math.random()-.5),this.particlePositions[3*o+2]+=.15*(Math.random()-.5));for(var a=0;a<this.activeParticles;a++){var h=Math.pow(1-a/this.activeParticles,.5);this.particleOpacities[a]*=h}for(var l=this.activeParticles;l<this.particleCount;l++)this.particleOpacities[l]=0,this.particleSizes[l]=0}},{key:"updateFadeOut",value:function(t){this.fadeOutTimer+=t;var e=this.fadeOutTimer/this.fadeOutDuration;if(e>=1)this.scene.remove(this.particleSystem);else{var i=1-e;this.particleMaterial.opacity=i}}},{key:"remove",value:function(){this.scene.remove(this.particleSystem)}},{key:"startFadeOut",value:function(){this.isFadingOut=!0}}])}();const tr=Ks;var er=function(t,e){var i=t.find((function(t){return(t.bi.id===e||t.bj.id===e)&&(t.bi.collisionFilterGroup&t.bj.collisionFilterMask)===t.bi.collisionFilterGroup&&(t.bj.collisionFilterGroup&t.bi.collisionFilterMask)===t.bj.collisionFilterGroup}));return i?{contact:i,target:i.bi.id==e?i.bi:i.bj,body:i.bi.id==e?i.bj:i.bi}:null};function ir(t){return ir="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ir(t)}function nr(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,sr(n.key),n)}}function sr(t){var e=function(t,e){if("object"!=ir(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=ir(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==ir(e)?e:e+""}var rr=function(){return function(t,e,i){return e&&nr(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(e,i,n,s,r,o,a,h){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.scene=e,this.world=i,this.game=a,this.isDestroyed=!1,this.initialVelocity=r,this.velocityFactor=o,this.owner=h;var l=new In(.2,16,16),c=new Vn({color:16711680});this.mesh=new Xe(l,c),this.mesh.position.copy(n),this.scene.add(this.mesh);var u=new ps.Sphere(.2);this.body=new ps.Body({mass:5,shape:u,position:new ps.Vec3(n.x,n.y,n.z),velocity:new ps.Vec3(s.x*r,s.y*r,s.z*r)}),this.body.force.set(0,-9.82*this.body.mass,0),this.world.addBody(this.body),this.particleCount=50,this.game.headless||(this.particleSystem=new tr(e,n,this.particleCount)),this.previousPosition=n.clone()}),[{key:"onCollide",value:function(t){if(!this.isDestroyed){if(t.body.isCrate&&(this.game.isSinglePlayer||this.game.headless)){var e=new ps.Vec3;t.body.pointToLocalFrame(t.contact.bj.position.clone().vadd(t.contact.rj),e);var i=this.game.battleMap.crates.find((function(e){return e.body===t.body}));this.game.damageCrate(this.mesh.position,e,1,i)}this.explode(1.5)}}},{key:"explode",value:function(t){var e=this;if(!this.isDestroyed){this.isDestroyed=!0;var i=new Zs(this.scene,this.mesh.position,t,this.game,this.owner);this.game.addExplosion(i);var n=(new ps.Vec3).copy(this.body.position);(this.game.isSinglePlayer||this.game.headless)&&this.game.tanks.forEach((function(i){var s=i.body.position,r=n.distanceTo(s);if(r<=2*t||i.isPointInsideTank(n)){var o=e.calculateDamage(r,t);e.game.damageTank(o,i,t,e.mesh.position,e.owner)}})),this.game.headless||this.particleSystem.startFadeOut(),this.remove()}}},{key:"update",value:function(t){this.mesh.position.copy(this.body.position),this.mesh.quaternion.copy(this.body.quaternion),this.game.headless||this.particleSystem.update(t,this.mesh.position,this.previousPosition),this.previousPosition.copy(this.mesh.position);var e=er(this.world.contacts,this.body.id);e&&this.onCollide(e)}},{key:"calculateDamage",value:function(t,e){var i=this.velocityFactor;if(0===t)return Math.round(25+20*i);var n=1-t/(2*e);return console.log("Deal ".concat(Math.round(25*n+20*i)," damage. Velocity bonus: ").concat(20*i)),Math.round(25*n+20*i)}},{key:"remove",value:function(){this.scene.remove(this.mesh),this.world.removeBody(this.body),this.game.headless||this.triggerParticles()}},{key:"triggerParticles",value:function(){this.particleSystem.startFadeOut(),this.game.addFadingParticleSystem(this.particleSystem)}},{key:"createDestroyedTankEffect",value:function(t,e){this.game.createDestroyedTankEffect(t,this.mesh.position,e)}},{key:"createDestroyedCrateEffect",value:function(t,e,i){this.game.createDestroyedCrateEffect(t,e,this.mesh.position,i)}}])}();const or=rr;function ar(t){return ar="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ar(t)}function hr(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,lr(n.key),n)}}function lr(t){var e=function(t,e){if("object"!=ar(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=ar(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==ar(e)?e:e+""}ps.Quaternion.prototype.slerp=function(t,e){if(0===e)return this;if(1===e)return this.copy(t);var i=this._x,n=this._y,s=this._z,r=this._w,o=r*t._w+i*t._x+n*t._y+s*t._z;if(o<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,o=-o):this.copy(t),o>=1)return this._w=r,this._x=i,this._y=n,this._z=s,this;var a=1-o*o;if(a<=Number.EPSILON){var h=1-e;return this._w=h*r+e*this._w,this._x=h*i+e*this._x,this._y=h*n+e*this._y,this._z=h*s+e*this._z,this.normalize(),this}var l=Math.sqrt(a),c=Math.atan2(l,o),u=Math.sin((1-e)*c)/l,p=Math.sin(e*c)/l;return this._w=r*u+this._w*p,this._x=i*u+this._x*p,this._y=n*u+this._y*p,this._z=s*u+this._z*p,this};var cr=function(){return function(t,e,i){return e&&hr(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(e,i,n,s,r,o){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.id=n.generateTankId(),this.scene=e,this.world=i,this.game=n,this.color=s,this.position=r,this.rotation=o,this.scale=1.5,this.health=100,this.maxHealth=100,this.moveDirection=0,this.rotateDirection=0,this.turnSpeed=.75,this.currentSpeed=0,this.currentTurnSpeed=0,this.maxSpeed=30,this.acceleration=60,this.deceleration=60,this.turnAcceleration=2,this.turnDeceleration=3,this.isDestroyed=!1,this.barrelPivot=null,this.barrelAngle=0,this.barrelRotationSpeed=.1,this.maxRotationPerFrame=Math.PI/30,this.indirectBarrelMinAngle=Math.PI/9,this.indirectBarrelMaxAngle=Math.PI/4,this.indirectFireInitialAngle=this.indirectBarrelMaxAngle-this.indirectBarrelMinAngle/2,this.directBarrelMinAngle=-Math.PI/24,this.directBarrelMaxAngle=0,this.directFireInitialAngle=this.directBarrelMaxAngle,this.barrelMaxAngle=this.directBarrelMaxAngle,this.barrelMinAngle=this.directBarrelMinAngle,this.turretRotation=0,this.turretRotationSpeed=.1,this.minShotVelocityDirect=10,this.maxShotVelocityDirect=60,this.minShotVelocityIndirect=5,this.maxShotVelocityIndirect=25,this.shotVelocity=this.minShotVelocityDirect,this.minShotVelocity=this.minShotVelocityDirect,this.maxShotVelocity=this.maxShotVelocityDirect,this.targetTurretAngle=0,this.targetBarrelAngle=0,this.isIndirectFireMode=!1,this.barrelTransitionSpeed=70,this.isChangingMode=!1,this.scale=1.5,this.isTransitioning=!1,this.transitionProgress=0,this.transitionDuration=500,this.originalDimensions=new G(1,.5,2),this.squareDimensions=new G(1.5,.5,1.5),this.isAcceleratingShot=!1,this.serverState={position:new ps.Vec3(0,0,0),quaternion:new ps.Quaternion(0,0,0),velocity:new ps.Vec3(0,0,0),angularVelocity:new ps.Vec3(0,0,0),targetBarrelAngle:null,targetTurretAngle:null,shotVelocity:null,isIndirectFireMode:null,isTransitioning:null,isAcceleratingShot:null},this.lastUpdateTime=null,this.serverUpdateDelta=0,this.interpolationTime=50,this.createMesh(),this.createPhysicsBody()}),[{key:"getStateData",value:function(){return{shotVelocity:this.shotVelocity,isIndirectFireMode:this.isIndirectFireMode,isAcceleratingShot:this.isAcceleratingShot,isTransitioning:this.isTransitioning,targetBarrelAngle:this.targetBarrelAngle,targetTurretAngle:this.targetTurretAngle,position:this.body.position,quaternion:this.body.quaternion,velocity:this.body.velocity,angularVelocity:this.body.angularVelocity,isDestroyed:this.isDestroyed}}},{key:"startTransition",value:function(t){t!=this.isIndirectFireMode&&(this.isTransitioning||(this.isTransitioning=!0,this.transitionProgress=0,this.isIndirectFireMode=t))}},{key:"setIndirectFireMode",value:function(t){this.isIndirectFireMode=t,this.isChangingMode=!0,t?(this.shotVelocity=this.minShotVelocityIndirect,this.minShotVelocity=this.minShotVelocityIndirect,this.maxShotVelocity=this.maxShotVelocityIndirect,this.barrelMinAngle=this.indirectBarrelMinAngle,this.barrelMaxAngle=this.indirectBarrelMaxAngle,this.targetBarrelAngle=this.indirectFireInitialAngle):(this.barrelMinAngle=this.directBarrelMinAngle,this.barrelMaxAngle=this.directBarrelMaxAngle,this.targetBarrelAngle=this.directFireInitialAngle,this.shotVelocity=this.minShotVelocityDirect,this.minShotVelocity=this.minShotVelocityDirect,this.maxShotVelocity=this.maxShotVelocityDirect)}},{key:"rotateTurretLeft",value:function(t){this.turretRotation+=this.turretRotationSpeed,this.updateTurretRotation(t)}},{key:"rotateTurretRight",value:function(t){this.turretRotation-=this.turretRotationSpeed,this.updateTurretRotation(t)}},{key:"takeDamage",value:function(t,e){this.health=Math.max(0,this.health-t),console.log("Tank took ".concat(t," damage from ").concat(e.id,". Current health: ").concat(this.health))}},{key:"updateServerState",value:function(t,e){this.serverState.position.copy(t.position),this.serverState.quaternion.copy(t.quaternion),this.serverState.velocity.copy(t.velocity),this.serverState.angularVelocity.copy(t.angularVelocity),this.serverState.targetBarrelAngle=t.targetBarrelAngle,this.serverState.targetTurretAngle=t.targetTurretAngle,this.serverState.shotVelocity=t.shotVelocity,this.serverState.isIndirectFireMode=t.isIndirectFireMode,this.serverState.isTransitioning=t.isTransitioning,this.serverState.isAcceleratingShot=t.isAcceleratingShot,this.serverState.isDestroyed=t.isDestroyed,this.lastUpdateTime=e}},{key:"interpolate",value:function(t){var e=t-this.lastUpdateTime,i=Math.min(e/this.interpolationTime,1);this.serverState.isDestroyed||(this.body.position.lerp(this.serverState.position,i,this.body.position),this.body.quaternion.slerp(this.serverState.quaternion,i)),this.body.velocity.copy(this.serverState.velocity),this.body.angularVelocity.copy(this.serverState.angularVelocity),this.targetBarrelAngle=this.serverState.targetBarrelAngle,this.targetTurretAngle=this.serverState.targetTurretAngle,this.serverState.isTransitioning!=this.isTransitioning&&this.startTransition(this.serverState.isIndirectFireMode),this.isTransitioning||this.serverState.isIndirectFireMode==this.isIndirectFireMode||this.setIndirectFireMode(this.serverState.isIndirectFireMode),this.isDestroyed=this.serverState.isDestroyed,this.isAcceleratingShot=this.serverState.isAcceleratingShot,this.shotVelocity=this.serverState.shotVelocity}},{key:"extrapolate",value:function(t){var e=(t-this.lastUpdateTime)/1e3,i=new ps.Vec3;i.copy(this.serverState.position),i.vadd(this.serverState.velocity.scale(e),i),this.body.position.copy(i);var n=new ps.Quaternion,s=this.serverState.angularVelocity.length();if(s>0){var r=this.serverState.angularVelocity.unit(),o=s*e;n.setFromAxisAngle(r,o),n.mult(this.serverState.quaternion,n)}else n.copy(this.serverState.quaternion);this.body.quaternion.copy(n),this.body.velocity.copy(this.serverState.velocity),this.body.angularVelocity.copy(this.serverState.angularVelocity),this.targetBarrelAngle=this.serverState.targetBarrelAngle,this.targetTurretAngle=this.serverState.targetTurretAngle,this.targetBarrelAngle=this.serverState.targetBarrelAngle,this.targetTurretAngle=this.serverState.targetTurretAngle,this.serverState.isTransitioning!=this.isTransitioning&&this.startTransition(this.serverState.isIndirectFireMode),this.isTransitioning||this.serverState.isIndirectFireMode==this.isIndirectFireMode||this.setIndirectFireMode(this.serverState.isIndirectFireMode),this.serverState.isAcceleratingShot=this.isAcceleratingShot,this.serverState.shotVelocity=this.shotVelocity}},{key:"updateTurretRotation",value:function(t){var e=this.targetTurretAngle-this.turretRotation;e>Math.PI&&(e-=2*Math.PI),e<-Math.PI&&(e+=2*Math.PI);var i=this.maxRotationPerFrame*(t/16.67),n=Math.sign(e)*Math.min(Math.abs(e),i);for(this.turretRotation+=n;this.turretRotation>Math.PI;)this.turretRotation-=2*Math.PI;for(;this.turretRotation<-Math.PI;)this.turretRotation+=2*Math.PI;this.turret.rotation.y=this.turretRotation}},{key:"updateBarrelRotation",value:function(t){var e=this.targetBarrelAngle-this.barrelAngle;this.barrelAngle+=e*(this.barrelTransitionSpeed*(t/16.67)),this.barrelAngle=this.isChangingMode?this.barrelAngle:Math.max(this.barrelMinAngle,Math.min(this.barrelAngle,this.barrelMaxAngle)),this.barrelPivot.rotation.x=this.barrelAngle,this.isChangingMode&&Math.floor(100*this.barrelAngle)===Math.floor(100*(this.isIndirectFireMode?this.indirectFireInitialAngle:this.directFireInitialAngle))&&(this.isChangingMode=!1)}},{key:"createMesh",value:function(){var t=new Ze(1,.5,2),e=new Rn({color:this.color,roughness:.1,metalness:.7});this.bodyMesh=new Xe(t,e),this.bodyMesh.scale.multiplyScalar(this.scale),this.bodyMesh.castShadow=!0,this.mesh=new Yi,this.mesh.add(this.bodyMesh),this.mesh.position.copy(this.position),this.mesh.rotation.y=this.rotation,this.mesh.rotation.order="YXZ";var i=new Tn(.4*this.scale,.4*this.scale,.3*this.scale,16),n=new Rn({color:this.color,roughness:.1,metalness:.7});this.turret=new Xe(i,n),this.turret.position.set(0,.4*this.scale,0),this.turret.castShadow=!0,this.mesh.add(this.turret);var s=new Tn(.1*this.scale,.1*this.scale,1.5*this.scale,8),r=new Rn({color:6710886,roughness:.1,metalness:.7}),o=new Xe(s,r);o.castShadow=!0,this.barrelPivot=new Zt,this.barrelPivot.position.set(0,.15*this.scale,0),o.position.set(0,0,-.75*this.scale),o.rotation.x=-Math.PI/2,this.barrelPivot.add(o),this.turret.add(this.barrelPivot),this.scene.add(this.mesh)}},{key:"createPhysicsBody",value:function(){var t=new ps.Box(new ps.Vec3(this.originalDimensions.x*this.scale/2,this.originalDimensions.y*this.scale/2,this.originalDimensions.z*this.scale/2));this.body=new ps.Body({mass:1e3*this.scale,material:new ps.Material({friction:1.5,restitution:.3}),collisionFilterGroup:1,collisionFilterMask:3}),this.body.addShape(t),this.body.position.copy(this.position),this.body.quaternion.setFromEuler(0,this.rotation,0),this.body.linearDamping=.5,this.body.angularDamping=.9,this.body.fixedRotation=!0,this.body.updateMassProperties(),this.world.addBody(this.body)}},{key:"setOriginalBodyState",value:function(){this.bodyMesh.scale.set(this.scale,this.scale,this.scale);var t=new ps.Vec3(this.originalDimensions.x*this.scale/2,this.originalDimensions.y*this.scale/2,this.originalDimensions.z*this.scale/2);this.body.shapes[0].halfExtents=t,this.body.shapes[0].updateConvexPolyhedronRepresentation(),this.body.updateBoundingRadius()}},{key:"setSquareBodyState",value:function(){this.bodyMesh.scale.set(this.scale,this.scale,this.scale);var t=new ps.Vec3(this.squareDimensions.x*this.scale/2,this.squareDimensions.y*this.scale/2,this.squareDimensions.z*this.scale/2);this.body.shapes[0].halfExtents=t,this.body.shapes[0].updateConvexPolyhedronRepresentation(),this.body.updateBoundingRadius()}},{key:"updateTransition",value:function(t){this.transitionProgress+=1e3*t;var e=Math.min(this.transitionProgress/this.transitionDuration,1),i=new G;i.lerpVectors(this.originalDimensions,this.squareDimensions,this.isIndirectFireMode?e:1-e),this.bodyMesh.scale.set(i.x/this.originalDimensions.x*this.scale,this.scale,i.z/this.originalDimensions.z*this.scale),this.turret.position.y=this.bodyMesh.scale.y/2;var n=new ps.Vec3(i.x*this.scale/2,this.originalDimensions.y*this.scale/2,i.z*this.scale/2);this.body.shapes[0].halfExtents=n,this.body.shapes[0].updateConvexPolyhedronRepresentation(),this.body.updateBoundingRadius(),1===e&&(this.setIndirectFireMode(this.isIndirectFireMode),this.isTransitioning=!1)}},{key:"heal",value:function(t){this.health=Math.min(this.health+t,this.maxHealth),console.log("Tank healed for ".concat(t,". Current health: ").concat(this.health))}},{key:"update",value:function(t){if(this.isTransitioning&&this.updateTransition(t),this.isAcceleratingShot){var e=(this.maxShotVelocity-this.minShotVelocity)/2*t;this.shotVelocity=Math.min(this.shotVelocity+e,this.maxShotVelocity)}var i=Date.now();this.lastUpdateTime&&(this.lastUpdateTime,this.interpolationTime,this.interpolate(i)),this.mesh.position.copy(this.body.position),this.mesh.quaternion.copy(this.body.quaternion);var n=this.targetTurretAngle-this.turretRotation;n>Math.PI&&(n-=2*Math.PI),n<-Math.PI&&(n+=2*Math.PI),this.turretRotation+=.1*n,this.turretRotation=(this.turretRotation+Math.PI)%(2*Math.PI)-Math.PI,this.setMoveSpeed(t),this.setRotateSpeed(t),this.applyMovement(t),this.updateTurretRotation(t),this.updateBarrelRotation(t)}},{key:"applyMovement",value:function(t){if(!this.isTransitioning&&!this.isIndirectFireMode){var e=new ps.Vec3(0,0,-1),i=new ps.Vec3(0,0,0);this.body.vectorToWorldFrame(e,i),i.y=0,i.normalize();var n=i.scale(this.currentSpeed);n.y=this.body.velocity.y,this.body.velocity.copy(n),this.body.angularVelocity.set(0,-this.currentTurnSpeed,0)}}},{key:"applyState",value:function(t){this.body.position.copy(t.position),this.body.quaternion.copy(t.quaternion),this.body.angularVelocity.copy(t.angularVelocity),this.body.velocity.copy(t.velocity),this.turretRotation=t.turretRotation,this.turret.rotation.y=t.turretRotation,this.targetTurretAngle=t.turretRotation,this.barrelAngle=t.barrelAngle,this.barrelPivot.rotation.x=t.barrelAngle,this.targetBarrelAngle=t.barrelAngle,this.isIndirectFireMode=t.isIndirectFireMode,t.isIndirectFireMode?this.setSquareBodyState():this.setOriginalBodyState(),this.isAcceleratingShot=t.isAcceleratingShot,this.shotVelocity=t.shotVelocity,this.isDestroyed=t.isDestroyed,this.health=t.hp,this.mesh.visible=t.visible}},{key:"move",value:function(t){this.isIndirectFireMode||(this.moveDirection=t)}},{key:"setMoveSpeed",value:function(t){var e=Math.sign(this.moveDirection)*this.maxSpeed;if(0!==Math.sign(this.moveDirection)){var i=this.acceleration*t;this.currentSpeed=Math.sign(e-this.currentSpeed)*Math.min(Math.abs(e-this.currentSpeed),i)+this.currentSpeed}else{var n=this.deceleration*t;Math.abs(this.currentSpeed)<=n?this.currentSpeed=0:this.currentSpeed-=Math.sign(this.currentSpeed)*n}}},{key:"rotate",value:function(t){this.isIndirectFireMode||(this.rotateDirection=t)}},{key:"setRotateSpeed",value:function(t){var e=Math.sign(this.rotateDirection)*this.turnSpeed;if(0!==Math.sign(this.rotateDirection)){var i=this.turnAcceleration*t;this.currentTurnSpeed=Math.sign(e-this.currentTurnSpeed)*Math.min(Math.abs(e-this.currentTurnSpeed),i)+this.currentTurnSpeed}else{var n=this.turnDeceleration*t;Math.abs(this.currentTurnSpeed)<=n?this.currentTurnSpeed=0:this.currentTurnSpeed-=Math.sign(this.currentTurnSpeed)*n}}},{key:"accelerateShotVelocity",value:function(){this.isDestroyed||(this.isAcceleratingShot=!0)}},{key:"stopAccelarateShotVelocity",value:function(){this.isDestroyed||(this.isAcceleratingShot=!1)}},{key:"setTargetTurretAngle",value:function(t){var e=new G;this.mesh.getWorldPosition(e);var i=this.mesh.quaternion,n=(new G).subVectors(t,e);n.y=0;var s=new G(0,0,-1).applyQuaternion(i);s.y=0,s.normalize();var r=Math.atan2(s.x*n.z-s.z*n.x,s.x*n.x+s.z*n.z);this.targetTurretAngle=-r}},{key:"setTargetAngles",value:function(t){this.setTargetTurretAngle(t),this.isChangingMode||(this.targetBarrelAngle=this.barrelMinAngle,this.isIndirectFireMode?this.targetBarrelAngle=this.barrelMinAngle:this.targetBarrelAngle=this.barrelMaxAngle)}},{key:"setBarrelTargetAngle",value:function(t){this.isChangingMode||(this.targetBarrelAngle=t)}},{key:"getBarrelEndPosition",value:function(t){var e=new _t;this.barrelPivot.updateMatrixWorld(),e.copy(this.barrelPivot.matrixWorld),t.set(0,0,-1.5*this.scale),t.applyMatrix4(e)}},{key:"getShootDirection",value:function(t){t.set(0,0,-1),t.applyQuaternion(this.mesh.quaternion),t.applyQuaternion(this.turret.quaternion),t.applyAxisAngle(new G(1,0,0),this.barrelAngle),t.normalize()}},{key:"isPointInsideTank",value:function(t){var e=this.body.shapes[0].halfExtents,i=this.body.pointToLocalFrame(t);return Math.abs(i.x)<=e.x&&Math.abs(i.y)<=e.y&&Math.abs(i.z)<=e.z}},{key:"remove",value:function(){this.isDestroyed=!0,this.isAcceleratingShot=!1,this.mesh.visible=!1,this.body.collisionResponse=!1,this.world.removeBody(this.body)}},{key:"getBarrelTipPosition",value:function(){var t=(new _t).makeRotationFromQuaternion(this.mesh.quaternion);t.setPosition(this.mesh.position);var e=(new _t).makeRotationY(this.turretRotation);e.setPosition(new G(0,.4*this.scale,0));var i=(new _t).makeRotationX(this.barrelAngle);i.setPosition(new G(0,.15*this.scale,0));var n=(new _t).multiplyMatrices(t,e);n.multiply(i);var s=new G(0,0,-1.5*this.scale);return s.applyMatrix4(n),s}},{key:"hackShoot",value:function(t){this.shotVelocity=t,this.shoot()}},{key:"calculateVelocity",value:function(t){var e,i=this.barrelAngle,n=this.getBarrelTipPosition(),s=t.x-n.x,r=t.z-n.z,o=Math.sqrt(s*s+r*r),a=t.y-n.y;return e=a>=0?Math.sqrt(9.82*o*o/(2*(a+o*Math.tan(i))*Math.cos(i)*Math.cos(i))):Math.sqrt(9.82*o*o/(2*Math.cos(i)*Math.cos(i)*(o*Math.tan(i)-a))),!isNaN(e)&&isFinite(e)||(e=Math.sqrt(19.64*Math.abs(a)+o*o/(2*Math.cos(i)*Math.cos(i)))),Math.max(Math.min(e,this.maxShotVelocity))}},{key:"calculateTrajectory",value:function(t,e){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=this.getBarrelTipPosition(),s=this.barrelAngle,r=Math.abs(9.82),o=t.x-n.x,a=t.z-n.z,h=Math.sqrt(o*o+a*a),l=h/(e*Math.cos(s)),c=n.y+e*l*Math.sin(s)-.5*r*l*l;if(i&&Math.abs(c-t.y)>.5)return null;for(var u=[],p=l/100,d=0;d<=100;d++){var m=d*p,f=n.x+o/h*e*Math.cos(s)*m,y=n.z+a/h*e*Math.cos(s)*m,v=n.y+e*Math.sin(s)*m-.5*r*m*m;if(v<t.y)break;u.push(new G(f,v,y))}return u}},{key:"shoot",value:function(){if(!this.isDestroyed){var t=(new _t).makeRotationFromQuaternion(this.mesh.quaternion);t.setPosition(this.mesh.position);var e=(new _t).makeRotationY(this.turretRotation);e.setPosition(new G(0,.4*this.scale,0));var i=(new _t).makeRotationX(this.barrelAngle);i.setPosition(new G(0,.15*this.scale,0));var n=(new _t).multiplyMatrices(t,e);n.multiply(i);var s=new G(0,0,-1.5*this.scale);s.applyMatrix4(n);var r=new G(0,0,-1);r.applyMatrix4(n);var o=new G(0,0,0);r.sub(o.setFromMatrixPosition(n)).normalize();var a=this.shotVelocity;this.shotVelocity=this.minShotVelocity,this.addProjectile(s,r,a),this.shootSignal(s,r,a)}}},{key:"addProjectile",value:function(t,e,i){var n=new or(this.scene,this.world,t,e,i,i/this.maxShotVelocity,this.game,this);this.game.addProjectile(n),this.isAcceleratingShot=!1}},{key:"shootSignal",value:function(t,e,i){this.game.onAction&&this.game.onAction({gameId:this.game.id},{type:"tank_shoot",data:{barrelEnd:t,shootDirection:e,initialVelocity:i,id:this.id}})}},{key:"reset",value:function(t,e){this.mesh.position.copy(t),this.body.position.copy(t),this.mesh.rotation.y=e,this.rotation=e,this.body.quaternion.setFromEuler(0,e,0),this.body.velocity.set(0,0,0),this.body.angularVelocity.set(0,0,0),this.mesh.quaternion.set(0,0,0,1),this.resetAttributes()}},{key:"resetAttributes",value:function(){this.health=this.maxHealth,this.isDestroyed=!1,this.isAcceleratingShot=!1,this.mesh.visible=!0,this.body.collisionResponse=!0,this.shotVelocity=this.minShotVelocity,this.isIndirectFireMode=!1,this.setOriginalBodyState(),this.world.addBody(this.body)}}])}();function ur(t){return ur="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ur(t)}function pr(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,dr(n.key),n)}}function dr(t){var e=function(t,e){if("object"!=ur(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=ur(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==ur(e)?e:e+""}!function(t,e,i){(e=lr(e))in t?Object.defineProperty(t,e,{value:4,enumerable:!0,configurable:!0,writable:!0}):t[e]=4}(cr,"objectId");var mr=function(){return function(t,e,i){return e&&pr(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.scene=e,this.createSkyBox()}),[{key:"createSkyBox",value:function(){var t={topColor:{value:new ue(30719)},bottomColor:{value:new ue(15004159)},offset:{value:33},exponent:{value:.6}},e=new In(400,32,15),i=new $e({uniforms:t,vertexShader:"\n            varying vec3 vWorldPosition;\n            void main() {\n                vec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n                vWorldPosition = worldPosition.xyz;\n                gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n            }\n        ",fragmentShader:"\n            uniform vec3 topColor;\n            uniform vec3 bottomColor;\n            uniform float offset;\n            uniform float exponent;\n            varying vec3 vWorldPosition;\n            void main() {\n                float h = normalize( vWorldPosition + offset ).y;\n                gl_FragColor = vec4( mix( bottomColor, topColor, max( pow( max( h, 0.0 ), exponent ), 0.0 ) ), 1.0 );\n            }\n        ",side:1});this.sky=new Xe(e,i),this.scene.add(this.sky)}}])}();function fr(t){return fr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},fr(t)}function yr(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,vr(n.key),n)}}function vr(t){var e=function(t,e){if("object"!=fr(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=fr(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==fr(e)?e:e+""}var gr=function(){return function(t,e,i){return e&&yr(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.content=[],this.scoreFunction=e}),[{key:"push",value:function(t){this.content.push(t),this.bubbleUp(this.content.length-1)}},{key:"pop",value:function(){var t=this.content[0],e=this.content.pop();return this.content.length>0&&(this.content[0]=e,this.sinkDown(0)),t}},{key:"remove",value:function(t){for(var e=this.content.length,i=0;i<e;i++)if(this.content[i]===t){var n=this.content.pop();if(i===e-1)break;this.content[i]=n,this.bubbleUp(i),this.sinkDown(i);break}}},{key:"size",value:function(){return this.content.length}},{key:"isEmpty",value:function(){return 0===this.content.length}},{key:"bubbleUp",value:function(t){for(var e=this.content[t],i=this.scoreFunction(e);t>0;){var n=Math.floor((t+1)/2)-1,s=this.content[n];if(i>=this.scoreFunction(s))break;this.content[n]=e,this.content[t]=s,t=n}}},{key:"sinkDown",value:function(t){for(var e=this.content.length,i=this.content[t],n=this.scoreFunction(i);;){var s=2*(t+1),r=s-1,o=null,a=void 0;if(r<e){var h=this.content[r];(a=this.scoreFunction(h))<n&&(o=r)}if(s<e){var l=this.content[s];this.scoreFunction(l)<(null===o?n:a)&&(o=s)}if(null===o)break;this.content[t]=this.content[o],this.content[o]=i,t=o}}}])}();function xr(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=function(t,e){if(t){if("string"==typeof t)return br(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?br(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0,s=function(){};return{s,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,o=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return o=t.done,t},e:function(t){a=!0,r=t},f:function(){try{o||null==i.return||i.return()}finally{if(a)throw r}}}}function br(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function wr(t){return wr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},wr(t)}function _r(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function Mr(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Ar(n.key),n)}}function Sr(t,e,i){return e&&Mr(t.prototype,e),i&&Mr(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function Ar(t){var e=function(t,e){if("object"!=wr(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=wr(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==wr(e)?e:e+""}var zr,Tr,Pr=function(){return Sr((function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;_r(this,t),this.position=e,this.g=i,this.h=n,this.f=i+n,this.parent=null}),[{key:"getPositionKey",value:function(){return"".concat(this.position.x,",").concat(this.position.y)}}])}(),kr=function(){return Sr((function t(e,i){_r(this,t),this.game=e,this.tank=i,this.target=null,this.state="search",this.lastFireTime=0,this.lastIndirectFireTime=0,this.fireCooldown=2,this.indirectFireCooldown=10,this.directFireAccuracy=.4,this.indirectFireAccuracy=.3,this.currentPath=[],this.currentTargetAngle=null,this.debugPath=null,this.nextPoint=null,this.obstacleGrid=this.createObstacleGrid(),this.lastPathfindingPosition=null,this.pathfindingThreshold=1,this.lastNoPathDeadline=null,this.noPathCooldown=1,this.isShooting=!1,this.tank.deceleration=3e3,this.tank.turnDeceleration=60,this.tank.acceleration=60}),[{key:"createDebugGrid",value:function(){var t=this;if(!this.game.headless){this.debugGrid&&this.game.scene.remove(this.debugGrid),this.obstacleMarkers&&this.obstacleMarkers.forEach((function(e){return t.game.scene.remove(e)}));for(var e=this.game.battleMap.size,i=new ke,n=new an({color:16777215,transparent:!0,opacity:.3}),s=[],r=-e/2;r<=e/2;r+=1)s.push(new G(r,.1,-e/2)),s.push(new G(r,.1,e/2));for(var o=-e/2;o<=e/2;o+=1)s.push(new G(-e/2,.1,o)),s.push(new G(e/2,.1,o));i.setFromPoints(s),this.debugGrid=new xn(i,n),this.game.scene.add(this.debugGrid),this.obstacleMarkers=[];for(var a=new fe({color:16711680,transparent:!0,opacity:.5}),h=0;h<this.obstacleGrid.length;h++)for(var l=0;l<this.obstacleGrid[0].length;l++)if(this.obstacleGrid[h][l]){var c=new ui(1,1),u=new Xe(c,a);u.rotation.x=-Math.PI/2,u.position.set(1*h-e/2+.5,.11,1*l-e/2+.5),this.game.scene.add(u),this.obstacleMarkers.push(u)}}}},{key:"update",value:function(t){if(this.tank.isDestroyed)return this.state="idle",void(this.isShooting=!1);switch(this.updateState(),this.state){case"search":this.search(t);break;case"siege":this.siege(t);break;case"attack":this.attack(t)}}},{key:"updateState",value:function(){var t=this,e=this.game.tanks.filter((function(e){return e!==t.tank&&!e.isDestroyed}));if(0!==e.length){var i=this.findNearestOpponent(e);i!==this.target?(this.target=i,this.recalculatePath(),this.isShooting=!1):this.target&&this.checkTargetMovement(),this.isShooting||(this.distanceToTarget()<=30&&this.hasLineOfSight()?this.state="attack":this.game.clock.getElapsedTime()-this.lastIndirectFireTime<this.indirectFireCooldown?this.state="search":this.state="siege")}else this.state="idle"}},{key:"recalculatePath",value:function(){var t=new A(this.tank.mesh.position.x,this.tank.mesh.position.z),e=new A(this.target.mesh.position.x,this.target.mesh.position.z);this.currentPath=this.findPath(t,e),this.lastPathfindingPosition=e.clone()}},{key:"checkTargetMovement",value:function(){if(this.lastPathfindingPosition){var t=new A(this.target.mesh.position.x,this.target.mesh.position.z);this.lastPathfindingPosition.distanceTo(t)>=this.pathfindingThreshold&&this.recalculatePath()}else this.recalculatePath()}},{key:"hasLineOfSight",value:function(){var t=this.tank.body.position,e=this.target.body.position,i=e.vsub(t),n=i.length();i.normalize();var s=new ps.RaycastResult,r=new ps.Ray(t,e),o=this.game.battleMap.crates.map((function(t){return t.body}));return r.intersectBodies(o,s),!s.hasHit||s.distance>n}},{key:"visualizeRay",value:function(t,e,i){this.debugLine&&this.game.scene.remove(this.debugLine);var n=new an({color:i?65280:16711680}),s=[];s.push(new G(t.x,t.y,t.z)),s.push(new G(e.x,e.y,e.z));var r=(new ke).setFromPoints(s);this.debugLine=new fn(r,n),this.game.scene.add(this.debugLine)}},{key:"search",value:function(t){this.moveTowardsTarget()}},{key:"siege",value:function(t){this.stopTank(),this.tryIndirectFire(t)}},{key:"attack",value:function(t){this.stopTank(),this.tryDirectFire(t)}},{key:"stopTank",value:function(){this.tank.move(0),this.tank.rotate(0)}},{key:"updatePathVisualization",value:function(){if(this.currentPath&&this.currentPath.length>0){var t=this.currentPath.slice();t.unshift(new A(Math.floor((this.tank.mesh.position.x+this.game.battleMap.size/2)/2),Math.floor((this.tank.mesh.position.z+this.game.battleMap.size/2)/2))),this.visualizePath(t)}}},{key:"findPath",value:function(t,e){var i=this,n=new gr((function(t){return t.f})),s=new Set,r=new Pr(new A(1*Math.round(t.x/1),1*Math.round(t.y/1))),o=new Pr(this.findNearestFreeNode(new A(1*Math.round(e.x/1),1*Math.round(e.y/1))));r.g=0,r.h=this.manhattanDistance(r.position,o.position),r.f=r.h,n.push(r);for(var a=0,h=1/0;!n.isEmpty()&&a<1e3;){a++;var l=n.pop();if(l.position.distanceTo(o.position)<1){for(var c=[],u=l;null!=u;)c.unshift(u.position),u=u.parent;return c}if(s.add(l.getPositionKey()),l.position.distanceTo(r.position)>h)return null;var p,d=xr(this.getNeighbors(l,1));try{var m=function(){var t=p.value;if(s.has(t.getPositionKey()))return 1;var e=l.g+l.position.distanceTo(t.position);(!n.content.some((function(e){return e.position.equals(t.position)}))||e<t.g)&&(t.parent=l,t.g=e,t.h=i.manhattanDistance(t.position,o.position),t.f=t.g+t.h,n.content.some((function(e){return e.position.equals(t.position)}))||n.push(t))};for(d.s();!(p=d.n()).done;)m()}catch(t){d.e(t)}finally{d.f()}}return a>=1e3?(console.log("Досягнуто максимальної кількості ітерацій при пошуку шляху"),null):null}},{key:"manhattanDistance",value:function(t,e){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}},{key:"getNeighbors",value:function(t,e){for(var i=[],n=0,s=[new A(1,0),new A(-1,0),new A(0,1),new A(0,-1),new A(1,1),new A(1,-1),new A(-1,1),new A(-1,-1)];n<s.length;n++){var r=s[n],o=new A(t.position.x+r.x*e,t.position.y+r.y*e);this.isWalkable(o)&&i.push(new Pr(o))}return i}},{key:"isWalkable",value:function(t){var e=this.game.battleMap.size,i=Math.floor((t.x+e/2)/1),n=Math.floor((t.y+e/2)/1);return!(i<0||i>=this.obstacleGrid.length||n<0||n>=this.obstacleGrid[0].length||this.obstacleGrid[i][n])}},{key:"createObstacleGrid",value:function(){var t=this.game.battleMap.size,e=Math.ceil(t/1),i=new Array(e).fill(null).map((function(){return new Array(e).fill(!1)}));return this.game.battleMap.crates.forEach((function(n){for(var s=Math.floor((n.position.x-1.3*n.size/2+t/2)/1),r=Math.ceil((n.position.x+1.3*n.size/2+t/2)/1),o=Math.floor((n.position.z-1.3*n.size/2+t/2)/1),a=Math.ceil((n.position.z+1.3*n.size/2+t/2)/1),h=s;h<r;h++)for(var l=o;l<a;l++)h>=0&&h<e&&l>=0&&l<e&&(i[h][l]=!0)})),i}},{key:"moveTowardsTarget",value:function(){if(this.target&&this.ensureDirectMode()){var t=new A(this.tank.mesh.position.x,this.tank.mesh.position.z);if(!this.currentPath||0===this.currentPath.length){var e=this.game.clock.getElapsedTime();if(e-this.lastNoPathDeadline<this.noPathCooldown)return;if(this.recalculatePath(),this.lastNoPathDeadline=e,!this.currentPath)return void console.log("Не вдалося знайти шлях до цілі")}var i,n,s,r,o=this.currentPath[0];if(t.distanceTo(o)<1){if(this.currentPath.shift(),!(this.currentPath.length>0))return void this.tank.move(0);o=this.currentPath[0]}this.currentTargetAngle||(this.currentTargetAngle=(i=this.tank.mesh.position,n=new G(o.x,0,o.y),s=(new G).subVectors(i,n),r=new G(s.x,0,s.z),Math.atan2(r.x,r.z)));var a=Er(this.tank.mesh.rotation.y,this.currentTargetAngle);Math.abs(a)>.05?(this.tank.rotate(-Math.sign(a)),this.tank.move(0)):(this.tank.rotate(0),this.currentTargetAngle=null,this.tank.move(1)),this.nextPoint=o}}},{key:"visualizePath",value:function(t){this.pathLine&&this.game.scene.remove(this.pathLine);var e=(new ke).setFromPoints(t.map((function(t){return new G(t.x,.2,t.y)}))),i=new an({color:65280});this.pathLine=new fn(e,i),this.game.scene.add(this.pathLine)}},{key:"onDebug",value:function(t){this.callback=t}},{key:"aimAtTarget",value:function(t){if(!this.target)return!1;if(this.tank.isTransitioning)return!1;for(var e=(new G).subVectors(this.target.mesh.position,this.tank.mesh.position),i=Math.atan2(e.x,e.z),n=this.tank.mesh.rotation.y,s=.04*(Math.random()-.5),r=i-n-Math.PI+4*s;r>Math.PI;)r-=2*Math.PI;for(;r<-Math.PI;)r+=2*Math.PI;this.tank.targetTurretAngle=r,e.length();var o=Math.atan2(e.y,Math.sqrt(e.x*e.x+e.z*e.z));return o=Math.max(this.tank.barrelMinAngle,Math.min(o,this.tank.barrelMaxAngle)),this.tank.setBarrelTargetAngle(o),this.aimCalculatedShotVelocity=this.tank.calculateVelocity(this.target.mesh.position),this.tank.shotVelocity<this.aimCalculatedShotVelocity?this.tank.accelerateShotVelocity():this.tank.stopAccelarateShotVelocity(),o+=s,this.callback&&this.callback(Math.abs(this.tank.turretRotation-r)<.05,Math.abs(this.tank.barrelAngle-o)<.05,this.tank.shotVelocity>=this.aimCalculatedShotVelocity,this.tank.turretRotation,r),Math.abs(this.tank.turretRotation-r)<.05&&Math.abs(this.tank.barrelAngle-o)<.05&&this.tank.shotVelocity>=this.aimCalculatedShotVelocity}},{key:"ensureIndirectMode",value:function(){return!(this.tank.isTransitioning||!this.tank.isIndirectFireMode&&(this.tank.startTransition(!0),1))}},{key:"ensureDirectMode",value:function(){return!(this.tank.isTransitioning||this.tank.isIndirectFireMode&&(this.tank.startTransition(!1),1))}},{key:"tryDirectFire",value:function(t){this.isShooting=!0;var e=this.game.clock.getElapsedTime();e-this.lastFireTime<this.fireCooldown||this.ensureDirectMode()&&this.aimAtTarget(t)&&(this.tank.shoot(),this.isShooting=!1,this.lastFireTime=e)}},{key:"tryIndirectFire",value:function(t){if(this.ensureIndirectMode()){var e=this.game.clock.getElapsedTime();this.isShooting=!0,this.aimAtTarget(t)&&(this.tank.shoot(),this.isShooting=!1,this.lastIndirectFireTime=e)}}},{key:"findNearestOpponent",value:function(t){var e=this;return t.reduce((function(t,i){var n=t.mesh.position.distanceTo(e.tank.mesh.position);return i.mesh.position.distanceTo(e.tank.mesh.position)<n?i:t}))}},{key:"distanceToTarget",value:function(){return this.target?this.tank.mesh.position.distanceTo(this.target.mesh.position):1/0}},{key:"findNearestFreeNode",value:function(t){for(var e=this.game.battleMap.size,i=Math.floor((t.x+e/2)/1),n=Math.floor((t.y+e/2)/1),s=null,r=1/0,o=-5;o<=5;o++)for(var a=-5;a<=5;a++){var h=i+o,l=n+a;if(h>=0&&h<this.obstacleGrid.length&&l>=0&&l<this.obstacleGrid[0].length&&!this.obstacleGrid[h][l]){var c=new A(1*h+.5-e/2,1*l+.5-e/2),u=c.distanceTo(t);u<r&&(r=u,s=c)}}return s||t}}])}(),Er=(zr=2*Math.PI,Tr=function(t,e){return(t%e+e)%e},function(t,e){var i=Tr(t-e,zr),n=Tr(e-t,zr);return i<n?-i:n});function Br(t){return Br="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Br(t)}function Cr(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Ir(n.key),n)}}function Ir(t){var e=function(t,e){if("object"!=Br(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=Br(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==Br(e)?e:e+""}var Rr=function(){return function(t,e,i){return e&&Cr(t.prototype,e),i&&Cr(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(e,i,n,s){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.scene=e,this.world=i,this.position=n,this.game=s,this.isDestroyed=!1,this.createMesh(),this.createPhysicsBody(),this.createGlowEffect(),this.startAnimation(),this.onCollideListener=null}),[{key:"createMesh",value:function(){var t=new Ze(1,1,1),e=new Cn(t);this.dashedMaterial=new Fn({color:16777215,dashSize:.4,gapSize:.2,linewidth:2}),this.cageMesh=new xn(e,this.dashedMaterial),this.cageMesh.computeLineDistances();var i=new Ze(.5,.5,.5);this.innerMaterial=new Vn({color:16776960}),this.innerMesh=new Xe(i,this.innerMaterial),this.mesh=new Yi,this.mesh.add(this.cageMesh),this.mesh.add(this.innerMesh),this.mesh.position.copy(this.position),this.scene.add(this.mesh)}},{key:"createGlowEffect",value:function(){var t=new ue(16777215);this.glowLight=new is(t,1,3),this.glowLight.position.set(0,0,0),this.mesh.add(this.glowLight)}},{key:"createPhysicsBody",value:function(){var t=new ps.Box(new ps.Vec3(.5,.5,.5));this.body=new ps.Body({mass:0,shape:t,collisionFilterGroup:2,position:new ps.Vec3(this.position.x,this.position.y,this.position.z)}),this.body.collisionResponse=!1,this.world.addBody(this.body)}},{key:"onCollide",value:function(t){if(!this.isDestroyed){var e=this.game.tanks.find((function(e){return e.body.id==t.body.id}));e&&this.onCollect(e)}}},{key:"startAnimation",value:function(){this.animationTime=0}},{key:"update",value:function(t){this.animationTime+=t,this.cageMesh.rotation.y=.5*this.animationTime,this.innerMesh.rotation.y=-.5*this.animationTime;var e=.1*Math.sin(2*this.animationTime);this.mesh.position.y=this.position.y+e;var i=.5+.3*Math.sin(4*this.animationTime);this.glowLight.intensity=i;var n=er(this.world.contacts,this.body.id);n&&this.onCollide(n)}},{key:"onCollect",value:function(t){}},{key:"remove",value:function(){this.scene.remove(this.mesh),this.isDestroyed=!0,this.world.removeBody(this.body)}}],[{key:"getMesh",value:function(){var t=new Ze(1,1,1),e=new Cn(t),i=new Fn({color:16777215,dashSize:.4,gapSize:.2,linewidth:2}),n=new xn(e,i);n.computeLineDistances();var s=new Ze(.5,.5,.5),r=new Vn({color:16776960}),o=new Xe(s,r),a=new Yi;return a.add(n),a.add(o),a}}])}();function Vr(t){return Vr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Vr(t)}function Fr(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function Or(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Wr(n.key),n)}}function jr(t,e,i){return e=Lr(e),function(t,e){if(e&&("object"==Vr(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,Nr()?Reflect.construct(e,i||[],Lr(t).constructor):e.apply(t,i))}function Nr(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(Nr=function(){return!!t})()}function qr(){return qr="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,i){var n=function(t,e){for(;!{}.hasOwnProperty.call(t,e)&&null!==(t=Lr(t)););return t}(t,e);if(n){var s=Object.getOwnPropertyDescriptor(n,e);return s.get?s.get.call(arguments.length<3?t:i):s.value}},qr.apply(null,arguments)}function Lr(t){return Lr=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},Lr(t)}function Dr(t,e){return Dr=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Dr(t,e)}function Wr(t){var e=function(t,e){if("object"!=Vr(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=Vr(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==Vr(e)?e:e+""}var Ur=function(t){function e(t,i,n,s){return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),jr(this,e,[t,i,n,s])}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&Dr(t,e)}(e,t),function(t,e,i){return e&&Or(t.prototype,e),i&&Or(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(e,[{key:"createMesh",value:function(){qr(Lr(e.prototype),"createMesh",this).call(this);var t=this.game.loader.getModel("cross");this.innerMesh=t,this.innerMesh.children[0].material.color.set(1,0,0),this.innerMesh.scale.set(.18,.18,.18),this.mesh.remove(this.mesh.children[1]),this.mesh.add(this.innerMesh),this.dashedMaterial.needsUpdate=!0,this.dashedMaterial.color.setHex(16777215)}},{key:"onCollect",value:function(t){t.heal(50),this.remove()}}],[{key:"getMesh",value:function(){var t=Rr.getMesh(),e=new Yi,i=new Vn({color:16711680,specular:85,shininess:30,flatShading:!0}),n=new Ze(.5,.1,.1),s=new Xe(n,i);e.add(s);var r=new Ze(.1,.5,.1),o=new Xe(r,i);e.add(o);var a=new Ze(.1,.1,.1);return[[.25,0,0],[-.25,0,0],[0,.25,0],[0,-.25,0]].forEach((function(t){var n,s=new Xe(a,i);(n=s.position).set.apply(n,function(t){return function(t){if(Array.isArray(t))return Fr(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(t){if("string"==typeof t)return Fr(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?Fr(t,e):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}(t)),e.add(s)})),t.children[0].material.needsUpdate=!0,t.children[0].material.color.setHex(16777215),t.remove(t.children[1]),t.add(e),t}}])}(Rr);!function(t,e,i){(e=Wr(e))in t?Object.defineProperty(t,e,{value:3,enumerable:!0,configurable:!0,writable:!0}):t[e]=3}(Ur,"objectId");var Hr=1e3/30;function Gr(t){return Gr="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Gr(t)}function Xr(t,e){if(t){if("string"==typeof t)return Yr(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?Yr(t,e):void 0}}function Yr(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function Zr(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function Qr(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Zr(Object(i),!0).forEach((function(e){Jr(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Zr(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function Jr(t,e,i){return(e=Kr(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function $r(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Kr(n.key),n)}}function Kr(t){var e=function(t,e){if("object"!=Gr(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=Gr(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==Gr(e)?e:e+""}var to=function(){return function(t,e,i){return e&&$r(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(e,i){var n=this;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t);var s=i.map,r=i.ai,o=i.onUpdate,a=i.onAction;this.loader=e,this.headless=!0,this.id=i.gameId,this._tankCounter=0,this._crateCounter=0,this.scene=new Zi,this.world=new ps.World,this.world.gravity.set(0,-9.82,0),this.clock=new ns,this.projectiles=[],this.maxProjectiles=100,this.plane=new ai(new G(0,1,0),0),this.skyBox=new mr(this.scene),this.battleMap=s?Us.fromMap(this.scene,this,s):new Us(this.scene,this,60,7),this.tanks=[new cr(this.scene,this.world,this,16711680,this.battleMap.spawnPoints[0].position,this.battleMap.spawnPoints[0].rotation),new cr(this.scene,this.world,this,255,this.battleMap.spawnPoints[1].position,this.battleMap.spawnPoints[1].rotation),new cr(this.scene,this.world,this,65280,this.battleMap.spawnPoints[2].position,this.battleMap.spawnPoints[2].rotation),new cr(this.scene,this.world,this,16776960,this.battleMap.spawnPoints[3].position,this.battleMap.spawnPoints[3].rotation)],this.tankSharedData=this.tanks.reduce((function(t,e){return t[e.id]={id:e.id,position:null,quaternion:null,angularVelocity:null,velocity:null,targetTurretAngle:null,targetBarrelAngle:null},t}),{}),this.aiPlayers=null,this.initiateAI(r),this.respawnTimer=5e3,this.powerUps=[],this.powerUpSpawnInterval=1e4,this.lastPowerUpSpawnTime=0,this.setupCollisionEvents(),this.explosions=[],this.frags=i.frags||this.tanks.reduce((function(t,e){return Qr(Qr({},t),{},Jr({},e.id,0))}),{}),this.onUpdate=o,this.onAction=a,this.tick=this.tick.bind(this),i.tanks&&Object.entries(i.tanks).forEach((function(t){var e=function(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,s,r,o,a=[],h=!0,l=!1;try{if(r=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;h=!1}else for(;!(h=(n=r.call(i)).done)&&(a.push(n.value),a.length!==e);h=!0);}catch(t){l=!0,s=t}finally{try{if(!h&&null!=i.return&&(o=i.return(),Object(o)!==o))return}finally{if(l)throw s}}return a}}(t,e)||Xr(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}(t,2),i=e[0],s=e[1],r=n.tanks.find((function(t){return t.id==i}));console.log("apply state",i,s,r.id),r.applyState(s)}))}),[{key:"generateTankId",value:function(){return++this._tankCounter}},{key:"generateCrateId",value:function(){return++this._crateCounter}},{key:"initiateAI",value:function(t){var e=this;console.log(this.tanks.map((function(t){return t.id})),t?t.map((function(t){return t.tankId})):[]),this.aiPlayers=t?t.map((function(t){return new kr(e,e.tanks.find((function(e){return e.id===t.tankId})))})):[]}},{key:"updateSharedData",value:function(){for(var t=this.tanks.length-1;t>=0;t--){var e=this.tanks[t],i=e.getStateData();this.tankSharedData[e.id].position=i.position,this.tankSharedData[e.id].quaternion=i.quaternion,this.tankSharedData[e.id].angularVelocity=i.angularVelocity,this.tankSharedData[e.id].velocity=i.velocity,this.tankSharedData[e.id].targetTurretAngle=i.targetTurretAngle,this.tankSharedData[e.id].targetBarrelAngle=i.targetBarrelAngle,this.tankSharedData[e.id].isIndirectFireMode=i.isIndirectFireMode,this.tankSharedData[e.id].isAcceleratingShot=i.isAcceleratingShot,this.tankSharedData[e.id].shotVelocity=i.shotVelocity,this.tankSharedData[e.id].isDestroyed=i.isDestroyed}}},{key:"setupCollisionEvents",value:function(){var t=this;this.world.addEventListener("beginContact",(function(e){var i=e.bodyA,n=e.bodyB,s=t.powerUps.find((function(t){return t.body===i||t.body===n})),r=t.tanks.find((function(t){return t.body===i||t.body===n}));s&&r&&(s.onCollect(r),t.removePowerUp(s))}))}},{key:"removePowerUp",value:function(t){var e=this.powerUps.indexOf(t);e>-1&&(this.powerUps.splice(e,1),t.remove())}},{key:"update",value:function(){var t=this.clock.getDelta();return this.battleMap.update(),this.tanks.forEach((function(e){return e.update(t)})),this.updateProjectiles(t),this.updateExplosions(t),this.updatePowerUps(t),this.aiPlayers.forEach((function(e){return e.update(t)})),this.updateSharedData(),this.onUpdate&&this.onUpdate({gameId:this.id},t),this.world.step(1/60,t,3),t}},{key:"loop",value:function(){this.update();var t,e=(t=null,function e(i){return t=setTimeout((function(){return e(i)}),Hr),i(),t.ref(),function(){return clearTimeout(t)}});this.cancelLoop=e(this.update.bind(this))}},{key:"tick",value:function(){this.update();var t=requestAnimationFrame(this.tick);this.cancelLoop=function(){return cancelAnimationFrame(t)}}},{key:"stop",value:function(){void 0!==this.cancelLoop&&(console.log("Stopping game "+this.id),this.cancelLoop())}},{key:"addProjectile",value:function(t){this.projectiles.push(t),this.projectiles.length>this.maxProjectiles&&this.projectiles.shift().remove(),t.game=this}},{key:"addExplosion",value:function(t){this.explosions.push(t)}},{key:"updateExplosions",value:function(t){this.explosions=this.explosions.filter((function(e){return e.update(t)}))}},{key:"checkProjectileCollision",value:function(t){return!!t.hasContact()}},{key:"updateProjectiles",value:function(t){for(var e=this.projectiles.length-1;e>=0;e--){var i=this.projectiles[e];i.update(t),i.isDestroyed?this.projectiles.splice(e,1):this.isOutOfBounds(i)&&(i.remove(),this.projectiles.splice(e,1))}}},{key:"isOutOfBounds",value:function(t){var e=t.mesh.position,i=1*this.battleMap.size;return Math.abs(e.x)>i||Math.abs(e.y)>i||Math.abs(e.z)>i}},{key:"isPlayerControlledTank",value:function(t){return!this.aiPlayers.some((function(e){return e.tank.id==t.id}))}},{key:"handleTankDeath",value:function(t){var e=this;t.remove(),this.isPlayerControlledTank(t)?this.onTankDeath(t):setTimeout((function(){return e.respawnTank(t)}),this.respawnTimer)}},{key:"onTankDeath",value:function(t){}},{key:"respawnTank",value:function(t){var e=this.getOptimalSpawnPoint(),i=e.optimalPoint,n=e.rotation;this.headless&&this.onAction&&this.onAction({gameId:this.id},{type:"respawn_tank",data:{id:t.id,point:i,rotation:n}}),this.respawnTankInPosition(t,i,n)}},{key:"respawnTankInPosition",value:function(t,e,i){this.headless||console.log("respawn_tank",t,e,i),t.reset(e,i)}},{key:"getOptimalSpawnPoint",value:function(){var t,e=null,i=null,n=1/0,s=function(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=Xr(t))){i&&(t=i);var n=0,s=function(){};return{s,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:s}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,o=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return o=t.done,t},e:function(t){a=!0,r=t},f:function(){try{o||null==i.return||i.return()}finally{if(a)throw r}}}}(this.battleMap.spawnPoints);try{for(s.s();!(t=s.n()).done;){var r=t.value,o=this.countEnemiesNearPoint(r.position);o<n&&(n=o,e=r.position,i=r.rotation)}}catch(t){s.e(t)}finally{s.f()}return{optimalPoint:e,rotation:i}}},{key:"countEnemiesNearPoint",value:function(t){return this.tanks.filter((function(e){return!e.isDestroyed&&e.mesh.position.distanceTo(t)<20})).length}},{key:"updatePowerUps",value:function(t){for(var e=this.powerUps.length-1;e>=0;e--)this.powerUps[e].update(t),this.isDestroyed&&this.powerUps.splice(e,1)}},{key:"spawnPowerUps",value:function(){var t=Date.now();if(t-this.lastPowerUpSpawnTime>this.powerUpSpawnInterval){var e=this.getRandomPosition(),i=new Ur(this.scene,this.world,e,this);this.powerUps.push(i),this.lastPowerUpSpawnTime=t}}},{key:"getRandomPosition",value:function(){var t=this.battleMap.size/2,e=Math.random()*this.battleMap.size-t,i=Math.random()*this.battleMap.size-t;return new G(e,1,i)}},{key:"damageTank",value:function(t,e,i,n,s){e.takeDamage(t,s);var r=this.checkTankDestruction(e,s);return this.headless&&this.onAction&&this.onAction({gameId:this.id},{type:"damage_tank",data:{id:e.id,radius:i,damage:t,dealer:s.id,position:n}}),r}},{key:"checkTankDestruction",value:function(t,e){return t.health<=0&&!t.isDestroyed?(t.isDestroyed=!0,console.log("".concat(e.id," killed ").concat(t.id)),this.handleTankDeath(t),e.id):null}},{key:"damageCrate",value:function(t,e,i,n){var s=n.destroyCubesInRadius(e,i);return this.headless&&this.onAction&&this.onAction({gameId:this.id},{type:"damage_crate",data:{id:n.id,innerPoint:t,deepPoint:e,radius:i}}),s}},{key:"addFrag",value:function(t){this.frags[t.id]=this.frags[t.id]?this.frags[t.id]+1:1}},{key:"start",value:function(){this.loop()}}])}();function eo(t){return eo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},eo(t)}function io(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,no(n.key),n)}}function no(t){var e=function(t,e){if("object"!=eo(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=eo(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==eo(e)?e:e+""}var so=function(){return function(t,e,i){return e&&io(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.model=new Zt;var e=new Ze(1,1,1),i=new Rn({color:new ue}),n=new Xe(e,i);this.model.children.push(n),this.texture=new Qi(new Uint8Array,16,16)}),[{key:"getModel",value:function(t){return this.model}},{key:"getTexture",value:function(t){return this.texture}}])}();function ro(t){return ro="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ro(t)}function oo(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function ao(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?oo(Object(i),!0).forEach((function(e){lo(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):oo(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function ho(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,co(n.key),n)}}function lo(t,e,i){return(e=co(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function co(t){var e=function(t,e){if("object"!=ro(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=ro(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==ro(e)?e:e+""}var uo=new so,po=function(){return function(t,e,i){return e&&ho(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),lo(this,"games",{}),lo(this,"playersReady",{}),this.provider=e,this.frequency=.05,this.timeSinceStateLastProvide=0}),[{key:"listen",value:function(){var t=this;this.provider.onGameCreate((function(e,i){t.onGameCreate(e,i)})),this.provider.onReadyToStartGame((function(e,i){t.onReadyToStartGame(e,i)})),this.provider.onUserTanksUpdate((function(e,i){t.onUserTanksUpdate(e,i)})),this.provider.onUserTankShoot((function(e,i){t.onUserTankShoot(e,i)})),this.provider.onUserLeft((function(e,i){t.onUserLeft(e,i)})),this.provider.onUserTankRespawn((function(e,i){t.onUserTankRespawn(e,i)})),this.provider.listen&&this.provider.listen()}},{key:"onGameTick",value:function(t,e){this.emitTanksUpdate(t)}},{key:"onUserLeft",value:function(t,e){this.games[t.gameId]&&(console.log("user left",t,e),this.games[t.gameId].playersReady[t.id]=!1,Object.values(this.games[t.gameId].playersReady).every((function(t){return!t}))&&(console.log("stopping game..."),this.games[t.gameId].stop(),delete this.games[t.gameId]))}},{key:"onGameAction",value:function(t,e){var i=e.type,n=e.data;switch(i){case"tank_shoot":this.emitTankShoot(t,n);break;case"damage_tank":this.emitDamageTank(t,n);break;case"damage_crate":this.emitDamageCrate(t,n);break;case"respawn_tank":this.emitRespawnTank(t,n)}}},{key:"emitTankShoot",value:function(t,e){this.provider.postTankShoot(t,{data:e,timestamp:Date.now()})}},{key:"emitDamageTank",value:function(t,e){this.provider.postDamageTank(t,{data:e,timestamp:Date.now()})}},{key:"emitDamageCrate",value:function(t,e){this.provider.postDamageCrate(t,{data:e,timestamp:Date.now()})}},{key:"emitRespawnTank",value:function(t,e){this.provider.postRespawnTank(t,{data:e,timestamp:Date.now()})}},{key:"emitTanksUpdate",value:function(t){this.games[t.gameId]&&this.provider.postTanksUpdate(t,{data:this.games[t.gameId].tankSharedData,timestamp:Date.now()})}},{key:"onUserTankShoot",value:function(t,e){var i=e.data,n=(e.timestamp,i.barrelEnd),s=i.shootDirection,r=i.initialVelocity,o=i.id,a=this.games[t.gameId].tanks.find((function(t){return t.id===+o}));a||console.warn(a.id+" tank shoot not found");var h=(new G).copy(n),l=(new G).copy(s);a.addProjectile(h,l,r),a.shootSignal(h.clone(),l.clone(),r)}},{key:"onUserTankRespawn",value:function(t,e){var i=e.data,n=(e.timestamp,i.id),s=this.games[t.gameId].tanks.find((function(t){return t.id===+n}));this.games[t.gameId].respawnTank(s)}},{key:"onUserTanksUpdate",value:function(t,e){var i=e.data,n=e.timestamp,s=i.id;this.games[t.gameId].tanks.find((function(t){return t.id===+s})).updateServerState(i,n)}},{key:"onGameCreate",value:function(t,e){var i=e.gameId&&this.games[e.gameId]?this.games[e.gameId]:new to(uo,ao(ao({},e),{},{gameId:"game-".concat(Math.floor(1e5*Math.random())),onUpdate:this.onGameTick.bind(this),onAction:this.onGameAction.bind(this)}));this.ensureGame(i,t,e)}},{key:"ensureGame",value:function(t,e,i){this.provider.setUserMeta(e.id,{gameId:t.id}),this.provider.postGameCreated({id:e.id,gameId:t.id},{playerTankId:i.playerTankId,gameId:t.id,map:t.battleMap.getMap(),tanks:t.tanks.reduce((function(t,e){return t[e.id]={position:e.body.position,quaternion:e.body.quaternion,angularVelocity:e.body.angularVelocity,velocity:e.body.velocity,turretRotation:e.turretRotation,barrelAngle:e.barrelAngle,isIndirectFireMode:e.isIndirectFireMode,isAcceleratingShot:e.isAcceleratingShot,shotVelocity:e.shotVelocity,isDestroyed:e.isDestroyed,hp:e.health,visible:e.mesh.visible},t}),{}),frags:t.frags}),this.games[t.id]=t,this.games[t.id].playersReady=lo({},e.id,!1),console.log(t.id,e.id)}},{key:"onReadyToStartGame",value:function(t,e){console.log("onReadyToStartGame",t),this.games[t.gameId].playersReady[t.id]=!0,Object.values(this.games[t.gameId].playersReady).every((function(t){return t}))&&(this.games[t.gameId].start(),this.provider.postGameStarted(t,{time:this.games[t.gameId].clock.getElapsedTime()}))}}])}();function mo(t){return mo="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},mo(t)}function fo(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function yo(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function vo(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?yo(Object(i),!0).forEach((function(e){xo(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):yo(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function go(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,bo(n.key),n)}}function xo(t,e,i){return(e=bo(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function bo(t){var e=function(t,e){if("object"!=mo(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=mo(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==mo(e)?e:e+""}var wo=function(){return function(t,e,i){return e&&go(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(e){var i=this;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),xo(this,"callbacks",{}),xo(this,"users",{}),xo(this,"gameId",null),xo(this,"id","user1"),e.onmessage=function(t){var e=t.data;i._handleEvent(vo(vo({},i.users[i.id]?i.users[i.id].meta:{}),{},{id:i.id}),e)}}),[{key:"_handleEvent",value:function(t,e){var i=e.event,n=e.payload,s=this.callbacks[i];s&&s.forEach((function(e){return e(t,n)}))}},{key:"_onEvent",value:function(t,e){this.callbacks[t]=this.callbacks[t]?[].concat(function(t){return function(t){if(Array.isArray(t))return fo(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(t){if("string"==typeof t)return fo(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?fo(t,e):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}(this.callbacks[t]),[e]):[e]}},{key:"setUserMeta",value:function(t,e){this.users[t]||(this.users[t]={}),this.users[t].meta=e}},{key:"_postEvent",value:function(t,e,i){self.postMessage({event:t,payload:i})}},{key:"onGameCreate",value:function(t){this._onEvent("game_create",t)}},{key:"onReadyToStartGame",value:function(t){this._onEvent("ready_to_start_game",t)}},{key:"postGameStarted",value:function(t,e){this._postEvent("game_started",t,e)}},{key:"postGameCreated",value:function(t,e){this._postEvent("game_created",t,e)}},{key:"postTanksUpdate",value:function(t,e){this._postEvent("tanks_update",t,e)}},{key:"postTankShoot",value:function(t,e){this._postEvent("tank_shoot",t,e)}},{key:"postDamageTank",value:function(t,e){this._postEvent("damage_tank",t,e)}},{key:"postDamageCrate",value:function(t,e){this._postEvent("damage_crate",t,e)}},{key:"postRespawnTank",value:function(t,e){this._postEvent("respawn_tank",t,e)}},{key:"onUserTanksUpdate",value:function(t){this._onEvent("user_tanks_update",t)}},{key:"onUserTankShoot",value:function(t){this._onEvent("user_tank_shoot",t)}},{key:"onUserTankRespawn",value:function(t){this._onEvent("user_tank_respawn",t)}},{key:"onUserLeft",value:function(t){}}])}();new po(new wo(self)).listen()})()})();
//# sourceMappingURL=worker.bundle.js.map