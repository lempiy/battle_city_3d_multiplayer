(()=>{"use strict";var t={n:e=>{var i=e&&e.__esModule?()=>e.default:()=>e;return t.d(i,{a:i}),i},d:(e,i)=>{for(var n in i)t.o(i,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:i[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};const e=require("three"),i=require("cannon");function n(t){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},n(t)}function r(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,o(n.key),n)}}function o(t){var e=function(t,e){if("object"!=n(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var r=i.call(t,"string");if("object"!=n(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==n(e)?e:e+""}var s,a,h=function(){return t=function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.position=e,this.size=i,this.createPhysicsBody()},(e=[{key:"createPhysicsBody",value:function(){var t=new i.Box(new i.Vec3(this.size/2,this.size/2,this.size/2));this.body=new i.Body({mass:0}),this.body.addShape(t),this.body.position.copy(this.position)}},{key:"update",value:function(){}}])&&r(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e}();function c(t){return c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},c(t)}function l(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,u(n.key),n)}}function u(t){var e=function(t,e){if("object"!=c(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=c(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==c(e)?e:e+""}s=h,(a=o(a="objectId"))in s?Object.defineProperty(s,a,{value:1,enumerable:!0,configurable:!0,writable:!0}):s[a]=1;var p=function(){return function(t,e,i){return e&&l(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(i,n,r){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new e.Vector3(.2,.2,.2);!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.scene=i,this.position=n,this.color=r,this.size=s,this.rotation=o,this.velocity=new e.Vector3,this.angularVelocity=new e.Vector3(5*Math.random()-2.5,5*Math.random()-2.5,5*Math.random()-2.5),this.removed=!1,this.createMesh()}),[{key:"createMesh",value:function(){var t=new e.BoxGeometry(this.size.x,this.size.y,this.size.z),i=new e.MeshPhongMaterial({color:this.color});this.mesh=new e.Mesh(t,i),this.mesh.rotateY(this.rotation),this.mesh.position.copy(this.position),this.scene.add(this.mesh)}},{key:"update",value:function(t){if(!this.removed){if(this.mesh.position.y<-this.size.y)return this.remove();this.mesh.position.addScaledVector(this.velocity,t),this.mesh.rotation.x+=this.angularVelocity.x*t,this.mesh.rotation.y+=this.angularVelocity.y*t,this.mesh.rotation.z+=this.angularVelocity.z*t,this.velocity.y-=9.8*t,this.velocity.multiplyScalar(.99)}}},{key:"remove",value:function(){this.removed||this.scene.remove(this.mesh),this.removed=!0}}])}();function y(t){return y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},y(t)}function d(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,f(n.key),n)}}function f(t){var e=function(t,e){if("object"!=y(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=y(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==y(e)?e:e+""}var v=function(){return function(t,e,i){return e&&d(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(e,i,n,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.scene=e,this.crate=i,this.world=n,this.debris=[],this.duration=3,this.elapsedTime=0,this.rectangles=r,this.createDebris()}),[{key:"createDebris",value:function(){for(var t=0;t<this.rectangles.length;t++){var i=this.rectangles[t],n=new e.Vector3(i.position.x+this.crate.position.x,i.position.y+this.crate.position.y,i.position.z+this.crate.position.z),r=new p(this.scene,n,this.crate.color,i.isVertical?0:Math.PI/2,new e.Vector3(2*this.crate.cubeSize,this.crate.cubeSize,this.crate.cubeSize));this.debris.push(r);var o=n.clone();o.y=0;var s=(new e.Vector3).subVectors(n,o).normalize();r.velocity.copy(s).multiplyScalar(2)}}},{key:"update",value:function(t){return this.elapsedTime+=t,this.elapsedTime>=this.duration?(this.remove(),!1):(this.debris.forEach((function(e){return e.update(t)})),!0)}},{key:"remove",value:function(){this.debris.forEach((function(t){return t.remove()}))}}])}();function m(t){return m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},m(t)}function b(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,r,o,s,a=[],h=!0,c=!1;try{if(o=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;h=!1}else for(;!(h=(n=o.call(i)).done)&&(a.push(n.value),a.length!==e);h=!0);}catch(t){c=!0,r=t}finally{try{if(!h&&null!=i.return&&(s=i.return(),Object(s)!==s))return}finally{if(c)throw r}}return a}}(t,e)||function(t,e){if(t){if("string"==typeof t)return g(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?g(t,e):void 0}}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function g(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function w(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,S(n.key),n)}}function S(t){var e=function(t,e){if("object"!=m(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=m(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==m(e)?e:e+""}var k=function(){return function(t,e,i){return e&&w(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(i,n,r,o,s,a,h){var c=arguments.length>7&&void 0!==arguments[7]?arguments[7]:2,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:6,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:6;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.id=n.generateCrateId(),this.scene=i,this.game=n,this.mesh=o,this.color=h,this.colorHex=new e.Color,this.colorHex.setHex(h),this.offset=s,this.geometryScale=a,this.world=n.world,this.position=r,this.size=c,this.resolution=l,this.height=u,this.cubeSize=c/l,this.cubes=[],this.shapes=[],this.scale=1,this.rectSizes=null,this.boxQuaternion=new e.Quaternion,this.scaleVec=new e.Vector3(1,1,1),this.boxIndexes=[],this.rectIndexes=[],this.isDirty=!1,this.activeCount=0,this.buildMesh(),this.createPhysicsBody()}),[{key:"buildMesh",value:function(){var t=this;this.geometry=new e.BoxGeometry(2*this.cubeSize,this.cubeSize,this.cubeSize),this.verticalGeometry=new e.BoxGeometry(this.cubeSize,this.cubeSize,2*this.cubeSize),this.rectSizes=new e.Vector3(2*this.cubeSize,this.cubeSize,this.cubeSize);for(var n=this.offset,r=new e.Matrix4,o=function(o,s){for(var a=0;a<t.resolution-(s?1:0);a++)for(var h=0;h<t.resolution/2-a-(s?1:0);h++){var c=s+a*t.cubeSize+h*(2*t.cubeSize)-t.size/2+2*t.cubeSize/2,l=a*t.cubeSize-t.size/2+t.cubeSize/2,u=r.makeRotationY(0);u.setPosition(t.position.x+c,t.position.y+o,t.position.z+l),u.scale(t.geometryScale),t.mesh.setMatrixAt(n,u);var p=new i.Box(new i.Vec3(t.cubeSize,t.cubeSize/2,t.cubeSize/2));t.shapes.push({shape:p,offset:new e.Vector3(c,o,l),active:!1}),t.cubes.push({index:n,isVertical:!1,position:new e.Vector3(c,o,l),active:!0}),n++,t.activeCount++}},s=function(o,s){for(var a=0;a<t.resolution/2-(s?1:0);a++)for(var h=0;h<t.resolution/2-a-(s?1:0);h++){var c=s+a*t.cubeSize+h*(2*t.cubeSize)-t.size/2+2*t.cubeSize/2,l=a*t.cubeSize-t.size/2+t.cubeSize/2,u=r.makeRotationY(Math.PI/2);u.setPosition(t.position.x+l,t.position.y+o,t.position.z+c),u.scale(t.geometryScale),t.mesh.setMatrixAt(n,u);var p=new i.Box(new i.Vec3(t.cubeSize/2,t.cubeSize/2,t.cubeSize));t.shapes.push({shape:p,offset:new e.Vector3(l,o,c),active:!1}),t.cubes.push({index:n,isVertical:!0,position:new e.Vector3(l,o,c),active:!0}),n++,t.activeCount++}},a=function(o,s){for(var a=0,h=t.resolution-1-(s?1:0);h>=t.resolution/2;h--){for(var c=t.resolution/2-a-1-(s?1:0);c>=0;c--){var l=a*t.cubeSize+c*(2*t.cubeSize)-t.size/2+2*t.cubeSize/2+s,u=h*t.cubeSize-t.size/2+t.cubeSize/2+s,p=r.makeRotationY(Math.PI/2);p.setPosition(t.position.x+u,t.position.y+o,t.position.z+l),p.scale(t.geometryScale),t.mesh.setMatrixAt(n,p);var y=new i.Box(new i.Vec3(t.cubeSize/2,t.cubeSize/2,t.cubeSize));t.shapes.push({shape:y,offset:new e.Vector3(u,o,l),active:!1}),t.cubes.push({index:n,isVertical:!0,position:new e.Vector3(u,o,l),active:!0}),n++,t.activeCount++}a++}},h=function(o,s){for(var a=0,h=t.resolution-1-(s?1:0);h>=0;h--){for(var c=0;c<t.resolution/2-a-(s?1:0);c++){var l=a*t.cubeSize+c*(2*t.cubeSize)-t.size/2+2*t.cubeSize/2+s,u=h*t.cubeSize-t.size/2+t.cubeSize/2+s,p=r.makeRotationY(0);p.setPosition(t.position.x+l,t.position.y+o,t.position.z+u),p.scale(t.geometryScale),t.mesh.setMatrixAt(n,p);var y=new i.Box(new i.Vec3(t.cubeSize,t.cubeSize/2,t.cubeSize/2));t.shapes.push({shape:y,offset:new e.Vector3(l,o,u),active:!1}),t.cubes.push({index:n,isVertical:!1,position:new e.Vector3(l,o,u),active:!0}),n++,t.activeCount++}a++}},c=0;c<this.height;c++){var l=c%2==0,u=c*this.cubeSize-this.size/2+this.cubeSize/2;o(u,l?this.cubeSize:0),h(u,l?this.cubeSize:0),s(u,l?0:this.cubeSize),a(u,l?0:this.cubeSize)}this.indexBlocks()}},{key:"indexBlocks",value:function(){this.boxIndexes=new Array(this.height*Math.pow(this.resolution,2)).fill(null);for(var t=0;t<this.height;t++)for(var i=0;i<this.resolution;i++)for(var n=0;n<this.resolution;n++)for(var r=n*this.cubeSize-this.size/2+this.cubeSize/2,o=t*this.cubeSize-this.size/2+this.cubeSize/2,s=i*this.cubeSize-this.size/2+this.cubeSize/2,a=new e.Vector3(r,o,s),h=t*Math.pow(this.resolution,2)/2;h<(t+1)*Math.pow(this.resolution,2)/2;h++){var c=this.cubes[h],l=c.position,u=c.isVertical?this.verticalGeometry:this.geometry;if(this.isPointInsideBox(a,u,l)){var p=t*this.resolution*this.resolution+i*this.resolution+n;this.boxIndexes[p]=h}}}},{key:"addBodyShapes",value:function(t){var e=this;t.forEach((function(t){var n=t.shape,r=t.offset,o=t.orientation,s=new i.Vec3,a=new i.Quaternion;r&&s.copy(r),o&&a.copy(o),e.body.shapes.push(n),e.body.shapeOffsets.push(s),e.body.shapeOrientations.push(a)})),this.body.updateMassProperties(),this.body.updateBoundingRadius(),this.body.aabbNeedsUpdate=!0}},{key:"removeBodyShapes",value:function(t){var e=this;t.forEach((function(t){var i=t.shape,n=e.body.shapes.indexOf(i);e.body.shapes.splice(n,1),e.body.shapeOffsets.splice(n,1),e.body.shapeOrientations.splice(n,1)})),this.body.updateMassProperties(),this.body.updateBoundingRadius(),this.body.aabbNeedsUpdate=!0}},{key:"updatePhysicalBody",value:function(){var t=this;if(!this.isDirty){this.removeBodyShapes([this.initialShape]);var e=this.shapes.filter((function(e,i){return t.cubes[i].active}));return this.addBodyShapes(e),e.forEach((function(t){return t.active=!0})),void(this.isDirty=!0)}var i=this.shapes.filter((function(e,i){return!t.cubes[i].active&&e.active}));i.forEach((function(t){return t.active=!1})),this.removeBodyShapes(i)}},{key:"createPhysicsBody",value:function(){this.body=new i.Body({mass:0}),this.body.position.copy(this.position),this.body.isCrate=!0,this.body.model=this,this.initialShape={shape:new i.Box(new i.Vec3(this.size/2,this.cubeSize*this.height/2,this.size/2))},this.addBodyShapes([this.initialShape]),this.world.addBody(this.body)}},{key:"applyState",value:function(t){var i=this,n=t.isDirty,r=t.inactiveCubes,o=new e.Matrix4;this.isDirty=n,n&&(r.forEach((function(t){var e=i.cubes.find((function(e){return e.index===t}));e.active&&(i.mesh.setMatrixAt(e.index,o.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)),i.mesh.instanceMatrix.addUpdateRange(16*e.index,16),e.active=!1,i.activeCount--)})),this.mesh.instanceMatrix.needsUpdate=!0,this.updatePhysicalBody(),this.activeCount||this.remove())}},{key:"destroyCubesInRadius",value:function(t,i){var n=this,r=new e.Matrix4,o=null,s=0;this.cubes.forEach((function(e){e.active&&e.position.distanceTo(t)<=i&&(n.mesh.setMatrixAt(e.index,r.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)),n.mesh.instanceMatrix.addUpdateRange(16*e.index,16),o=e.position,e.active=!1,n.activeCount--,s++)}));var a=this.findFloatingCubes();return a.size&&this.clearFloatingCubes(a),this.mesh.instanceMatrix.needsUpdate=!0,this.updatePhysicalBody(),this.activeCount||this.remove(),new e.Vector4(o?this.position.x+o.x:this.position.x,o?this.position.y+o.y:this.position.y,o?this.position.z+o.z:this.position.z,s)}},{key:"clearFloatingCubes",value:function(t){var i=this,n=new e.Matrix4,r=this.cubes.filter((function(e,i){return e.active&&t.has(i)})).map((function(t){return i.mesh.setMatrixAt(t.index,n.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)),i.mesh.instanceMatrix.addUpdateRange(16*t.index,16),t.active=!1,i.activeCount--,t}));this.activeCount||this.remove(),this.game.headless||this.createFallingCrateDerbisEffect(r)}},{key:"findFloatingCubes",value:function(){for(var t=this,e=new Set,i=new Set(this.boxIndexes.map((function(t,e){return[t,e]})).filter((function(e){var i=b(e,1)[0];return t.cubes[i].active})).map((function(t){var e=b(t,2);return e[0],e[1]}))),n=function n(r,o,s){var a=t.getIndex(r,o,s);-1!==a&&i.has(a)&&(i.delete(a),e.add(a),[[r+1,o,s],[r-1,o,s],[r,o+1,s],[r,o-1,s],[r,o,s+1],[r,o,s-1]].forEach((function(i){var r=b(i,3),o=r[0],s=r[1],a=r[2];e.has(t.getIndex(o,s,a))||n(o,s,a)})))},r=0;r<this.resolution;r++)for(var o=0;o<this.resolution;o++)n(o,0,r);return new Set(Array.from(i).map((function(e){return t.boxIndexes[e]})))}},{key:"getIndex",value:function(t,e,i){return t<0||t>=this.resolution||e<0||e>=this.height||i<0||i>=this.resolution?-1:e*this.resolution*this.resolution+i*this.resolution+t}},{key:"isPointInsideBox",value:function(t,i,n){var r=new e.Vector3;i.computeBoundingBox(),i.boundingBox.getSize(r);var o=new e.Matrix4;o.compose(n,this.boxQuaternion,this.scaleVec);var s=new e.Matrix4;s.copy(o).invert();var a=t.clone().applyMatrix4(s);return Math.abs(a.x)<=r.x/2&&Math.abs(a.y)<=r.y/2&&Math.abs(a.z)<=r.z/2}},{key:"createFallingCrateDerbisEffect",value:function(t){var e=new v(this.scene,this,this.world,t);this.game.addDestroyedEffect(e)}},{key:"remove",value:function(){this.game.battleMap.removeCrate(this),this.world.removeBody(this.body)}},{key:"update",value:function(){}}])}();function M(t){return M="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},M(t)}function P(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,x(n.key),n)}}function x(t){var e=function(t,e){if("object"!=M(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=M(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==M(e)?e:e+""}!function(t,e,i){(e=S(e))in t?Object.defineProperty(t,e,{value:2,enumerable:!0,configurable:!0,writable:!0}):t[e]=2}(k,"objectId");var T=function(){return function(t,e,i){return e&&P(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(i,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:6,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:50;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.scene=i,this.game=n,this.size=r,this.resolution=o,this.basicCount=s,this.cubeSize=r/o,this.offset=0;var a=this.game.loader.getModel("red_crate"),h=this.game.loader.getTexture("red_crate"),c=this.game.loader.getTexture("red_crate_normal"),l=new e.MeshStandardMaterial({map:h,normalMap:c,roughness:1,metalness:.1});a.traverse((function(t){t instanceof e.Mesh&&(t.material=l)}));var u=new e.Vector3;a.children[0].geometry.computeBoundingBox(),a.children[0].geometry.boundingBox.getSize(u),this.geometryScale=new e.Vector3(2*this.cubeSize/u.x,this.cubeSize/u.y,this.cubeSize/u.z),this.material=a.children[0].material,this.geometry=a.children[0].geometry}),[{key:"produceCrates",value:function(t){var i=this,n=t.reduce((function(t,e){var n=e.height;return t+Math.pow(i.resolution,2)/2*n}),0);return this.mesh=new e.InstancedMesh(this.geometry,this.material,n),this.mesh.castShadow=!0,this.mesh.instanceMatrix.setUsage(e.StaticDrawUsage),this.scene.add(this.mesh),t.map((function(t){var e=t.position,n=t.height,r=t.isDirty,o=new k(i.scene,i.game,e,i.mesh,i.offset,i.geometryScale,16162934,i.size,i.resolution,n);return r&&o.applyState(t),i.offset+=o.cubes.length,o}))}}])}();function A(t){return A="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},A(t)}function V(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function z(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function O(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?z(Object(i),!0).forEach((function(e){j(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):z(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function j(t,e,i){return(e=D(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function I(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,D(n.key),n)}}function D(t){var e=function(t,e){if("object"!=A(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=A(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==A(e)?e:e+""}var C=function(){function t(i,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:50,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:6,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.scene=i,this.game=n,this.world=n.world,this.size=r,this.fence=[],this.crates=[],this.cratesMeta=[],this.crateSize=2,this.crateResolution=6,this.obstaclesLevel=o,this.map=s,this.spawnPoints=s?s.spawnPoints:null,this.obstacles=s?s.obstacles:null,this.crateInstancedMesh=null,this.tempPosition=new e.Vector3,this.tempQuaternion=new e.Quaternion,this.tempScale=new e.Vector3(1,1,1),this.tempMatrix=new e.Matrix4,this.map||this.createMap(),this.createGround(),this.createCrateInstancedMesh(),this.createFence(),this.createObstacles()}return function(t,e,i){return e&&I(t.prototype,e),i&&I(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(t,[{key:"createCrateInstancedMesh",value:function(){var t=new e.BoxGeometry(2,2,2),i=this.game.loader.getTexture("crate").clone(),n=this.game.loader.getTexture("crate_normal").clone(),r=this.game.loader.getTexture("crate_metallic").clone(),o=this.game.loader.getTexture("crate_roughness").clone(),s=this.game.loader.getTexture("crate_ao").clone(),a=(this.game.loader.getTexture("crate"),new e.MeshStandardMaterial({roughness:.8,color:new e.Color(.2,.2,.2),metalness:.6,map:i,roughnessMap:o,normalMap:n,metalnessMap:r,aoMap:s}));this.crateInstancedMesh=new e.InstancedMesh(t,a,1e3),this.crateInstancedMesh.instanceMatrix.setUsage(e.StaticDrawUsage),this.crateInstancedMesh.castShadow=!0,this.crateInstancedMesh.receiveShadow=!0,this.crateInstancedMesh.count=0,this.scene.add(this.crateInstancedMesh)}},{key:"addCrate",value:function(t){var i=new h(t);this.fence.push(i),this.world.addBody(i.body);var n=new e.Matrix4;return n.setPosition(t.x,t.y,t.z),this.crateInstancedMesh.count=this.fence.length,this.crateInstancedMesh.setMatrixAt(this.fence.length-1,n),this.crateInstancedMesh.instanceMatrix.needsUpdate=!0,i}},{key:"createGround",value:function(){var t=this.game.loader.getTexture("grass");t.wrapS=e.RepeatWrapping,t.wrapT=e.RepeatWrapping,t.repeat.set(5,5);var n=this.game.loader.getTexture("metal").clone();n.wrapS=e.RepeatWrapping,n.wrapT=e.RepeatWrapping,n.repeat.set(6,6);var r=this.game.loader.getTexture("metal_normal").clone();r.wrapS=e.RepeatWrapping,r.wrapT=e.RepeatWrapping,r.repeat.set(6,6);var o=this.game.loader.getTexture("metal_metallic").clone();o.wrapS=e.RepeatWrapping,o.wrapT=e.RepeatWrapping,o.repeat.set(6,6);var s=this.game.loader.getTexture("metal_roughness").clone();s.wrapS=e.RepeatWrapping,s.wrapT=e.RepeatWrapping,s.repeat.set(6,6);var a=this.game.loader.getTexture("metal_ao").clone();a.wrapS=e.RepeatWrapping,a.wrapT=e.RepeatWrapping,a.repeat.set(6,6);var h=new e.PlaneGeometry(this.size,this.size),c=new e.MeshStandardMaterial({roughness:.8,color:new e.Color(.2,.2,.2),metalness:.6,map:n,roughnessMap:s,normalMap:r,metalnessMap:o,aoMap:a});this.ground=new e.Mesh(h,c),this.ground.rotation.x=-Math.PI/2,this.ground.receiveShadow=!0,this.scene.add(this.ground);var l=new i.Plane,u=new i.Body({mass:0,material:new i.Material({friction:1.5,restitution:.3})});u.addShape(l),u.quaternion.setFromAxisAngle(new i.Vec3(1,0,0),-Math.PI/2),this.world.addBody(u)}},{key:"createFence",value:function(){for(var t=this.size/2,i=-t;i<=t;i+=2)this.addCrate(new e.Vector3(i,1,-t)),this.addCrate(new e.Vector3(i,1,t));for(var n=2-t;n<t;n+=2)this.addCrate(new e.Vector3(-t,1,n)),this.addCrate(new e.Vector3(t,1,n));this.crateInstancedMesh.instanceMatrix.needsUpdate=!0}},{key:"createMap",value:function(){var t=this,i=this.obstaclesLevel,n=this.size/i,r=this.size/2;this.spawnPoints=[{box:new e.Box3(new e.Vector3(-r,0,-r),new e.Vector3(1.25*n-r,1.25*n,1.25*n-r)),position:new e.Vector3(-25,.5,-25),rotation:-3*Math.PI/4},{box:new e.Box3(new e.Vector3(r-1.25*n,0,r-1.25*n),new e.Vector3(r,1.25*n,r)),position:new e.Vector3(25,.5,25),rotation:Math.PI/4},{box:new e.Box3(new e.Vector3(-r,0,r-1.25*n),new e.Vector3(1.25*n-r,1.25*n,r)),position:new e.Vector3(-25,.5,25),rotation:3*Math.PI/4},{box:new e.Box3(new e.Vector3(r-1.25*n,0,-r),new e.Vector3(r,1.25*n,1.25*n-r)),position:new e.Vector3(25,.5,-25),rotation:-Math.PI/4}];for(var o=[],s=0;s<i;s++)for(var a=function(){if(Math.random()<.7){var r=(s-i/2+.5)*n,a=(h-i/2+.5)*n,c=new e.Vector3(r,1,a);if(!t.spawnPoints.some((function(t){return t.box.containsPoint(c)}))){var l=Math.random()<.3?2*t.crateResolution:t.crateResolution;o.push({position:c,height:l,isDirty:!1,inactiveCubes:[]})}}},h=0;h<i;h++)a();this.obstacles=j({},k.objectId,{id:k.objectId,options:{size:this.crateSize,resolution:this.crateResolution,basicCount:50,crates:o}}),this.map=O(O({},this.map),{},{spawnPoints:this.spawnPoints,obstacles:this.obstacles,obstaclesLevel:this.obstaclesLevel,size:this.size})}},{key:"getMap",value:function(){var t=this,e=this.map;return e.obstacles[k.objectId].options.crates=e.obstacles[k.objectId].options.crates.map((function(e,i){var n=t.crates[i];return O(O({},e),{},{isDirty:n.isDirty,inactiveCubes:n.cubes.filter((function(t){return!t.active})).map((function(t){return t.index}))})})),e}},{key:"createObstacles",value:function(){var t,e=this.obstacles[k.objectId].options,i=new T(this.scene,this.game,e.size,e.resolution,e.basicCount);(t=this.crates).push.apply(t,function(t){return function(t){if(Array.isArray(t))return V(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(t){if("string"==typeof t)return V(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?V(t,e):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}(i.produceCrates(e.crates)))}},{key:"removeCrate",value:function(t){var e=this.crates.indexOf(t);-1!=e&&this.crates.splice(e,1)}},{key:"update",value:function(){}},{key:"getSpawnPoints",value:function(){return this.spawnPoints.map((function(t){return{position:t.position.clone(),rotation:t.rotation}}))}}],[{key:"fromMap",value:function(e,i,n){return new t(e,i,n.size,n.obstaclesLevel,n)}}])}();function B(t){return B="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},B(t)}function E(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,F(n.key),n)}}function F(t){var e=function(t,e){if("object"!=B(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=B(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==B(e)?e:e+""}var R=function(){return function(t,e,i){return e&&E(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(e,i,n,r,o){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.scene=e,this.position=i,this.radius=n,this.duration=1,this.elapsedTime=0,this.game=r,this.owner=o,this.createExplosionCore(),this.createShockwave()}),[{key:"createExplosionCore",value:function(){var t=new e.SphereGeometry(this.radius/3,32,32),i=new e.MeshPhongMaterial({color:16724736,emissive:16742144,transparent:!0,opacity:.9});this.core=new e.Mesh(t,i),this.core.position.copy(this.position),this.scene.add(this.core)}},{key:"createShockwave",value:function(){var t=new e.SphereGeometry(this.radius/3,32,32),i=new e.MeshBasicMaterial({color:16750848,transparent:!0,opacity:.7,side:e.DoubleSide});this.shockwave=new e.Mesh(t,i),this.shockwave.position.copy(this.position),this.shockwave.rotation.x=Math.PI/2,this.scene.add(this.shockwave)}},{key:"update",value:function(t){this.elapsedTime+=t;var e=this.elapsedTime/this.duration;if(e>=1)return this.remove(),!1;var i=1+.5*e;this.core.scale.set(i,i,i),this.core.material.opacity=.9*(1-e);var n=1+2*e;return this.shockwave.scale.set(n,n,n),this.shockwave.material.opacity=.7*(1-e),!0}},{key:"remove",value:function(){this.scene.remove(this.core),this.scene.remove(this.shockwave),this.scene.remove(this.particles),this.scene.remove(this.light)}}])}();const _=R;function U(t){return U="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},U(t)}function G(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,q(n.key),n)}}function q(t){var e=function(t,e){if("object"!=U(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=U(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==U(e)?e:e+""}var L=function(){return function(t,e,i){return e&&G(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(e,i,n){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.scene=e,this.particleCount=n,this.isFadingOut=!1,this.fadeOutDuration=1,this.fadeOutTimer=0,this.activeParticles=0,this.setupParticles(i)}),[{key:"setupParticles",value:function(t){this.particles=new e.BufferGeometry,this.particlePositions=new Float32Array(3*this.particleCount),this.particleOpacities=new Float32Array(this.particleCount),this.particleSizes=new Float32Array(this.particleCount),this.particleColors=new Float32Array(3*this.particleCount);for(var i=0;i<this.particleCount;i++)this.particlePositions[3*i]=t.x,this.particlePositions[3*i+1]=t.y,this.particlePositions[3*i+2]=t.z,this.particleOpacities[i]=0,this.particleSizes[i]=0,this.particleColors[3*i]=.7,this.particleColors[3*i+1]=.7,this.particleColors[3*i+2]=.7;this.particles.setAttribute("position",new e.BufferAttribute(this.particlePositions,3)),this.particles.setAttribute("opacity",new e.BufferAttribute(this.particleOpacities,1)),this.particles.setAttribute("size",new e.BufferAttribute(this.particleSizes,1)),this.particles.setAttribute("color",new e.BufferAttribute(this.particleColors,3)),this.particleMaterial=new e.PointsMaterial({size:.2,transparent:!0,blending:e.AdditiveBlending,depthWrite:!1,vertexColors:!0,sizeAttenuation:!0}),this.particleSystem=new e.Points(this.particles,this.particleMaterial),this.scene.add(this.particleSystem)}},{key:"update",value:function(t,e,i){this.isFadingOut?this.updateFadeOut(t):this.updateActiveParticles(t,e,i),this.particles.attributes.position.needsUpdate=!0,this.particles.attributes.opacity.needsUpdate=!0,this.particles.attributes.size.needsUpdate=!0,this.particles.attributes.color.needsUpdate=!0}},{key:"updateActiveParticles",value:function(t,i,n){var r=(new e.Vector3).subVectors(i,n).divideScalar(t).length();this.activeParticles=Math.min(this.activeParticles+2,this.particleCount);for(var o=this.activeParticles-1;o>0;o--){this.particlePositions[3*o]=this.particlePositions[3*(o-1)],this.particlePositions[3*o+1]=this.particlePositions[3*(o-1)+1],this.particlePositions[3*o+2]=this.particlePositions[3*(o-1)+2],this.particleOpacities[o]=.95*this.particleOpacities[o-1],this.particleSizes[o]=.95*this.particleSizes[o-1];var s=1-o/this.activeParticles;this.particleColors[3*o]=.7*s,this.particleColors[3*o+1]=.7*s,this.particleColors[3*o+2]=.7*s}this.particlePositions[0]=i.x,this.particlePositions[1]=i.y,this.particlePositions[2]=i.z,this.particleOpacities[0]=Math.min(r/5,1),this.particleSizes[0]=Math.min(r/2,.4);for(var a=1;a<this.activeParticles;a++)Math.random()<.2&&(this.particlePositions[3*a]+=.15*(Math.random()-.5),this.particlePositions[3*a+1]+=.15*(Math.random()-.5),this.particlePositions[3*a+2]+=.15*(Math.random()-.5));for(var h=0;h<this.activeParticles;h++){var c=Math.pow(1-h/this.activeParticles,.5);this.particleOpacities[h]*=c}for(var l=this.activeParticles;l<this.particleCount;l++)this.particleOpacities[l]=0,this.particleSizes[l]=0}},{key:"updateFadeOut",value:function(t){this.fadeOutTimer+=t;var e=this.fadeOutTimer/this.fadeOutDuration;if(e>=1)this.scene.remove(this.particleSystem);else{var i=1-e;this.particleMaterial.opacity=i}}},{key:"remove",value:function(){this.scene.remove(this.particleSystem)}},{key:"startFadeOut",value:function(){this.isFadingOut=!0}}])}();const W=L;var N=function(t,e){var i=t.find((function(t){return(t.bi.id===e||t.bj.id===e)&&(t.bi.collisionFilterGroup&t.bj.collisionFilterMask)===t.bi.collisionFilterGroup&&(t.bj.collisionFilterGroup&t.bi.collisionFilterMask)===t.bj.collisionFilterGroup}));return i?{contact:i,target:i.bi.id==e?i.bi:i.bj,body:i.bi.id==e?i.bj:i.bi}:null};function Q(t){return Q="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Q(t)}function H(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Y(n.key),n)}}function Y(t){var e=function(t,e){if("object"!=Q(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=Q(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==Q(e)?e:e+""}var $=function(){return function(t,e,i){return e&&H(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(n,r,o,s,a,h,c,l){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.scene=n,this.world=r,this.game=c,this.isDestroyed=!1,this.initialVelocity=a,this.velocityFactor=h,this.owner=l;var u=new e.SphereGeometry(.2,16,16),p=new e.MeshPhongMaterial({color:16711680});this.mesh=new e.Mesh(u,p),this.mesh.position.copy(o),this.scene.add(this.mesh);var y=new i.Sphere(.2);this.body=new i.Body({mass:5,shape:y,position:new i.Vec3(o.x,o.y,o.z),velocity:new i.Vec3(s.x*a,s.y*a,s.z*a)}),this.body.force.set(0,-9.82*this.body.mass,0),this.world.addBody(this.body),this.particleCount=50,this.game.headless||(this.particleSystem=new W(n,o,this.particleCount)),this.previousPosition=o.clone()}),[{key:"onCollide",value:function(t){if(!this.isDestroyed){if(t.body.isCrate&&(this.game.isSinglePlayer||this.game.headless)){var e=new i.Vec3;t.body.pointToLocalFrame(t.contact.bj.position.clone().vadd(t.contact.rj),e);var n=this.game.battleMap.crates.find((function(e){return e.body===t.body}));this.game.damageCrate(this.mesh.position,e,1,n)}this.explode(1.5)}}},{key:"explode",value:function(t){var e=this;if(!this.isDestroyed){this.isDestroyed=!0;var n=new _(this.scene,this.mesh.position,t,this.game,this.owner);this.game.addExplosion(n);var r=(new i.Vec3).copy(this.body.position);(this.game.isSinglePlayer||this.game.headless)&&this.game.tanks.forEach((function(i){var n=i.body.position,o=r.distanceTo(n);if(o<=2*t||i.isPointInsideTank(r)){var s=e.calculateDamage(o,t);e.game.damageTank(s,i,t,e.mesh.position,e.owner)}})),this.game.headless||this.particleSystem.startFadeOut(),this.remove()}}},{key:"update",value:function(t){this.mesh.position.copy(this.body.position),this.mesh.quaternion.copy(this.body.quaternion),this.game.headless||this.particleSystem.update(t,this.mesh.position,this.previousPosition),this.previousPosition.copy(this.mesh.position);var e=N(this.world.contacts,this.body.id);e&&this.onCollide(e)}},{key:"calculateDamage",value:function(t,e){var i=this.velocityFactor;if(0===t)return Math.round(25+20*i);var n=1-t/(2*e);return console.log("Deal ".concat(Math.round(25*n+20*i)," damage. Velocity bonus: ").concat(20*i)),Math.round(25*n+20*i)}},{key:"remove",value:function(){this.scene.remove(this.mesh),this.world.removeBody(this.body),this.game.headless||this.triggerParticles()}},{key:"triggerParticles",value:function(){this.particleSystem.startFadeOut(),this.game.addFadingParticleSystem(this.particleSystem)}},{key:"createDestroyedTankEffect",value:function(t,e){this.game.createDestroyedTankEffect(t,this.mesh.position,e)}},{key:"createDestroyedCrateEffect",value:function(t,e,i){this.game.createDestroyedCrateEffect(t,e,this.mesh.position,i)}}])}();const J=$;function K(t){return K="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},K(t)}function X(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Z(n.key),n)}}function Z(t){var e=function(t,e){if("object"!=K(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=K(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==K(e)?e:e+""}i.Quaternion.prototype.slerp=function(t,e){if(0===e)return this;if(1===e)return this.copy(t);var i=this._x,n=this._y,r=this._z,o=this._w,s=o*t._w+i*t._x+n*t._y+r*t._z;if(s<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,s=-s):this.copy(t),s>=1)return this._w=o,this._x=i,this._y=n,this._z=r,this;var a=1-s*s;if(a<=Number.EPSILON){var h=1-e;return this._w=h*o+e*this._w,this._x=h*i+e*this._x,this._y=h*n+e*this._y,this._z=h*r+e*this._z,this.normalize(),this}var c=Math.sqrt(a),l=Math.atan2(c,s),u=Math.sin((1-e)*l)/c,p=Math.sin(e*l)/c;return this._w=o*u+this._w*p,this._x=i*u+this._x*p,this._y=n*u+this._y*p,this._z=r*u+this._z*p,this};var tt=function(){return function(t,e,i){return e&&X(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(n,r,o,s,a,h){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.id=o.generateTankId(),this.scene=n,this.world=r,this.game=o,this.color=s,this.position=a,this.rotation=h,this.scale=1.5,this.health=100,this.maxHealth=100,this.moveDirection=0,this.rotateDirection=0,this.turnSpeed=.75,this.currentSpeed=0,this.currentTurnSpeed=0,this.maxSpeed=30,this.acceleration=60,this.deceleration=60,this.turnAcceleration=2,this.turnDeceleration=3,this.isDestroyed=!1,this.barrelPivot=null,this.barrelAngle=0,this.barrelRotationSpeed=.1,this.maxRotationPerFrame=Math.PI/30,this.indirectBarrelMinAngle=Math.PI/9,this.indirectBarrelMaxAngle=Math.PI/4,this.indirectFireInitialAngle=this.indirectBarrelMaxAngle-this.indirectBarrelMinAngle/2,this.directBarrelMinAngle=-Math.PI/24,this.directBarrelMaxAngle=0,this.directFireInitialAngle=this.directBarrelMaxAngle,this.barrelMaxAngle=this.directBarrelMaxAngle,this.barrelMinAngle=this.directBarrelMinAngle,this.turretRotation=0,this.turretRotationSpeed=.1,this.minShotVelocityDirect=10,this.maxShotVelocityDirect=60,this.minShotVelocityIndirect=5,this.maxShotVelocityIndirect=25,this.shotVelocity=this.minShotVelocityDirect,this.minShotVelocity=this.minShotVelocityDirect,this.maxShotVelocity=this.maxShotVelocityDirect,this.targetTurretAngle=0,this.targetBarrelAngle=0,this.isIndirectFireMode=!1,this.barrelTransitionSpeed=70,this.isChangingMode=!1,this.scale=1.5,this.isTransitioning=!1,this.transitionProgress=0,this.transitionDuration=500,this.originalDimensions=new e.Vector3(1,.5,2),this.squareDimensions=new e.Vector3(1.5,.5,1.5),this.isAcceleratingShot=!1,this.serverState={position:new i.Vec3(0,0,0),quaternion:new i.Quaternion(0,0,0),velocity:new i.Vec3(0,0,0),angularVelocity:new i.Vec3(0,0,0),targetBarrelAngle:null,targetTurretAngle:null,shotVelocity:null,isIndirectFireMode:null,isTransitioning:null,isAcceleratingShot:null},this.lastUpdateTime=null,this.serverUpdateDelta=0,this.interpolationTime=50,this.createMesh(),this.createPhysicsBody()}),[{key:"getStateData",value:function(){return{shotVelocity:this.shotVelocity,isIndirectFireMode:this.isIndirectFireMode,isAcceleratingShot:this.isAcceleratingShot,isTransitioning:this.isTransitioning,targetBarrelAngle:this.targetBarrelAngle,targetTurretAngle:this.targetTurretAngle,position:this.body.position,quaternion:this.body.quaternion,velocity:this.body.velocity,angularVelocity:this.body.angularVelocity,isDestroyed:this.isDestroyed}}},{key:"startTransition",value:function(t){t!=this.isIndirectFireMode&&(this.isTransitioning||(this.isTransitioning=!0,this.transitionProgress=0,this.isIndirectFireMode=t))}},{key:"setIndirectFireMode",value:function(t){this.isIndirectFireMode=t,this.isChangingMode=!0,t?(this.shotVelocity=this.minShotVelocityIndirect,this.minShotVelocity=this.minShotVelocityIndirect,this.maxShotVelocity=this.maxShotVelocityIndirect,this.barrelMinAngle=this.indirectBarrelMinAngle,this.barrelMaxAngle=this.indirectBarrelMaxAngle,this.targetBarrelAngle=this.indirectFireInitialAngle):(this.barrelMinAngle=this.directBarrelMinAngle,this.barrelMaxAngle=this.directBarrelMaxAngle,this.targetBarrelAngle=this.directFireInitialAngle,this.shotVelocity=this.minShotVelocityDirect,this.minShotVelocity=this.minShotVelocityDirect,this.maxShotVelocity=this.maxShotVelocityDirect)}},{key:"rotateTurretLeft",value:function(t){this.turretRotation+=this.turretRotationSpeed,this.updateTurretRotation(t)}},{key:"rotateTurretRight",value:function(t){this.turretRotation-=this.turretRotationSpeed,this.updateTurretRotation(t)}},{key:"takeDamage",value:function(t,e){this.health=Math.max(0,this.health-t),console.log("Tank took ".concat(t," damage from ").concat(e.id,". Current health: ").concat(this.health))}},{key:"updateServerState",value:function(t,e){this.serverState.position.copy(t.position),this.serverState.quaternion.copy(t.quaternion),this.serverState.velocity.copy(t.velocity),this.serverState.angularVelocity.copy(t.angularVelocity),this.serverState.targetBarrelAngle=t.targetBarrelAngle,this.serverState.targetTurretAngle=t.targetTurretAngle,this.serverState.shotVelocity=t.shotVelocity,this.serverState.isIndirectFireMode=t.isIndirectFireMode,this.serverState.isTransitioning=t.isTransitioning,this.serverState.isAcceleratingShot=t.isAcceleratingShot,this.serverState.isDestroyed=t.isDestroyed,this.lastUpdateTime=e}},{key:"interpolate",value:function(t){var e=t-this.lastUpdateTime,i=Math.min(e/this.interpolationTime,1);this.serverState.isDestroyed||(this.body.position.lerp(this.serverState.position,i,this.body.position),this.body.quaternion.slerp(this.serverState.quaternion,i)),this.body.velocity.copy(this.serverState.velocity),this.body.angularVelocity.copy(this.serverState.angularVelocity),this.targetBarrelAngle=this.serverState.targetBarrelAngle,this.targetTurretAngle=this.serverState.targetTurretAngle,this.serverState.isTransitioning!=this.isTransitioning&&this.startTransition(this.serverState.isIndirectFireMode),this.isTransitioning||this.serverState.isIndirectFireMode==this.isIndirectFireMode||this.setIndirectFireMode(this.serverState.isIndirectFireMode),this.isDestroyed=this.serverState.isDestroyed,this.isAcceleratingShot=this.serverState.isAcceleratingShot,this.shotVelocity=this.serverState.shotVelocity}},{key:"extrapolate",value:function(t){var e=(t-this.lastUpdateTime)/1e3,n=new i.Vec3;n.copy(this.serverState.position),n.vadd(this.serverState.velocity.scale(e),n),this.body.position.copy(n);var r=new i.Quaternion,o=this.serverState.angularVelocity.length();if(o>0){var s=this.serverState.angularVelocity.unit(),a=o*e;r.setFromAxisAngle(s,a),r.mult(this.serverState.quaternion,r)}else r.copy(this.serverState.quaternion);this.body.quaternion.copy(r),this.body.velocity.copy(this.serverState.velocity),this.body.angularVelocity.copy(this.serverState.angularVelocity),this.targetBarrelAngle=this.serverState.targetBarrelAngle,this.targetTurretAngle=this.serverState.targetTurretAngle,this.targetBarrelAngle=this.serverState.targetBarrelAngle,this.targetTurretAngle=this.serverState.targetTurretAngle,this.serverState.isTransitioning!=this.isTransitioning&&this.startTransition(this.serverState.isIndirectFireMode),this.isTransitioning||this.serverState.isIndirectFireMode==this.isIndirectFireMode||this.setIndirectFireMode(this.serverState.isIndirectFireMode),this.serverState.isAcceleratingShot=this.isAcceleratingShot,this.serverState.shotVelocity=this.shotVelocity}},{key:"updateTurretRotation",value:function(t){var e=this.targetTurretAngle-this.turretRotation;e>Math.PI&&(e-=2*Math.PI),e<-Math.PI&&(e+=2*Math.PI);var i=this.maxRotationPerFrame*(t/16.67),n=Math.sign(e)*Math.min(Math.abs(e),i);for(this.turretRotation+=n;this.turretRotation>Math.PI;)this.turretRotation-=2*Math.PI;for(;this.turretRotation<-Math.PI;)this.turretRotation+=2*Math.PI;this.turret.rotation.y=this.turretRotation}},{key:"updateBarrelRotation",value:function(t){var e=this.targetBarrelAngle-this.barrelAngle;this.barrelAngle+=e*(this.barrelTransitionSpeed*(t/16.67)),this.barrelAngle=this.isChangingMode?this.barrelAngle:Math.max(this.barrelMinAngle,Math.min(this.barrelAngle,this.barrelMaxAngle)),this.barrelPivot.rotation.x=this.barrelAngle,this.isChangingMode&&Math.floor(100*this.barrelAngle)===Math.floor(100*(this.isIndirectFireMode?this.indirectFireInitialAngle:this.directFireInitialAngle))&&(this.isChangingMode=!1)}},{key:"createMesh",value:function(){var t=new e.BoxGeometry(1,.5,2),i=new e.MeshStandardMaterial({color:this.color,roughness:.1,metalness:.7});this.bodyMesh=new e.Mesh(t,i),this.bodyMesh.scale.multiplyScalar(this.scale),this.bodyMesh.castShadow=!0,this.mesh=new e.Group,this.mesh.add(this.bodyMesh),this.mesh.position.copy(this.position),this.mesh.rotation.y=this.rotation,this.mesh.rotation.order="YXZ";var n=new e.CylinderGeometry(.4*this.scale,.4*this.scale,.3*this.scale,16),r=new e.MeshStandardMaterial({color:this.color,roughness:.1,metalness:.7});this.turret=new e.Mesh(n,r),this.turret.position.set(0,.4*this.scale,0),this.turret.castShadow=!0,this.mesh.add(this.turret);var o=new e.CylinderGeometry(.1*this.scale,.1*this.scale,1.5*this.scale,8),s=new e.MeshStandardMaterial({color:6710886,roughness:.1,metalness:.7}),a=new e.Mesh(o,s);a.castShadow=!0,this.barrelPivot=new e.Object3D,this.barrelPivot.position.set(0,.15*this.scale,0),a.position.set(0,0,-.75*this.scale),a.rotation.x=-Math.PI/2,this.barrelPivot.add(a),this.turret.add(this.barrelPivot),this.scene.add(this.mesh)}},{key:"createPhysicsBody",value:function(){var t=new i.Box(new i.Vec3(this.originalDimensions.x*this.scale/2,this.originalDimensions.y*this.scale/2,this.originalDimensions.z*this.scale/2));this.body=new i.Body({mass:1e3*this.scale,material:new i.Material({friction:1.5,restitution:.3}),collisionFilterGroup:1,collisionFilterMask:3}),this.body.addShape(t),this.body.position.copy(this.position),this.body.quaternion.setFromEuler(0,this.rotation,0),this.body.linearDamping=.5,this.body.angularDamping=.9,this.body.fixedRotation=!0,this.body.updateMassProperties(),this.world.addBody(this.body)}},{key:"setOriginalBodyState",value:function(){this.bodyMesh.scale.set(this.scale,this.scale,this.scale);var t=new i.Vec3(this.originalDimensions.x*this.scale/2,this.originalDimensions.y*this.scale/2,this.originalDimensions.z*this.scale/2);this.body.shapes[0].halfExtents=t,this.body.shapes[0].updateConvexPolyhedronRepresentation(),this.body.updateBoundingRadius()}},{key:"setSquareBodyState",value:function(){this.bodyMesh.scale.set(this.scale,this.scale,this.scale);var t=new i.Vec3(this.squareDimensions.x*this.scale/2,this.squareDimensions.y*this.scale/2,this.squareDimensions.z*this.scale/2);this.body.shapes[0].halfExtents=t,this.body.shapes[0].updateConvexPolyhedronRepresentation(),this.body.updateBoundingRadius()}},{key:"updateTransition",value:function(t){this.transitionProgress+=1e3*t;var n=Math.min(this.transitionProgress/this.transitionDuration,1),r=new e.Vector3;r.lerpVectors(this.originalDimensions,this.squareDimensions,this.isIndirectFireMode?n:1-n),this.bodyMesh.scale.set(r.x/this.originalDimensions.x*this.scale,this.scale,r.z/this.originalDimensions.z*this.scale),this.turret.position.y=this.bodyMesh.scale.y/2;var o=new i.Vec3(r.x*this.scale/2,this.originalDimensions.y*this.scale/2,r.z*this.scale/2);this.body.shapes[0].halfExtents=o,this.body.shapes[0].updateConvexPolyhedronRepresentation(),this.body.updateBoundingRadius(),1===n&&(this.setIndirectFireMode(this.isIndirectFireMode),this.isTransitioning=!1)}},{key:"heal",value:function(t){this.health=Math.min(this.health+t,this.maxHealth),console.log("Tank healed for ".concat(t,". Current health: ").concat(this.health))}},{key:"update",value:function(t){if(this.isTransitioning&&this.updateTransition(t),this.isAcceleratingShot){var e=(this.maxShotVelocity-this.minShotVelocity)/2*t;this.shotVelocity=Math.min(this.shotVelocity+e,this.maxShotVelocity)}var i=Date.now();this.lastUpdateTime&&(this.lastUpdateTime,this.interpolationTime,this.interpolate(i)),this.mesh.position.copy(this.body.position),this.mesh.quaternion.copy(this.body.quaternion);var n=this.targetTurretAngle-this.turretRotation;n>Math.PI&&(n-=2*Math.PI),n<-Math.PI&&(n+=2*Math.PI),this.turretRotation+=.1*n,this.turretRotation=(this.turretRotation+Math.PI)%(2*Math.PI)-Math.PI,this.setMoveSpeed(t),this.setRotateSpeed(t),this.applyMovement(t),this.updateTurretRotation(t),this.updateBarrelRotation(t)}},{key:"applyMovement",value:function(t){if(!this.isTransitioning&&!this.isIndirectFireMode){var e=new i.Vec3(0,0,-1),n=new i.Vec3(0,0,0);this.body.vectorToWorldFrame(e,n),n.y=0,n.normalize();var r=n.scale(this.currentSpeed);r.y=this.body.velocity.y,this.body.velocity.copy(r),this.body.angularVelocity.set(0,-this.currentTurnSpeed,0)}}},{key:"applyState",value:function(t){this.body.position.copy(t.position),this.body.quaternion.copy(t.quaternion),this.body.angularVelocity.copy(t.angularVelocity),this.body.velocity.copy(t.velocity),this.turretRotation=t.turretRotation,this.turret.rotation.y=t.turretRotation,this.targetTurretAngle=t.turretRotation,this.barrelAngle=t.barrelAngle,this.barrelPivot.rotation.x=t.barrelAngle,this.targetBarrelAngle=t.barrelAngle,this.isIndirectFireMode=t.isIndirectFireMode,t.isIndirectFireMode?this.setSquareBodyState():this.setOriginalBodyState(),this.isAcceleratingShot=t.isAcceleratingShot,this.shotVelocity=t.shotVelocity,this.isDestroyed=t.isDestroyed,this.health=t.hp,this.mesh.visible=t.visible}},{key:"move",value:function(t){this.isIndirectFireMode||(this.moveDirection=t)}},{key:"setMoveSpeed",value:function(t){var e=Math.sign(this.moveDirection)*this.maxSpeed;if(0!==Math.sign(this.moveDirection)){var i=this.acceleration*t;this.currentSpeed=Math.sign(e-this.currentSpeed)*Math.min(Math.abs(e-this.currentSpeed),i)+this.currentSpeed}else{var n=this.deceleration*t;Math.abs(this.currentSpeed)<=n?this.currentSpeed=0:this.currentSpeed-=Math.sign(this.currentSpeed)*n}}},{key:"rotate",value:function(t){this.isIndirectFireMode||(this.rotateDirection=t)}},{key:"setRotateSpeed",value:function(t){var e=Math.sign(this.rotateDirection)*this.turnSpeed;if(0!==Math.sign(this.rotateDirection)){var i=this.turnAcceleration*t;this.currentTurnSpeed=Math.sign(e-this.currentTurnSpeed)*Math.min(Math.abs(e-this.currentTurnSpeed),i)+this.currentTurnSpeed}else{var n=this.turnDeceleration*t;Math.abs(this.currentTurnSpeed)<=n?this.currentTurnSpeed=0:this.currentTurnSpeed-=Math.sign(this.currentTurnSpeed)*n}}},{key:"accelerateShotVelocity",value:function(){this.isDestroyed||(this.isAcceleratingShot=!0)}},{key:"stopAccelarateShotVelocity",value:function(){this.isDestroyed||(this.isAcceleratingShot=!1)}},{key:"setTargetTurretAngle",value:function(t){var i=new e.Vector3;this.mesh.getWorldPosition(i);var n=this.mesh.quaternion,r=(new e.Vector3).subVectors(t,i);r.y=0;var o=new e.Vector3(0,0,-1).applyQuaternion(n);o.y=0,o.normalize();var s=Math.atan2(o.x*r.z-o.z*r.x,o.x*r.x+o.z*r.z);this.targetTurretAngle=-s}},{key:"setTargetAngles",value:function(t){this.setTargetTurretAngle(t),this.isChangingMode||(this.targetBarrelAngle=this.barrelMinAngle,this.isIndirectFireMode?this.targetBarrelAngle=this.barrelMinAngle:this.targetBarrelAngle=this.barrelMaxAngle)}},{key:"setBarrelTargetAngle",value:function(t){this.isChangingMode||(this.targetBarrelAngle=t)}},{key:"getBarrelEndPosition",value:function(t){var i=new e.Matrix4;this.barrelPivot.updateMatrixWorld(),i.copy(this.barrelPivot.matrixWorld),t.set(0,0,-1.5*this.scale),t.applyMatrix4(i)}},{key:"getShootDirection",value:function(t){t.set(0,0,-1),t.applyQuaternion(this.mesh.quaternion),t.applyQuaternion(this.turret.quaternion),t.applyAxisAngle(new e.Vector3(1,0,0),this.barrelAngle),t.normalize()}},{key:"isPointInsideTank",value:function(t){var e=this.body.shapes[0].halfExtents,i=this.body.pointToLocalFrame(t);return Math.abs(i.x)<=e.x&&Math.abs(i.y)<=e.y&&Math.abs(i.z)<=e.z}},{key:"remove",value:function(){this.isDestroyed=!0,this.isAcceleratingShot=!1,this.mesh.visible=!1,this.body.collisionResponse=!1,this.world.removeBody(this.body)}},{key:"getBarrelTipPosition",value:function(){var t=(new e.Matrix4).makeRotationFromQuaternion(this.mesh.quaternion);t.setPosition(this.mesh.position);var i=(new e.Matrix4).makeRotationY(this.turretRotation);i.setPosition(new e.Vector3(0,.4*this.scale,0));var n=(new e.Matrix4).makeRotationX(this.barrelAngle);n.setPosition(new e.Vector3(0,.15*this.scale,0));var r=(new e.Matrix4).multiplyMatrices(t,i);r.multiply(n);var o=new e.Vector3(0,0,-1.5*this.scale);return o.applyMatrix4(r),o}},{key:"hackShoot",value:function(t){this.shotVelocity=t,this.shoot()}},{key:"calculateVelocity",value:function(t){var e,i=this.barrelAngle,n=this.getBarrelTipPosition(),r=t.x-n.x,o=t.z-n.z,s=Math.sqrt(r*r+o*o),a=t.y-n.y;return e=a>=0?Math.sqrt(9.82*s*s/(2*(a+s*Math.tan(i))*Math.cos(i)*Math.cos(i))):Math.sqrt(9.82*s*s/(2*Math.cos(i)*Math.cos(i)*(s*Math.tan(i)-a))),!isNaN(e)&&isFinite(e)||(e=Math.sqrt(19.64*Math.abs(a)+s*s/(2*Math.cos(i)*Math.cos(i)))),Math.max(Math.min(e,this.maxShotVelocity))}},{key:"calculateTrajectory",value:function(t,i){var n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=this.getBarrelTipPosition(),o=this.barrelAngle,s=Math.abs(9.82),a=t.x-r.x,h=t.z-r.z,c=Math.sqrt(a*a+h*h),l=c/(i*Math.cos(o)),u=r.y+i*l*Math.sin(o)-.5*s*l*l;if(n&&Math.abs(u-t.y)>.5)return null;for(var p=[],y=l/100,d=0;d<=100;d++){var f=d*y,v=r.x+a/c*i*Math.cos(o)*f,m=r.z+h/c*i*Math.cos(o)*f,b=r.y+i*Math.sin(o)*f-.5*s*f*f;if(b<t.y)break;p.push(new e.Vector3(v,b,m))}return p}},{key:"shoot",value:function(){if(!this.isDestroyed){var t=(new e.Matrix4).makeRotationFromQuaternion(this.mesh.quaternion);t.setPosition(this.mesh.position);var i=(new e.Matrix4).makeRotationY(this.turretRotation);i.setPosition(new e.Vector3(0,.4*this.scale,0));var n=(new e.Matrix4).makeRotationX(this.barrelAngle);n.setPosition(new e.Vector3(0,.15*this.scale,0));var r=(new e.Matrix4).multiplyMatrices(t,i);r.multiply(n);var o=new e.Vector3(0,0,-1.5*this.scale);o.applyMatrix4(r);var s=new e.Vector3(0,0,-1);s.applyMatrix4(r);var a=new e.Vector3(0,0,0);s.sub(a.setFromMatrixPosition(r)).normalize();var h=this.shotVelocity;this.shotVelocity=this.minShotVelocity,this.addProjectile(o,s,h),this.shootSignal(o,s,h)}}},{key:"addProjectile",value:function(t,e,i){var n=new J(this.scene,this.world,t,e,i,i/this.maxShotVelocity,this.game,this);this.game.addProjectile(n),this.isAcceleratingShot=!1}},{key:"shootSignal",value:function(t,e,i){this.game.onAction&&this.game.onAction({gameId:this.game.id},{type:"tank_shoot",data:{barrelEnd:t,shootDirection:e,initialVelocity:i,id:this.id}})}},{key:"reset",value:function(t,e){this.mesh.position.copy(t),this.body.position.copy(t),this.mesh.rotation.y=e,this.rotation=e,this.body.quaternion.setFromEuler(0,e,0),this.body.velocity.set(0,0,0),this.body.angularVelocity.set(0,0,0),this.mesh.quaternion.set(0,0,0,1),this.resetAttributes()}},{key:"resetAttributes",value:function(){this.health=this.maxHealth,this.isDestroyed=!1,this.isAcceleratingShot=!1,this.mesh.visible=!0,this.body.collisionResponse=!0,this.shotVelocity=this.minShotVelocity,this.isIndirectFireMode=!1,this.setOriginalBodyState(),this.world.addBody(this.body)}}])}();function et(t){return et="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},et(t)}function it(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,nt(n.key),n)}}function nt(t){var e=function(t,e){if("object"!=et(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=et(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==et(e)?e:e+""}!function(t,e,i){(e=Z(e))in t?Object.defineProperty(t,e,{value:4,enumerable:!0,configurable:!0,writable:!0}):t[e]=4}(tt,"objectId");var rt=function(){return function(t,e,i){return e&&it(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.scene=e,this.createSkyBox()}),[{key:"createSkyBox",value:function(){var t={topColor:{value:new e.Color(30719)},bottomColor:{value:new e.Color(15004159)},offset:{value:33},exponent:{value:.6}},i=new e.SphereGeometry(400,32,15),n=new e.ShaderMaterial({uniforms:t,vertexShader:"\n            varying vec3 vWorldPosition;\n            void main() {\n                vec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n                vWorldPosition = worldPosition.xyz;\n                gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n            }\n        ",fragmentShader:"\n            uniform vec3 topColor;\n            uniform vec3 bottomColor;\n            uniform float offset;\n            uniform float exponent;\n            varying vec3 vWorldPosition;\n            void main() {\n                float h = normalize( vWorldPosition + offset ).y;\n                gl_FragColor = vec4( mix( bottomColor, topColor, max( pow( max( h, 0.0 ), exponent ), 0.0 ) ), 1.0 );\n            }\n        ",side:e.BackSide});this.sky=new e.Mesh(i,n),this.scene.add(this.sky)}}])}();function ot(t){return ot="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ot(t)}function st(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,at(n.key),n)}}function at(t){var e=function(t,e){if("object"!=ot(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=ot(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==ot(e)?e:e+""}var ht=function(){return function(t,e,i){return e&&st(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.content=[],this.scoreFunction=e}),[{key:"push",value:function(t){this.content.push(t),this.bubbleUp(this.content.length-1)}},{key:"pop",value:function(){var t=this.content[0],e=this.content.pop();return this.content.length>0&&(this.content[0]=e,this.sinkDown(0)),t}},{key:"remove",value:function(t){for(var e=this.content.length,i=0;i<e;i++)if(this.content[i]===t){var n=this.content.pop();if(i===e-1)break;this.content[i]=n,this.bubbleUp(i),this.sinkDown(i);break}}},{key:"size",value:function(){return this.content.length}},{key:"isEmpty",value:function(){return 0===this.content.length}},{key:"bubbleUp",value:function(t){for(var e=this.content[t],i=this.scoreFunction(e);t>0;){var n=Math.floor((t+1)/2)-1,r=this.content[n];if(i>=this.scoreFunction(r))break;this.content[n]=e,this.content[t]=r,t=n}}},{key:"sinkDown",value:function(t){for(var e=this.content.length,i=this.content[t],n=this.scoreFunction(i);;){var r=2*(t+1),o=r-1,s=null,a=void 0;if(o<e){var h=this.content[o];(a=this.scoreFunction(h))<n&&(s=o)}if(r<e){var c=this.content[r];this.scoreFunction(c)<(null===s?n:a)&&(s=r)}if(null===s)break;this.content[t]=this.content[s],this.content[s]=i,t=s}}}])}();function ct(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=function(t,e){if(t){if("string"==typeof t)return lt(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?lt(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0,r=function(){};return{s:r,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return s=t.done,t},e:function(t){a=!0,o=t},f:function(){try{s||null==i.return||i.return()}finally{if(a)throw o}}}}function lt(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function ut(t){return ut="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},ut(t)}function pt(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function yt(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,ft(n.key),n)}}function dt(t,e,i){return e&&yt(t.prototype,e),i&&yt(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}function ft(t){var e=function(t,e){if("object"!=ut(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=ut(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==ut(e)?e:e+""}var vt,mt,bt=function(){return dt((function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;pt(this,t),this.position=e,this.g=i,this.h=n,this.f=i+n,this.parent=null}),[{key:"getPositionKey",value:function(){return"".concat(this.position.x,",").concat(this.position.y)}}])}(),gt=function(){return dt((function t(e,i){pt(this,t),this.game=e,this.tank=i,this.target=null,this.state="search",this.lastFireTime=0,this.lastIndirectFireTime=0,this.fireCooldown=2,this.indirectFireCooldown=10,this.directFireAccuracy=.4,this.indirectFireAccuracy=.3,this.currentPath=[],this.currentTargetAngle=null,this.debugPath=null,this.nextPoint=null,this.obstacleGrid=this.createObstacleGrid(),this.lastPathfindingPosition=null,this.pathfindingThreshold=1,this.lastNoPathDeadline=null,this.noPathCooldown=1,this.isShooting=!1,this.tank.deceleration=3e3,this.tank.turnDeceleration=60,this.tank.acceleration=60}),[{key:"createDebugGrid",value:function(){var t=this;if(!this.game.headless){this.debugGrid&&this.game.scene.remove(this.debugGrid),this.obstacleMarkers&&this.obstacleMarkers.forEach((function(e){return t.game.scene.remove(e)}));for(var i=this.game.battleMap.size,n=new e.BufferGeometry,r=new e.LineBasicMaterial({color:16777215,transparent:!0,opacity:.3}),o=[],s=-i/2;s<=i/2;s+=1)o.push(new e.Vector3(s,.1,-i/2)),o.push(new e.Vector3(s,.1,i/2));for(var a=-i/2;a<=i/2;a+=1)o.push(new e.Vector3(-i/2,.1,a)),o.push(new e.Vector3(i/2,.1,a));n.setFromPoints(o),this.debugGrid=new e.LineSegments(n,r),this.game.scene.add(this.debugGrid),this.obstacleMarkers=[];for(var h=new e.MeshBasicMaterial({color:16711680,transparent:!0,opacity:.5}),c=0;c<this.obstacleGrid.length;c++)for(var l=0;l<this.obstacleGrid[0].length;l++)if(this.obstacleGrid[c][l]){var u=new e.PlaneGeometry(1,1),p=new e.Mesh(u,h);p.rotation.x=-Math.PI/2,p.position.set(1*c-i/2+.5,.11,1*l-i/2+.5),this.game.scene.add(p),this.obstacleMarkers.push(p)}}}},{key:"update",value:function(t){if(this.tank.isDestroyed)return this.state="idle",void(this.isShooting=!1);switch(this.updateState(),this.state){case"search":this.search(t);break;case"siege":this.siege(t);break;case"attack":this.attack(t)}}},{key:"updateState",value:function(){var t=this,e=this.game.tanks.filter((function(e){return e!==t.tank&&!e.isDestroyed}));if(0!==e.length){var i=this.findNearestOpponent(e);i!==this.target?(this.target=i,this.recalculatePath(),this.isShooting=!1):this.target&&this.checkTargetMovement(),this.isShooting||(this.distanceToTarget()<=30&&this.hasLineOfSight()?this.state="attack":this.game.clock.getElapsedTime()-this.lastIndirectFireTime<this.indirectFireCooldown?this.state="search":this.state="siege")}else this.state="idle"}},{key:"recalculatePath",value:function(){var t=new e.Vector2(this.tank.mesh.position.x,this.tank.mesh.position.z),i=new e.Vector2(this.target.mesh.position.x,this.target.mesh.position.z);this.currentPath=this.findPath(t,i),this.lastPathfindingPosition=i.clone()}},{key:"checkTargetMovement",value:function(){if(this.lastPathfindingPosition){var t=new e.Vector2(this.target.mesh.position.x,this.target.mesh.position.z);this.lastPathfindingPosition.distanceTo(t)>=this.pathfindingThreshold&&this.recalculatePath()}else this.recalculatePath()}},{key:"hasLineOfSight",value:function(){var t=this.tank.body.position,e=this.target.body.position,n=e.vsub(t),r=n.length();n.normalize();var o=new i.RaycastResult,s=new i.Ray(t,e),a=this.game.battleMap.crates.map((function(t){return t.body}));return s.intersectBodies(a,o),!o.hasHit||o.distance>r}},{key:"visualizeRay",value:function(t,i,n){this.debugLine&&this.game.scene.remove(this.debugLine);var r=new e.LineBasicMaterial({color:n?65280:16711680}),o=[];o.push(new e.Vector3(t.x,t.y,t.z)),o.push(new e.Vector3(i.x,i.y,i.z));var s=(new e.BufferGeometry).setFromPoints(o);this.debugLine=new e.Line(s,r),this.game.scene.add(this.debugLine)}},{key:"search",value:function(t){this.moveTowardsTarget()}},{key:"siege",value:function(t){this.stopTank(),this.tryIndirectFire(t)}},{key:"attack",value:function(t){this.stopTank(),this.tryDirectFire(t)}},{key:"stopTank",value:function(){this.tank.move(0),this.tank.rotate(0)}},{key:"updatePathVisualization",value:function(){if(this.currentPath&&this.currentPath.length>0){var t=this.currentPath.slice();t.unshift(new e.Vector2(Math.floor((this.tank.mesh.position.x+this.game.battleMap.size/2)/2),Math.floor((this.tank.mesh.position.z+this.game.battleMap.size/2)/2))),this.visualizePath(t)}}},{key:"findPath",value:function(t,i){var n=this,r=new ht((function(t){return t.f})),o=new Set,s=new bt(new e.Vector2(1*Math.round(t.x/1),1*Math.round(t.y/1))),a=new bt(this.findNearestFreeNode(new e.Vector2(1*Math.round(i.x/1),1*Math.round(i.y/1))));s.g=0,s.h=this.manhattanDistance(s.position,a.position),s.f=s.h,r.push(s);for(var h=0,c=1/0;!r.isEmpty()&&h<1e3;){h++;var l=r.pop();if(l.position.distanceTo(a.position)<1){for(var u=[],p=l;null!=p;)u.unshift(p.position),p=p.parent;return u}if(o.add(l.getPositionKey()),l.position.distanceTo(s.position)>c)return null;var y,d=ct(this.getNeighbors(l,1));try{var f=function(){var t=y.value;if(o.has(t.getPositionKey()))return 1;var e=l.g+l.position.distanceTo(t.position);(!r.content.some((function(e){return e.position.equals(t.position)}))||e<t.g)&&(t.parent=l,t.g=e,t.h=n.manhattanDistance(t.position,a.position),t.f=t.g+t.h,r.content.some((function(e){return e.position.equals(t.position)}))||r.push(t))};for(d.s();!(y=d.n()).done;)f()}catch(t){d.e(t)}finally{d.f()}}return h>=1e3?(console.log("      "),null):null}},{key:"manhattanDistance",value:function(t,e){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}},{key:"getNeighbors",value:function(t,i){for(var n=[],r=0,o=[new e.Vector2(1,0),new e.Vector2(-1,0),new e.Vector2(0,1),new e.Vector2(0,-1),new e.Vector2(1,1),new e.Vector2(1,-1),new e.Vector2(-1,1),new e.Vector2(-1,-1)];r<o.length;r++){var s=o[r],a=new e.Vector2(t.position.x+s.x*i,t.position.y+s.y*i);this.isWalkable(a)&&n.push(new bt(a))}return n}},{key:"isWalkable",value:function(t){var e=this.game.battleMap.size,i=Math.floor((t.x+e/2)/1),n=Math.floor((t.y+e/2)/1);return!(i<0||i>=this.obstacleGrid.length||n<0||n>=this.obstacleGrid[0].length||this.obstacleGrid[i][n])}},{key:"createObstacleGrid",value:function(){var t=this.game.battleMap.size,e=Math.ceil(t/1),i=new Array(e).fill(null).map((function(){return new Array(e).fill(!1)}));return this.game.battleMap.crates.forEach((function(n){for(var r=Math.floor((n.position.x-1.3*n.size/2+t/2)/1),o=Math.ceil((n.position.x+1.3*n.size/2+t/2)/1),s=Math.floor((n.position.z-1.3*n.size/2+t/2)/1),a=Math.ceil((n.position.z+1.3*n.size/2+t/2)/1),h=r;h<o;h++)for(var c=s;c<a;c++)h>=0&&h<e&&c>=0&&c<e&&(i[h][c]=!0)})),i}},{key:"moveTowardsTarget",value:function(){if(this.target&&this.ensureDirectMode()){var t=new e.Vector2(this.tank.mesh.position.x,this.tank.mesh.position.z);if(!this.currentPath||0===this.currentPath.length){var i=this.game.clock.getElapsedTime();if(i-this.lastNoPathDeadline<this.noPathCooldown)return;if(this.recalculatePath(),this.lastNoPathDeadline=i,!this.currentPath)return void console.log("     ")}var n,r,o,s,a=this.currentPath[0];if(t.distanceTo(a)<1){if(this.currentPath.shift(),!(this.currentPath.length>0))return void this.tank.move(0);a=this.currentPath[0]}this.currentTargetAngle||(this.currentTargetAngle=(n=this.tank.mesh.position,r=new e.Vector3(a.x,0,a.y),o=(new e.Vector3).subVectors(n,r),s=new e.Vector3(o.x,0,o.z),Math.atan2(s.x,s.z)));var h=wt(this.tank.mesh.rotation.y,this.currentTargetAngle);Math.abs(h)>.05?(this.tank.rotate(-Math.sign(h)),this.tank.move(0)):(this.tank.rotate(0),this.currentTargetAngle=null,this.tank.move(1)),this.nextPoint=a}}},{key:"visualizePath",value:function(t){this.pathLine&&this.game.scene.remove(this.pathLine);var i=(new e.BufferGeometry).setFromPoints(t.map((function(t){return new e.Vector3(t.x,.2,t.y)}))),n=new e.LineBasicMaterial({color:65280});this.pathLine=new e.Line(i,n),this.game.scene.add(this.pathLine)}},{key:"onDebug",value:function(t){this.callback=t}},{key:"aimAtTarget",value:function(t){if(!this.target)return!1;if(this.tank.isTransitioning)return!1;for(var i=(new e.Vector3).subVectors(this.target.mesh.position,this.tank.mesh.position),n=Math.atan2(i.x,i.z),r=this.tank.mesh.rotation.y,o=.04*(Math.random()-.5),s=n-r-Math.PI+4*o;s>Math.PI;)s-=2*Math.PI;for(;s<-Math.PI;)s+=2*Math.PI;this.tank.targetTurretAngle=s,i.length();var a=Math.atan2(i.y,Math.sqrt(i.x*i.x+i.z*i.z));return a=Math.max(this.tank.barrelMinAngle,Math.min(a,this.tank.barrelMaxAngle)),this.tank.setBarrelTargetAngle(a),this.aimCalculatedShotVelocity=this.tank.calculateVelocity(this.target.mesh.position),this.tank.shotVelocity<this.aimCalculatedShotVelocity?this.tank.accelerateShotVelocity():this.tank.stopAccelarateShotVelocity(),a+=o,this.callback&&this.callback(Math.abs(this.tank.turretRotation-s)<.05,Math.abs(this.tank.barrelAngle-a)<.05,this.tank.shotVelocity>=this.aimCalculatedShotVelocity,this.tank.turretRotation,s),Math.abs(this.tank.turretRotation-s)<.05&&Math.abs(this.tank.barrelAngle-a)<.05&&this.tank.shotVelocity>=this.aimCalculatedShotVelocity}},{key:"ensureIndirectMode",value:function(){return!(this.tank.isTransitioning||!this.tank.isIndirectFireMode&&(this.tank.startTransition(!0),1))}},{key:"ensureDirectMode",value:function(){return!(this.tank.isTransitioning||this.tank.isIndirectFireMode&&(this.tank.startTransition(!1),1))}},{key:"tryDirectFire",value:function(t){this.isShooting=!0;var e=this.game.clock.getElapsedTime();e-this.lastFireTime<this.fireCooldown||this.ensureDirectMode()&&this.aimAtTarget(t)&&(this.tank.shoot(),this.isShooting=!1,this.lastFireTime=e)}},{key:"tryIndirectFire",value:function(t){if(this.ensureIndirectMode()){var e=this.game.clock.getElapsedTime();this.isShooting=!0,this.aimAtTarget(t)&&(this.tank.shoot(),this.isShooting=!1,this.lastIndirectFireTime=e)}}},{key:"findNearestOpponent",value:function(t){var e=this;return t.reduce((function(t,i){var n=t.mesh.position.distanceTo(e.tank.mesh.position);return i.mesh.position.distanceTo(e.tank.mesh.position)<n?i:t}))}},{key:"distanceToTarget",value:function(){return this.target?this.tank.mesh.position.distanceTo(this.target.mesh.position):1/0}},{key:"findNearestFreeNode",value:function(t){for(var i=this.game.battleMap.size,n=Math.floor((t.x+i/2)/1),r=Math.floor((t.y+i/2)/1),o=null,s=1/0,a=-5;a<=5;a++)for(var h=-5;h<=5;h++){var c=n+a,l=r+h;if(c>=0&&c<this.obstacleGrid.length&&l>=0&&l<this.obstacleGrid[0].length&&!this.obstacleGrid[c][l]){var u=new e.Vector2(1*c+.5-i/2,1*l+.5-i/2),p=u.distanceTo(t);p<s&&(s=p,o=u)}}return o||t}}])}(),wt=(vt=2*Math.PI,mt=function(t,e){return(t%e+e)%e},function(t,e){var i=mt(t-e,vt),n=mt(e-t,vt);return i<n?-i:n});function St(t){return St="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},St(t)}function kt(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Mt(n.key),n)}}function Mt(t){var e=function(t,e){if("object"!=St(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=St(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==St(e)?e:e+""}var Pt=function(){return function(t,e,i){return e&&kt(t.prototype,e),i&&kt(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(e,i,n,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.scene=e,this.world=i,this.position=n,this.game=r,this.isDestroyed=!1,this.createMesh(),this.createPhysicsBody(),this.createGlowEffect(),this.startAnimation(),this.onCollideListener=null}),[{key:"createMesh",value:function(){var t=new e.BoxGeometry(1,1,1),i=new e.EdgesGeometry(t);this.dashedMaterial=new e.LineDashedMaterial({color:16777215,dashSize:.4,gapSize:.2,linewidth:2}),this.cageMesh=new e.LineSegments(i,this.dashedMaterial),this.cageMesh.computeLineDistances();var n=new e.BoxGeometry(.5,.5,.5);this.innerMaterial=new e.MeshPhongMaterial({color:16776960}),this.innerMesh=new e.Mesh(n,this.innerMaterial),this.mesh=new e.Group,this.mesh.add(this.cageMesh),this.mesh.add(this.innerMesh),this.mesh.position.copy(this.position),this.scene.add(this.mesh)}},{key:"createGlowEffect",value:function(){var t=new e.Color(16777215);this.glowLight=new e.PointLight(t,1,3),this.glowLight.position.set(0,0,0),this.mesh.add(this.glowLight)}},{key:"createPhysicsBody",value:function(){var t=new i.Box(new i.Vec3(.5,.5,.5));this.body=new i.Body({mass:0,shape:t,collisionFilterGroup:2,position:new i.Vec3(this.position.x,this.position.y,this.position.z)}),this.body.collisionResponse=!1,this.world.addBody(this.body)}},{key:"onCollide",value:function(t){if(!this.isDestroyed){var e=this.game.tanks.find((function(e){return e.body.id==t.body.id}));e&&this.onCollect(e)}}},{key:"startAnimation",value:function(){this.animationTime=0}},{key:"update",value:function(t){this.animationTime+=t,this.cageMesh.rotation.y=.5*this.animationTime,this.innerMesh.rotation.y=-.5*this.animationTime;var e=.1*Math.sin(2*this.animationTime);this.mesh.position.y=this.position.y+e;var i=.5+.3*Math.sin(4*this.animationTime);this.glowLight.intensity=i;var n=N(this.world.contacts,this.body.id);n&&this.onCollide(n)}},{key:"onCollect",value:function(t){}},{key:"remove",value:function(){this.scene.remove(this.mesh),this.isDestroyed=!0,this.world.removeBody(this.body)}}],[{key:"getMesh",value:function(){var t=new e.BoxGeometry(1,1,1),i=new e.EdgesGeometry(t),n=new e.LineDashedMaterial({color:16777215,dashSize:.4,gapSize:.2,linewidth:2}),r=new e.LineSegments(i,n);r.computeLineDistances();var o=new e.BoxGeometry(.5,.5,.5),s=new e.MeshPhongMaterial({color:16776960}),a=new e.Mesh(o,s),h=new e.Group;return h.add(r),h.add(a),h}}])}();function xt(t){return xt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},xt(t)}function Tt(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function At(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Dt(n.key),n)}}function Vt(t,e,i){return e=jt(e),function(t,e){if(e&&("object"==xt(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,zt()?Reflect.construct(e,i||[],jt(t).constructor):e.apply(t,i))}function zt(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(zt=function(){return!!t})()}function Ot(){return Ot="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,i){var n=function(t,e){for(;!{}.hasOwnProperty.call(t,e)&&null!==(t=jt(t)););return t}(t,e);if(n){var r=Object.getOwnPropertyDescriptor(n,e);return r.get?r.get.call(arguments.length<3?t:i):r.value}},Ot.apply(null,arguments)}function jt(t){return jt=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},jt(t)}function It(t,e){return It=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},It(t,e)}function Dt(t){var e=function(t,e){if("object"!=xt(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=xt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==xt(e)?e:e+""}var Ct=function(t){function i(t,e,n,r){return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,i),Vt(this,i,[t,e,n,r])}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&It(t,e)}(i,t),function(t,e,i){return e&&At(t.prototype,e),i&&At(t,i),Object.defineProperty(t,"prototype",{writable:!1}),t}(i,[{key:"createMesh",value:function(){Ot(jt(i.prototype),"createMesh",this).call(this);var t=this.game.loader.getModel("cross");this.innerMesh=t,this.innerMesh.children[0].material.color.set(1,0,0),this.innerMesh.scale.set(.18,.18,.18),this.mesh.remove(this.mesh.children[1]),this.mesh.add(this.innerMesh),this.dashedMaterial.needsUpdate=!0,this.dashedMaterial.color.setHex(16777215)}},{key:"onCollect",value:function(t){t.heal(50),this.remove()}}],[{key:"getMesh",value:function(){var t=Pt.getMesh(),i=new e.Group,n=new e.MeshPhongMaterial({color:16711680,specular:85,shininess:30,flatShading:!0}),r=new e.BoxGeometry(.5,.1,.1),o=new e.Mesh(r,n);i.add(o);var s=new e.BoxGeometry(.1,.5,.1),a=new e.Mesh(s,n);i.add(a);var h=new e.BoxGeometry(.1,.1,.1);return[[.25,0,0],[-.25,0,0],[0,.25,0],[0,-.25,0]].forEach((function(t){var r,o=new e.Mesh(h,n);(r=o.position).set.apply(r,function(t){return function(t){if(Array.isArray(t))return Tt(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(t){if("string"==typeof t)return Tt(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?Tt(t,e):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}(t)),i.add(o)})),t.children[0].material.needsUpdate=!0,t.children[0].material.color.setHex(16777215),t.remove(t.children[1]),t.add(i),t}}])}(Pt);!function(t,e,i){(e=Dt(e))in t?Object.defineProperty(t,e,{value:3,enumerable:!0,configurable:!0,writable:!0}):t[e]=3}(Ct,"objectId");var Bt=1e3/30;function Et(t){return Et="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Et(t)}function Ft(t,e){if(t){if("string"==typeof t)return Rt(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?Rt(t,e):void 0}}function Rt(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function _t(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function Ut(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?_t(Object(i),!0).forEach((function(e){Gt(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):_t(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function Gt(t,e,i){return(e=Lt(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function qt(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Lt(n.key),n)}}function Lt(t){var e=function(t,e){if("object"!=Et(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=Et(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==Et(e)?e:e+""}var Wt=function(){return function(t,e,i){return e&&qt(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(n,r){var o=this;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t);var s=r.map,a=r.ai,h=r.onUpdate,c=r.onAction;this.loader=n,this.headless=!0,this.id=r.gameId,this._tankCounter=0,this._crateCounter=0,this.scene=new e.Scene,this.world=new i.World,this.world.gravity.set(0,-9.82,0),this.clock=new e.Clock,this.projectiles=[],this.maxProjectiles=100,this.plane=new e.Plane(new e.Vector3(0,1,0),0),this.skyBox=new rt(this.scene),this.battleMap=s?C.fromMap(this.scene,this,s):new C(this.scene,this,60,7),this.tanks=[new tt(this.scene,this.world,this,16711680,this.battleMap.spawnPoints[0].position,this.battleMap.spawnPoints[0].rotation),new tt(this.scene,this.world,this,255,this.battleMap.spawnPoints[1].position,this.battleMap.spawnPoints[1].rotation),new tt(this.scene,this.world,this,65280,this.battleMap.spawnPoints[2].position,this.battleMap.spawnPoints[2].rotation),new tt(this.scene,this.world,this,16776960,this.battleMap.spawnPoints[3].position,this.battleMap.spawnPoints[3].rotation)],this.tankSharedData=this.tanks.reduce((function(t,e){return t[e.id]={id:e.id,position:null,quaternion:null,angularVelocity:null,velocity:null,targetTurretAngle:null,targetBarrelAngle:null},t}),{}),this.aiPlayers=null,this.initiateAI(a),this.respawnTimer=5e3,this.powerUps=[],this.powerUpSpawnInterval=1e4,this.lastPowerUpSpawnTime=0,this.setupCollisionEvents(),this.explosions=[],this.frags=r.frags||this.tanks.reduce((function(t,e){return Ut(Ut({},t),{},Gt({},e.id,0))}),{}),this.onUpdate=h,this.onAction=c,this.tick=this.tick.bind(this),r.tanks&&Object.entries(r.tanks).forEach((function(t){var e=function(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=i){var n,r,o,s,a=[],h=!0,c=!1;try{if(o=(i=i.call(t)).next,0===e){if(Object(i)!==i)return;h=!1}else for(;!(h=(n=o.call(i)).done)&&(a.push(n.value),a.length!==e);h=!0);}catch(t){c=!0,r=t}finally{try{if(!h&&null!=i.return&&(s=i.return(),Object(s)!==s))return}finally{if(c)throw r}}return a}}(t,e)||Ft(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}(t,2),i=e[0],n=e[1],r=o.tanks.find((function(t){return t.id==i}));console.log("apply state",i,n,r.id),r.applyState(n)}))}),[{key:"generateTankId",value:function(){return++this._tankCounter}},{key:"generateCrateId",value:function(){return++this._crateCounter}},{key:"initiateAI",value:function(t){var e=this;console.log(this.tanks.map((function(t){return t.id})),t?t.map((function(t){return t.tankId})):[]),this.aiPlayers=t?t.map((function(t){return new gt(e,e.tanks.find((function(e){return e.id===t.tankId})))})):[]}},{key:"updateSharedData",value:function(){for(var t=this.tanks.length-1;t>=0;t--){var e=this.tanks[t],i=e.getStateData();this.tankSharedData[e.id].position=i.position,this.tankSharedData[e.id].quaternion=i.quaternion,this.tankSharedData[e.id].angularVelocity=i.angularVelocity,this.tankSharedData[e.id].velocity=i.velocity,this.tankSharedData[e.id].targetTurretAngle=i.targetTurretAngle,this.tankSharedData[e.id].targetBarrelAngle=i.targetBarrelAngle,this.tankSharedData[e.id].isIndirectFireMode=i.isIndirectFireMode,this.tankSharedData[e.id].isAcceleratingShot=i.isAcceleratingShot,this.tankSharedData[e.id].shotVelocity=i.shotVelocity,this.tankSharedData[e.id].isDestroyed=i.isDestroyed}}},{key:"setupCollisionEvents",value:function(){var t=this;this.world.addEventListener("beginContact",(function(e){var i=e.bodyA,n=e.bodyB,r=t.powerUps.find((function(t){return t.body===i||t.body===n})),o=t.tanks.find((function(t){return t.body===i||t.body===n}));r&&o&&(r.onCollect(o),t.removePowerUp(r))}))}},{key:"removePowerUp",value:function(t){var e=this.powerUps.indexOf(t);e>-1&&(this.powerUps.splice(e,1),t.remove())}},{key:"update",value:function(){var t=this.clock.getDelta();return this.battleMap.update(),this.tanks.forEach((function(e){return e.update(t)})),this.updateProjectiles(t),this.updateExplosions(t),this.updatePowerUps(t),this.aiPlayers.forEach((function(e){return e.update(t)})),this.updateSharedData(),this.onUpdate&&this.onUpdate({gameId:this.id},t),this.world.step(1/60,t,3),t}},{key:"loop",value:function(){this.update();var t,e=(t=null,function e(i){return t=setTimeout((function(){return e(i)}),Bt),i(),t.ref(),function(){return clearTimeout(t)}});this.cancelLoop=e(this.update.bind(this))}},{key:"tick",value:function(){this.update();var t=requestAnimationFrame(this.tick);this.cancelLoop=function(){return cancelAnimationFrame(t)}}},{key:"stop",value:function(){void 0!==this.cancelLoop&&(console.log("Stopping game "+this.id),this.cancelLoop())}},{key:"addProjectile",value:function(t){this.projectiles.push(t),this.projectiles.length>this.maxProjectiles&&this.projectiles.shift().remove(),t.game=this}},{key:"addExplosion",value:function(t){this.explosions.push(t)}},{key:"updateExplosions",value:function(t){this.explosions=this.explosions.filter((function(e){return e.update(t)}))}},{key:"checkProjectileCollision",value:function(t){return!!t.hasContact()}},{key:"updateProjectiles",value:function(t){for(var e=this.projectiles.length-1;e>=0;e--){var i=this.projectiles[e];i.update(t),i.isDestroyed?this.projectiles.splice(e,1):this.isOutOfBounds(i)&&(i.remove(),this.projectiles.splice(e,1))}}},{key:"isOutOfBounds",value:function(t){var e=t.mesh.position,i=1*this.battleMap.size;return Math.abs(e.x)>i||Math.abs(e.y)>i||Math.abs(e.z)>i}},{key:"isPlayerControlledTank",value:function(t){return!this.aiPlayers.some((function(e){return e.tank.id==t.id}))}},{key:"handleTankDeath",value:function(t){var e=this;t.remove(),this.isPlayerControlledTank(t)?this.onTankDeath(t):setTimeout((function(){return e.respawnTank(t)}),this.respawnTimer)}},{key:"onTankDeath",value:function(t){}},{key:"respawnTank",value:function(t){var e=this.getOptimalSpawnPoint(),i=e.optimalPoint,n=e.rotation;this.headless&&this.onAction&&this.onAction({gameId:this.id},{type:"respawn_tank",data:{id:t.id,point:i,rotation:n}}),this.respawnTankInPosition(t,i,n)}},{key:"respawnTankInPosition",value:function(t,e,i){this.headless||console.log("respawn_tank",t,e,i),t.reset(e,i)}},{key:"getOptimalSpawnPoint",value:function(){var t,e=null,i=null,n=1/0,r=function(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=Ft(t))){i&&(t=i);var n=0,r=function(){};return{s:r,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return s=t.done,t},e:function(t){a=!0,o=t},f:function(){try{s||null==i.return||i.return()}finally{if(a)throw o}}}}(this.battleMap.spawnPoints);try{for(r.s();!(t=r.n()).done;){var o=t.value,s=this.countEnemiesNearPoint(o.position);s<n&&(n=s,e=o.position,i=o.rotation)}}catch(t){r.e(t)}finally{r.f()}return{optimalPoint:e,rotation:i}}},{key:"countEnemiesNearPoint",value:function(t){return this.tanks.filter((function(e){return!e.isDestroyed&&e.mesh.position.distanceTo(t)<20})).length}},{key:"updatePowerUps",value:function(t){for(var e=this.powerUps.length-1;e>=0;e--)this.powerUps[e].update(t),this.isDestroyed&&this.powerUps.splice(e,1)}},{key:"spawnPowerUps",value:function(){var t=Date.now();if(t-this.lastPowerUpSpawnTime>this.powerUpSpawnInterval){var e=this.getRandomPosition(),i=new Ct(this.scene,this.world,e,this);this.powerUps.push(i),this.lastPowerUpSpawnTime=t}}},{key:"getRandomPosition",value:function(){var t=this.battleMap.size/2,i=Math.random()*this.battleMap.size-t,n=Math.random()*this.battleMap.size-t;return new e.Vector3(i,1,n)}},{key:"damageTank",value:function(t,e,i,n,r){e.takeDamage(t,r);var o=this.checkTankDestruction(e,r);return this.headless&&this.onAction&&this.onAction({gameId:this.id},{type:"damage_tank",data:{id:e.id,radius:i,damage:t,dealer:r.id,position:n}}),o}},{key:"checkTankDestruction",value:function(t,e){return t.health<=0&&!t.isDestroyed?(t.isDestroyed=!0,console.log("".concat(e.id," killed ").concat(t.id)),this.handleTankDeath(t),e.id):null}},{key:"damageCrate",value:function(t,e,i,n){var r=n.destroyCubesInRadius(e,i);return this.headless&&this.onAction&&this.onAction({gameId:this.id},{type:"damage_crate",data:{id:n.id,innerPoint:t,deepPoint:e,radius:i}}),r}},{key:"addFrag",value:function(t){this.frags[t.id]=this.frags[t.id]?this.frags[t.id]+1:1}},{key:"start",value:function(){this.loop()}}])}();function Nt(t){return Nt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Nt(t)}function Qt(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Ht(n.key),n)}}function Ht(t){var e=function(t,e){if("object"!=Nt(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=Nt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==Nt(e)?e:e+""}var Yt=function(){return function(t,e,i){return e&&Qt(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.model=new e.Object3D;var i=new e.BoxGeometry(1,1,1),n=new e.MeshStandardMaterial({color:new e.Color}),r=new e.Mesh(i,n);this.model.children.push(r),this.texture=new e.DataTexture(new Uint8Array,16,16)}),[{key:"getModel",value:function(t){return this.model}},{key:"getTexture",value:function(t){return this.texture}}])}();function $t(t){return $t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},$t(t)}function Jt(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function Kt(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?Jt(Object(i),!0).forEach((function(e){Zt(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):Jt(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function Xt(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,te(n.key),n)}}function Zt(t,e,i){return(e=te(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function te(t){var e=function(t,e){if("object"!=$t(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=$t(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==$t(e)?e:e+""}var ee=new Yt,ie=function(){return function(t,e,i){return e&&Xt(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),Zt(this,"games",{}),Zt(this,"playersReady",{}),this.provider=e,this.frequency=.05,this.timeSinceStateLastProvide=0}),[{key:"listen",value:function(){var t=this;this.provider.onGameCreate((function(e,i){t.onGameCreate(e,i)})),this.provider.onReadyToStartGame((function(e,i){t.onReadyToStartGame(e,i)})),this.provider.onUserTanksUpdate((function(e,i){t.onUserTanksUpdate(e,i)})),this.provider.onUserTankShoot((function(e,i){t.onUserTankShoot(e,i)})),this.provider.onUserLeft((function(e,i){t.onUserLeft(e,i)})),this.provider.onUserTankRespawn((function(e,i){t.onUserTankRespawn(e,i)})),this.provider.listen&&this.provider.listen()}},{key:"onGameTick",value:function(t,e){this.emitTanksUpdate(t)}},{key:"onUserLeft",value:function(t,e){this.games[t.gameId]&&(console.log("user left",t,e),this.games[t.gameId].playersReady[t.id]=!1,Object.values(this.games[t.gameId].playersReady).every((function(t){return!t}))&&(console.log("stopping game..."),this.games[t.gameId].stop(),delete this.games[t.gameId]))}},{key:"onGameAction",value:function(t,e){var i=e.type,n=e.data;switch(i){case"tank_shoot":this.emitTankShoot(t,n);break;case"damage_tank":this.emitDamageTank(t,n);break;case"damage_crate":this.emitDamageCrate(t,n);break;case"respawn_tank":this.emitRespawnTank(t,n)}}},{key:"emitTankShoot",value:function(t,e){this.provider.postTankShoot(t,{data:e,timestamp:Date.now()})}},{key:"emitDamageTank",value:function(t,e){this.provider.postDamageTank(t,{data:e,timestamp:Date.now()})}},{key:"emitDamageCrate",value:function(t,e){this.provider.postDamageCrate(t,{data:e,timestamp:Date.now()})}},{key:"emitRespawnTank",value:function(t,e){this.provider.postRespawnTank(t,{data:e,timestamp:Date.now()})}},{key:"emitTanksUpdate",value:function(t){this.games[t.gameId]&&this.provider.postTanksUpdate(t,{data:this.games[t.gameId].tankSharedData,timestamp:Date.now()})}},{key:"onUserTankShoot",value:function(t,i){var n=i.data,r=(i.timestamp,n.barrelEnd),o=n.shootDirection,s=n.initialVelocity,a=n.id,h=this.games[t.gameId].tanks.find((function(t){return t.id===+a}));h||console.warn(h.id+" tank shoot not found");var c=(new e.Vector3).copy(r),l=(new e.Vector3).copy(o);h.addProjectile(c,l,s),h.shootSignal(c.clone(),l.clone(),s)}},{key:"onUserTankRespawn",value:function(t,e){var i=e.data,n=(e.timestamp,i.id),r=this.games[t.gameId].tanks.find((function(t){return t.id===+n}));this.games[t.gameId].respawnTank(r)}},{key:"onUserTanksUpdate",value:function(t,e){var i=e.data,n=e.timestamp,r=i.id;this.games[t.gameId].tanks.find((function(t){return t.id===+r})).updateServerState(i,n)}},{key:"onGameCreate",value:function(t,e){var i=e.gameId&&this.games[e.gameId]?this.games[e.gameId]:new Wt(ee,Kt(Kt({},e),{},{gameId:"game-".concat(Math.floor(1e5*Math.random())),onUpdate:this.onGameTick.bind(this),onAction:this.onGameAction.bind(this)}));this.ensureGame(i,t,e)}},{key:"ensureGame",value:function(t,e,i){this.provider.setUserMeta(e.id,{gameId:t.id}),this.provider.postGameCreated({id:e.id,gameId:t.id},{playerTankId:i.playerTankId,gameId:t.id,map:t.battleMap.getMap(),tanks:t.tanks.reduce((function(t,e){return t[e.id]={position:e.body.position,quaternion:e.body.quaternion,angularVelocity:e.body.angularVelocity,velocity:e.body.velocity,turretRotation:e.turretRotation,barrelAngle:e.barrelAngle,isIndirectFireMode:e.isIndirectFireMode,isAcceleratingShot:e.isAcceleratingShot,shotVelocity:e.shotVelocity,isDestroyed:e.isDestroyed,hp:e.health,visible:e.mesh.visible},t}),{}),frags:t.frags}),this.games[t.id]=t,this.games[t.id].playersReady=Zt({},e.id,!1),console.log(t.id,e.id)}},{key:"onReadyToStartGame",value:function(t,e){console.log("onReadyToStartGame",t),this.games[t.gameId].playersReady[t.id]=!0,Object.values(this.games[t.gameId].playersReady).every((function(t){return t}))&&(this.games[t.gameId].start(),this.provider.postGameStarted(t,{time:this.games[t.gameId].clock.getElapsedTime()}))}}])}(),ne=function(t,e){return{event:t,payload:e}};const re=require("uWebSockets.js");var oe=t.n(re);function se(t){return se="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},se(t)}function ae(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function he(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?ae(Object(i),!0).forEach((function(e){ue(t,e,i[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):ae(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}function ce(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function le(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,pe(n.key),n)}}function ue(t,e,i){return(e=pe(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function pe(t){var e=function(t,e){if("object"!=se(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,"string");if("object"!=se(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==se(e)?e:e+""}var ye=+process.env.PORT||9001,de=function(){return function(t,e,i){return e&&le(t.prototype,e),Object.defineProperty(t,"prototype",{writable:!1}),t}((function t(){var e=this;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),ue(this,"_count",0),ue(this,"callbacks",{}),ue(this,"users",{}),console.log("Listen on post "+ye),this.app=oe().App().get("/",(function(t,e){t.end("Pocket tanks server time: ".concat((new Date).toISOString()))})).ws("/ws",{compression:oe().SHARED_COMPRESSOR,maxPayloadLength:16777216,idleTimeout:10,maxBackpressure:1024,open:function(t){t.id="".concat(++e._count),e.users[t.id]=t},message:function(t,i,n){var r=(new TextDecoder).decode(i),o=JSON.parse(r),s=t.getUserData();e._handleEvent(s.meta?s.meta:s,o)},drain:function(t){},close:function(t,i,n){var r=t.getUserData();e._handleEvent(r.meta,{event:"user_left",data:{}}),delete e.users[t.id]}}).any("/*",(function(t,e){t.end("Nothing to see here!")}))}),[{key:"listen",value:function(){this.app.listen(ye,(function(t){t?console.log("Listening to port "+ye):console.log("Failed to listen to port "+ye)}))}},{key:"_handleEvent",value:function(t,e){var i=e.event,n=e.payload,r=this.callbacks[i];r&&r.forEach((function(e){return e(t,n)}))}},{key:"_onEvent",value:function(t,e){this.callbacks[t]=this.callbacks[t]?[].concat(function(t){return function(t){if(Array.isArray(t))return ce(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,e){if(t){if("string"==typeof t)return ce(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?ce(t,e):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}(this.callbacks[t]),[e]):[e]}},{key:"_postSingleEvent",value:function(t,e,i){this.users[e.id].send(JSON.stringify(ne(t,i)),!1,!0)}},{key:"_postEvent",value:function(t,e,i){this.app.publish("/game/".concat(e.gameId,"/events"),JSON.stringify(ne(t,i)),!1,!0)}},{key:"setUserMeta",value:function(t,e){this.users[t].meta=he(he({},e),{},{id:t})}},{key:"onUserLeft",value:function(t){this._onEvent("user_left",t)}},{key:"onGameCreate",value:function(t){this._onEvent("game_create",t)}},{key:"onReadyToStartGame",value:function(t){this._onEvent("ready_to_start_game",t)}},{key:"postGameStarted",value:function(t,e){console.log("game_started",t,e),this._postSingleEvent("game_started",t,e)}},{key:"postGameCreated",value:function(t,e){console.log(this.users[t.id],"/game/".concat(t.gameId,"/events")),this.users[t.id].subscribe("/game/".concat(t.gameId,"/events")),this._postSingleEvent("game_created",t,e)}},{key:"postTanksUpdate",value:function(t,e){this._postEvent("tanks_update",t,e)}},{key:"postTankShoot",value:function(t,e){this._postEvent("tank_shoot",t,e)}},{key:"postDamageTank",value:function(t,e){this._postEvent("damage_tank",t,e)}},{key:"postDamageCrate",value:function(t,e){this._postEvent("damage_crate",t,e)}},{key:"postRespawnTank",value:function(t,e){this._postEvent("respawn_tank",t,e)}},{key:"onUserTanksUpdate",value:function(t){this._onEvent("user_tanks_update",t)}},{key:"onUserTankShoot",value:function(t){this._onEvent("user_tank_shoot",t)}},{key:"onUserTankRespawn",value:function(t){this._onEvent("user_tank_respawn",t)}}])}();console.log(process.env),new ie(new de).listen()})();
//# sourceMappingURL=server.js.map